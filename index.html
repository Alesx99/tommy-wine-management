<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gestione Tommy - Privilege Caf√®&Wine</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #059669;
            --primary-dark: #047857;
            --primary-light: #10b981;
            --secondary-color: #64748b;
            --success-color: #059669;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #06b6d4;
            --background-color: #f8fafc;
            --surface-color: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --border-light: #f1f5f9;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: var(--spacing-lg);
        }

        .container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            box-sizing: border-box;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: var(--spacing-2xl);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        .header h1 {
            font-size: 2.75rem;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.125rem;
            opacity: 0.95;
            font-weight: 400;
            position: relative;
            z-index: 1;
        }

        .nav-tabs {
            display: flex;
            background: var(--surface-color);
            border-bottom: 2px solid var(--border-light);
            position: relative;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            flex: 1;
            min-width: 140px;
            padding: var(--spacing-lg) var(--spacing-xl);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }

        .nav-tab.active {
            background: var(--surface-color);
            color: var(--primary-color);
            font-weight: 600;
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-color);
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
        }

        .nav-tab:hover:not(.active) {
            background: var(--border-light);
            color: var(--text-primary);
        }

        .tab-content {
            display: none;
            padding: var(--spacing-2xl);
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            margin-bottom: var(--spacing-2xl);
            background: var(--surface-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            border: 1px solid var(--border-color);
        }

        .form-section h3 {
            color: var(--text-primary);
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 2px solid var(--primary-color);
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-lg);
            width: 100%;
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-group label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-lg);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--surface-color);
            color: var(--text-primary);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
            transform: translateY(-1px);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--text-muted);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
            line-height: 1.5;
        }

        .btn {
            padding: var(--spacing-md) var(--spacing-xl);
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            margin: var(--spacing-xs);
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            text-decoration: none;
            font-family: inherit;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-info {
            background: var(--info-color);
            color: white;
        }

        .btn-info:hover {
            background: #0891b2;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-sm {
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: 0.75rem;
        }

        .btn-lg {
            padding: var(--spacing-lg) var(--spacing-2xl);
            font-size: 1rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--spacing-lg);
            background: var(--surface-color);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .data-table th,
        .data-table td {
            padding: var(--spacing-md) var(--spacing-lg);
            text-align: left;
            border-bottom: 1px solid var(--border-light);
            white-space: nowrap;
        }
        
        .data-table th:last-child,
        .data-table td:last-child {
            position: sticky;
            right: 0;
            background: var(--surface-color);
            z-index: 10;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
        }
        
        .data-table td:last-child .btn {
            margin: 2px;
            white-space: nowrap;
        }

        .data-table th {
            background: var(--border-light);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .data-table tr:hover {
            background: var(--border-light);
        }

        .data-table tbody tr {
            transition: background-color 0.2s ease;
        }

        .status-badge {
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-paid {
            background: #dcfce7;
            color: #166534;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-overdue {
            background: #fee2e2;
            color: #991b1b;
        }

        .stock-low {
            background: #fee2e2;
            color: #991b1b;
        }

        .stock-ok {
            background: #dcfce7;
            color: #166534;
        }

        .actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: flex-start;
            margin-top: var(--spacing-xl);
            flex-wrap: wrap;
        }

        .export-section {
            background: var(--border-light);
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            margin-top: var(--spacing-lg);
            border: 1px solid var(--border-color);
        }

        .export-section h4 {
            margin-bottom: var(--spacing-lg);
            color: var(--text-primary);
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* Dashboard Styles */
        .dashboard-container {
            max-width: 100%;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: var(--spacing-2xl);
        }

        .dashboard-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
        }

        .dashboard-header p {
            color: var(--text-secondary);
            font-size: 1.125rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-2xl);
        }

        .stat-card {
            background: var(--surface-color);
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            font-size: 2rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-color);
            color: white;
            border-radius: var(--radius-lg);
        }

        .stat-content h3 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .stat-content p {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .filters-section {
            background: var(--surface-color);
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-xl);
            border: 1px solid var(--border-color);
        }

        .filters-section h3 {
            margin-bottom: var(--spacing-lg);
            color: var(--text-primary);
            font-size: 1.25rem;
            font-weight: 600;
        }

        .filter-controls {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .btn-outline {
            background: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-outline.active {
            background: var(--primary-color);
            color: white;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: var(--spacing-xl);
            margin-bottom: var(--spacing-2xl);
        }

        .chart-section {
            background: var(--surface-color);
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
        }

        .chart-section h3 {
            margin-bottom: var(--spacing-lg);
            color: var(--text-primary);
            font-size: 1.25rem;
            font-weight: 600;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: var(--spacing-md);
            }

            .container {
                border-radius: var(--radius-lg);
            }

            .header {
                padding: var(--spacing-xl);
            }

            .header h1 {
                font-size: 2rem;
            }

            .nav-tabs {
                flex-direction: row;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .nav-tab {
                flex: 0 0 auto;
                min-width: 120px;
                padding: var(--spacing-md) var(--spacing-lg);
                font-size: 0.875rem;
            }
            
            .tab-content {
                padding: var(--spacing-lg);
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-container {
                grid-template-columns: 1fr;
            }

            .actions {
                flex-direction: column;
                align-items: stretch;
            }

            .btn {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.75rem;
            }

            .nav-tab {
                min-width: 100px;
                padding: var(--spacing-sm) var(--spacing-md);
                font-size: 0.8rem;
            }

            .stat-card {
                flex-direction: column;
                text-align: center;
            }

            .stat-icon {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }
        }

        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .print-wine-list, .print-wine-list * {
                visibility: visible;
            }
            
            .print-wine-list {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: white;
                padding: 20px;
                margin: 0;
            }
            
            .wine-header {
                text-align: center;
                margin-bottom: 30px;
                border-bottom: 3px solid #228B22;
                padding-bottom: 20px;
                position: relative;
            }
            
            .wine-header::before,
            .wine-header::after {
                content: 'üç∑';
                font-size: 24px;
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
            }
            
            .wine-header::before {
                left: 20px;
            }
            
            .wine-header::after {
                right: 20px;
            }
            
            .wine-title {
                font-size: 36px;
                font-weight: bold;
                color: #228B22;
                margin: 0;
                font-family: 'Georgia', serif;
            }
            
            .wine-subtitle {
                font-size: 18px;
                color: #666;
                margin: 10px 0 0 0;
                font-style: italic;
            }
            
            .wine-date {
                font-size: 14px;
                color: #888;
                margin: 5px 0 0 0;
            }
            
            .wine-category {
                margin: 40px 0 20px 0;
                font-size: 24px;
                font-weight: bold;
                color: #228B22;
                border-bottom: 2px solid #228B22;
                padding-bottom: 12px;
                text-transform: uppercase;
                letter-spacing: 1px;
                position: relative;
                text-align: center;
            }
            
            .wine-category::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 10px;
                transform: translateY(-50%);
                width: 20px;
                height: 20px;
                background: #228B22;
                border-radius: 50%;
            }
            
            .wine-category::after {
                content: 'üçá';
                position: absolute;
                top: 50%;
                right: 10px;
                transform: translateY(-50%);
                font-size: 18px;
            }
            
            .wine-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px 0;
                border-bottom: 1px solid #f0f0f0;
                font-size: 16px;
            }
            
            .wine-item:last-child {
                border-bottom: 2px solid #ddd;
            }
            
            .wine-name {
                font-weight: 600;
                color: #333;
                flex: 1;
            }
            
            .wine-price {
                font-weight: bold;
                color: #8B0000;
                font-size: 18px;
                min-width: 80px;
                text-align: right;
            }
            
            .wine-tipologia {
                font-size: 14px;
                color: #666;
                font-style: italic;
                margin-left: 20px;
                flex: 0 0 120px;
            }
            
            .page-break {
                page-break-before: always;
            }
            
            .wine-footer {
                margin-top: 40px;
                text-align: center;
                font-size: 12px;
                color: #888;
                border-top: 1px solid #ddd;
                padding-top: 20px;
            }
        }

        /* Loading Animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Table Scroll Improvements */
        @media (max-width: 768px) {
            .table-scroll-container {
                overflow-x: auto;
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-sm);
            }
            
            .table-scroll-container::-webkit-scrollbar {
                height: 6px;
            }
            
            .table-scroll-container::-webkit-scrollbar-track {
                background: var(--border-light);
                border-radius: var(--radius-sm);
            }
            
            .table-scroll-container::-webkit-scrollbar-thumb {
                background: var(--primary-color);
                border-radius: var(--radius-sm);
            }
            
            .table-scroll-container::-webkit-scrollbar-thumb:hover {
                background: var(--primary-dark);
            }
            
            .scrollable-table {
                min-width: 1200px;
                width: 100%;
            }
            
            .scrollable-table th,
            .scrollable-table td {
                white-space: nowrap;
                padding: var(--spacing-md) var(--spacing-sm);
            }
            
            .scrollable-table td:nth-child(1) {
                font-weight: 600;
                min-width: 150px;
            }
            
            .scrollable-table td:nth-child(8) {
                font-weight: 600;
                color: var(--success-color);
            }
            
            .scrollable-table td:nth-child(9) {
                font-weight: 600;
                color: var(--danger-color);
            }
            
            .scrollable-table td:nth-child(10) {
                text-align: center;
                font-weight: 600;
            }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .security-modal {
            background: var(--surface-color);
            padding: var(--spacing-2xl);
            border-radius: var(--radius-xl);
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
        }

        .security-modal h3 {
            color: var(--text-primary);
            margin-bottom: var(--spacing-lg);
            font-size: 1.5rem;
            font-weight: 600;
        }

        .security-modal input {
            width: 100%;
            padding: var(--spacing-md);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 1rem;
            margin-bottom: var(--spacing-lg);
            text-align: center;
            font-family: inherit;
        }

        .security-modal input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        .security-warning {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            color: #92400e;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-lg);
            font-size: 0.875rem;
            text-align: center;
        }

        .security-warning strong {
            color: var(--danger-color);
        }

        /* Security Toggle Animation */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .security-toggle.alert {
            animation: pulse 2s infinite;
            background: var(--danger-color);
        }

        /* Censored Table Styles */
        .table-censored {
            position: relative;
        }

        .table-censored .censored {
            background: var(--border-light);
            border-radius: var(--radius-sm);
            padding: 2px 6px;
        }

        /* Product Table Styles */
        .prodotti-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--spacing-lg);
            background: var(--surface-color);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .prodotti-table th,
        .prodotti-table td {
            padding: var(--spacing-md);
            text-align: left;
            border-bottom: 1px solid var(--border-light);
        }

        .prodotti-table th {
            background: var(--border-light);
            font-weight: 600;
            color: var(--text-primary);
        }

        .prodotti-table input {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-family: inherit;
        }

        .prodotti-table input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        /* Totals Section */
        .totali-section {
            margin: var(--spacing-xl) 0;
            padding: var(--spacing-xl);
            background: var(--border-light);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
        }

        .totali-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-lg);
        }

        .totali-grid input {
            font-weight: 600;
            font-size: 1rem;
            background: var(--surface-color);
        }

        /* Catalog Tabs */
        .catalogo-tabs {
            display: flex;
            margin-bottom: var(--spacing-lg);
            border-bottom: 2px solid var(--border-light);
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .catalogo-tabs::-webkit-scrollbar {
            display: none;
        }

        .catalogo-tab {
            padding: var(--spacing-md) var(--spacing-xl);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            position: relative;
        }

        .catalogo-tab.active {
            color: var(--primary-color);
            font-weight: 600;
        }

        .catalogo-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-color);
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
        }

        .catalogo-tab:hover:not(.active) {
            background: var(--border-light);
            color: var(--text-primary);
        }

        .catalogo-tab-content {
            display: none;
        }

        .catalogo-tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        
        .mb-0 { margin-bottom: 0; }
        .mb-1 { margin-bottom: var(--spacing-xs); }
        .mb-2 { margin-bottom: var(--spacing-sm); }
        .mb-3 { margin-bottom: var(--spacing-md); }
        .mb-4 { margin-bottom: var(--spacing-lg); }
        .mb-5 { margin-bottom: var(--spacing-xl); }
        
        .mt-0 { margin-top: 0; }
        .mt-1 { margin-top: var(--spacing-xs); }
        .mt-2 { margin-top: var(--spacing-sm); }
        .mt-3 { margin-top: var(--spacing-md); }
        .mt-4 { margin-top: var(--spacing-lg); }
        .mt-5 { margin-top: var(--spacing-xl); }
        
        .p-0 { padding: 0; }
        .p-1 { padding: var(--spacing-xs); }
        .p-2 { padding: var(--spacing-sm); }
        .p-3 { padding: var(--spacing-md); }
        .p-4 { padding: var(--spacing-lg); }
        .p-5 { padding: var(--spacing-xl); }

        /* Focus States */
        .btn:focus,
        .nav-tab:focus,
        .catalogo-tab:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --background-color: #0f172a;
                --surface-color: #1e293b;
                --text-primary: #f1f5f9;
                --text-secondary: #cbd5e1;
                --text-muted: #64748b;
                --border-color: #334155;
                --border-light: #1e293b;
            }
        }

        /* Print Styles for Wine List */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .print-wine-list, .print-wine-list * {
                visibility: visible;
            }
            
            .print-wine-list {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: white;
                padding: var(--spacing-xl);
                margin: 0;
            }
            
            .wine-header {
                text-align: center;
                margin-bottom: var(--spacing-xl);
                border-bottom: 3px solid var(--success-color);
                padding-bottom: var(--spacing-lg);
                position: relative;
            }
            
            .wine-header::before,
            .wine-header::after {
                content: 'üç∑';
                font-size: 1.5rem;
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
            }
            
            .wine-header::before {
                left: var(--spacing-xl);
            }
            
            .wine-header::after {
                right: var(--spacing-xl);
            }
            
            .wine-title {
                font-size: 2.25rem;
                font-weight: 700;
                color: var(--success-color);
                margin: 0;
                font-family: 'Georgia', serif;
            }
            
            .wine-subtitle {
                font-size: 1.125rem;
                color: var(--text-secondary);
                margin: var(--spacing-sm) 0 0 0;
                font-style: italic;
            }
            
            .wine-date {
                font-size: 0.875rem;
                color: var(--text-muted);
                margin: var(--spacing-xs) 0 0 0;
            }
            
            .wine-category {
                margin: var(--spacing-2xl) 0 var(--spacing-lg) 0;
                font-size: 1.5rem;
                font-weight: 700;
                color: var(--success-color);
                border-bottom: 2px solid var(--success-color);
                padding-bottom: var(--spacing-md);
                text-transform: uppercase;
                letter-spacing: 0.05em;
                position: relative;
                text-align: center;
            }
            
            .wine-category::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 0;
                right: 0;
                height: 1px;
                background: linear-gradient(to right, transparent, var(--success-color), transparent);
            }
            
            .wine-category::after {
                content: 'üçá';
                position: absolute;
                top: 50%;
                right: var(--spacing-md);
                transform: translateY(-50%);
                font-size: 1.125rem;
            }
            
            .wine-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: var(--spacing-md) 0;
                border-bottom: 1px solid var(--border-light);
                font-size: 1rem;
            }
            
            .wine-item:last-child {
                border-bottom: 2px solid var(--border-color);
            }
            
            .wine-name {
                font-weight: 600;
                color: var(--text-primary);
                flex: 1;
            }
            
            .wine-price {
                font-weight: 700;
                color: var(--danger-color);
                font-size: 1.125rem;
                min-width: 80px;
                text-align: right;
            }
            
            .wine-tipologia {
                font-size: 0.875rem;
                color: var(--text-secondary);
                font-style: italic;
                margin-left: var(--spacing-lg);
                flex: 0 0 120px;
            }
            
            .page-break {
                page-break-before: always;
            }
            
            .wine-footer {
                margin-top: var(--spacing-2xl);
                text-align: center;
                font-size: 0.75rem;
                color: var(--text-muted);
                border-top: 1px solid var(--border-color);
                padding-top: var(--spacing-lg);
            }
        }

        /* Loading Animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Table Improvements */
        @media (max-width: 768px) {
            .data-table {
                font-size: 0.75rem;
            }
            
            .data-table th,
            .data-table td {
                padding: var(--spacing-sm) var(--spacing-xs);
            }
            
            .btn-sm {
                padding: var(--spacing-xs) var(--spacing-sm);
                font-size: 0.75rem;
            }
        }
        
        /* Table Scroll Container */
        .table-scroll-container {
            overflow-x: auto;
            width: 100%;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            background: var(--surface-color);
            position: relative;
        }

        /* Ensure proper scrolling behavior */
        .table-scroll-container::-webkit-scrollbar {
            height: 8px;
        }

        .table-scroll-container::-webkit-scrollbar-track {
            background: var(--border-light);
            border-radius: var(--radius-sm);
        }

        .table-scroll-container::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: var(--radius-sm);
        }

        .table-scroll-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        .table-scroll-container::-webkit-scrollbar {
            height: 8px;
        }
        
        .table-scroll-container::-webkit-scrollbar-track {
            background: var(--border-light);
            border-radius: var(--radius-sm);
        }
        
        .table-scroll-container::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: var(--radius-sm);
        }
        
        .table-scroll-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        .scrollable-table {
            min-width: 1200px;
            width: 100%;
            border-collapse: collapse;
        }
        
        .scrollable-table th,
        .scrollable-table td {
            white-space: nowrap;
            padding: var(--spacing-md) var(--spacing-sm);
            border-bottom: 1px solid var(--border-light);
        }

        .scrollable-table th {
            background: var(--border-light);
            font-weight: 600;
            color: var(--text-primary);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .scrollable-table tr:hover {
            background: var(--border-light);
        }
        
        /* Specific column styles */
        .scrollable-table td:nth-child(1) {
            font-weight: 600;
            min-width: 150px;
        }
        
        .scrollable-table td:nth-child(8) {
            font-weight: 600;
            color: var(--success-color);
        }
        
        .scrollable-table td:nth-child(9) {
            font-weight: 600;
            color: var(--danger-color);
        }
        
        .scrollable-table td:nth-child(10) {
            text-align: center;
            font-weight: 600;
        }
        
        .scrollable-table td:nth-child(14) {
            white-space: nowrap;
            min-width: 120px;
        }

        /* Vini table specific styles */
        #viniTable {
            min-width: 1400px;
        }

        #viniTable th,
        #viniTable td {
            padding: var(--spacing-md) var(--spacing-sm);
            white-space: nowrap;
            vertical-align: middle;
        }

        #viniTable th {
            background: var(--border-light);
            font-weight: 600;
            color: var(--text-primary);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #viniTable td {
            border-bottom: 1px solid var(--border-light);
        }

        #viniTable tr:hover {
            background: var(--border-light);
        }

        /* Sticky actions column - always visible */
        #viniTable th:last-child,
        #viniTable td:last-child {
            position: sticky;
            right: 0;
            background: var(--surface-color);
            z-index: 15;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            min-width: 140px;
        }

        /* Ensure buttons are always visible and compact */
        #viniTable td:last-child .btn {
            margin: 2px;
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 0.75rem;
            white-space: nowrap;
            min-width: 60px;
        }

        /* Responsive adjustments for vini table */
        @media (max-width: 1200px) {
            #viniTable {
                min-width: 1200px;
            }
        }

        @media (max-width: 768px) {
            #viniTable {
                min-width: 1000px;
                font-size: 0.875rem;
            }
            
            #viniTable th,
            #viniTable td {
                padding: var(--spacing-sm) var(--spacing-xs);
            }

            #viniTable td:last-child .btn {
                padding: var(--spacing-xs);
                font-size: 0.7rem;
                min-width: 50px;
            }
        }

        /* Prodotti table specific styles */
        #prodottiTable {
            min-width: 1200px;
        }

        #prodottiTable th,
        #prodottiTable td {
            padding: var(--spacing-md) var(--spacing-sm);
            white-space: nowrap;
            vertical-align: middle;
        }

        #prodottiTable th {
            background: var(--border-light);
            font-weight: 600;
            color: var(--text-primary);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #prodottiTable td {
            border-bottom: 1px solid var(--border-light);
        }

        #prodottiTable tr:hover {
            background: var(--border-light);
        }

        /* Sticky actions column for prodotti table */
        #prodottiTable th:last-child,
        #prodottiTable td:last-child {
            position: sticky;
            right: 0;
            background: var(--surface-color);
            z-index: 15;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            min-width: 140px;
        }

        /* Ensure buttons are always visible and compact for prodotti */
        #prodottiTable td:last-child .btn {
            margin: 2px;
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 0.75rem;
            white-space: nowrap;
            min-width: 60px;
        }

        /* Responsive adjustments for prodotti table */
        @media (max-width: 1200px) {
            #prodottiTable {
                min-width: 1000px;
            }
        }

        @media (max-width: 768px) {
            #prodottiTable {
                min-width: 800px;
                font-size: 0.875rem;
            }
            
            #prodottiTable th,
            #prodottiTable td {
                padding: var(--spacing-sm) var(--spacing-xs);
            }

            #prodottiTable td:last-child .btn {
                padding: var(--spacing-xs);
                font-size: 0.7rem;
                min-width: 50px;
            }
        }

        /* Clienti table specific styles */
        #clientiTable {
            min-width: 1100px;
        }

        #clientiTable th,
        #clientiTable td {
            padding: var(--spacing-md) var(--spacing-sm);
            white-space: nowrap;
            vertical-align: middle;
        }

        #clientiTable th {
            background: var(--border-light);
            font-weight: 600;
            color: var(--text-primary);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #clientiTable td {
            border-bottom: 1px solid var(--border-light);
        }

        #clientiTable tr:hover {
            background: var(--border-light);
        }

        /* Sticky actions column for clienti table */
        #clientiTable th:last-child,
        #clientiTable td:last-child {
            position: sticky;
            right: 0;
            background: var(--surface-color);
            z-index: 15;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            min-width: 140px;
        }

        /* Ensure buttons are always visible and compact for clienti */
        #clientiTable td:last-child .btn {
            margin: 2px;
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 0.75rem;
            white-space: nowrap;
            min-width: 60px;
        }

        /* Responsive adjustments for clienti table */
        @media (max-width: 1200px) {
            #clientiTable {
                min-width: 900px;
            }
        }

        @media (max-width: 768px) {
            #clientiTable {
                min-width: 700px;
                font-size: 0.875rem;
            }
            
            #clientiTable th,
            #clientiTable td {
                padding: var(--spacing-sm) var(--spacing-xs);
            }

            #clientiTable td:last-child .btn {
                padding: var(--spacing-xs);
                font-size: 0.7rem;
                min-width: 50px;
            }
        }

        /* Fatture table specific styles */
        #fattureTable {
            min-width: 1200px;
        }

        #fattureTable th,
        #fattureTable td {
            padding: var(--spacing-md) var(--spacing-sm);
            white-space: nowrap;
            vertical-align: middle;
        }

        #fattureTable th {
            background: var(--border-light);
            font-weight: 600;
            color: var(--text-primary);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #fattureTable td {
            border-bottom: 1px solid var(--border-light);
        }

        #fattureTable tr:hover {
            background: var(--border-light);
        }

        /* Sticky actions column for fatture table */
        #fattureTable th:last-child,
        #fattureTable td:last-child {
            position: sticky;
            right: 0;
            background: var(--surface-color);
            z-index: 15;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            min-width: 160px;
        }

        /* Ensure buttons are always visible and compact for fatture */
        #fattureTable td:last-child .btn {
            margin: 2px;
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 0.75rem;
            white-space: nowrap;
            min-width: 50px;
        }

        /* Responsive adjustments for fatture table */
        @media (max-width: 1400px) {
            #fattureTable {
                min-width: 1000px;
            }
        }

        @media (max-width: 768px) {
            #fattureTable {
                min-width: 800px;
                font-size: 0.875rem;
            }
            
            #fattureTable th,
            #fattureTable td {
                padding: var(--spacing-sm) var(--spacing-xs);
            }

            #fattureTable td:last-child .btn {
                padding: var(--spacing-xs);
                font-size: 0.7rem;
                min-width: 40px;
            }
        }

        /* Censorship and Security System */
        .censored {
            color: transparent;
            text-shadow: 0 0 8px #000;
            user-select: none;
            position: relative;
        }

        .censored::before {
            content: '***';
            color: var(--text-muted);
            text-shadow: none;
            position: absolute;
            left: 0;
            top: 0;
        }

        .security-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .security-modal {
            background: var(--surface-color);
            padding: var(--spacing-2xl);
            border-radius: var(--radius-xl);
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
        }

        .security-modal h3 {
            color: var(--text-primary);
            margin-bottom: var(--spacing-lg);
            font-size: 1.5rem;
            font-weight: 600;
        }

        .security-modal input {
            width: 100%;
            padding: var(--spacing-md);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 1rem;
            margin-bottom: var(--spacing-lg);
            text-align: center;
            font-family: inherit;
        }

        .security-modal input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .security-toggle {
            position: fixed;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            z-index: 1000;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            box-shadow: var(--shadow-md);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .security-toggle:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .security-toggle.active {
            background: var(--success-color);
        }

        .security-toggle.active:hover {
            background: #059669;
        }

        .security-warning {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            color: #92400e;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-lg);
            font-size: 0.875rem;
            text-align: center;
        }

        .security-warning strong {
            color: var(--danger-color);
        }

        /* Security Toggle Animation */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .security-toggle.alert {
            animation: pulse 2s infinite;
            background: var(--danger-color);
        }

        /* Censored Table Styles */
        .table-censored {
            position: relative;
        }

        .table-censored .censored {
            background: var(--border-light);
            border-radius: var(--radius-sm);
            padding: 2px 6px;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            max-width: 90%;
            max-height: 90%;
            width: 1200px;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: var(--spacing-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            transform: scale(1.1);
        }

        .modal-body {
            padding: var(--spacing-xl);
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: var(--spacing-xl);
            background: var(--border-light);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: var(--spacing-md);
            justify-content: flex-end;
        }

        /* Product Section Styles */
        .prodotti-section {
            margin: var(--spacing-xl) 0;
        }

        .prodotti-controls {
            margin-bottom: var(--spacing-lg);
            display: flex;
            gap: var(--spacing-md);
        }

        .prodotti-table-container {
            overflow-x: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
        }

        .prodotti-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        .prodotti-table th,
        .prodotti-table td {
            padding: var(--spacing-md);
            text-align: left;
            border-bottom: 1px solid var(--border-light);
        }

        .prodotti-table th {
            background: var(--border-light);
            font-weight: 600;
            color: var(--text-primary);
        }

        .prodotti-table input {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-family: inherit;
        }

        .prodotti-table input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        /* Totals Section */
        .totali-section {
            margin: var(--spacing-xl) 0;
            padding: var(--spacing-xl);
            background: var(--border-light);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
        }

        .totali-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-lg);
        }

        .totali-grid input {
            font-weight: 600;
            font-size: 1rem;
            background: var(--surface-color);
        }

        /* Catalog Tabs */
        .catalogo-tabs {
            display: flex;
            margin-bottom: var(--spacing-lg);
            border-bottom: 2px solid var(--border-light);
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .catalogo-tabs::-webkit-scrollbar {
            display: none;
        }

        .catalogo-tab {
            padding: var(--spacing-md) var(--spacing-xl);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            position: relative;
        }

        .catalogo-tab.active {
            color: var(--primary-color);
            font-weight: 600;
        }

        .catalogo-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-color);
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
        }

        .catalogo-tab:hover:not(.active) {
            background: var(--border-light);
            color: var(--text-primary);
        }

        .catalogo-tab-content {
            display: none;
        }

        .catalogo-tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        .catalogo-table {
            width: 100%;
            border-collapse: collapse;
        }

        .catalogo-table th,
        .catalogo-table td {
            padding: var(--spacing-md);
            text-align: left;
            border-bottom: 1px solid var(--border-light);
        }

        .catalogo-table th {
            background: var(--border-light);
            font-weight: 600;
            color: var(--text-primary);
        }

        .catalogo-table tr:hover {
            background: var(--border-light);
        }

        /* Preview Table Styles */
        .anteprima-section {
            margin-top: var(--spacing-xl);
            padding: var(--spacing-xl);
            background: var(--border-light);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
        }

        .anteprima-section h5 {
            margin: 0 0 var(--spacing-md) 0;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
        }

        .anteprima-table-container {
            overflow-x: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            background: var(--surface-color);
        }

        .anteprima-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        .anteprima-table th,
        .anteprima-table td {
            padding: var(--spacing-md);
            text-align: left;
            border-bottom: 1px solid var(--border-light);
            font-size: 0.875rem;
        }

        .anteprima-table th {
            background: var(--border-light);
            font-weight: 600;
            color: var(--text-primary);
        }

        .anteprima-table tr:hover {
            background: var(--border-light);
        }

        .anteprima-table .sconto-cell {
            font-weight: 600;
            color: var(--danger-color);
        }

        .anteprima-table .subtotale-cell {
            font-weight: 600;
            color: var(--success-color);
        }

        /* Preview Controls */
        .anteprima-table input[type="number"],
        .anteprima-table select {
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 0.875rem;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .anteprima-table input[type="number"]:focus,
        .anteprima-table select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        .anteprima-table .sconto-cell .flex-container {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        /* Preview Delete Button */
        .anteprima-table .btn-danger {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 0.75rem;
        }

        .anteprima-table .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        /* Badge Styles */
        .badge {
            display: inline-block;
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-primary {
            background: var(--primary-color);
            color: white;
        }

        .badge-warning {
            background: var(--warning-color);
            color: white;
        }

        .badge-info {
            background: var(--info-color);
            color: white;
        }

        .badge-secondary {
            background: var(--secondary-color);
            color: white;
        }

        /* Security System Responsive */
        @media (max-width: 768px) {
            .security-toggle {
                top: var(--spacing-md);
                right: var(--spacing-md);
                padding: var(--spacing-xs) var(--spacing-sm);
                font-size: 0.75rem;
            }
            
            .security-modal {
                margin: var(--spacing-lg);
                padding: var(--spacing-xl);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading Indicator -->
        <div id="loadingIndicator" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
                <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #1a5f3a; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
                <p>Caricamento...</p>
            </div>
        </div>

        <!-- Sistema di Login -->
        <div id="loginOverlay" class="security-overlay">
            <div class="security-modal">
                <h3>üç∑ Gestione Tommy - Accesso</h3>
                <div class="security-warning">
                    <strong>üîê LOGIN:</strong><br>
                    Inserisci le credenziali per accedere al sistema
                </div>
                <input type="text" id="loginUsername" placeholder="Username..." style="margin-bottom: 10px;">
                <input type="password" id="loginPassword" placeholder="Password..." onkeypress="handleLoginPassword(event)">
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-primary" onclick="validateLogin()">üîì Accedi</button>
                    <button class="btn btn-secondary" onclick="guestLogin()">üë§ Accesso Cliente</button>
                </div>
            </div>
        </div>

        <!-- Sistema di Sicurezza -->
        <button id="securityToggle" class="security-toggle" onclick="toggleSecurity()" title="üîí Attiva/Disattiva Sicurezza" style="display: none;">
            üîí Sicurezza
        </button>

        <!-- Modal per Password di Sicurezza -->
        <div id="securityOverlay" class="security-overlay">
            <div class="security-modal">
                <h3 id="securityModalTitle">üîê Accesso Sicurezza</h3>
                <div class="security-warning" id="securityWarning">
                    <strong>‚ö†Ô∏è ATTENZIONE:</strong><br>
                    Inserisci la password per visualizzare i prezzi di acquisto
                </div>
                <input type="password" id="securityPassword" placeholder="Inserisci password..." onkeypress="handleSecurityPassword(event)">
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-primary" id="securityActionBtn" onclick="validateSecurityPassword()">üîì Sblocca</button>
                    <button class="btn btn-secondary" onclick="cancelSecurity()">‚ùå Annulla</button>
                </div>
                <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-info" onclick="showChangePasswordModal()">üîë Cambia Password</button>
                </div>
                <p style="margin-top: 15px; font-size: 12px; color: #666;">
                    Password attuale: <strong id="currentPasswordDisplay">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</strong>
                </p>
            </div>
        </div>

        <!-- Modal per Cambio Password -->
        <div id="changePasswordOverlay" class="security-overlay">
            <div class="security-modal">
                <h3>üîë Cambio Password</h3>
                <div class="security-warning">
                    <strong>‚ö†Ô∏è ATTENZIONE:</strong><br>
                    Inserisci la password attuale e poi la nuova password
                </div>
                <input type="password" id="currentPassword" placeholder="Password attuale..." style="margin-bottom: 10px;">
                <input type="password" id="newPassword" placeholder="Nuova password..." style="margin-bottom: 10px;">
                <input type="password" id="confirmPassword" placeholder="Conferma nuova password..." style="margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-primary" onclick="changePassword()">üîë Cambia Password</button>
                    <button class="btn btn-secondary" onclick="cancelChangePassword()">‚ùå Annulla</button>
                </div>
            </div>
        </div>

        <!-- Modal per Configurazione GitHub -->
        <div id="githubConfigOverlay" class="security-overlay">
            <div class="security-modal">
                <h3>‚öôÔ∏è Configurazione GitHub</h3>
                <div class="security-warning">
                    <strong>üì° SINCRONIZZAZIONE:</strong><br>
                    Configura GitHub per sincronizzare i dati tra dispositivi
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">GitHub Token:</label>
                    <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <small style="color: #666; font-size: 12px;">Token personale con permessi gist</small>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Gist ID:</label>
                    <input type="text" id="gistId" placeholder="xxxxxxxxxxxxxxxxxxxx" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <small style="color: #666; font-size: 12px;">ID del Gist (crea un nuovo Gist e copia l'ID)</small>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="githubEnabled" style="margin: 0;">
                        <span>Abilita sincronizzazione GitHub</span>
                    </label>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-primary" onclick="saveGitHubConfig()">üíæ Salva Configurazione</button>
                    <button class="btn btn-secondary" onclick="hideGitHubConfig()">‚ùå Annulla</button>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px;">
                    <strong>üìã Istruzioni:</strong><br>
                    1. Crea un token GitHub su Settings > Developer settings > Personal access tokens<br>
                    2. Crea un nuovo Gist su gist.github.com<br>
                    3. Inserisci token e Gist ID qui sopra<br>
                    4. I dati verranno sincronizzati automaticamente
                </div>
            </div>
        </div>

        <!-- Modal per Configurazione GitHub Obbligatoria all'Avvio -->
        <div id="githubSetupOverlay" class="security-overlay">
            <div class="security-modal">
                <h3>üîß Configurazione Iniziale GitHub</h3>
                <div class="security-warning">
                    <strong>üì° SINCRONIZZAZIONE CLOUD:</strong><br>
                    Inserisci il tuo token GitHub per abilitare la sincronizzazione tra dispositivi
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">GitHub Token:</label>
                    <input type="password" id="githubTokenSetup" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <small style="color: #666; font-size: 12px;">Token personale con permessi gist</small>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Gist ID (opzionale):</label>
                    <input type="text" id="gistIdSetup" placeholder="ed140f6366c097f54410d096017bb51b" value="ed140f6366c097f54410d096017bb51b" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <small style="color: #666; font-size: 12px;">ID del Gist (pre-compilato con il tuo Gist)</small>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-primary" onclick="saveGitHubSetup()">‚úÖ Configura e Continua</button>
                    <button class="btn btn-secondary" onclick="skipGitHubSetup()">‚è≠Ô∏è Salta Configurazione</button>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px;">
                    <strong>üí° Suggerimento:</strong><br>
                    Se non hai ancora un token, puoi saltare questa configurazione e inserirla dopo tramite il pulsante ‚öôÔ∏è GitHub
                </div>
            </div>
        </div>
        
        <div class="header">
            <h1>üç∑ Gestione Tommy</h1>
            <p>Privilege Caf√®&Wine - Sistema di Gestione Dati</p>
            <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">
                üíæ Dati salvati automaticamente nel browser
                <div id="syncStatus" style="margin-top: 5px; font-size: 0.8em;">
                    <span id="syncIndicator">üîÑ Sincronizzazione attiva</span>
                    <span id="deviceInfo" style="margin-left: 10px;">üì± Dispositivo: <span id="deviceIdDisplay"></span></span>
                </div>
            </div>
                                <div id="userInfo" style="margin-top: 10px; display: none;">
                        <span id="currentUserDisplay"></span>
                        <button class="btn btn-sm btn-secondary" onclick="logout()" style="margin-left: 10px;">üö™ Logout</button>
                        <button class="btn btn-sm btn-info" onclick="forceSync()" style="margin-left: 10px;" title="üîÑ Forza sincronizzazione">üîÑ Sync</button>
                        <button class="btn btn-sm btn-warning" onclick="showGitHubConfig()" style="margin-left: 10px;" title="‚öôÔ∏è Configura GitHub">‚öôÔ∏è GitHub</button>
                    </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab admin-only" onclick="showTab('dashboard', event)">üìä Dashboard</button>
            <button class="nav-tab admin-only" onclick="showTab('clienti', event)">üë• Clienti</button>
            <button class="nav-tab admin-only" onclick="showTab('fatture', event)">üìÑ Fatture</button>
            <button class="nav-tab guest-only" onclick="showTab('benvenuto', event)" style="display: none;">üè† Benvenuto</button>
            <button class="nav-tab" onclick="showTab('prodotti', event)">üç∫ Prodotti</button>
            <button class="nav-tab" onclick="showTab('vini', event)">üç∑ Vini</button>
        </div>

        <!-- TAB CLIENTI -->
        <div id="clienti" class="tab-content admin-only">
            <div class="form-section">
                <h3>üìù Inserimento Nuovo Cliente</h3>
                <form id="clienteForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nome Azienda</label>
                            <input type="text" name="nomeAzienda" placeholder="Nome dell'azienda (lasciare vuoto per privati)">
                        </div>
                        <div class="form-group">
                            <label>Tipologia *</label>
                            <select name="tipologia" required onchange="toggleNomeAzienda()">
                                <option value="">Seleziona tipologia...</option>
                                <option value="privato">Privato</option>
                                <option value="azienda">Azienda</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Nome Referente *</label>
                            <input type="text" name="nome" required>
                        </div>
                        <div class="form-group">
                            <label>Cognome Referente *</label>
                            <input type="text" name="cognome" required>
                        </div>
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" name="email" required>
                        </div>
                        <div class="form-group">
                            <label>Telefono *</label>
                            <input type="tel" name="telefono" required>
                        </div>
                        <div class="form-group">
                            <label>Indirizzo</label>
                            <input type="text" name="indirizzo">
                        </div>
                        <div class="form-group">
                            <label>Citt√†</label>
                            <input type="text" name="citta">
                        </div>
                        <div class="form-group">
                            <label>CAP</label>
                            <input type="text" name="cap">
                        </div>
                        <div class="form-group">
                            <label>Data Registrazione</label>
                            <input type="date" name="dataRegistrazione">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Note</label>
                        <textarea name="note" placeholder="Note aggiuntive sul cliente..."></textarea>
                    </div>
                    <div class="actions">
                        <button type="submit" class="btn btn-primary">‚ûï Aggiungi Cliente</button>
                        <button type="button" class="btn btn-success" onclick="exportToExcel('clienti')">üìä Esporta Excel</button>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('importClienti').click()">üì• Importa Excel</button>
                        <input type="file" id="importClienti" accept=".xlsx,.xls" style="display: none;" onchange="importFromExcel('clienti', this)">
                    </div>
                </form>
            </div>

            <div class="export-section">
                <h4>üìã Lista Clienti</h4>
                
                <!-- Tabella con scroll orizzontale -->
                <div class="table-scroll-container">
                    <table id="clientiTable" class="data-table scrollable-table" role="table" aria-label="Tabella dati clienti">
                        <thead>
                            <tr role="row">
                                <th role="columnheader">Nome Azienda</th>
                                <th role="columnheader">Tipologia</th>
                                <th role="columnheader">Nome Referente</th>
                                <th role="columnheader">Cognome Referente</th>
                                <th role="columnheader">Email</th>
                                <th role="columnheader">Telefono</th>
                                <th role="columnheader">Citt√†</th>
                                <th role="columnheader">Data Registrazione</th>
                                <th role="columnheader">Note</th>
                                <th role="columnheader">Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="clientiTableBody"></tbody>
                    </table>
                </div>
                

            </div>
        </div>

        <!-- TAB DASHBOARD -->
        <div id="dashboard" class="tab-content admin-only">
            <div class="dashboard-container">
                <div class="dashboard-header">
                    <h2>üéØ Dashboard Tommaso</h2>
                    <p>Monitora le performance del tuo business e rimani aggiornato sul mondo del vino</p>
                </div>
                
                <!-- Statistiche Rapide -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-content">
                            <h3 id="totalFatture">0</h3>
                            <p>Fatture Totali</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üíé</div>
                        <div class="stat-content">
                            <h3 id="totalRevenue">‚Ç¨0</h3>
                            <p>Fatturato Totale</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-content">
                            <h3 id="totalClienti">0</h3>
                            <p>Clienti Attivi</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üç∑</div>
                        <div class="stat-content">
                            <h3 id="totalVini">0</h3>
                            <p>Vini in Catalogo</p>
                        </div>
                    </div>
                </div>
                
                <!-- Filtri Temporali -->
                <div class="filters-section">
                    <h3>‚è∞ Filtri Temporali</h3>
                    <div class="filter-controls">
                        <button class="btn btn-sm btn-primary active" onclick="setTimeFilter('all', event)">Tutti</button>
                        <button class="btn btn-sm btn-outline" onclick="setTimeFilter('year', event)">Anno Corrente</button>
                        <button class="btn btn-sm btn-outline" onclick="setTimeFilter('month', event)">Mese Corrente</button>
                        <button class="btn btn-sm btn-outline" onclick="setTimeFilter('week', event)">Settimana</button>
                    </div>
                </div>

                <!-- Grafici -->
                <div class="charts-container">
                    <div class="chart-section">
                        <h3>üìà Andamento Fatture</h3>
                        <div class="chart-wrapper">
                            <canvas id="fattureChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-section">
                        <h3>üç∑ Distribuzione per Tipo</h3>
                        <div class="chart-wrapper">
                            <canvas id="tipoChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-section">
                        <h3>üí∞ Top Clienti per Fatturato</h3>
                        <div class="chart-wrapper">
                            <canvas id="clientiChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-section">
                        <h3>üìä Stato Pagamenti</h3>
                        <div class="chart-wrapper">
                            <canvas id="statoChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Widget di Sistema -->
                <div class="widgets-container">
                    <div class="widget-section">
                        <h3>‚öôÔ∏è Sistema e Performance</h3>
                        <div class="widget-grid">
                            <div class="widget-card">
                                <div class="widget-icon">üíæ</div>
                                <div class="widget-content">
                                    <h4>Storage</h4>
                                    <p id="storageInfo">Calcolando...</p>
                                </div>
                            </div>
                            <div class="widget-card">
                                <div class="widget-icon">üîÑ</div>
                                <div class="widget-content">
                                    <h4>Ultimo Sync</h4>
                                    <p id="lastSyncInfo">Calcolando...</p>
                                </div>
                            </div>
                            <div class="widget-card">
                                <div class="widget-icon">üìä</div>
                                <div class="widget-content">
                                    <h4>Integrit√† Dati</h4>
                                    <p id="integrityInfo">Verificando...</p>
                                </div>
                            </div>
                            <div class="widget-card">
                                <div class="widget-icon">üö®</div>
                                <div class="widget-content">
                                    <h4>Alert</h4>
                                    <p id="alertInfo">Nessun problema</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notizie Vino -->
                <div class="news-section">
                    <h3>üç∑ Ultime Notizie dal Mondo del Vino</h3>
                    <div class="news-controls">
                        <button class="btn btn-sm btn-primary" onclick="refreshNews()">üîÑ Aggiorna</button>
                        <button class="btn btn-sm btn-outline" onclick="toggleNewsSource()">üì∞ Cambia Fonte</button>
                        <span class="news-source-indicator" id="newsSourceIndicator">
                            Fonte: <span id="currentSource">NewsAPI</span>
                        </span>
                    </div>
                    <div class="news-container" id="newsContainer">
                        <div class="loading-news">üîÑ Caricamento notizie...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB FATTURE -->
        <div id="fatture" class="tab-content admin-only">
            <div class="form-section">
                <h3>üìÑ Gestione Documenti</h3>
                <div class="actions">
                    <button type="button" class="btn btn-primary" onclick="showFatturaModal()">üìÑ Nuova Fattura</button>
                    <button type="button" class="btn btn-warning" onclick="showProformaModal()">üìã Nuova Proforma</button>
                    <button type="button" class="btn btn-info" onclick="showDDTModal()">üöö Nuovo DDT</button>
                    <button type="button" class="btn btn-success" onclick="exportToExcel('fatture')">üìä Esporta Excel</button>
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('importFatture').click()">üì• Importa Excel</button>
                    <button type="button" class="btn btn-info" onclick="checkAndUpdateStatoFatture()" title="Verifica e aggiorna stati fatture">üîÑ Verifica Stati</button>
                    <button type="button" class="btn btn-outline" onclick="toggleStatoFatture()" id="toggleStatoBtn" title="Abilita/Disabilita modifica stati">üîß Gestione Stati</button>
                    <input type="file" id="importFatture" accept=".xlsx,.xls" style="display: none;" onchange="importFromExcel('fatture', this)">
                </div>
            </div>

            <div class="export-section">
                <h4>üìã Lista Documenti</h4>
                
                <!-- Tabella con scroll orizzontale -->
                <div class="table-scroll-container">
                    <table id="fattureTable" class="data-table scrollable-table" role="table" aria-label="Tabella dati fatture">
                        <thead>
                            <tr role="row">
                                <th role="columnheader">Tipo</th>
                                <th role="columnheader">Numero</th>
                                <th role="columnheader">Cliente</th>
                                <th role="columnheader">Data</th>
                                <th role="columnheader">Scadenza</th>
                                <th role="columnheader">Subtotale</th>
                                <th role="columnheader">Sconto Extra</th>
                                <th role="columnheader">Totale</th>
                                <th role="columnheader">Stato</th>
                                <th role="columnheader">Note</th>
                                <th role="columnheader">Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="fattureTableBody"></tbody>
                    </table>
                </div>
                

            </div>
        </div>

        <!-- TAB PRODOTTI -->
        <div id="prodotti" class="tab-content">
            <div class="form-section">
                <h3>üç∫ Inserimento Nuovo Prodotto</h3>
                <form id="prodottoForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nome Prodotto *</label>
                            <input type="text" name="nome" required>
                        </div>
                        <div class="form-group">
                            <label>Categoria Principale *</label>
                            <select name="categoriaPrincipale" id="categoriaPrincipale" required onchange="updateSottocategorie()">
                                <option value="">Seleziona categoria...</option>
                                <option value="distillati">Distillati</option>
                                <option value="liquori">Liquori</option>
                                <option value="vini">Vini</option>
                                <option value="birre">Birre</option>
                                <option value="altro">Altro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Sottocategoria *</label>
                            <select name="sottocategoria" id="sottocategoria" required>
                                <option value="">Prima seleziona una categoria...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Marca</label>
                            <input type="text" name="marca">
                        </div>
                        <div class="form-group">
                            <label>Prezzo Acquisto (‚Ç¨) <span id="securityLabelProdotti" style="color: #dc3545; font-size: 12px;">üîí</span></label>
                            <input type="number" name="prezzoAcquisto" step="0.01" id="prezzoAcquistoProdottiInput">
                        </div>
                        <div class="form-group">
                            <label>Prezzo Vendita Ingrosso (‚Ç¨) *</label>
                            <input type="number" name="prezzoVenditaIngrosso" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Prezzo Vendita al Dettaglio (‚Ç¨) *</label>
                            <input type="number" name="prezzoVenditaDettaglio" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Quantit√† in Stock *</label>
                            <input type="number" name="quantita" required>
                        </div>
                        <div class="form-group">
                            <label>Quantit√† Minima</label>
                            <input type="number" name="quantitaMinima" value="5">
                        </div>
                        <div class="form-group">
                            <label>Fornitore</label>
                            <input type="text" name="fornitore">
                        </div>
                        <div class="form-group">
                            <label>Codice Prodotto</label>
                            <input type="text" name="codiceProdotto">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Note</label>
                        <textarea name="note" placeholder="Note sul prodotto..."></textarea>
                    </div>
                    <div class="actions">
                        <button type="submit" class="btn btn-primary">‚ûï Aggiungi Prodotto</button>
                        <button type="button" class="btn btn-success" onclick="exportToExcel('prodotti', 'dettaglio')">üìä Esporta Excel Dettaglio</button>
                        <button type="button" class="btn btn-warning" onclick="exportToExcel('prodotti', 'ingrosso')">üìä Esporta Excel Ingrosso</button>
                        <button type="button" class="btn btn-info" onclick="exportToExcel('prodotti', 'completo')">üìä Esporta Excel Completo</button>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('importProdotti').click()">üì• Importa Excel</button>
                        <input type="file" id="importProdotti" accept=".xlsx,.xls" style="display: none;" onchange="importFromExcel('prodotti', this)">
                    </div>
                </form>
            </div>

            <div class="export-section">
                <h4>üìã Lista Prodotti</h4>
                
                <!-- Sistema di Filtri -->
                <div class="filters-section" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h5 style="margin-bottom: 15px; color: #333;">üîç Filtri di Ricerca</h5>
                    <div class="filters-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Nome Prodotto</label>
                            <input type="text" id="filterNomeProdotti" placeholder="Cerca per nome..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Categoria Principale</label>
                            <select id="filterCategoriaPrincipale" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Tutte le categorie</option>
                                <option value="distillati">Distillati</option>
                                <option value="liquori">Liquori</option>
                                <option value="vini">Vini</option>
                                <option value="birre">Birre</option>
                                <option value="altro">Altro</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Marca</label>
                            <input type="text" id="filterMarca" placeholder="Cerca per marca..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Fornitore</label>
                            <input type="text" id="filterFornitore" placeholder="Cerca per fornitore..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Stato Stock</label>
                            <select id="filterStockProdotti" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Tutti</option>
                                <option value="ok">OK</option>
                                <option value="basso">Scorte Basse</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Prezzo</label>
                            <select id="filterPrezzo" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Tutti i prezzi</option>
                                <option value="basso">Prezzo basso (< ‚Ç¨10)</option>
                                <option value="medio">Prezzo medio (‚Ç¨10-‚Ç¨30)</option>
                                <option value="alto">Prezzo alto (> ‚Ç¨30)</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-actions" style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button type="button" class="btn btn-primary" onclick="applyProdottiFilters()">üîç Applica Filtri</button>
                        <button type="button" class="btn btn-secondary" onclick="clearProdottiFilters()">üóëÔ∏è Cancella Filtri</button>
                        <span id="filterResultsProdotti" style="margin-left: 10px; font-weight: 600; color: #666;"></span>
                    </div>
                </div>
                
                
                <!-- Tabella con scroll orizzontale -->
                <div class="table-scroll-container">
                    <table id="prodottiTable" class="data-table scrollable-table" role="table" aria-label="Tabella dati prodotti">
                        <thead>
                            <tr role="row">
                                <th role="columnheader">Nome</th>
                                <th role="columnheader">Categoria</th>
                                <th role="columnheader">Marca</th>
                                <th id="prezzoAcquistoHeaderProdotti" style="display: none;" role="columnheader">Prezzo Acquisto</th>
                                <th role="columnheader">Prezzo Ingrosso</th>
                                <th role="columnheader">Prezzo Dettaglio</th>
                                <th role="columnheader">Quantit√†</th>
                                <th role="columnheader">Stato Stock</th>
                                <th role="columnheader">Fornitore</th>
                                <th role="columnheader">Note</th>
                                <th role="columnheader">Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="prodottiTableBody"></tbody>
                    </table>
                </div>
                

            </div>
        </div>

        <!-- TAB BENVENUTO (Solo per ospiti) -->
        <div id="benvenuto" class="tab-content guest-only" style="display: none;">
            <div class="modern-welcome-section">
                <!-- Hero Section con Gradiente Animato -->
                <div class="hero-section">
                    <div class="hero-background">
                        <div class="gradient-overlay"></div>
                        <div class="floating-elements">
                            <div class="floating-icon">üç∑</div>
                            <div class="floating-icon">üç∫</div>
                            <div class="floating-icon">ü•É</div>
                            <div class="floating-icon">üçæ</div>
                        </div>
                    </div>
                    <div class="hero-content">
                        <div class="welcome-badge">
                            <span class="badge-icon">üëã</span>
                            <span class="badge-text">Modalit√† Ospite</span>
                        </div>
                        <h1 class="hero-title">Benvenuto in <span class="highlight">Gestione Tommy</span></h1>
                        <p class="hero-subtitle">Privilege Caf√®&Wine - Il tuo catalogo digitale</p>
                        <div class="hero-stats">
                            <div class="stat-card">
                                <div class="stat-icon">üç∫</div>
                                <div class="stat-info">
                                    <span class="stat-number" id="prodottiCount">0</span>
                                    <span class="stat-label">Prodotti</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">üç∑</div>
                                <div class="stat-info">
                                    <span class="stat-number" id="viniCount">0</span>
                                    <span class="stat-label">Vini</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">üìä</div>
                                <div class="stat-info">
                                    <span class="stat-number" id="categorieCount">0</span>
                                    <span class="stat-label">Categorie</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sezione Azioni Principali -->
                <div class="actions-section">
                    <div class="section-header">
                        <h2>üöÄ Esplora i Cataloghi</h2>
                        <p>Scegli cosa vuoi visualizzare</p>
                    </div>
                    
                    <div class="action-cards">
                        <div class="action-card primary" onclick="navigateToSection('prodotti')">
                            <div class="card-glow"></div>
                            <div class="card-content">
                                <div class="card-icon">
                                    <span class="icon-emoji">üç∫</span>
                                    <div class="icon-background"></div>
                                </div>
                                <div class="card-info">
                                    <h3>Catalogo Prodotti</h3>
                                    <p>Distillati, liquori, birre e molto altro</p>
                                    <div class="card-stats">
                                        <div class="stat">
                                            <span class="stat-value" id="prodottiTotal">0</span>
                                            <span class="stat-label">Prodotti</span>
                                        </div>
                                        <div class="stat">
                                            <span class="stat-value" id="categorieTotal">0</span>
                                            <span class="stat-label">Categorie</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-action">
                                    <button class="modern-btn">
                                        <span>Esplora</span>
                                        <svg class="arrow-icon" viewBox="0 0 24 24">
                                            <path d="M7 17l9.2-9.2M17 17V7H7"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="action-card secondary" onclick="navigateToSection('vini')">
                            <div class="card-glow"></div>
                            <div class="card-content">
                                <div class="card-icon">
                                    <span class="icon-emoji">üç∑</span>
                                    <div class="icon-background"></div>
                                </div>
                                <div class="card-info">
                                    <h3>Selezione Vini</h3>
                                    <p>Vini italiani e internazionali di qualit√†</p>
                                    <div class="card-stats">
                                        <div class="stat">
                                            <span class="stat-value" id="viniTotal">0</span>
                                            <span class="stat-label">Vini</span>
                                        </div>
                                        <div class="stat">
                                            <span class="stat-value" id="tipologieTotal">0</span>
                                            <span class="stat-label">Tipologie</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-action">
                                    <button class="modern-btn">
                                        <span>Esplora</span>
                                        <svg class="arrow-icon" viewBox="0 0 24 24">
                                            <path d="M7 17l9.2-9.2M17 17V7H7"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sezione Azioni Rapide -->
                <div class="quick-actions-section">
                    <div class="section-header">
                        <h2>‚ö° Azioni Rapide</h2>
                        <p>Accedi velocemente alle funzioni pi√π utilizzate</p>
                    </div>
                    
                    <div class="quick-actions-grid">
                        <div class="quick-action-card" onclick="exportToExcel('prodotti')">
                            <div class="action-icon">üìä</div>
                            <div class="action-content">
                                <h4>Esporta Prodotti</h4>
                                <p>Scarica il catalogo completo</p>
                            </div>
                            <div class="action-arrow">‚Üí</div>
                        </div>

                        <div class="quick-action-card" onclick="exportToExcel('vini')">
                            <div class="action-icon">üìä</div>
                            <div class="action-content">
                                <h4>Esporta Vini</h4>
                                <p>Scarica la lista vini</p>
                            </div>
                            <div class="action-arrow">‚Üí</div>
                        </div>

                        <div class="quick-action-card" onclick="printWineList()">
                            <div class="action-icon">üñ®Ô∏è</div>
                            <div class="action-content">
                                <h4>Stampa Listino</h4>
                                <p>Genera listino vini</p>
                            </div>
                            <div class="action-arrow">‚Üí</div>
                        </div>

                        <div class="quick-action-card" onclick="showNotification('üîç Funzione di ricerca avanzata disponibile nelle sezioni Prodotti e Vini', 'info')">
                            <div class="action-icon">üîç</div>
                            <div class="action-content">
                                <h4>Ricerca Avanzata</h4>
                                <p>Filtra e cerca prodotti</p>
                            </div>
                            <div class="action-arrow">‚Üí</div>
                        </div>
                    </div>
                </div>

                <!-- Sezione Informazioni -->
                <div class="info-section">
                    <div class="info-card">
                        <div class="info-icon">üí°</div>
                        <div class="info-content">
                            <h4>Modalit√† Ospite</h4>
                            <p>In questa modalit√† puoi visualizzare e consultare i cataloghi. Per modificare i dati o accedere alle funzioni complete, contatta l'amministratore del sistema.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB VINI -->
        <div id="vini" class="tab-content">
            <div class="form-section">
                <h3>üç∑ Inserimento Nuovo Vino</h3>
                <form id="vinoForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nome Vino *</label>
                            <input type="text" name="nome" required>
                        </div>
                        <div class="form-group">
                            <label>Produttore *</label>
                            <input type="text" name="produttore" required>
                        </div>
                        <div class="form-group">
                            <label>Annata *</label>
                            <input type="number" name="annata" min="1900" max="2030" required>
                        </div>
                        <div class="form-group">
                            <label>Tipologia Vino *</label>
                            <select name="tipologia" required>
                                <option value="">Seleziona tipologia...</option>
                                <option value="rosso">Rosso</option>
                                <option value="bianco">Bianco</option>
                                <option value="rosato">Rosato</option>
                                <option value="spumante">Spumante</option>
                                <option value="frizzante">Vino Frizzante</option>
                                <option value="dolce">Vino Dolce</option>
                                <option value="franciacorta">Franciacorta</option>
                                <option value="metodo-classico">Metodo Classico</option>
                                <option value="prosecco">Prosecco</option>
                                <option value="champagne">Champagne</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Regione</label>
                            <input type="text" name="regione">
                        </div>
                        <div class="form-group">
                            <label>Vitigno</label>
                            <input type="text" name="vitigno" placeholder="es. Sangiovese, Nebbiolo, Chardonnay...">
                        </div>
                        <div class="form-group">
                            <label>Prezzo Acquisto (‚Ç¨) <span id="securityLabelVini" style="color: #dc3545; font-size: 12px;">üîí</span></label>
                            <input type="number" name="prezzoAcquisto" step="0.01" id="prezzoAcquistoViniInput">
                        </div>
                        <div class="form-group">
                            <label>Prezzo Vendita Ingrosso (‚Ç¨) *</label>
                            <input type="number" name="prezzoVenditaIngrosso" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Prezzo Vendita al Dettaglio (‚Ç¨) *</label>
                            <input type="number" name="prezzoVenditaDettaglio" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Quantit√† *</label>
                            <input type="number" name="quantita" required>
                        </div>
                        <div class="form-group">
                            <label>Unit√† di Misura</label>
                            <input type="text" name="unitaMisura" placeholder="es. bottiglie, cassette, litri...">
                        </div>
                        <div class="form-group">
                            <label>Fornitore</label>
                            <input type="text" name="fornitore">
                        </div>
                        <div class="form-group">
                            <label>Codice Prodotto</label>
                            <input type="text" name="codiceProdotto">
                        </div>

                    </div>
                    <div class="form-group">
                        <label>Descrizione</label>
                        <textarea name="descrizione" placeholder="Descrizione del vino..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Note</label>
                        <textarea name="note" placeholder="Note aggiuntive..."></textarea>
                    </div>
                    <div class="actions">
                        <button type="submit" class="btn btn-primary">‚ûï Aggiungi Vino</button>
                        <button type="button" class="btn btn-success" onclick="exportToExcel('vini', 'dettaglio')">üìä Esporta Excel Dettaglio</button>
                        <button type="button" class="btn btn-warning" onclick="exportToExcel('vini', 'ingrosso')">üìä Esporta Excel Ingrosso</button>
                        <button type="button" class="btn btn-info" onclick="exportToExcel('vini', 'completo')">üìä Esporta Excel Completo</button>
                        <button type="button" class="btn btn-primary" onclick="printWineList()">üñ®Ô∏è Stampa Listino</button>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('importVini').click()">üì• Importa Excel</button>
                        <input type="file" id="importVini" accept=".xlsx,.xls" style="display: none;" onchange="importFromExcel('vini', this)">
                    </div>
                </form>
            </div>

            <div class="export-section">
                <h4>üìã Lista Vini</h4>
                
                <!-- Sistema di Filtri -->
                <div class="filters-section" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h5 style="margin-bottom: 15px; color: #333;">üîç Filtri di Ricerca</h5>
                    <div class="filters-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Nome Vino</label>
                            <input type="text" id="filterNome" placeholder="Cerca per nome..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Produttore</label>
                            <input type="text" id="filterProduttore" placeholder="Cerca per produttore..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Tipologia</label>
                            <select id="filterTipologia" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Tutte le tipologie</option>
                                <option value="rosso">Rosso</option>
                                <option value="bianco">Bianco</option>
                                <option value="rosato">Rosato</option>
                                <option value="spumante">Spumante</option>
                                <option value="frizzante">Vino Frizzante</option>
                                <option value="dolce">Vino Dolce</option>
                                <option value="franciacorta">Franciacorta</option>
                                <option value="metodo-classico">Metodo Classico</option>
                                <option value="prosecco">Prosecco</option>
                                <option value="champagne">Champagne</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Regione</label>
                            <input type="text" id="filterRegione" placeholder="Cerca per regione..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Vitigno</label>
                            <input type="text" id="filterVitigno" placeholder="Cerca per vitigno..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Stato Stock</label>
                            <select id="filterStock" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Tutti</option>
                                <option value="ok">OK</option>
                                <option value="basso">Scorte Basse</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-actions" style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button type="button" class="btn btn-primary" onclick="applyViniFilters()">üîç Applica Filtri</button>
                        <button type="button" class="btn btn-secondary" onclick="clearViniFilters()">üóëÔ∏è Cancella Filtri</button>
                        <span id="filterResults" style="margin-left: 10px; font-weight: 600; color: #666;"></span>
                    </div>
                </div>
                
                
                <!-- Tabella con scroll orizzontale -->
                <div class="table-scroll-container">
                    <table id="viniTable" class="data-table scrollable-table" role="table" aria-label="Tabella dati vini">
                        <thead>
                            <tr role="row">
                                <th role="columnheader">Nome</th>
                                <th role="columnheader">Produttore</th>
                                <th role="columnheader">Annata</th>
                                <th role="columnheader">Tipologia</th>
                                <th role="columnheader">Regione</th>
                                <th role="columnheader">Vitigno</th>
                                <th id="prezzoAcquistoHeaderVini" style="display: none;" role="columnheader">Prezzo Acquisto</th>
                                <th role="columnheader">Prezzo Ingrosso</th>
                                <th role="columnheader">Prezzo Dettaglio</th>
                                <th role="columnheader">Quantit√†</th>
                                <th role="columnheader">Unit√†</th>
                                <th role="columnheader">Stato Stock</th>
                                <th role="columnheader">Note</th>
                                <th role="columnheader">Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="viniTableBody"></tbody>
                    </table>
                </div>
                

            </div>
        </div>
    </div>

    <!-- Modal Fattura -->
    <div id="fatturaModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìÑ Nuova Fattura</h3>
                <button class="modal-close" onclick="hideFatturaModal()">&times;</button>
            </div>
            <form id="fatturaFormModal">
                <div class="modal-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Tipo Documento *</label>
                            <select name="tipoDocumento" required>
                                <option value="fattura">Fattura</option>
                                <option value="proforma">Proforma</option>
                                <option value="ddt">DDT</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Numero Documento *</label>
                            <input type="text" name="numero" required>
                        </div>
                        <div class="form-group">
                            <label>Cliente *</label>
                            <select name="cliente" required>
                                <option value="">Seleziona cliente...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Data Documento *</label>
                            <input type="date" name="data" required>
                        </div>
                        <div class="form-group">
                            <label>Data Scadenza</label>
                            <input type="date" name="scadenza">
                        </div>
                        <div class="form-group">
                            <label>Sconto Extra (‚Ç¨)</label>
                            <input type="number" name="scontoExtra" step="0.01" value="0" onchange="calcolaTotali()" placeholder="0.00">
                        </div>
                    </div>
                    
                    <div class="prodotti-section">
                        <h4>üõí Prodotti/Servizi (Prezzi IVA Inclusa)</h4>
                        <div class="prodotti-controls">
                            <button type="button" class="btn btn-sm btn-primary" onclick="aggiungiRigaProdotto()">‚ûï Aggiungi Prodotto</button>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="selezionaDaCatalogo()">üìã Seleziona da Catalogo</button>
                        </div>
                        
                        <!-- Tabella di inserimento prodotti -->
                        <div class="prodotti-table-container">
                            <table id="prodottiTable" class="prodotti-table">
                                <thead>
                                    <tr>
                                        <th>Prodotto/Servizio</th>
                                        <th>Quantit√†</th>
                                        <th>Prezzo Unitario (IVA Inclusa)</th>
                                        <th>Tipo Sconto</th>
                                        <th>Valore Sconto</th>
                                        <th>Subtotale Riga</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="prodottiTableBody"></tbody>
                            </table>
                        </div>
                        
                        <!-- Tabella di anteprima prodotti -->
                        <div class="anteprima-section">
                            <h5>üìã Anteprima Prodotti Aggiunti</h5>
                            <div class="anteprima-table-container">
                                <table id="anteprimaTable" class="anteprima-table">
                                    <thead>
                                        <tr>
                                            <th>Prodotto</th>
                                            <th>Q.t√†</th>
                                            <th>Prezzo Unit.</th>
                                            <th>Sconto</th>
                                            <th>Subtotale</th>
                                            <th>Azioni</th>
                                        </tr>
                                    </thead>
                                    <tbody id="anteprimaTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="totali-section">
                        <div class="totali-grid">
                            <div class="form-group">
                                <label>Subtotale</label>
                                <input type="number" name="subtotale" step="0.01" readonly>
                            </div>
                            <div class="form-group">
                                <label>Sconto Extra</label>
                                <input type="number" name="scontoExtraDisplay" step="0.01" readonly>
                            </div>
                            <div class="form-group">
                                <label>Totale</label>
                                <input type="number" name="totale" step="0.01" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Note</label>
                        <textarea name="note" placeholder="Note sul documento..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">üíæ Salva Documento</button>
                    <button type="button" class="btn btn-success" onclick="stampaDocumento()">üñ®Ô∏è Stampa</button>
                    <button type="button" class="btn btn-secondary" onclick="hideFatturaModal()">‚ùå Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Selezione Catalogo -->
    <div id="catalogoModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìã Selezione da Catalogo</h3>
                <button class="modal-close" onclick="hideCatalogoModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="catalogo-tabs">
                    <button class="catalogo-tab active" onclick="showCatalogoTab('prodotti')">üç∫ Prodotti</button>
                    <button class="catalogo-tab" onclick="showCatalogoTab('vini')">üç∑ Vini</button>
                </div>
                <div class="catalogo-content">
                    <div id="catalogoProdotti" class="catalogo-tab-content active">
                        <table class="catalogo-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Categoria</th>
                                    <th>Prezzo Ingrosso</th>
                                    <th>Prezzo Dettaglio</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="catalogoProdottiBody"></tbody>
                        </table>
                    </div>
                    <div id="catalogoVini" class="catalogo-tab-content">
                        <table class="catalogo-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Produttore</th>
                                    <th>Prezzo Ingrosso</th>
                                    <th>Prezzo Dettaglio</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="catalogoViniBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Dati in memoria
        let clienti = [];
        let documenti = [];
        let prodotti = [];
        let vini = [];
        
        // Stato dell'applicazione
        let isLoading = false;
        let currentFilters = {};
        
        // Sistema di sicurezza e accesso
        let isSecurityActive = true; // Di default attiva la censura
        let isSecurityUnlocked = false; // Se la password √® stata inserita correttamente
        let SECURITY_PASSWORD = 'Tommy123'; // Password predefinita
        let currentUser = null; // 'admin' o 'guest'
        let isLoggedIn = false; // Se l'utente √® loggato
        
        // Sistema di sincronizzazione
        let lastSyncTime = 0;
        let syncInterval = null;
        let deviceId = generateDeviceId();
        let isOnline = navigator.onLine;
        
        // Configurazione GitHub
        const GITHUB_CONFIG = {
            token: localStorage.getItem('tommy_github_token') || '',
            gistId: localStorage.getItem('tommy_gist_id') || '',
            enabled: localStorage.getItem('tommy_github_enabled') === 'true'
        };
        
        // Contatore errori GitHub per auto-disabilitazione
        let githubErrorCount = 0;
        const MAX_GITHUB_ERRORS = 3;
        
        // Funzione per disabilitare GitHub sync se ci sono errori persistenti
        function disableGitHubSync() {
            GITHUB_CONFIG.enabled = false;
            localStorage.setItem('tommy_github_enabled', 'false');
            console.log('GitHub sync disabilitato automaticamente');
            showNotification('‚ö†Ô∏è GitHub sync disabilitato per evitare errori', 'warning');
        }
        
        // Funzione per gestire errori GitHub persistenti
        function handleGitHubError() {
            githubErrorCount++;
            if (githubErrorCount >= MAX_GITHUB_ERRORS) {
                disableGitHubSync();
                githubErrorCount = 0; // Reset counter
            }
        }
        
        // Genera ID univoco per il dispositivo
        function generateDeviceId() {
            let deviceId = localStorage.getItem('tommy_device_id');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('tommy_device_id', deviceId);
            }
            return deviceId;
        }

        // Utility functions
        function showLoading(show = true) {
            isLoading = show;
            const loadingEl = document.getElementById('loadingIndicator');
            if (loadingEl) {
                loadingEl.style.display = show ? 'block' : 'none';
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">√ó</button>
            `;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#ffc107'};
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                display: flex;
                align-items: center;
                gap: 10px;
                max-width: 300px;
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }

        // Ottimizzazione: Gestione errori centralizzata
        function handleError(error, context = '') {
            const errorMessage = `Errore ${context ? `in ${context}` : ''}: ${error.message}`;
            console.error(errorMessage, error);
            showNotification(errorMessage, 'error');
            
            // Log per debugging in produzione
            if (window.location.hostname !== 'localhost') {
                // In produzione, invia errori a un servizio di logging
                logErrorToService(error, context);
            }
        }

        // Ottimizzazione: Logging strutturato
        function logErrorToService(error, context) {
            try {
                const errorData = {
                    message: error.message,
                    stack: error.stack,
                    context: context,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    url: window.location.href
                };
                
                // In futuro, invia a servizio di logging
                console.log('Error logged:', errorData);
            } catch (e) {
                console.error('Failed to log error:', e);
            }
        }

        // Debounce function per performance
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Ottimizzazione: Cleanup timer per evitare memory leaks
        function cleanupTimers() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
        }

        // Ottimizzazione: Cache per dati frequentemente accessibili
        const dataCache = new Map();
        
        function getCachedData(key, generator) {
            if (!dataCache.has(key)) {
                dataCache.set(key, generator());
            }
            return dataCache.get(key);
        }
        
        function clearCache() {
            dataCache.clear();
        }

        // Ottimizzazione: Throttling per operazioni costose
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }

        // Ottimizzazione: Memoization per calcoli costosi
        const memoCache = new Map();
        
        function memoize(func, keyGenerator) {
            return function(...args) {
                const key = keyGenerator ? keyGenerator(...args) : JSON.stringify(args);
                if (!memoCache.has(key)) {
                    memoCache.set(key, func.apply(this, args));
                }
                return memoCache.get(key);
            }
        }

        // Ottimizzazione: Lazy loading per tabelle grandi
        function lazyLoadTableData(tableType, startIndex = 0, batchSize = 50) {
            const data = getTableData(tableType);
            const endIndex = Math.min(startIndex + batchSize, data.length);
            return data.slice(startIndex, endIndex);
        }

        function getTableData(tableType) {
            switch(tableType) {
                case 'clienti': return clienti;
                case 'fatture': return documenti;
                case 'prodotti': return prodotti;
                case 'vini': return vini;
                default: return [];
            }
        }

        // Ottimizzazione: Virtualizzazione tabelle per grandi dataset
        class VirtualTable {
            constructor(container, data, rowHeight = 40, visibleRows = 20) {
                this.container = container;
                this.data = data;
                this.rowHeight = rowHeight;
                this.visibleRows = visibleRows;
                this.scrollTop = 0;
                this.startIndex = 0;
                this.endIndex = visibleRows;
                
                this.init();
            }
            
            init() {
                this.container.style.position = 'relative';
                this.container.style.height = `${this.data.length * this.rowHeight}px`;
                this.container.style.overflow = 'auto';
                
                this.container.addEventListener('scroll', this.handleScroll.bind(this));
                this.render();
            }
            
            handleScroll() {
                this.scrollTop = this.container.scrollTop;
                this.startIndex = Math.floor(this.scrollTop / this.rowHeight);
                this.endIndex = Math.min(this.startIndex + this.visibleRows, this.data.length);
                this.render();
            }
            
            render() {
                const fragment = document.createDocumentFragment();
                
                for (let i = this.startIndex; i < this.endIndex; i++) {
                    const row = this.createRow(this.data[i], i);
                    row.style.position = 'absolute';
                    row.style.top = `${i * this.rowHeight}px`;
                    row.style.width = '100%';
                    fragment.appendChild(row);
                }
                
                this.container.innerHTML = '';
                this.container.appendChild(fragment);
            }
            
            createRow(item, index) {
                // Implementazione specifica per tipo di tabella
                const row = document.createElement('div');
                row.className = 'virtual-row';
                row.textContent = `Row ${index}: ${JSON.stringify(item)}`;
                return row;
            }
        }

        // Ottimizzazione: Gestione DOM efficiente
        function createElement(tag, className, innerHTML) {
            const element = document.createElement(tag);
            if (className) element.className = className;
            if (innerHTML) element.innerHTML = innerHTML;
            return element;
        }

        // Ottimizzazione: Batch DOM updates
        function batchDOMUpdates(updates) {
            const fragment = document.createDocumentFragment();
            updates.forEach(update => {
                fragment.appendChild(update);
            });
            return fragment;
        }

        // Carica dati dal localStorage all'avvio con sincronizzazione robusta
        async function loadDataFromStorage() {
            try {
                showLoading(true);
                console.log('üîÑ Avvio caricamento dati...');
                
                // Carica dati locali con validazione
                const savedClienti = localStorage.getItem('tommy_clienti');
                const savedDocumenti = localStorage.getItem('tommy_documenti');
                const savedProdotti = localStorage.getItem('tommy_prodotti');
                const savedVini = localStorage.getItem('tommy_vini');
                
                // Validazione e caricamento dati
                if (savedClienti) {
                    try {
                        clienti = JSON.parse(savedClienti);
                        console.log(`‚úÖ Clienti caricati: ${clienti.length} record`);
                    } catch (e) {
                        console.error('‚ùå Errore parsing clienti:', e);
                        clienti = [];
                    }
                }
                
                if (savedDocumenti) {
                    try {
                        documenti = JSON.parse(savedDocumenti);
                        console.log(`‚úÖ Documenti caricati: ${documenti.length} record`);
                    } catch (e) {
                        console.error('‚ùå Errore parsing documenti:', e);
                        documenti = [];
                    }
                }
                
                if (savedProdotti) {
                    try {
                        prodotti = JSON.parse(savedProdotti);
                        console.log(`‚úÖ Prodotti caricati: ${prodotti.length} record`);
                    } catch (e) {
                        console.error('‚ùå Errore parsing prodotti:', e);
                        prodotti = [];
                    }
                }
                
                if (savedVini) {
                    try {
                        vini = JSON.parse(savedVini);
                        console.log(`‚úÖ Vini caricati: ${vini.length} record`);
                    } catch (e) {
                        console.error('‚ùå Errore parsing vini:', e);
                        vini = [];
                    }
                }
                
                // Sync forzato all'avvio
                console.log('üîÑ Avvio sincronizzazione forzata...');
                await forceSyncOnStartup();
                
                // Aggiorna le tabelle
                updateAllTables();
                
                // Aggiorna statistiche scheda benvenuto
                updateWelcomeStats();
                
                showNotification('‚úÖ Dati caricati e sincronizzati con successo!', 'success');
                
                // Avvia il sistema di sincronizzazione
                startSyncSystem();
                
                        // Imposta il salvataggio automatico alla chiusura
        setupAutoSaveOnClose();
        
        // Ottimizzazione: Cleanup all'avvio
        cleanupTimers();
        clearCache();
        memoCache.clear();
        
        // Ottimizzazione: Event listeners centralizzati
        addEventListeners();
                
            } catch (error) {
                console.error('‚ùå Errore nel caricamento dati:', error);
                showNotification('‚ùå Errore nel caricamento dei dati salvati', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Sync forzato all'avvio con controllo completo
        async function forceSyncOnStartup() {
            try {
                console.log('üîÑ Controllo aggiornamenti cloud...');
                
                // Prima controlla GitHub Gist se configurato
                if (GITHUB_CONFIG.enabled && GITHUB_CONFIG.token && GITHUB_CONFIG.gistId) {
                    console.log('üì° Controllo GitHub Gist...');
                    const githubData = await loadFromGitHubGist();
                    if (githubData) {
                        const localTimestamp = localStorage.getItem('tommy_last_sync');
                        const githubTime = githubData.lastModified;
                        const localTime = parseInt(localTimestamp) || 0;
                        
                        console.log(`üìä Timestamp locale: ${localTime}, GitHub: ${githubTime}`);
                        
                        if (githubTime > localTime && githubData.deviceId !== deviceId) {
                            console.log('‚úÖ Aggiornamento dati da GitHub...');
                            
                            // Aggiorna i dati locali con quelli di GitHub
                            clienti = githubData.clienti || clienti;
                            documenti = githubData.documenti || documenti;
                            prodotti = githubData.prodotti || prodotti;
                            vini = githubData.vini || vini;
                            
                            // Salva i dati aggiornati localmente
                            saveAllDataToLocalStorage();
                            localStorage.setItem('tommy_last_sync', githubTime.toString());
                            
                            console.log('‚úÖ Sincronizzazione GitHub completata');
                            showNotification('üì° Dati sincronizzati da GitHub!', 'success');
                            return true;
                        } else {
                            console.log('‚ÑπÔ∏è Nessun aggiornamento necessario da GitHub');
                        }
                    }
                }
                
                // Fallback: controlla localStorage cloud
                console.log('üì° Controllo localStorage cloud...');
                const cloudData = localStorage.getItem('tommy_cloud_data');
                const cloudTimestamp = localStorage.getItem('tommy_cloud_timestamp');
                const localTimestamp = localStorage.getItem('tommy_last_sync');
                
                if (cloudData && cloudTimestamp && localTimestamp) {
                    const cloudTime = parseInt(cloudTimestamp);
                    const localTime = parseInt(localTimestamp);
                    
                    console.log(`üìä Timestamp locale: ${localTime}, Cloud: ${cloudTime}`);
                    
                    if (cloudTime > localTime) {
                        // Ci sono dati pi√π recenti nel cloud
                        const cloudDataObj = JSON.parse(cloudData);
                        
                        // Verifica che i dati non siano dello stesso dispositivo
                        if (cloudDataObj.deviceId !== deviceId) {
                            console.log('‚úÖ Aggiornamento dati dal cloud...');
                            
                            // Aggiorna i dati locali con quelli del cloud
                            clienti = cloudDataObj.clienti || clienti;
                            documenti = cloudDataObj.documenti || documenti;
                            prodotti = cloudDataObj.prodotti || prodotti;
                            vini = cloudDataObj.vini || vini;
                            
                            // Salva i dati aggiornati localmente
                            saveAllDataToLocalStorage();
                            localStorage.setItem('tommy_last_sync', cloudTimestamp);
                            
                            console.log('‚úÖ Sincronizzazione cloud completata');
                            showNotification('üì° Dati sincronizzati dal cloud!', 'success');
                            return true;
                        }
                    }
                }
                
                console.log('‚ÑπÔ∏è Nessun aggiornamento necessario');
                return false;
                
            } catch (error) {
                console.error('‚ùå Errore nel sync forzato:', error);
                showNotification('‚ö†Ô∏è Errore sincronizzazione - Dati locali mantenuti', 'warning');
                return false;
            }
        }

        // Salva tutti i dati nel localStorage con validazione
        function saveAllDataToLocalStorage() {
            try {
                const timestamp = Date.now();
                
                // Validazione dati prima del salvataggio
                const validatedClienti = Array.isArray(clienti) ? clienti : [];
                const validatedDocumenti = Array.isArray(documenti) ? documenti : [];
                const validatedProdotti = Array.isArray(prodotti) ? prodotti : [];
                const validatedVini = Array.isArray(vini) ? vini : [];
                
                // Salvataggio con validazione
                localStorage.setItem('tommy_clienti', JSON.stringify(validatedClienti));
                localStorage.setItem('tommy_documenti', JSON.stringify(validatedDocumenti));
                localStorage.setItem('tommy_prodotti', JSON.stringify(validatedProdotti));
                localStorage.setItem('tommy_vini', JSON.stringify(validatedVini));
                localStorage.setItem('tommy_last_sync', timestamp.toString());
                localStorage.setItem('tommy_device_id', deviceId);
                
                console.log(`üíæ Dati salvati: ${validatedClienti.length} clienti, ${validatedDocumenti.length} documenti, ${validatedProdotti.length} prodotti, ${validatedVini.length} vini`);
                
                return true;
            } catch (error) {
                console.error('‚ùå Errore salvataggio localStorage:', error);
                return false;
            }
        }

        // Imposta salvataggio automatico alla chiusura
        function setupAutoSaveOnClose() {
            // Salvataggio automatico alla chiusura della finestra
            window.addEventListener('beforeunload', function(e) {
                console.log('üîÑ Salvataggio automatico alla chiusura...');
                saveDataToStorage();
                createBackup(); // Crea backup prima della chiusura
                
                // Ottimizzazione: Cleanup risorse
                cleanupTimers();
                removeEventListeners();
                clearCache();
                memoCache.clear();
                
                // Mostra messaggio di conferma
                e.preventDefault();
                e.returnValue = 'I dati non salvati andranno persi. Sei sicuro di voler chiudere?';
                return e.returnValue;
            });
            
            // Salvataggio automatico quando la pagina perde il focus
            window.addEventListener('blur', function() {
                console.log('üîÑ Salvataggio automatico (perdita focus)...');
                saveDataToStorage();
            });
            
            // Salvataggio automatico ogni 30 minuti
            setInterval(() => {
                console.log('üîÑ Salvataggio automatico periodico...');
                saveDataToStorage();
            }, 1800000);
            
            // Backup automatico ogni 5 minuti
            setInterval(() => {
                console.log('üíæ Backup automatico...');
                createBackup();
            }, 300000); // 5 minuti
            
            console.log('‚úÖ Sistema di salvataggio automatico configurato');
        }

        // Controlla aggiornamenti dal cloud
        async function checkForCloudUpdates() {
            try {
                // Prima controlla GitHub Gist se configurato
                if (GITHUB_CONFIG.enabled) {
                    const githubData = await loadFromGitHubGist();
                    if (githubData) {
                        const localTimestamp = localStorage.getItem('tommy_last_sync');
                        const githubTime = githubData.lastModified;
                        const localTime = parseInt(localTimestamp) || 0;
                        
                        if (githubTime > localTime && githubData.deviceId !== deviceId) {
                            // Aggiorna i dati locali con quelli di GitHub
                            clienti = githubData.clienti || clienti;
                            documenti = githubData.documenti || documenti;
                            prodotti = githubData.prodotti || prodotti;
                            vini = githubData.vini || vini;
                            
                            // Salva i dati aggiornati localmente
                            localStorage.setItem('tommy_clienti', JSON.stringify(clienti));
                            localStorage.setItem('tommy_documenti', JSON.stringify(documenti));
                            localStorage.setItem('tommy_prodotti', JSON.stringify(prodotti));
                            localStorage.setItem('tommy_vini', JSON.stringify(vini));
                            localStorage.setItem('tommy_last_sync', githubTime.toString());
                            
                            showNotification('üì° Dati sincronizzati da GitHub!', 'success');
                            return;
                        }
                    }
                }
                
                // Fallback: controlla localStorage
                const cloudData = localStorage.getItem('tommy_cloud_data');
                const cloudTimestamp = localStorage.getItem('tommy_cloud_timestamp');
                const localTimestamp = localStorage.getItem('tommy_last_sync');
                
                if (cloudData && cloudTimestamp && localTimestamp) {
                    const cloudTime = parseInt(cloudTimestamp);
                    const localTime = parseInt(localTimestamp);
                    
                    if (cloudTime > localTime) {
                        // Ci sono dati pi√π recenti nel cloud
                        const cloudDataObj = JSON.parse(cloudData);
                        
                        // Verifica che i dati non siano dello stesso dispositivo
                        if (cloudDataObj.deviceId !== deviceId) {
                            // Aggiorna i dati locali con quelli del cloud
                            clienti = cloudDataObj.clienti || clienti;
                            documenti = cloudDataObj.documenti || documenti;
                            prodotti = cloudDataObj.prodotti || prodotti;
                            vini = cloudDataObj.vini || vini;
                            
                            // Salva i dati aggiornati localmente
                            localStorage.setItem('tommy_clienti', JSON.stringify(clienti));
                            localStorage.setItem('tommy_documenti', JSON.stringify(documenti));
                            localStorage.setItem('tommy_prodotti', JSON.stringify(prodotti));
                            localStorage.setItem('tommy_vini', JSON.stringify(vini));
                            localStorage.setItem('tommy_last_sync', cloudTimestamp);
                            
                            showNotification('üì° Dati sincronizzati dal cloud!', 'success');
                        }
                    }
                }
            } catch (error) {
                console.error('Errore nel controllo aggiornamenti cloud:', error);
            }
        }
        
        // Avvia il sistema di sincronizzazione robusto
        function startSyncSystem() {
            console.log('üîÑ Avvio sistema di sincronizzazione...');
            
            // Verifica integrit√† dati all'avvio
            verifyDataIntegrity();
            
            // Controlla aggiornamenti ogni 30 minuti
            syncInterval = setInterval(async () => {
                if (isOnline) {
                    console.log('üîÑ Controllo aggiornamenti periodico...');
                    await checkForCloudUpdates();
                }
            }, 1800000);
            
            // Ascolta eventi di connessione
            window.addEventListener('online', () => {
                isOnline = true;
                console.log('üåê Connessione ripristinata');
                showNotification('üåê Connessione ripristinata - Sincronizzazione attiva', 'success');
                checkForCloudUpdates();
                updateSyncIndicator();
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                console.log('üì° Modalit√† offline');
                showNotification('üì° Modalit√† offline - Dati salvati localmente', 'warning');
                updateSyncIndicator();
            });
            
            // Ascolta modifiche ai dati da altri dispositivi
            window.addEventListener('tommyDataChanged', (event) => {
                const { data, deviceId: sourceDeviceId, timestamp } = event.detail;
                
                // Ignora le proprie modifiche
                if (sourceDeviceId === deviceId) return;
                
                console.log('üîÑ Dati ricevuti da altro dispositivo');
                
                // Aggiorna i dati se sono pi√π recenti
                if (timestamp > lastSyncTime) {
                    clienti = data.clienti || clienti;
                    documenti = data.documenti || documenti;
                    prodotti = data.prodotti || prodotti;
                    vini = data.vini || vini;
                    
                    // Salva localmente con validazione
                    saveAllDataToLocalStorage();
                    localStorage.setItem('tommy_last_sync', timestamp.toString());
                    
                    // Aggiorna le tabelle
                    updateAllTables();
                    
                    showNotification('üîÑ Dati aggiornati da altro dispositivo', 'info');
                }
            });
            
            console.log('‚úÖ Sistema di sincronizzazione avviato');
        }

        // Verifica integrit√† dei dati
        function verifyDataIntegrity() {
            console.log('üîç Verifica integrit√† dati...');
            
            let issues = [];
            
            // Verifica che tutti i dati siano array
            if (!Array.isArray(clienti)) {
                issues.push('Clienti non √® un array valido');
                clienti = [];
            }
            
            if (!Array.isArray(documenti)) {
                issues.push('Documenti non √® un array valido');
                documenti = [];
            }
            
            if (!Array.isArray(prodotti)) {
                issues.push('Prodotti non √® un array valido');
                prodotti = [];
            }
            
            if (!Array.isArray(vini)) {
                issues.push('Vini non √® un array valido');
                vini = [];
            }
            
            // Verifica ID univoci
            const clientiIds = clienti.map(c => c.id).filter((id, index, arr) => arr.indexOf(id) !== index);
            const documentiIds = documenti.map(d => d.id).filter((id, index, arr) => arr.indexOf(id) !== index);
            const prodottiIds = prodotti.map(p => p.id).filter((id, index, arr) => arr.indexOf(id) !== index);
            const viniIds = vini.map(v => v.id).filter((id, index, arr) => arr.indexOf(id) !== index);
            
            if (clientiIds.length > 0) issues.push(`ID duplicati nei clienti: ${clientiIds.join(', ')}`);
            if (documentiIds.length > 0) issues.push(`ID duplicati nei documenti: ${documentiIds.join(', ')}`);
            if (prodottiIds.length > 0) issues.push(`ID duplicati nei prodotti: ${prodottiIds.join(', ')}`);
            if (viniIds.length > 0) issues.push(`ID duplicati nei vini: ${viniIds.join(', ')}`);
            
            if (issues.length > 0) {
                console.warn('‚ö†Ô∏è Problemi di integrit√† trovati:', issues);
                showNotification(`‚ö†Ô∏è ${issues.length} problemi di integrit√† risolti`, 'warning');
                
                // Salva i dati corretti
                saveAllDataToLocalStorage();
            } else {
                console.log('‚úÖ Integrit√† dati verificata - Nessun problema trovato');
            }
        }

        // Backup automatico dei dati
        function createBackup() {
            try {
                const backupData = {
                    clienti: clienti,
                    documenti: documenti,
                    prodotti: prodotti,
                    vini: vini,
                    timestamp: Date.now(),
                    deviceId: deviceId,
                    version: '1.0'
                };
                
                const backupKey = `tommy_backup_${Date.now()}`;
                localStorage.setItem(backupKey, JSON.stringify(backupData));
                
                // Mantieni solo gli ultimi 5 backup
                const backupKeys = Object.keys(localStorage).filter(key => key.startsWith('tommy_backup_'));
                if (backupKeys.length > 5) {
                    backupKeys.sort().slice(0, -5).forEach(key => localStorage.removeItem(key));
                }
                
                console.log('üíæ Backup creato:', backupKey);
                return true;
            } catch (error) {
                console.error('‚ùå Errore creazione backup:', error);
                return false;
            }
        }

        // Ripristina da backup
        function restoreFromBackup(backupKey) {
            try {
                const backupData = localStorage.getItem(backupKey);
                if (!backupData) {
                    throw new Error('Backup non trovato');
                }
                
                const backup = JSON.parse(backupData);
                
                // Verifica integrit√† backup
                if (!backup.clienti || !backup.documenti || !backup.prodotti || !backup.vini) {
                    throw new Error('Backup corrotto');
                }
                
                // Ripristina i dati
                clienti = backup.clienti;
                documenti = backup.documenti;
                prodotti = backup.prodotti;
                vini = backup.vini;
                
                // Salva i dati ripristinati
                saveAllDataToLocalStorage();
                updateAllTables();
                
                console.log('‚úÖ Ripristino da backup completato:', backupKey);
                showNotification('‚úÖ Dati ripristinati da backup', 'success');
                return true;
            } catch (error) {
                console.error('‚ùå Errore ripristino backup:', error);
                showNotification('‚ùå Errore nel ripristino da backup', 'error');
                return false;
            }
        }

        // Funzione per aggiungere i dati dell'azienda di Tommaso
        function addTommasoCompanyData() {
            // Controlla se l'azienda di Tommaso esiste gi√†
            const existingCompany = clienti.find(cliente => 
                                        cliente.nomeAzienda === 'Privilege Caf√®&Wine' || 
                cliente.nomeAzienda === 'Privilege Caf√®&Wine' ||
                (cliente.nome === 'Tommaso' && cliente.tipologia === 'azienda')
            );
            
            if (existingCompany) {
                // Aggiorna i dati esistenti
                existingCompany.indirizzo = 'C.so Vittorio Emanuele II, 48 Bitonto (Ba) 70032';
                existingCompany.telefono = '0803740786';
                existingCompany.email = 'tommyprivilege@gmail.com';
                existingCompany.nomeAzienda = 'Privilege Caf√®&Wine';
                existingCompany.citta = 'Bitonto';
                existingCompany.cap = '70032';
                existingCompany.provincia = 'BA';
                showNotification('‚úÖ Dati azienda Tommaso aggiornati!', 'success');
            } else {
                // Aggiungi nuovo cliente azienda
                const newCompany = {
                    id: Date.now().toString(),
                    nome: 'Tommaso',
                    cognome: '',
                    email: 'tommyprivilege@gmail.com',
                    telefono: '0803740786',
                    indirizzo: 'C.so Vittorio Emanuele II, 48 Bitonto (Ba) 70032',
                    citta: 'Bitonto',
                    cap: '70032',
                    provincia: 'BA',
                    tipologia: 'azienda',
                    nomeAzienda: 'Privilege Caf√®&Wine',
                    note: 'Azienda principale - Dati per intestazione fatture',
                    dataRegistrazione: new Date().toISOString().split('T')[0]
                };
                
                clienti.push(newCompany);
                showNotification('‚úÖ Azienda Tommaso aggiunta con successo!', 'success');
            }
            
            // Salva i dati
            saveDataToStorage();
            updateAllTables();
        }

                // Salva dati nel localStorage con gestione errori e sincronizzazione robusta
        function saveDataToStorage() {
            try {
                console.log('üíæ Avvio salvataggio dati...');
                const timestamp = Date.now();
                
                // Salvataggio validato nel localStorage
                const saveSuccess = saveAllDataToLocalStorage();
                if (!saveSuccess) {
                    throw new Error('Errore nel salvataggio localStorage');
                }
                
                // Prepara dati per il cloud
                const dataToSave = {
                    clienti: clienti,
                    documenti: documenti,
                    prodotti: prodotti,
                    vini: vini,
                    lastModified: timestamp,
                    deviceId: deviceId
                };
                
                // Salva anche nel cloud storage se disponibile
                saveToCloudStorage(dataToSave);
                
                // Aggiorna il timestamp dell'ultima modifica
                lastSyncTime = timestamp;
                
                console.log('‚úÖ Salvataggio completato con successo');
                
            } catch (error) {
                console.error('‚ùå Errore nel salvataggio:', error);
                showNotification('‚ùå Errore nel salvataggio dei dati', 'error');
            }
        }
        
        // Salva dati nel cloud storage (GitHub Gist + localStorage fallback)
        async function saveToCloudStorage(data) {
            try {
                // Salva sempre in localStorage come backup
                localStorage.setItem('tommy_cloud_data', JSON.stringify(data));
                localStorage.setItem('tommy_cloud_timestamp', Date.now().toString());
                
                // Se GitHub √® configurato, salva anche l√¨
                if (GITHUB_CONFIG.enabled && GITHUB_CONFIG.token && GITHUB_CONFIG.gistId) {
                    try {
                        const success = await saveToGitHubGist(data);
                        if (success) {
                            showNotification('üì° Dati sincronizzati su GitHub!', 'success');
                        } else {
                            // Non mostrare warning per errori GitHub - i dati sono salvati localmente
                            console.log('Salvataggio locale completato - GitHub sync fallito');
                        }
                    } catch (error) {
                        console.error('Errore durante il salvataggio GitHub:', error);
                        // I dati sono gi√† salvati localmente, quindi non √® critico
                    }
                }
                
                // Simula sincronizzazione con altri dispositivi
                broadcastDataChange(data);
                
            } catch (error) {
                console.error('Errore nel salvataggio cloud:', error);
            }
        }
        
        // Salva dati su GitHub Gist
        async function saveToGitHubGist(data) {
            try {
                // Verifica che la configurazione sia valida
                if (!GITHUB_CONFIG.token || !GITHUB_CONFIG.gistId) {
                    console.warn('Configurazione GitHub incompleta - salvataggio locale only');
                    return false;
                }

                const response = await fetch(`https://api.github.com/gists/${GITHUB_CONFIG.gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        description: `Gestione Tommy - Dati aggiornati il ${new Date().toLocaleString('it-IT')}`,
                        files: {
                            'tommy_data.json': {
                                content: JSON.stringify({
                                    clienti: data.clienti,
                                    documenti: data.documenti,
                                    prodotti: data.prodotti,
                                    vini: data.vini,
                                    lastModified: data.lastModified,
                                    deviceId: data.deviceId
                                }, null, 2)
                            }
                        }
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`GitHub API error ${response.status}: ${errorText}`);
                    
                    // Gestisci errori specifici
                    if (response.status === 403) {
                        console.error('Accesso negato - verifica token e permessi Gist');
                    } else if (response.status === 404) {
                        console.error('Gist non trovato - verifica ID Gist');
                    } else if (response.status === 401) {
                        console.error('Token non valido - verifica autenticazione');
                    }
                    
                    // Gestisci errori persistenti
                    handleGitHubError();
                    
                    return false;
                }
                
                // Reset error counter on success
                githubErrorCount = 0;
                
                return true;
            } catch (error) {
                console.error('Errore nel salvataggio su GitHub Gist:', error);
                return false;
            }
        }
        
        // Carica dati da GitHub Gist
        async function loadFromGitHubGist() {
            try {
                if (!GITHUB_CONFIG.enabled || !GITHUB_CONFIG.token || !GITHUB_CONFIG.gistId) {
                    console.log('GitHub sync disabilitato o configurazione incompleta');
                    return null;
                }
                
                const response = await fetch(`https://api.github.com/gists/${GITHUB_CONFIG.gistId}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const gist = await response.json();
                    const file = gist.files['tommy_data.json'];
                    if (file && file.content) {
                        return JSON.parse(file.content);
                    } else {
                        console.log('Nessun file tommy_data.json trovato nel Gist');
                    }
                } else {
                    const errorText = await response.text();
                    console.error(`GitHub API error ${response.status}: ${errorText}`);
                    
                    // Gestisci errori specifici
                    if (response.status === 403) {
                        console.error('Accesso negato al Gist - verifica token e permessi');
                    } else if (response.status === 404) {
                        console.error('Gist non trovato - verifica ID Gist');
                    } else if (response.status === 401) {
                        console.error('Token non valido - verifica autenticazione');
                    }
                }
                
                return null;
            } catch (error) {
                console.error('Errore nel caricamento da GitHub Gist:', error);
                return null;
            }
        }
        
        // Broadcast delle modifiche ai dati
        function broadcastDataChange(data) {
            // Simula la sincronizzazione con altri dispositivi
            // In un'implementazione reale, questo sarebbe un WebSocket o Server-Sent Events
            const event = new CustomEvent('tommyDataChanged', {
                detail: {
                    data: data,
                    deviceId: deviceId,
                    timestamp: Date.now()
                }
            });
            window.dispatchEvent(event);
        }

        // Funzione per mostrare le tab
        function showTab(tabName, event = null) {
            // Controlla l'accesso alle sezioni admin-only per ospiti
            if (!handleAdminSectionAccessForGuest(tabName)) {
                return;
            }
            
            // Forza il nascondimento di TUTTE le sezioni prima di mostrare quella selezionata
            forceHideAllSections();
            
            // Rimuovi le classi active da tutte le tab
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Gestione specifica per admin
            if (currentUser === 'admin') {
                // Nascondi completamente la sezione benvenuto per admin
                const benvenutoSection = document.getElementById('benvenuto');
                if (benvenutoSection) {
                    benvenutoSection.style.display = 'none';
                    benvenutoSection.classList.remove('active');
                    benvenutoSection.classList.remove('guest-only');
                    benvenutoSection.setAttribute('style', 'display: none !important');
                }
                
                // Nascondi la tab benvenuto per admin
                const benvenutoTab = document.querySelector('.nav-tab[onclick*="showTab(\'benvenuto\')"]');
                if (benvenutoTab) {
                    benvenutoTab.style.display = 'none';
                    benvenutoTab.classList.remove('active');
                    benvenutoTab.classList.add('guest-only');
                }
                
                // Mostra solo le tab admin e quelle pubbliche (prodotti, vini)
                const adminTabs = document.querySelectorAll('.nav-tab.admin-only');
                adminTabs.forEach(tab => {
                    tab.style.display = 'block';
                    tab.classList.remove('hidden-for-guest');
                    tab.classList.add('admin-only');
                });
                
                // Mostra le sezioni admin
                const adminSections = ['dashboard', 'clienti', 'fatture'];
                adminSections.forEach(sectionId => {
                    const section = document.getElementById(sectionId);
                    if (section) {
                        section.style.display = 'block';
                        section.classList.remove('hidden-for-guest');
                        section.classList.add('admin-only');
                    }
                });
            }

            // Gestione specifica per ospiti
            if (currentUser === 'guest') {
                // Nascondi tutte le tab admin-only per ospiti
                const adminTabs = document.querySelectorAll('.nav-tab.admin-only');
                adminTabs.forEach(tab => {
                    tab.style.display = 'none';
                    tab.classList.remove('active');
                    tab.classList.add('admin-only');
                });
                
                // Nascondi tutte le sezioni admin-only per ospiti
                const adminSections = ['dashboard', 'clienti', 'fatture'];
                adminSections.forEach(sectionId => {
                    const section = document.getElementById(sectionId);
                    if (section) {
                        section.style.display = 'none';
                        section.classList.remove('active');
                        section.classList.add('admin-only');
                        section.setAttribute('style', 'display: none !important');
                    }
                });
                
                // Mostra solo le tab pubbliche per ospiti
                const publicTabs = document.querySelectorAll('.nav-tab:not(.admin-only)');
                publicTabs.forEach(tab => {
                    tab.style.display = 'block';
                    tab.classList.remove('hidden-for-guest');
                });
            }
            
            // Mostra SOLO la tab selezionata
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.style.display = 'block';
                selectedTab.classList.add('active');
                selectedTab.setAttribute('style', 'display: block !important');
            }
            
            // Attiva il pulsante della tab corrispondente
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Trova e attiva il pulsante della tab corrispondente
                const tabButtons = document.querySelectorAll('.nav-tab');
                tabButtons.forEach(button => {
                    if (button.getAttribute('onclick') && button.getAttribute('onclick').includes(tabName)) {
                        button.classList.add('active');
                    }
                });
            }
            
            // Aggiorna il select clienti se si √® nella tab fatture
            if (tabName === 'fatture') {
                updateClientiSelect();
                // Inizializza i miglioramenti per la tabella fatture
                setTimeout(() => {
                    initTableEnhancements('fatture');
                }, 200);
            }
            
            // Carica la dashboard se si √® nella tab dashboard
            if (tabName === 'dashboard') {
                loadTommasoDashboard();
            }
            
            // Inizializza i miglioramenti per tutte le tabelle quando si cambia tab
            setTimeout(() => {
                initTableEnhancements(tabName);
            }, 200);
            
            // Pulisci le classi CSS per evitare conflitti
            cleanupTabClasses();
            
            // Preveni la duplicazione delle schede
            preventTabDuplication();
        }

        // Funzione per forzare il nascondimento di tutte le sezioni
        function forceHideAllSections() {
            document.querySelectorAll('.tab-content').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
                section.setAttribute('style', 'display: none !important');
            });
        }

        // Funzione per navigare alle sezioni dalla scheda di benvenuto
        function navigateToSection(section) {
            showTab(section);
            showNotification(`Navigazione alla sezione ${section}`, 'success');
        }

        // Funzione per gestire la modalit√† ospite
        function setupGuestMode() {
            if (currentUser === 'guest') {
                // Nascondi completamente tutti gli elementi admin
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.style.display = 'none';
                    el.classList.add('admin-only');
                });
                
                // Mostra elementi guest
                document.querySelectorAll('.guest-only').forEach(el => {
                    el.style.display = 'block';
                    el.classList.add('guest-only');
                });
                
                // Nascondi specificamente le tab admin-only per ospiti
                const adminTabIds = ['dashboard', 'clienti', 'fatture'];
                adminTabIds.forEach(tabId => {
                    const tab = document.querySelector(`.nav-tab[onclick*="showTab('${tabId}')"]`);
                    if (tab) {
                        tab.style.display = 'none';
                        tab.classList.add('admin-only');
                        tab.classList.add('hidden-for-guest');
                    }
                });
                
                // Nascondi le sezioni admin-only per ospiti
                adminTabIds.forEach(sectionId => {
                    const section = document.getElementById(sectionId);
                    if (section) {
                        section.style.display = 'none';
                        section.classList.remove('active');
                        section.classList.add('admin-only');
                        section.classList.add('hidden-for-guest');
                    }
                });
                
                // Mostra la tab benvenuto per ospiti
                const benvenutoTab = document.querySelector('.nav-tab[onclick*="showTab(\'benvenuto\')"]');
                if (benvenutoTab) {
                    benvenutoTab.style.display = 'block';
                    benvenutoTab.classList.add('guest-only');
                    benvenutoTab.classList.remove('admin-only');
                }
                
                // Mostra la sezione benvenuto per ospiti
                const benvenutoSection = document.getElementById('benvenuto');
                if (benvenutoSection) {
                    benvenutoSection.style.display = 'block';
                    benvenutoSection.classList.add('guest-only');
                    benvenutoSection.classList.remove('admin-only');
                }
                
                // Mostra le tab pubbliche (prodotti, vini) per ospiti
                const publicTabIds = ['prodotti', 'vini'];
                publicTabIds.forEach(tabId => {
                    const tab = document.querySelector(`.nav-tab[onclick*="showTab('${tabId}')"]`);
                    if (tab) {
                        tab.style.display = 'block';
                        tab.classList.remove('admin-only');
                        tab.classList.remove('hidden-for-guest');
                    }
                });
                
                // Mostra le sezioni pubbliche per ospiti
                publicTabIds.forEach(sectionId => {
                    const section = document.getElementById(sectionId);
                    if (section) {
                        section.style.display = 'block';
                        section.classList.remove('admin-only');
                        section.classList.remove('hidden-for-guest');
                    }
                });
                
                // Disabilita funzioni di modifica per ospiti
                disableEditFunctions();
                
                // Inizializza correttamente le schede
                initializeTabsCorrectly();
                
                // Mostra la scheda di benvenuto per gli ospiti
                showTab('benvenuto');
                
                console.log('üë§ Modalit√† ospite attivata');
            } else {
                // Nascondi elementi guest per admin
                document.querySelectorAll('.guest-only').forEach(el => {
                    el.style.display = 'none';
                    el.classList.add('guest-only');
                });
                
                // Nascondi specificamente la sezione benvenuto per admin
                const benvenutoSection = document.getElementById('benvenuto');
                if (benvenutoSection) {
                    benvenutoSection.style.display = 'none';
                    benvenutoSection.classList.remove('active');
                    benvenutoSection.classList.add('guest-only');
                }
                
                // Nascondi la tab benvenuto per admin
                const benvenutoTab = document.querySelector('.nav-tab[onclick*="showTab(\'benvenuto\')"]');
                if (benvenutoTab) {
                    benvenutoTab.style.display = 'none';
                    benvenutoTab.classList.remove('active');
                    benvenutoTab.classList.add('guest-only');
                }
                
                // Mostra elementi admin
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.style.display = 'block';
                    el.classList.add('admin-only');
                });
                
                // Mostra tutte le schede admin per admin
                const adminTabIds = ['dashboard', 'clienti', 'fatture'];
                adminTabIds.forEach(tabId => {
                    const tab = document.querySelector(`.nav-tab[onclick*="showTab('${tabId}')"]`);
                    if (tab) {
                        tab.style.display = 'block';
                        tab.classList.add('admin-only');
                        tab.classList.remove('hidden-for-guest');
                    }
                });
                
                // Mostra le sezioni admin per admin
                adminTabIds.forEach(sectionId => {
                    const section = document.getElementById(sectionId);
                    if (section) {
                        section.style.display = 'block';
                        section.classList.add('admin-only');
                        section.classList.remove('hidden-for-guest');
                    }
                });
            }
        }

        // Funzione per gestire l'ordine delle schede per ospiti
        function organizeTabsForGuest() {
            const navTabs = document.querySelector('.nav-tabs');
            if (!navTabs) return;
            
            // Ottieni tutte le schede
            const benvenutoTab = document.querySelector('.nav-tab[onclick="showTab(\'benvenuto\')"]');
            const prodottiTab = document.querySelector('.nav-tab[onclick="showTab(\'prodotti\')"]');
            const viniTab = document.querySelector('.nav-tab[onclick="showTab(\'vini\')"]');
            
            if (benvenutoTab && prodottiTab && viniTab) {
                // Rimuovi le schede dalla loro posizione attuale
                benvenutoTab.remove();
                prodottiTab.remove();
                viniTab.remove();
                
                // Aggiungi le schede nell'ordine corretto per ospiti: Benvenuto, Prodotti, Vini
                navTabs.appendChild(benvenutoTab);
                navTabs.appendChild(prodottiTab);
                navTabs.appendChild(viniTab);
                
                // Imposta la scheda Benvenuto come attiva solo per ospiti
                if (currentUser === 'guest') {
                    benvenutoTab.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.getElementById('benvenuto').classList.add('active');
                }
            }
        }

        // Funzione per ripristinare l'ordine originale delle schede per admin
        function restoreOriginalTabOrder() {
            const navTabs = document.querySelector('.nav-tabs');
            if (!navTabs) return;
            
            // Ottieni tutte le schede
            const benvenutoTab = document.querySelector('.nav-tab[onclick="showTab(\'benvenuto\')"]');
            const prodottiTab = document.querySelector('.nav-tab[onclick="showTab(\'prodotti\')"]');
            const viniTab = document.querySelector('.nav-tab[onclick="showTab(\'vini\')"]');
            
            if (benvenutoTab && prodottiTab && viniTab) {
                // Rimuovi le schede dalla loro posizione attuale
                benvenutoTab.remove();
                prodottiTab.remove();
                viniTab.remove();
                
                // Ripristina l'ordine originale: Dashboard, Clienti, Fatture, Prodotti, Vini, Benvenuto
                const fattureTab = document.querySelector('.nav-tab[onclick="showTab(\'fatture\')"]');
                if (fattureTab) {
                    fattureTab.after(prodottiTab);
                    prodottiTab.after(viniTab);
                    viniTab.after(benvenutoTab);
                }
            }
        }

        // Funzione per gestire la navigazione tra schede per ospiti
        function navigateToSection(section) {
            if (currentUser === 'guest') {
                // Per gli ospiti, mostra direttamente la scheda richiesta
                showTab(section);
                
                // Aggiorna le statistiche se necessario
                if (section === 'benvenuto') {
                    updateWelcomeStats();
                }
            } else {
                // Per gli admin, comportamento normale
                showTab(section);
                
                // Assicurati che la sezione benvenuto sia sempre nascosta per admin
                if (section !== 'benvenuto') {
                    const benvenutoSection = document.getElementById('benvenuto');
                    if (benvenutoSection) {
                        benvenutoSection.style.display = 'none';
                        benvenutoSection.classList.remove('active');
                    }
                }
            }
        }

        // Funzione per aggiornare le statistiche della sezione benvenuto
        function updateWelcomeStats() {
            // Aggiorna statistiche hero section
            const prodottiCount = document.getElementById('prodottiCount');
            const viniCount = document.getElementById('viniCount');
            const categorieCount = document.getElementById('categorieCount');
            
            if (prodottiCount) prodottiCount.textContent = prodotti.length;
            if (viniCount) viniCount.textContent = vini.length;
            if (categorieCount) {
                const categorieTotal = new Set(prodotti.map(p => p.categoriaPrincipale)).size;
                categorieCount.textContent = categorieTotal;
            }

            // Aggiorna statistiche action cards
            const prodottiTotal = document.getElementById('prodottiTotal');
            const categorieTotal = document.getElementById('categorieTotal');
            const viniTotal = document.getElementById('viniTotal');
            const tipologieTotal = document.getElementById('tipologieTotal');
            
            if (prodottiTotal) prodottiTotal.textContent = prodotti.length;
            if (categorieTotal) {
                const categorieCount = new Set(prodotti.map(p => p.categoriaPrincipale)).size;
                categorieTotal.textContent = categorieCount;
            }
            if (viniTotal) viniTotal.textContent = vini.length;
            if (tipologieTotal) {
                const tipologieCount = new Set(vini.map(v => v.tipologia)).size;
                tipologieTotal.textContent = tipologieCount;
            }
            
            console.log('üìä Statistiche benvenuto moderne aggiornate');
        }

        // Funzione per nascondere completamente i prezzi di acquisto per ospiti
        function hidePurchasePricesForGuests() {
            // Nascondi intestazioni prezzi di acquisto
            const prezzoAcquistoHeaders = document.querySelectorAll('#prezzoAcquistoHeaderProdotti, #prezzoAcquistoHeaderVini');
            prezzoAcquistoHeaders.forEach(header => {
                header.style.display = 'none';
                header.classList.add('hidden-for-guest');
            });
            
            // Nascondi celle con prezzi di acquisto nelle tabelle
            const prodottiTable = document.getElementById('prodottiTable');
            const viniTable = document.getElementById('viniTable');
            
            if (prodottiTable) {
                const rows = prodottiTable.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    // La colonna prezzo acquisto √® la 4a (indice 3)
                    if (cells[3]) {
                        cells[3].style.display = 'none';
                        cells[3].classList.add('hidden-for-guest');
                    }
                });
            }
            
            if (viniTable) {
                const rows = viniTable.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    // La colonna prezzo acquisto √® la 7a (indice 6)
                    if (cells[6]) {
                        cells[6].style.display = 'none';
                        cells[6].classList.add('hidden-for-guest');
                    }
                });
            }
            
            // Nascondi input prezzi di acquisto nei form
            const prezzoAcquistoInputs = document.querySelectorAll('input[name="prezzoAcquisto"], input[name="prezzoAcquistoProdotti"], input[name="prezzoAcquistoVini"]');
            prezzoAcquistoInputs.forEach(input => {
                const formGroup = input.closest('.form-group');
                if (formGroup) {
                    formGroup.style.display = 'none';
                    formGroup.classList.add('hidden-for-guest');
                }
            });
        }

        // Funzione per mostrare i prezzi di acquisto per admin
        function showPurchasePricesForAdmin() {
            // Mostra intestazioni prezzi di acquisto
            const prezzoAcquistoHeaders = document.querySelectorAll('#prezzoAcquistoHeaderProdotti, #prezzoAcquistoHeaderVini');
            prezzoAcquistoHeaders.forEach(header => {
                header.style.display = 'table-cell';
                header.classList.remove('hidden-for-guest');
            });
            
            // Mostra celle con prezzi di acquisto nelle tabelle
            const prodottiTable = document.getElementById('prodottiTable');
            const viniTable = document.getElementById('viniTable');
            
            if (prodottiTable) {
                const rows = prodottiTable.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    // La colonna prezzo acquisto √® la 4a (indice 3)
                    if (cells[3]) {
                        cells[3].style.display = 'table-cell';
                        cells[3].classList.remove('hidden-for-guest');
                    }
                });
            }
            
            if (viniTable) {
                const rows = viniTable.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    // La colonna prezzo acquisto √® la 7a (indice 6)
                    if (cells[6]) {
                        cells[6].style.display = 'table-cell';
                        cells[6].classList.remove('hidden-for-guest');
                    }
                });
            }
            
            // Mostra input prezzi di acquisto nei form
            const prezzoAcquistoInputs = document.querySelectorAll('input[name="prezzoAcquisto"], input[name="prezzoAcquistoProdotti"], input[name="prezzoAcquistoVini"]');
            prezzoAcquistoInputs.forEach(input => {
                const formGroup = input.closest('.form-group');
                if (formGroup) {
                    formGroup.style.display = 'block';
                    formGroup.classList.remove('hidden-for-guest');
                }
            });
        }

        // Funzione per verificare la modalit√† ospite
        function verifyGuestMode() {
            if (currentUser === 'guest') {
                console.log('üîç Verifica modalit√† ospite:');
                
                // Verifica schede nascoste
                const hiddenTabs = ['clienti', 'fatture', 'dashboard'];
                hiddenTabs.forEach(tabId => {
                    const tab = document.querySelector(`.nav-tab[onclick="showTab('${tabId}')"]`);
                    if (tab && tab.style.display !== 'none') {
                        console.warn(`‚ö†Ô∏è Scheda ${tabId} ancora visibile per ospiti`);
                    } else {
                        console.log(`‚úÖ Scheda ${tabId} correttamente nascosta`);
                    }
                });
                
                // Verifica prezzi di acquisto nascosti
                const prezzoHeaders = document.querySelectorAll('#prezzoAcquistoHeaderProdotti, #prezzoAcquistoHeaderVini');
                prezzoHeaders.forEach(header => {
                    if (header.style.display !== 'none') {
                        console.warn('‚ö†Ô∏è Intestazione prezzo acquisto ancora visibile');
                    } else {
                        console.log('‚úÖ Intestazioni prezzi acquisto correttamente nascoste');
                    }
                });
                
                console.log('‚úÖ Verifica modalit√† ospite completata');
            }
        }

        // Funzione per disabilitare le funzioni di modifica per ospiti
        function disableEditFunctions() {
            // Disabilita bottoni di modifica
            document.querySelectorAll('.btn-warning, .btn-danger').forEach(btn => {
                if (btn.textContent.includes('‚úèÔ∏è') || btn.textContent.includes('üóëÔ∏è')) {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                }
            });
            
            // Nascondi form di inserimento
            document.querySelectorAll('.form-section').forEach(form => {
                const formElement = form.querySelector('form');
                if (formElement) {
                    formElement.style.display = 'none';
                }
            });
            
            // Aggiungi note per ospiti
            document.querySelectorAll('.tab-content').forEach(tab => {
                if (tab.id !== 'benvenuto') {
                    const note = document.createElement('div');
                    note.className = 'guest-note';
                    note.innerHTML = '<p><strong>üë§ Modalit√† Ospite:</strong> Puoi visualizzare i dati ma non modificarli.</p>';
                    tab.appendChild(note);
                }
            });
        }

        // Funzione per aggiornare le statistiche nella scheda di benvenuto
        function updateWelcomeStats() {
            try {
                // Aggiorna statistiche prodotti
                const prodottiStats = document.querySelector('.menu-card[onclick="navigateToSection(\'prodotti\')"] .stat-item strong');
                if (prodottiStats) {
                    prodottiStats.textContent = prodotti.length;
                }
                
                const prodottiCategorie = document.querySelector('.menu-card[onclick="navigateToSection(\'prodotti\')"] .stat-item:last-child strong');
                if (prodottiCategorie) {
                    const categorieUniche = new Set(prodotti.map(p => p.categoriaPrincipale)).size;
                    prodottiCategorie.textContent = categorieUniche;
                }
                
                // Aggiorna statistiche vini
                const viniStats = document.querySelector('.menu-card[onclick="navigateToSection(\'vini\')"] .stat-item strong');
                if (viniStats) {
                    viniStats.textContent = vini.length;
                }
                
                const viniTipologie = document.querySelector('.menu-card[onclick="navigateToSection(\'vini\')"] .stat-item:last-child strong');
                if (viniTipologie) {
                    const tipologieUniche = new Set(vini.map(v => v.tipologia)).size;
                    viniTipologie.textContent = tipologieUniche;
                }
                
                console.log('üìä Statistiche scheda benvenuto aggiornate');
            } catch (error) {
                console.error('Errore nell\'aggiornamento statistiche benvenuto:', error);
            }
        }

        // Gestione form clienti migliorata
        function updateClientiTable() {
            try {
                const tbody = document.getElementById('clientiTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                clienti.forEach(cliente => {
                    const row = document.createElement('tr');
                    row.setAttribute('role', 'row');
                    row.innerHTML = `
                        <td role="cell">${cliente.nomeAzienda || '-'}</td>
                        <td role="cell">${cliente.tipologia || 'privato'}</td>
                        <td role="cell">${cliente.nome || ''}</td>
                        <td role="cell">${cliente.cognome || ''}</td>
                        <td role="cell">${cliente.email || ''}</td>
                        <td role="cell">${cliente.telefono || ''}</td>
                        <td role="cell">${cliente.citta || ''}</td>
                        <td role="cell">${cliente.dataRegistrazione || ''}</td>
                        <td role="cell">${cliente.note || ''}</td>
                        <td role="cell">
                            <button class="btn btn-sm btn-warning" onclick="editCliente(${cliente.id})" title="Modifica cliente">‚úèÔ∏è Modifica</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCliente(${cliente.id})" title="Elimina cliente">üóëÔ∏è Elimina</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                            // Inizializza i miglioramenti delle tabelle dopo l'aggiornamento
            setTimeout(() => {
                initTableEnhancements('clienti');
            }, 100);
            

            } catch (error) {
                console.error('Errore nell\'aggiornamento tabella clienti:', error);
                showNotification('Errore nell\'aggiornamento della tabella clienti', 'error');
            }
        }

        function editCliente(id) {
            const cliente = clienti.find(c => c.id === id);
            if (!cliente) return;
            const form = document.getElementById('clienteForm');
            form.nomeAzienda.value = cliente.nomeAzienda || '';
            form.tipologia.value = cliente.tipologia || 'privato';
            form.nome.value = cliente.nome;
            form.cognome.value = cliente.cognome;
            form.email.value = cliente.email;
            form.telefono.value = cliente.telefono;
            form.indirizzo.value = cliente.indirizzo;
            form.citta.value = cliente.citta;
            form.cap.value = cliente.cap;
            form.dataRegistrazione.value = cliente.dataRegistrazione;
            form.note.value = cliente.note;
            
            // Aggiorna la visibilit√† del campo Nome Azienda
            toggleNomeAzienda();
            
            if (!form.querySelector('[name="editId"]')) {
                const hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = 'editId';
                form.appendChild(hidden);
            }
            form.editId.value = cliente.id;
            form.scrollIntoView({ behavior: 'smooth' });
        }

        function deleteCliente(id) {
            if (confirm('Sei sicuro di voler eliminare questo cliente?')) {
                const idx = clienti.findIndex(c => c.id === id);
                if (idx !== -1) {
                    clienti.splice(idx, 1);
                    updateClientiTable();
                    saveDataToStorage();
                    alert('Cliente eliminato con successo!');
                }
            }
        }

        document.getElementById('clienteForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            // Validazione per le aziende
            const tipologia = formData.get('tipologia');
            const nomeAzienda = formData.get('nomeAzienda');
            
            if (tipologia === 'azienda' && !nomeAzienda.trim()) {
                alert('Per le aziende √® obbligatorio inserire il nome dell\'azienda!');
                return;
            }
            
            const editId = formData.get('editId');
            if (editId) {
                const idx = clienti.findIndex(c => c.id == editId);
                if (idx !== -1) {
                    clienti[idx] = {
                        ...clienti[idx],
                        nomeAzienda: formData.get('nomeAzienda'),
                        tipologia: formData.get('tipologia'),
                        nome: formData.get('nome'),
                        cognome: formData.get('cognome'),
                        email: formData.get('email'),
                        telefono: formData.get('telefono'),
                        indirizzo: formData.get('indirizzo'),
                        citta: formData.get('citta'),
                        cap: formData.get('cap'),
                        dataRegistrazione: formData.get('dataRegistrazione'),
                        note: formData.get('note')
                    };
                    updateClientiTable();
                    saveDataToStorage();
                    alert('Cliente modificato con successo!');
                }
                this.removeChild(this.querySelector('[name="editId"]'));
                this.reset();
                return;
            }
            // Inserimento nuovo cliente (comportamento originale)
            const cliente = {
                id: Date.now(),
                nomeAzienda: formData.get('nomeAzienda'),
                tipologia: formData.get('tipologia'),
                nome: formData.get('nome'),
                cognome: formData.get('cognome'),
                email: formData.get('email'),
                telefono: formData.get('telefono'),
                indirizzo: formData.get('indirizzo'),
                citta: formData.get('citta'),
                cap: formData.get('cap'),
                dataRegistrazione: formData.get('dataRegistrazione'),
                note: formData.get('note')
            };
            clienti.push(cliente);
            updateClientiTable();
            saveDataToStorage();
            this.reset();
            alert('Cliente aggiunto con successo!');
        });

        // Gestione form fatture
        function updateFattureTable() {
            const tbody = document.getElementById('fattureTableBody');
            tbody.innerHTML = '';
            
            documenti.forEach(documento => {
                const row = document.createElement('tr');
                row.setAttribute('role', 'row');
                row.innerHTML = `
                    <td role="cell"><span class="badge badge-${getTipoBadge(documento.tipo)}">${documento.tipo.toUpperCase()}</span></td>
                    <td role="cell">${documento.numero}</td>
                    <td role="cell">${documento.cliente}</td>
                    <td role="cell">${documento.data}</td>
                    <td role="cell">${documento.scadenza || '-'}</td>
                    <td role="cell">‚Ç¨${documento.subtotale.toFixed(2)}</td>
                    <td role="cell">‚Ç¨${documento.scontoExtra.toFixed(2)}</td>
                    <td role="cell">‚Ç¨${documento.totale.toFixed(2)}</td>
                    <td role="cell">${getStatoBadge(documento.stato)}</td>
                    <td role="cell">${documento.note || '-'}</td>
                    <td role="cell">
                        <button class="btn btn-sm btn-primary" onclick="editDocumento(${documento.id})" title="Modifica documento">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-success" onclick="stampaDocumentoSalvato(${documento.id})" title="Stampa documento">üñ®Ô∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteDocumento(${documento.id})" title="Elimina documento">üóëÔ∏è</button>
                        ${enableStatoFatture ? `
                            <div class="stato-actions" style="margin-top: 5px;">
                                <button class="btn btn-xs btn-warning" onclick="changeStatoFattura(${documento.id}, 'in_attesa')" title="Imposta In Attesa" ${documento.stato === 'in_attesa' ? 'disabled' : ''}>‚è≥</button>
                                <button class="btn btn-xs btn-success" onclick="changeStatoFattura(${documento.id}, 'pagata')" title="Imposta Pagata" ${documento.stato === 'pagata' ? 'disabled' : ''}>‚úÖ</button>
                                <button class="btn btn-xs btn-danger" onclick="changeStatoFattura(${documento.id}, 'scaduta')" title="Imposta Scaduta" ${documento.stato === 'scaduta' ? 'disabled' : ''}>‚ö†Ô∏è</button>
                            </div>
                        ` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Inizializza i miglioramenti dopo l'aggiornamento della tabella
            setTimeout(() => {
                initTableEnhancements('fatture');
            }, 100);
            

        }

        function getTipoBadge(tipo) {
            switch(tipo) {
                case 'fattura': return 'primary';
                case 'proforma': return 'warning';
                case 'ddt': return 'info';
                default: return 'secondary';
            }
        }

        function getStatoBadge(stato) {
            if (!stato) return '<span class="status-badge status-pending">In Attesa</span>';
            
            switch(stato) {
                case 'pagata': 
                    return '<span class="status-badge status-paid">Pagata</span>';
                case 'in_attesa': 
                    return '<span class="status-badge status-pending">In Attesa</span>';
                case 'scaduta': 
                    return '<span class="status-badge status-overdue">Scaduta</span>';
                default: 
                    return '<span class="status-badge status-pending">In Attesa</span>';
            }
        }

        function editDocumento(id) {
            const documento = documenti.find(d => d.id === id);
            if (!documento) return;
            
            // Popola il modal con i dati del documento
            const modal = document.getElementById('fatturaModal');
            modal.style.display = 'flex';
            
            document.querySelector('#fatturaModal h3').textContent = `‚úèÔ∏è Modifica ${documento.tipo.toUpperCase()}`;
            document.querySelector('#fatturaModal select[name="tipoDocumento"]').value = documento.tipo;
            document.querySelector('#fatturaModal input[name="numero"]').value = documento.numero;
            document.querySelector('#fatturaModal select[name="cliente"]').value = documento.cliente;
            document.querySelector('#fatturaModal input[name="data"]').value = documento.data;
            document.querySelector('#fatturaModal input[name="scadenza"]').value = documento.scadenza || '';
            document.querySelector('#fatturaModal input[name="scontoExtra"]').value = documento.scontoExtra || 0;
            document.querySelector('#fatturaModal textarea[name="note"]').value = documento.note || '';
            
            // Popola le righe prodotto
            righeProdotto = [...documento.prodotti];
            updateProdottiTable();
            calcolaTotali();
            
            // Modifica il comportamento del form per l'aggiornamento
            const form = document.getElementById('fatturaFormModal');
            form.onsubmit = function(e) {
                e.preventDefault();
                updateDocumento(id);
            };
        }

        function updateDocumento(id) {
            const formData = new FormData(document.getElementById('fatturaFormModal'));
            
            if (righeProdotto.length === 0) {
                alert('Aggiungi almeno un prodotto/servizio!');
                return;
            }
            
            const documentoIndex = documenti.findIndex(d => d.id === id);
            if (documentoIndex === -1) return;
            
            documenti[documentoIndex] = {
                ...documenti[documentoIndex],
                tipo: formData.get('tipoDocumento'),
                numero: formData.get('numero'),
                cliente: formData.get('cliente'),
                data: formData.get('data'),
                scadenza: formData.get('scadenza'),
                subtotale: parseFloat(formData.get('subtotale')),
                scontoExtra: parseFloat(formData.get('scontoExtra')),
                totale: parseFloat(formData.get('totale')),
                prodotti: [...righeProdotto],
                note: formData.get('note')
            };
            
            updateFattureTable();
            saveDataToStorage();
            
            alert('Documento aggiornato con successo!');
            hideFatturaModal();
            
            // Ripristina il comportamento normale del form
            const form = document.getElementById('fatturaFormModal');
            form.onsubmit = null;
        }

        function deleteDocumento(id) {
            if (confirm('Sei sicuro di voler eliminare questo documento?')) {
                documenti = documenti.filter(d => d.id !== id);
                updateFattureTable();
                saveDataToStorage();
            }
        }

        function stampaDocumentoSalvato(id) {
            const documento = documenti.find(d => d.id === id);
            if (!documento) return;
            
            // Crea il contenuto per la stampa
            let printContent = `
                <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px;">
                    <div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px;">
                        <h1 style="margin: 0; color: #333;">Privilege Caf√®&Wine</h1>
                        <p style="margin: 5px 0; color: #666;">C.so Vittorio Emanuele II, 48 Bitonto (Ba) 70032 - Tel: 0803740786</p>
                        <h2 style="margin: 20px 0; color: #1a5f3a;">${documento.tipo.toUpperCase()} N. ${documento.numero}</h2>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                            <div>
                                <strong>Cliente:</strong> ${documento.cliente}<br>
                                <strong>Data:</strong> ${documento.data}
                            </div>
                            <div style="text-align: right;">
                                <strong>Numero:</strong> ${documento.numero}<br>
                                <strong>Tipo:</strong> ${documento.tipo.toUpperCase()}
                            </div>
                        </div>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Prodotto/Servizio</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Q.t√†</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Prezzo Unit.</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Sconto</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Imponibile</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            documento.prodotti.forEach(riga => {
                const tipoSconto = riga.tipoSconto || 'percentuale';
                const valoreSconto = riga.valoreSconto || 0;
                const simboloSconto = tipoSconto === 'percentuale' ? '%' : '‚Ç¨';
                
                // Calcolo dinamico dell'imponibile
                const quantita = parseFloat(riga.quantita) || 0;
                const prezzoUnitario = parseFloat(riga.prezzoUnitario) || 0;
                const subtotaleBase = quantita * prezzoUnitario;
                
                let imponibile = subtotaleBase;
                
                // Applica sconto se presente
                if (valoreSconto > 0) {
                    if (tipoSconto === 'percentuale') {
                        // Sconto percentuale
                        const scontoAmount = subtotaleBase * (valoreSconto / 100);
                        imponibile = subtotaleBase - scontoAmount;
                    } else {
                        // Sconto fisso in euro
                        imponibile = subtotaleBase - valoreSconto;
                    }
                }
                
                // Assicurati che l'imponibile non sia negativo
                imponibile = Math.max(0, imponibile);
                
                printContent += `
                    <tr>
                        <td style="padding: 12px; border: 1px solid #ddd;">${riga.prodotto}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${riga.quantita}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">‚Ç¨${riga.prezzoUnitario.toFixed(2)}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${valoreSconto}${simboloSconto}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">‚Ç¨${imponibile.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            // Calcolo dinamico del subtotale e totale
            let subtotaleCalcolato = 0;
            let scontoExtraCalcolato = parseFloat(documento.scontoExtra) || 0;
            
            // Ricalcola il subtotale basandosi sui nuovi imponibili
            documento.prodotti.forEach(riga => {
                const quantita = parseFloat(riga.quantita) || 0;
                const prezzoUnitario = parseFloat(riga.prezzoUnitario) || 0;
                const subtotaleBase = quantita * prezzoUnitario;
                
                let imponibile = subtotaleBase;
                const valoreSconto = parseFloat(riga.valoreSconto) || 0;
                const tipoSconto = riga.tipoSconto || 'percentuale';
                
                if (valoreSconto > 0) {
                    if (tipoSconto === 'percentuale') {
                        const scontoAmount = subtotaleBase * (valoreSconto / 100);
                        imponibile = subtotaleBase - scontoAmount;
                    } else {
                        imponibile = subtotaleBase - valoreSconto;
                    }
                }
                
                imponibile = Math.max(0, imponibile);
                subtotaleCalcolato += imponibile;
            });
            
            // Calcola il totale finale
            const totaleCalcolato = subtotaleCalcolato - scontoExtraCalcolato;
            
            printContent += `
                        </tbody>
                    </table>
                    
                    <div style="text-align: right; margin-top: 30px;">
                        <div style="margin-bottom: 10px;">
                            <strong>Subtotale:</strong> ‚Ç¨${subtotaleCalcolato.toFixed(2)}
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Sconto Extra:</strong> ‚Ç¨${scontoExtraCalcolato.toFixed(2)}
                        </div>
                        <div style="font-size: 18px; font-weight: bold; border-top: 2px solid #333; padding-top: 10px;">
                            <strong>TOTALE:</strong> ‚Ç¨${totaleCalcolato.toFixed(2)}
                        </div>
                    </div>
                </div>
            `;
            
            // Crea una nuova finestra per la stampa
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${documento.tipo.toUpperCase()} ${documento.numero}</title>
                    <style>
                        body { margin: 0; padding: 20px; }
                        @media print {
                            body { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    ${printContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            
            // Stampa automatica
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }



        // Gestione form prodotti
        document.getElementById('prodottoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const editId = formData.get('editId');
            if (editId) {
                // Modifica prodotto esistente
                const idx = prodotti.findIndex(p => p.id == editId);
                if (idx !== -1) {
                    prodotti[idx] = {
                        ...prodotti[idx],
                        nome: formData.get('nome'),
                        categoriaPrincipale: formData.get('categoriaPrincipale'),
                        sottocategoria: formData.get('sottocategoria'),
                        marca: formData.get('marca'),
                        prezzoAcquisto: parseFloat(formData.get('prezzoAcquisto')) || 0,
                        prezzoVenditaIngrosso: parseFloat(formData.get('prezzoVenditaIngrosso')),
                        prezzoVenditaDettaglio: parseFloat(formData.get('prezzoVenditaDettaglio')),
                        quantita: parseInt(formData.get('quantita')),
                        quantitaMinima: parseInt(formData.get('quantitaMinima')),
                        fornitore: formData.get('fornitore'),
                        codiceProdotto: formData.get('codiceProdotto'),
                        note: formData.get('note')
                    };
                    updateProdottiTable();
                    saveDataToStorage();
                    alert('Prodotto modificato con successo!');
                }
                // Rimuovi campo nascosto e resetta il form
                this.removeChild(this.querySelector('[name="editId"]'));
                this.reset();
                return;
            }
            // Inserimento nuovo prodotto (comportamento originale)
            const prodotto = {
                id: Date.now(),
                nome: formData.get('nome'),
                categoriaPrincipale: formData.get('categoriaPrincipale'),
                sottocategoria: formData.get('sottocategoria'),
                marca: formData.get('marca'),
                prezzoAcquisto: parseFloat(formData.get('prezzoAcquisto')) || 0,
                prezzoVenditaIngrosso: parseFloat(formData.get('prezzoVenditaIngrosso')),
                prezzoVenditaDettaglio: parseFloat(formData.get('prezzoVenditaDettaglio')),
                quantita: parseInt(formData.get('quantita')),
                quantitaMinima: parseInt(formData.get('quantitaMinima')),
                fornitore: formData.get('fornitore'),
                codiceProdotto: formData.get('codiceProdotto'),
                note: formData.get('note')
            };
            prodotti.push(prodotto);
            updateProdottiTable();
            saveDataToStorage();
            this.reset();
            alert('Prodotto aggiunto con successo!');
        });

        // Gestione form vini
        function updateViniTable() {
            const tbody = document.getElementById('viniTableBody');
            tbody.innerHTML = '';
            
            vini.forEach(vino => {
                const stockClass = vino.quantita <= 3 ? 'stock-low' : 'stock-ok';
                const stockText = vino.quantita <= 3 ? 'Scorte Basse' : 'OK';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${vino.nome}</td>
                    <td>${vino.produttore}</td>
                    <td>${vino.annata}</td>
                    <td>${vino.tipologia}</td>
                    <td>${vino.regione}</td>
                    <td>${vino.vitigno || '-'}</td>
                    <td>‚Ç¨${vino.prezzoAcquisto.toFixed(2)}</td>
                    <td>‚Ç¨${vino.prezzoVenditaIngrosso.toFixed(2)}</td>
                    <td>‚Ç¨${vino.prezzoVenditaDettaglio.toFixed(2)}</td>
                    <td>${vino.quantita}</td>
                    <td>${vino.unitaMisura || 'bottiglie'}</td>
                    <td><span class="status-badge ${stockClass}">${stockText}</span></td>
                    <td>${vino.note}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editVino(${vino.id})">‚úèÔ∏è Modifica</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteVino(${vino.id})">ÔøΩÔøΩÔ∏è Elimina</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        


        function editVino(id) {
            const vino = vini.find(v => v.id === id);
            if (!vino) return;
            const form = document.getElementById('vinoForm');
            form.nome.value = vino.nome;
            form.produttore.value = vino.produttore;
            form.annata.value = vino.annata;
            form.tipologia.value = vino.tipologia;
            form.regione.value = vino.regione;
            form.vitigno.value = vino.vitigno;
            form.prezzoAcquisto.value = vino.prezzoAcquisto;
            form.prezzoVenditaIngrosso.value = vino.prezzoVenditaIngrosso;
            form.prezzoVenditaDettaglio.value = vino.prezzoVenditaDettaglio;
            form.quantita.value = vino.quantita;
            form.unitaMisura.value = vino.unitaMisura || 'bottiglie';
            form.fornitore.value = vino.fornitore;
            form.codiceProdotto.value = vino.codiceProdotto;
            form.descrizione.value = vino.descrizione;
            form.note.value = vino.note;
            if (!form.querySelector('[name="editId"]')) {
                const hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = 'editId';
                form.appendChild(hidden);
            }
            form.editId.value = vino.id;
            form.scrollIntoView({ behavior: 'smooth' });
        }

        function deleteVino(id) {
            if (confirm('Sei sicuro di voler eliminare questo vino?')) {
                const idx = vini.findIndex(v => v.id === id);
                if (idx !== -1) {
                    vini.splice(idx, 1);
                    updateViniTable();
                    saveDataToStorage();
                    alert('Vino eliminato con successo!');
                }
            }
        }

        document.getElementById('vinoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const editId = formData.get('editId');
            if (editId) {
                const idx = vini.findIndex(v => v.id == editId);
                if (idx !== -1) {
                    vini[idx] = {
                        ...vini[idx],
                        nome: formData.get('nome'),
                        produttore: formData.get('produttore'),
                        annata: parseInt(formData.get('annata')),
                        tipologia: formData.get('tipologia'),
                        regione: formData.get('regione'),
                        vitigno: formData.get('vitigno'),
                        prezzoAcquisto: parseFloat(formData.get('prezzoAcquisto')) || 0,
                        prezzoVenditaIngrosso: parseFloat(formData.get('prezzoVenditaIngrosso')),
                        prezzoVenditaDettaglio: parseFloat(formData.get('prezzoVenditaDettaglio')),
                        quantita: parseInt(formData.get('quantita')),
                        unitaMisura: formData.get('unitaMisura') || 'bottiglie',
                        fornitore: formData.get('fornitore'),
                        codiceProdotto: formData.get('codiceProdotto'),
                        descrizione: formData.get('descrizione'),
                        note: formData.get('note')
                    };
                    updateViniTable();
                    saveDataToStorage();
                    alert('Vino modificato con successo!');
                }
                this.removeChild(this.querySelector('[name="editId"]'));
                this.reset();
                return;
            }
            // Inserimento nuovo vino (comportamento originale)
            const vino = {
                id: Date.now(),
                nome: formData.get('nome'),
                produttore: formData.get('produttore'),
                annata: parseInt(formData.get('annata')),
                tipologia: formData.get('tipologia'),
                regione: formData.get('regione'),
                vitigno: formData.get('vitigno'),
                prezzoAcquisto: parseFloat(formData.get('prezzoAcquisto')) || 0,
                prezzoVenditaIngrosso: parseFloat(formData.get('prezzoVenditaIngrosso')),
                prezzoVenditaDettaglio: parseFloat(formData.get('prezzoVenditaDettaglio')),
                quantita: parseInt(formData.get('quantita')),
                unitaMisura: formData.get('unitaMisura') || 'bottiglie',
                fornitore: formData.get('fornitore'),
                codiceProdotto: formData.get('codiceProdotto'),
                descrizione: formData.get('descrizione'),
                note: formData.get('note')
            };
            vini.push(vino);
            updateViniTable();
            saveDataToStorage();
            this.reset();
            alert('Vino aggiunto con successo!');
        });


        
        // Funzione per gestire la visibilit√† del campo Nome Azienda
        function toggleNomeAzienda() {
            const tipologiaSelect = document.querySelector('select[name="tipologia"]');
            const nomeAziendaInput = document.querySelector('input[name="nomeAzienda"]');
            
            if (tipologiaSelect.value === 'azienda') {
                nomeAziendaInput.required = true;
                nomeAziendaInput.placeholder = 'Nome dell\'azienda (obbligatorio)';
            } else {
                nomeAziendaInput.required = false;
                nomeAziendaInput.placeholder = 'Nome dell\'azienda (lasciare vuoto per privati)';
            }
        }
        
        // Funzione per aggiornare il select clienti nelle fatture (evita duplicati)
        function updateClientiSelect() {
            const clienteSelect = document.querySelector('select[name="cliente"]');
            if (!clienteSelect) return;
            
            // Salva il valore selezionato
            const selectedValue = clienteSelect.value;
            
            // Pulisci le opzioni esistenti
            clienteSelect.innerHTML = '<option value="">Seleziona cliente...</option>';
            
            // Crea un Set per evitare duplicati
            const clientiUnici = new Set();
            
            // Aggiungi i clienti unici
            clienti.forEach(cliente => {
                let displayValue, optionValue;
                
                if (cliente.tipologia === 'azienda' && cliente.nomeAzienda) {
                    // Per le aziende, usa il nome azienda
                    displayValue = cliente.nomeAzienda;
                    optionValue = cliente.nomeAzienda;
                } else {
                    // Per i privati o aziende senza nome, usa nome e cognome
                    displayValue = `${cliente.nome} ${cliente.cognome}`;
                    optionValue = `${cliente.nome} ${cliente.cognome}`;
                }
                
                // Aggiungi solo se non √® gi√† presente
                if (!clientiUnici.has(optionValue)) {
                    clientiUnici.add(optionValue);
                    
                    const option = document.createElement('option');
                    option.value = optionValue;
                    option.textContent = displayValue + (cliente.tipologia === 'azienda' ? ' (Azienda)' : ' (Privato)');
                    clienteSelect.appendChild(option);
                }
            });
            
            // Ripristina il valore selezionato se era presente
            if (selectedValue) {
                clienteSelect.value = selectedValue;
            }
        }

        // Variabili globali per i documenti
        let righeProdotto = [];

        // Funzioni per i modal
        function showFatturaModal() {
            const modal = document.getElementById('fatturaModal');
            modal.style.display = 'flex';
            
            // Imposta la data di oggi
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('#fatturaModal input[name="data"]').value = today;
            
            // Aggiorna il select clienti
            updateClientiSelect();
            
            // Pulisci le righe prodotto
            righeProdotto = [];
            updateProdottiTable();
            
            // Pulisci i totali
            calcolaTotali();
        }

        function hideFatturaModal() {
            const modal = document.getElementById('fatturaModal');
            modal.style.display = 'none';
        }

        function showProformaModal() {
            const modal = document.getElementById('fatturaModal');
            modal.style.display = 'flex';
            document.querySelector('#fatturaModal h3').textContent = 'üìã Nuova Proforma';
            document.querySelector('#fatturaModal select[name="tipoDocumento"]').value = 'proforma';
            
            // Imposta la data di oggi
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('#fatturaModal input[name="data"]').value = today;
            
            // Aggiorna il select clienti
            updateClientiSelect();
            
            // Pulisci le righe prodotto
            righeProdotto = [];
            updateProdottiTable();
            
            // Pulisci i totali
            calcolaTotali();
        }

        function showDDTModal() {
            const modal = document.getElementById('fatturaModal');
            modal.style.display = 'flex';
            document.querySelector('#fatturaModal h3').textContent = 'üöö Nuovo DDT';
            document.querySelector('#fatturaModal select[name="tipoDocumento"]').value = 'ddt';
            
            // Imposta la data di oggi
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('#fatturaModal input[name="data"]').value = today;
            
            // Aggiorna il select clienti
            updateClientiSelect();
            
            // Pulisci le righe prodotto
            righeProdotto = [];
            updateProdottiTable();
            
            // Pulisci i totali
            calcolaTotali();
        }

        // Funzioni per gestire le righe prodotto
        function aggiungiRigaProdotto() {
            const riga = {
                id: Date.now() + Math.random(),
                prodotto: '',
                quantita: 1,
                prezzoUnitario: 0,
                tipoSconto: 'percentuale', // 'percentuale' o 'arbitrario'
                valoreSconto: 0,
                subtotaleRiga: 0
            };
            
            righeProdotto.push(riga);
            updateProdottiTable();
            updateAnteprimaTable();
            calcolaTotali();
        }

        function rimuoviRigaProdotto(id) {
            righeProdotto = righeProdotto.filter(r => r.id !== id);
            updateProdottiTable();
            updateAnteprimaTable();
            calcolaTotali();
        }

        function updateProdottiTable() {
            const tbody = document.getElementById('prodottiTableBody');
            tbody.innerHTML = '';
            
            righeProdotto.forEach(riga => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" value="${riga.prodotto}" onchange="aggiornaRiga(${riga.id}, 'prodotto', this.value)" placeholder="Nome prodotto/servizio"></td>
                    <td><input type="number" value="${riga.quantita}" onchange="aggiornaRiga(${riga.id}, 'quantita', this.value)" min="1" step="1"></td>
                    <td><input type="number" value="${riga.prezzoUnitario}" onchange="aggiornaRiga(${riga.id}, 'prezzoUnitario', this.value)" step="0.01"></td>
                    <td>
                        <select onchange="aggiornaRiga(${riga.id}, 'tipoSconto', this.value)">
                            <option value="percentuale" ${riga.tipoSconto === 'percentuale' ? 'selected' : ''}>%</option>
                            <option value="arbitrario" ${riga.tipoSconto === 'arbitrario' ? 'selected' : ''}>‚Ç¨</option>
                        </select>
                    </td>
                    <td><input type="number" value="${riga.valoreSconto}" onchange="aggiornaRiga(${riga.id}, 'valoreSconto', this.value)" step="0.01" min="0"></td>
                    <td><input type="number" value="${riga.subtotaleRiga}" readonly></td>
                    <td><button type="button" class="btn btn-sm btn-danger" onclick="rimuoviRigaProdotto(${riga.id})">üóëÔ∏è</button></td>
                `;
                tbody.appendChild(row);
            });
            
            // Aggiorna anche la tabella di anteprima
            updateAnteprimaTable();
        }

        function aggiornaRiga(id, campo, valore) {
            const riga = righeProdotto.find(r => r.id === id);
            if (riga) {
                if (campo === 'tipoSconto' || campo === 'prodotto') {
                    riga[campo] = valore;
                } else {
                    riga[campo] = parseFloat(valore) || 0;
                }
                calcolaSubtotaleRiga(riga);
                updateProdottiTable();
                updateAnteprimaTable();
                calcolaTotali();
            }
        }

        function calcolaSubtotaleRiga(riga) {
            const quantita = parseFloat(riga.quantita) || 0;
            const prezzoUnitario = parseFloat(riga.prezzoUnitario) || 0;
            const tipoSconto = riga.tipoSconto || 'percentuale';
            const valoreSconto = parseFloat(riga.valoreSconto) || 0;
            
            const subtotale = quantita * prezzoUnitario;
            let scontoImporto = 0;
            
            if (tipoSconto === 'percentuale') {
                // Sconto percentuale sul totale della riga
                scontoImporto = subtotale * (valoreSconto / 100);
            } else {
                // Sconto fisso in euro
                scontoImporto = valoreSconto;
            }
            
            riga.subtotaleRiga = Math.max(0, subtotale - scontoImporto);
        }

        function updateAnteprimaTable() {
            const tbody = document.getElementById('anteprimaTableBody');
            tbody.innerHTML = '';
            
            righeProdotto.forEach(riga => {
                const tipoSconto = riga.tipoSconto || 'percentuale';
                const valoreSconto = riga.valoreSconto || 0;
                const simboloSconto = tipoSconto === 'percentuale' ? '%' : '‚Ç¨';
                const scontoDisplay = valoreSconto > 0 ? `${valoreSconto}${simboloSconto}` : '-';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${riga.prodotto}</td>
                    <td>
                        <input type="number" value="${riga.quantita}" min="1" step="1" 
                               style="width: 60px; text-align: center;"
                               onchange="modificaQuantitaAnteprima(${riga.id}, this.value)">
                    </td>
                    <td>‚Ç¨${riga.prezzoUnitario.toFixed(2)}</td>
                    <td class="sconto-cell">
                        <div class="flex-container">
                            <select onchange="modificaTipoScontoAnteprima(${riga.id}, this.value)" 
                                    style="width: 50px;">
                                <option value="percentuale" ${tipoSconto === 'percentuale' ? 'selected' : ''}>%</option>
                                <option value="arbitrario" ${tipoSconto === 'arbitrario' ? 'selected' : ''}>‚Ç¨</option>
                            </select>
                            <input type="number" value="${valoreSconto}" min="0" step="0.01" 
                                   style="width: 60px; text-align: center;"
                                   onchange="modificaValoreScontoAnteprima(${riga.id}, this.value)">
                        </div>
                    </td>
                    <td class="subtotale-cell">‚Ç¨${riga.subtotaleRiga.toFixed(2)}</td>
                    <td style="text-align: center;">
                        <button type="button" class="btn btn-sm btn-danger" 
                                onclick="eliminaRigaAnteprima(${riga.id})" 
                                style="padding: 2px 6px; font-size: 12px;" 
                                title="Elimina prodotto">
                            üóëÔ∏è
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function calcolaTotali() {
            const scontoExtra = parseFloat(document.querySelector('#fatturaModal input[name="scontoExtra"]').value) || 0;
            
            let subtotale = 0;
            righeProdotto.forEach(riga => {
                subtotale += parseFloat(riga.subtotaleRiga) || 0;
            });
            
            const totale = subtotale - scontoExtra;
            
            document.querySelector('#fatturaModal input[name="subtotale"]').value = subtotale.toFixed(2);
            document.querySelector('#fatturaModal input[name="scontoExtraDisplay"]').value = scontoExtra.toFixed(2);
            document.querySelector('#fatturaModal input[name="totale"]').value = totale.toFixed(2);
        }

        // Funzioni per modificare dall'anteprima
        function modificaQuantitaAnteprima(id, nuovaQuantita) {
            const riga = righeProdotto.find(r => r.id === id);
            if (riga) {
                riga.quantita = parseInt(nuovaQuantita) || 1;
                calcolaSubtotaleRiga(riga);
                updateAnteprimaTable();
                calcolaTotali();
            }
        }

        function modificaTipoScontoAnteprima(id, nuovoTipo) {
            const riga = righeProdotto.find(r => r.id === id);
            if (riga) {
                riga.tipoSconto = nuovoTipo;
                calcolaSubtotaleRiga(riga);
                updateAnteprimaTable();
                calcolaTotali();
            }
        }

        function modificaValoreScontoAnteprima(id, nuovoValore) {
            const riga = righeProdotto.find(r => r.id === id);
            if (riga) {
                riga.valoreSconto = parseFloat(nuovoValore) || 0;
                calcolaSubtotaleRiga(riga);
                updateAnteprimaTable();
                calcolaTotali();
            }
        }

        function eliminaRigaAnteprima(id) {
            const riga = righeProdotto.find(r => r.id === id);
            if (riga && confirm(`Sei sicuro di voler eliminare "${riga.prodotto}" dalla fattura?`)) {
                righeProdotto = righeProdotto.filter(r => r.id !== id);
                updateProdottiTable();
                updateAnteprimaTable();
                calcolaTotali();
                showNotification('Prodotto eliminato dalla fattura', 'success');
            }
        }

        // Funzioni per il catalogo
        function selezionaDaCatalogo() {
            const modal = document.getElementById('catalogoModal');
            modal.style.display = 'flex';
            
            // Popola le tabelle del catalogo
            popolaCatalogoProdotti();
            popolaCatalogoVini();
        }

        function hideCatalogoModal() {
            const modal = document.getElementById('catalogoModal');
            modal.style.display = 'none';
        }

        function showCatalogoTab(tab) {
            // Nascondi tutte le tab
            document.querySelectorAll('.catalogo-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.catalogo-tab').forEach(tabBtn => {
                tabBtn.classList.remove('active');
            });
            
            // Mostra la tab selezionata
            document.getElementById(`catalogo${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');
            event.target.classList.add('active');
        }

        function popolaCatalogoProdotti() {
            const tbody = document.getElementById('catalogoProdottiBody');
            tbody.innerHTML = '';
            
            prodotti.forEach(prodotto => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${prodotto.nome}</td>
                    <td>${prodotto.categoriaPrincipale} - ${prodotto.sottocategoria}</td>
                    <td>‚Ç¨${prodotto.prezzoVenditaIngrosso.toFixed(2)}</td>
                    <td>‚Ç¨${prodotto.prezzoVenditaDettaglio.toFixed(2)}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-primary" onclick="selezionaProdotto('${prodotto.nome}', ${prodotto.prezzoVenditaDettaglio})">Seleziona</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function popolaCatalogoVini() {
            const tbody = document.getElementById('catalogoViniBody');
            tbody.innerHTML = '';
            
            vini.forEach(vino => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${vino.nome}</td>
                    <td>${vino.produttore}</td>
                    <td>‚Ç¨${vino.prezzoVenditaIngrosso.toFixed(2)}</td>
                    <td>‚Ç¨${vino.prezzoVenditaDettaglio.toFixed(2)}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-primary" onclick="selezionaProdotto('${vino.nome}', ${vino.prezzoVenditaDettaglio})">Seleziona</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function selezionaProdotto(nome, prezzo) {
            const riga = {
                id: Date.now() + Math.random(),
                prodotto: nome,
                quantita: 1,
                prezzoUnitario: prezzo,
                tipoSconto: 'percentuale',
                valoreSconto: 0,
                subtotaleRiga: 0
            };
            
            // Calcola il subtotale iniziale
            calcolaSubtotaleRiga(riga);
            
            righeProdotto.push(riga);
            updateProdottiTable();
            updateAnteprimaTable();
            calcolaTotali();
            hideCatalogoModal();
        }

        // Gestione del form fattura
        document.getElementById('fatturaFormModal').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            if (righeProdotto.length === 0) {
                alert('Aggiungi almeno un prodotto/servizio!');
                return;
            }
            
            const documento = {
                id: Date.now(),
                tipo: formData.get('tipoDocumento'),
                numero: formData.get('numero'),
                cliente: formData.get('cliente'),
                data: formData.get('data'),
                scadenza: formData.get('scadenza'),
                subtotale: parseFloat(formData.get('subtotale')),
                scontoExtra: parseFloat(formData.get('scontoExtra')),
                totale: parseFloat(formData.get('totale')),
                prodotti: [...righeProdotto],
                note: formData.get('note'),
                stato: 'in_attesa'
            };
            
            documenti.push(documento);
            updateFattureTable();
            saveDataToStorage();
            
            alert('Documento salvato con successo!');
            hideFatturaModal();
            this.reset();
        });

        // Funzione per stampare il documento
        function stampaDocumento() {
            const formData = new FormData(document.getElementById('fatturaFormModal'));
            
            if (righeProdotto.length === 0) {
                alert('Aggiungi almeno un prodotto/servizio!');
                return;
            }
            
            const tipo = formData.get('tipoDocumento');
            const numero = formData.get('numero');
            const cliente = formData.get('cliente');
            const data = formData.get('data');
            const subtotale = parseFloat(formData.get('subtotale'));
            const scontoExtra = parseFloat(formData.get('scontoExtra'));
            const totale = parseFloat(formData.get('totale'));
            
            // Crea il contenuto per la stampa
            let printContent = `
                <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px;">
                    <div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px;">
                        <h1 style="margin: 0; color: #333;">Privilege Caf√®&Wine</h1>
                        <p style="margin: 5px 0; color: #666;">C.so Vittorio Emanuele II, 48 Bitonto (Ba) 70032 - Tel: 0803740786</p>
                        <h2 style="margin: 20px 0; color: #1a5f3a;">${tipo.toUpperCase()} N. ${numero}</h2>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                            <div>
                                <strong>Cliente:</strong> ${cliente}<br>
                                <strong>Data:</strong> ${data}
                            </div>
                            <div style="text-align: right;">
                                <strong>Numero:</strong> ${numero}<br>
                                <strong>Tipo:</strong> ${tipo.toUpperCase()}
                            </div>
                        </div>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Prodotto/Servizio</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Q.t√†</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Prezzo Unit.</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Sconto</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Imponibile</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Calcolo dinamico del subtotale e totale
            let subtotaleCalcolato = 0;
            let scontoExtraCalcolato = parseFloat(scontoExtra) || 0;
            
            righeProdotto.forEach(riga => {
                const tipoSconto = riga.tipoSconto || 'percentuale';
                const valoreSconto = riga.valoreSconto || 0;
                const simboloSconto = tipoSconto === 'percentuale' ? '%' : '‚Ç¨';
                
                // Calcolo dinamico dell'imponibile
                const quantita = parseFloat(riga.quantita) || 0;
                const prezzoUnitario = parseFloat(riga.prezzoUnitario) || 0;
                const subtotaleBase = quantita * prezzoUnitario;
                
                let imponibile = subtotaleBase;
                
                // Applica sconto se presente
                if (valoreSconto > 0) {
                    if (tipoSconto === 'percentuale') {
                        // Sconto percentuale
                        const scontoAmount = subtotaleBase * (valoreSconto / 100);
                        imponibile = subtotaleBase - scontoAmount;
                    } else {
                        // Sconto fisso in euro
                        imponibile = subtotaleBase - valoreSconto;
                    }
                }
                
                // Assicurati che l'imponibile non sia negativo
                imponibile = Math.max(0, imponibile);
                subtotaleCalcolato += imponibile;
                
                printContent += `
                    <tr>
                        <td style="padding: 12px; border: 1px solid #ddd;">${riga.prodotto}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${riga.quantita}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">‚Ç¨${riga.prezzoUnitario.toFixed(2)}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${valoreSconto}${simboloSconto}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">‚Ç¨${imponibile.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            // Calcola il totale finale
            const totaleCalcolato = subtotaleCalcolato - scontoExtraCalcolato;
            
            printContent += `
                        </tbody>
                    </table>
                    
                    <div style="text-align: right; margin-top: 30px;">
                        <div style="margin-bottom: 10px;">
                            <strong>Subtotale:</strong> ‚Ç¨${subtotaleCalcolato.toFixed(2)}
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Sconto Extra:</strong> ‚Ç¨${scontoExtraCalcolato.toFixed(2)}
                        </div>
                        <div style="font-size: 18px; font-weight: bold; border-top: 2px solid #333; padding-top: 10px;">
                            <strong>TOTALE:</strong> ‚Ç¨${totaleCalcolato.toFixed(2)}
                        </div>
                    </div>
                </div>
            `;
            
            // Crea una nuova finestra per la stampa
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${tipo.toUpperCase()} ${numero}</title>
                    <style>
                        body { margin: 0; padding: 20px; }
                        @media print {
                            body { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    ${printContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            
            // Stampa automatica
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }





        function deleteProdotto(id) {
            if (confirm('Sei sicuro di voler eliminare questo prodotto?')) {
                const idx = prodotti.findIndex(p => p.id === id);
                if (idx !== -1) {
                    prodotti.splice(idx, 1);
                    updateProdottiTable();
                    saveDataToStorage();
                    alert('Prodotto eliminato con successo!');
                }
            }
        }



        // Funzione per modificare un prodotto
        function editProdotto(id) {
            const prodotto = prodotti.find(p => p.id === id);
            if (!prodotto) return;
            // Precompila il form con i dati del prodotto
            const form = document.getElementById('prodottoForm');
            form.nome.value = prodotto.nome;
            form.categoriaPrincipale.value = prodotto.categoriaPrincipale;
            updateSottocategorie();
            form.sottocategoria.value = prodotto.sottocategoria;
            form.marca.value = prodotto.marca;
            form.prezzoAcquisto.value = prodotto.prezzoAcquisto;
            form.prezzoVenditaIngrosso.value = prodotto.prezzoVenditaIngrosso;
            form.prezzoVenditaDettaglio.value = prodotto.prezzoVenditaDettaglio;
            form.quantita.value = prodotto.quantita;
            form.quantitaMinima.value = prodotto.quantitaMinima;
            form.fornitore.value = prodotto.fornitore;
            form.codiceProdotto.value = prodotto.codiceProdotto;
            form.note.value = prodotto.note;
            // Salva l'id in un campo nascosto
            if (!form.querySelector('[name="editId"]')) {
                const hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = 'editId';
                form.appendChild(hidden);
            }
            form.editId.value = prodotto.id;
            // Scorri in alto al form
            form.scrollIntoView({ behavior: 'smooth' });
        }

        // Categorie e sottocategorie semplificate e ottimizzate
        const categorie = {
            distillati: {
                rum: 'Rum',
                gin: 'Gin',
                vodka: 'Vodka',
                whisky: 'Whisky',
                tequila: 'Tequila',
                cognac: 'Cognac',
                brandy: 'Brandy',
                bourbon: 'Bourbon',
                scotch: 'Scotch',
                irish: 'Irish Whiskey',
                grappa: 'Grappa',
                altro: 'Altri Distillati'
            },
            liquori: {
                amari: 'Amari',
                digestivi: 'Digestivi',
                creme: 'Creme Liquori',
                premium: 'Premium',
                flavored: 'Aromatizzati',
                limoncello: 'Limoncello',
                sambuca: 'Sambuca',
                altro: 'Altri Liquori'
            },
            vini: {
                rossi: 'Vini Rossi',
                bianchi: 'Vini Bianchi',
                spumanti: 'Spumanti',
                dessert: 'Vini da Dessert',
                fortificati: 'Vini Fortificati',
                altro: 'Altri Vini'
            },
            birre: {
                lager: 'Lager',
                ale: 'Ale',
                speciali: 'Birre Speciali',
                italiane: 'Birre Italiane',
                altro: 'Altre Birre'
            },
            altro: {
                generico: 'Generico',
                altro: 'Altro'
            }
        };

        // Funzione per ottenere il nome di visualizzazione delle sottocategorie
        function getSottocategoriaDisplayName(categoriaPrincipale, sottocategoria) {
            if (categorie[categoriaPrincipale] && categorie[categoriaPrincipale][sottocategoria]) {
                return categorie[categoriaPrincipale][sottocategoria];
            }
            return sottocategoria.charAt(0).toUpperCase() + sottocategoria.slice(1);
        }

        // Funzione per aggiornare le sottocategorie
        function updateSottocategorie() {
            const categoriaPrincipale = document.getElementById('categoriaPrincipale').value;
            const sottocategoriaSelect = document.getElementById('sottocategoria');
            
            sottocategoriaSelect.innerHTML = '<option value="">Seleziona sottocategoria...</option>';
            
            if (categoriaPrincipale && categorie[categoriaPrincipale]) {
                Object.keys(categorie[categoriaPrincipale]).forEach(sottocat => {
                    const option = document.createElement('option');
                    option.value = sottocat;
                    option.textContent = categorie[categoriaPrincipale][sottocat];
                    sottocategoriaSelect.appendChild(option);
                });
            }
        }

        // Funzione per importare da Excel
        function importFromExcel(type, input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    if (jsonData.length === 0) {
                        alert('Il file Excel √® vuoto!');
                        return;
                    }

                    let importedCount = 0;
                    let existingCount = 0;

                    jsonData.forEach(row => {
                        const item = convertExcelRowToItem(type, row);
                        if (item) {
                            // Controlla se l'elemento esiste gi√†
                            const exists = checkIfExists(type, item);
                            if (!exists) {
                                addItemToArray(type, item);
                                importedCount++;
                            } else {
                                existingCount++;
                            }
                        }
                    });

                    // Aggiorna le tabelle e salva
                    updateAllTables();
                    saveDataToStorage();

                    alert(`Importazione completata!\nNuovi elementi: ${importedCount}\nElementi esistenti saltati: ${existingCount}`);
                    input.value = ''; // Reset input
                } catch (error) {
                    alert('Errore durante l\'importazione del file Excel: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Funzione per convertire riga Excel in oggetto
        function convertExcelRowToItem(type, row) {
            switch(type) {
                case 'clienti':
                    return {
                        id: Date.now() + Math.random(),
                        nomeAzienda: row['Nome Azienda'] || '',
                        tipologia: row['Tipologia'] || 'privato',
                        nome: row['Nome Referente'] || row['Nome'] || '',
                        cognome: row['Cognome Referente'] || row['Cognome'] || '',
                        email: row['Email'] || '',
                        telefono: row['Telefono'] || '',
                        indirizzo: row['Indirizzo'] || '',
                        citta: row['Citt√†'] || '',
                        cap: row['CAP'] || '',
                        dataRegistrazione: row['Data Registrazione'] || new Date().toISOString().split('T')[0],
                        note: row['Note'] || ''
                    };
                case 'fatture':
                    return {
                        id: Date.now() + Math.random(),
                        tipo: row['Tipo'] ? row['Tipo'].toLowerCase() : 'fattura',
                        numero: row['Numero'] || '',
                        cliente: row['Cliente'] || '',
                        data: row['Data'] || new Date().toISOString().split('T')[0],
                        scadenza: row['Scadenza'] || '',
                        subtotale: parseFloat(row['Subtotale']) || 0,
                        scontoExtra: parseFloat(row['Sconto Extra']) || 0,
                        totale: parseFloat(row['Totale']) || 0,
                        prodotti: [],
                        stato: row['Stato'] || 'in_attesa',
                        note: row['Note'] || ''
                    };
                case 'prodotti':
                    return {
                        id: Date.now() + Math.random(),
                        nome: row['Nome'] || '',
                        categoriaPrincipale: row['Categoria Principale'] || 'altro',
                        sottocategoria: row['Sottocategoria'] || 'altro',
                        marca: row['Marca'] || '',
                        prezzoAcquisto: parseFloat(row['Prezzo Acquisto']) || 0,
                        prezzoVenditaIngrosso: parseFloat(row['Prezzo Vendita Ingrosso']) || 0,
                        prezzoVenditaDettaglio: parseFloat(row['Prezzo Vendita al Dettaglio']) || 0,
                        quantita: parseInt(row['Quantit√†']) || 0,
                        quantitaMinima: parseInt(row['Quantit√† Minima']) || 5,
                        fornitore: row['Fornitore'] || '',
                        codiceProdotto: row['Codice Prodotto'] || '',
                        note: row['Note'] || ''
                    };
                case 'vini':
                    return {
                        id: Date.now() + Math.random(),
                        nome: row['Nome'] || '',
                        produttore: row['Produttore'] || '',
                        annata: parseInt(row['Annata']) || new Date().getFullYear(),
                        tipologia: row['Tipologia'] || 'rosso',
                        regione: row['Regione'] || '',
                        vitigno: row['Vitigno'] || '',
                        prezzoAcquisto: parseFloat(row['Prezzo Acquisto']) || 0,
                        prezzoVenditaIngrosso: parseFloat(row['Prezzo Vendita Ingrosso']) || 0,
                        prezzoVenditaDettaglio: parseFloat(row['Prezzo Vendita al Dettaglio']) || 0,
                        quantita: parseInt(row['Quantit√†']) || 0,
                        unitaMisura: row['Unit√† di Misura'] || 'bottiglie',
                        fornitore: row['Fornitore'] || '',
                        codiceProdotto: row['Codice Prodotto'] || '',
                        descrizione: row['Descrizione'] || '',
                        note: row['Note'] || ''
                    };
                default:
                    return null;
            }
        }

        // Funzione per controllare se un elemento esiste gi√†
        function checkIfExists(type, item) {
            switch(type) {
                case 'clienti':
                    return clienti.some(c => c.email === item.email && c.nome === item.nome);
                case 'fatture':
                    return documenti.some(d => d.numero === item.numero);
                case 'prodotti':
                    return prodotti.some(p => p.nome === item.nome && p.marca === item.marca);
                case 'vini':
                    return vini.some(v => v.nome === item.nome && v.produttore === item.produttore && v.annata === item.annata);
                default:
                    return false;
            }
        }

        // Funzione per aggiungere elemento all'array
        function addItemToArray(type, item) {
            switch(type) {
                case 'clienti':
                    clienti.push(item);
                    break;
                case 'fatture':
                    documenti.push(item);
                    break;
                case 'prodotti':
                    prodotti.push(item);
                    break;
                case 'vini':
                    vini.push(item);
                    break;
            }
        }

        // Funzione per aggiornare tutte le tabelle
        function updateAllTables() {
            updateClientiTable();
            updateFattureTable();
            updateProdottiTable();
            updateViniTable();
            
            // Gestisci prezzi di acquisto per ospiti
            if (currentUser === 'guest') {
                hidePurchasePricesForGuests();
                updateWelcomeStats();
            } else {
                showPurchasePricesForAdmin();
            }
        }

        // Funzione per esportare in Excel con formattazione avanzata
        function exportToExcel(type, prezzoType = null) {
            let data = [];
            let filename = '';
            let columnWidths = [];
            
            switch(type) {
                case 'clienti':
                    data = clienti.map(c => ({
                        'Nome Azienda': c.nomeAzienda || '',
                        'Tipologia': c.tipologia || 'privato',
                        'Nome Referente': c.nome,
                        'Cognome Referente': c.cognome,
                        'Email': c.email,
                        'Telefono': c.telefono,
                        'Indirizzo': c.indirizzo,
                        'Citt√†': c.citta,
                        'CAP': c.cap,
                        'Data Registrazione': c.dataRegistrazione,
                        'Note': c.note
                    }));
                    filename = 'Clienti_Tommy.xlsx';
                    columnWidths = [25, 15, 20, 20, 30, 15, 25, 15, 10, 15, 40];
                    break;
                    
                case 'fatture':
                    data = documenti.map(d => ({
                        'Tipo': d.tipo.toUpperCase(),
                        'Numero': d.numero,
                        'Cliente': d.cliente,
                        'Data': d.data,
                        'Scadenza': d.scadenza || '',
                        'Subtotale': d.subtotale,
                        'Sconto Extra': d.scontoExtra,
                        'Totale': d.totale,
                        'Stato': d.stato,
                        'Note': d.note || ''
                    }));
                    filename = 'Documenti_Tommy.xlsx';
                    columnWidths = [15, 15, 25, 12, 12, 12, 12, 12, 15, 40];
                    break;
                    
                case 'prodotti':
                    if (prezzoType === 'ingrosso') {
                        data = prodotti.map(p => ({
                            'Nome': p.nome,
                            'Categoria Principale': p.categoriaPrincipale,
                            'Sottocategoria': p.sottocategoria,
                            'Marca': p.marca,
                            'Prezzo Acquisto': p.prezzoAcquisto,
                            'Prezzo Vendita Ingrosso': p.prezzoVenditaIngrosso,
                            'Quantit√†': p.quantita,
                            'Quantit√† Minima': p.quantitaMinima,
                            'Fornitore': p.fornitore,
                            'Codice Prodotto': p.codiceProdotto,
                            'Note': p.note
                        }));
                        filename = 'Prodotti_Ingrosso_Tommy.xlsx';
                        columnWidths = [25, 20, 20, 15, 15, 18, 10, 12, 20, 15, 30];
                    } else if (prezzoType === 'dettaglio') {
                        data = prodotti.map(p => ({
                            'Nome': p.nome,
                            'Categoria Principale': p.categoriaPrincipale,
                            'Sottocategoria': p.sottocategoria,
                            'Marca': p.marca,
                            'Prezzo Acquisto': p.prezzoAcquisto,
                            'Prezzo Vendita al Dettaglio': p.prezzoVenditaDettaglio,
                            'Quantit√†': p.quantita,
                            'Quantit√† Minima': p.quantitaMinima,
                            'Fornitore': p.fornitore,
                            'Codice Prodotto': p.codiceProdotto,
                            'Note': p.note
                        }));
                        filename = 'Prodotti_Dettaglio_Tommy.xlsx';
                        columnWidths = [25, 20, 20, 15, 15, 20, 10, 12, 20, 15, 30];
                    } else {
                        // Export completo con entrambi i prezzi
                        data = prodotti.map(p => ({
                            'Nome': p.nome,
                            'Categoria Principale': p.categoriaPrincipale,
                            'Sottocategoria': p.sottocategoria,
                            'Marca': p.marca,
                            'Prezzo Acquisto': p.prezzoAcquisto,
                            'Prezzo Vendita Ingrosso': p.prezzoVenditaIngrosso,
                            'Prezzo Vendita al Dettaglio': p.prezzoVenditaDettaglio,
                            'Quantit√†': p.quantita,
                            'Quantit√† Minima': p.quantitaMinima,
                            'Fornitore': p.fornitore,
                            'Codice Prodotto': p.codiceProdotto,
                            'Note': p.note
                        }));
                        filename = 'Prodotti_Completo_Tommy.xlsx';
                        columnWidths = [25, 20, 20, 15, 15, 18, 20, 10, 12, 20, 15, 30];
                    }
                    break;
                    
                case 'vini':
                    if (prezzoType === 'ingrosso') {
                        data = vini.map(v => ({
                            'Nome': v.nome,
                            'Produttore': v.produttore,
                            'Annata': v.annata,
                            'Tipologia': v.tipologia,
                            'Regione': v.regione,
                            'Vitigno': v.vitigno,
                            'Prezzo Acquisto': v.prezzoAcquisto,
                            'Prezzo Vendita Ingrosso': v.prezzoVenditaIngrosso,
                            'Quantit√†': v.quantita,
                            'Unit√† di Misura': v.unitaMisura || 'bottiglie',
                            'Fornitore': v.fornitore,
                            'Codice Prodotto': v.codiceProdotto,
                            'Descrizione': v.descrizione,
                            'Note': v.note
                        }));
                        filename = 'Vini_Ingrosso_Tommy.xlsx';
                        columnWidths = [25, 20, 10, 15, 15, 15, 15, 18, 10, 15, 20, 15, 30, 30];
                    } else if (prezzoType === 'dettaglio') {
                        data = vini.map(v => ({
                            'Nome': v.nome,
                            'Produttore': v.produttore,
                            'Annata': v.annata,
                            'Tipologia': v.tipologia,
                            'Regione': v.regione,
                            'Vitigno': v.vitigno,
                            'Prezzo Acquisto': v.prezzoAcquisto,
                            'Prezzo Vendita al Dettaglio': v.prezzoVenditaDettaglio,
                            'Quantit√†': v.quantita,
                            'Unit√† di Misura': v.unitaMisura || 'bottiglie',
                            'Fornitore': v.fornitore,
                            'Codice Prodotto': v.codiceProdotto,
                            'Descrizione': v.descrizione,
                            'Note': v.note
                        }));
                        filename = 'Vini_Dettaglio_Tommy.xlsx';
                        columnWidths = [25, 20, 10, 15, 15, 15, 15, 20, 10, 15, 20, 15, 30, 30];
                    } else {
                        // Export completo con entrambi i prezzi
                        data = vini.map(v => ({
                            'Nome': v.nome,
                            'Produttore': v.produttore,
                            'Annata': v.annata,
                            'Tipologia': v.tipologia,
                            'Regione': v.regione,
                            'Vitigno': v.vitigno,
                            'Prezzo Acquisto': v.prezzoAcquisto,
                            'Prezzo Vendita Ingrosso': v.prezzoVenditaIngrosso,
                            'Prezzo Vendita al Dettaglio': v.prezzoVenditaDettaglio,
                            'Quantit√†': v.quantita,
                            'Unit√† di Misura': v.unitaMisura || 'bottiglie',
                            'Fornitore': v.fornitore,
                            'Codice Prodotto': v.codiceProdotto,
                            'Descrizione': v.descrizione,
                            'Note': v.note
                        }));
                        filename = 'Vini_Completo_Tommy.xlsx';
                        columnWidths = [25, 20, 10, 15, 15, 15, 15, 18, 20, 10, 15, 20, 15, 30, 30];
                    }
                    break;
            }
            
            if (data.length === 0) {
                alert('Nessun dato da esportare!');
                return;
            }
            
            // Crea il foglio di lavoro
            const ws = XLSX.utils.json_to_sheet(data);
            
            // Imposta le larghezze delle colonne
            ws['!cols'] = columnWidths.map(width => ({ width }));
            
            // Imposta la riga di intestazione come fissa
            ws['!freeze'] = { r: 1, c: 0 };
            
            // Aggiungi stili per l'intestazione
            const headerRange = XLSX.utils.decode_range(ws['!ref']);
            for (let C = headerRange.s.c; C <= headerRange.e.c; ++C) {
                const cellAddress = XLSX.utils.encode_cell({ r: 0, c: C });
                if (!ws[cellAddress]) continue;
                
                // Stile per intestazioni
                ws[cellAddress].s = {
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "4472C4" } },
                    alignment: { horizontal: "center", vertical: "center" },
                    border: {
                        top: { style: "thin" },
                        bottom: { style: "thin" },
                        left: { style: "thin" },
                        right: { style: "thin" }
                    }
                };
            }
            
            // Stili per le righe dati
            for (let R = 1; R <= headerRange.e.r; ++R) {
                for (let C = headerRange.s.c; C <= headerRange.e.c; ++C) {
                    const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                    if (!ws[cellAddress]) continue;
                    
                    // Stile per dati
                    ws[cellAddress].s = {
                        border: {
                            top: { style: "thin" },
                            bottom: { style: "thin" },
                            left: { style: "thin" },
                            right: { style: "thin" }
                        },
                        alignment: { vertical: "center" }
                    };
                    
                    // Stile speciale per colonne numeriche (prezzi, quantit√†)
                    const columnName = Object.keys(data[0])[C];
                    if (columnName && (columnName.includes('Prezzo') || columnName.includes('Quantit√†') || columnName.includes('Importo'))) {
                        ws[cellAddress].s.numFmt = '‚Ç¨#,##0.00';
                    }
                }
            }
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Dati");
            XLSX.writeFile(wb, filename);
        }

        // Variabili globali per lo slider
        // Funzione per migliorare la gestione delle tabelle
        function enhanceTableScrolling() {
            const tableWrappers = document.querySelectorAll('.table-wrapper');
            
            tableWrappers.forEach(wrapper => {
                // Aggiungi indicatori di scroll
                const table = wrapper.querySelector('.data-table');
                if (table && table.scrollWidth > wrapper.clientWidth) {
                    wrapper.classList.add('has-scroll');
                }
                
                // Aggiungi event listener per scroll smooth
                wrapper.addEventListener('scroll', function() {
                    // Aggiorna indicatori di scroll se necessario
                    updateScrollIndicators(wrapper);
                });
            });
        }
        
        // Funzione per aggiornare indicatori di scroll
        function updateScrollIndicators(wrapper) {
            const scrollLeft = wrapper.scrollLeft;
            const scrollWidth = wrapper.scrollWidth;
            const clientWidth = wrapper.clientWidth;
            
            // Aggiungi/rimuovi classi per indicatori visivi
            if (scrollLeft > 0) {
                wrapper.classList.add('scrolled-left');
            } else {
                wrapper.classList.remove('scrolled-left');
            }
            
            if (scrollLeft < scrollWidth - clientWidth - 1) {
                wrapper.classList.add('scrolled-right');
            } else {
                wrapper.classList.remove('scrolled-right');
            }
        }
        
        // Funzione per inizializzare le tabelle quando si cambia tab
        function initTableEnhancements(tableType = 'fatture') {
            setTimeout(() => {
                enhanceTableScrolling();
                updateTableAccessibility();
            }, 100);
        }
        
        // Funzione per migliorare l'accessibilit√† delle tabelle
        function updateTableAccessibility() {
            const tables = document.querySelectorAll('.data-table');
            
            tables.forEach(table => {
                // Aggiungi attributi di accessibilit√†
                table.setAttribute('role', 'table');
                table.setAttribute('aria-label', 'Tabella dati');
                
                // Aggiungi attributi alle righe
                const rows = table.querySelectorAll('tr');
                rows.forEach((row, index) => {
                    if (index === 0) {
                        row.setAttribute('role', 'row');
                        const headers = row.querySelectorAll('th');
                        headers.forEach(header => {
                            header.setAttribute('role', 'columnheader');
                        });
                    } else {
                        row.setAttribute('role', 'row');
                        const cells = row.querySelectorAll('td');
                        cells.forEach(cell => {
                            cell.setAttribute('role', 'cell');
                        });
                    }
                });
            });
        }
        

        
        // Funzione per stampare il listino vini - VERSIONE OTTIMIZZATA PER STAMPA B/N
        function printWineList() {
            if (vini.length === 0) {
                alert('Nessun vino disponibile per la stampa!');
                return;
            }

            // Chiedi all'utente quale tipo di listino stampare
            const tipoListino = confirm('Vuoi stampare il listino al DETTAGLIO?\n\nClicca OK per DETTAGLIO\nClicca Annulla per INGROSSO');
            const isDettaglio = tipoListino;
            const prezzoType = isDettaglio ? 'dettaglio' : 'ingrosso';
            const prezzoField = isDettaglio ? 'prezzoVenditaDettaglio' : 'prezzoVenditaIngrosso';
            const tipoText = isDettaglio ? 'DETTAGLIO' : 'INGROSSO';

            // Raggruppa i vini per tipologia
            const viniPerTipologia = {};
            vini.forEach(vino => {
                if (!viniPerTipologia[vino.tipologia]) {
                    viniPerTipologia[vino.tipologia] = [];
                }
                viniPerTipologia[vino.tipologia].push(vino);
            });

            // Crea il contenuto HTML per la stampa ottimizzata
            let printContent = `
                <div class="print-wine-list">
                    <div class="wine-header">
                        <h1 class="wine-title">Privilege Caf√®&Wine</h1>
                        <p class="wine-subtitle">Listino Vini - ${tipoText}</p>
                        <p class="wine-date">Aggiornato al ${new Date().toLocaleDateString('it-IT')}</p>
                    </div>
            `;

            // Aggiungi i vini raggruppati per tipologia
            Object.keys(viniPerTipologia).forEach((tipologia, index) => {
                if (index > 0 && index % 12 === 0) {
                    printContent += '<div class="page-break"></div>';
                }
                
                printContent += `<div class="wine-category">${tipologia.charAt(0).toUpperCase() + tipologia.slice(1)}</div>`;
                
                viniPerTipologia[tipologia].forEach(vino => {
                    printContent += `
                        <div class="wine-item">
                            <div class="wine-name">${vino.nome}</div>
                            <div class="wine-producer">${vino.produttore}</div>
                            <div class="wine-year">${vino.annata}</div>
                            <div class="wine-vitigno">${vino.vitigno || '-'}</div>
                            <div class="wine-unit">${vino.unitaMisura || 'bott.'}</div>
                            <div class="wine-price">‚Ç¨${vino[prezzoField].toFixed(2)}</div>
                        </div>
                    `;
                });
            });

            printContent += `
                    <div class="wine-footer">
                        <p>Privilege Caf√®&Wine - Listino prezzi al ${tipoText.toLowerCase()}</p>
                        <p>I prezzi sono espressi in Euro e includono IVA</p>
                    </div>
                </div>
            `;

            // Crea una nuova finestra per la stampa ottimizzata
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Listino Vini ${tipoText} - Privilege Caf√®&Wine</title>
                    <style>
                        * {
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: Arial, sans-serif;
                            margin: 0;
                            padding: 15px;
                            background: white;
                            color: black;
                            font-size: 12px;
                            line-height: 1.4;
                        }
                        
                        .print-wine-list {
                            max-width: 100%;
                            margin: 0 auto;
                        }
                        
                        /* Header compatto */
                        .wine-header {
                            text-align: center;
                            margin-bottom: 20px;
                            border-bottom: 2px solid black;
                            padding-bottom: 10px;
                        }
                        
                        .wine-title {
                            font-size: 24px;
                            font-weight: bold;
                            margin: 0 0 5px 0;
                            color: black;
                        }
                        
                        .wine-subtitle {
                            font-size: 16px;
                            margin: 0 0 5px 0;
                            color: black;
                            font-weight: bold;
                        }
                        
                        .wine-date {
                            font-size: 12px;
                            margin: 0;
                            color: black;
                        }
                        
                        /* Categorie compatte */
                        .wine-category {
                            margin: 15px 0 8px 0;
                            font-size: 16px;
                            font-weight: bold;
                            color: black;
                            border-bottom: 1px solid black;
                            padding-bottom: 5px;
                            text-transform: uppercase;
                        }
                        
                        /* Tabella compatta per i vini */
                        .wine-item {
                            display: grid;
                            grid-template-columns: 2fr 1fr 0.5fr 0.8fr 0.5fr 0.8fr;
                            gap: 8px;
                            padding: 6px 0;
                            border-bottom: 1px solid #ccc;
                            align-items: center;
                            font-size: 11px;
                        }
                        
                        .wine-item:nth-child(even) {
                            background-color: #f9f9f9;
                        }
                        
                        .wine-name {
                            font-weight: bold;
                            color: black;
                        }
                        
                        .wine-producer {
                            color: black;
                            font-weight: normal;
                        }
                        
                        .wine-year {
                            color: black;
                            text-align: center;
                            font-weight: bold;
                        }
                        
                        .wine-vitigno {
                            color: black;
                            font-style: italic;
                        }
                        
                        .wine-unit {
                            color: black;
                            text-align: center;
                            font-size: 10px;
                        }
                        
                        .wine-price {
                            font-weight: bold;
                            color: black;
                            text-align: right;
                            font-size: 12px;
                        }
                        
                        /* Header della tabella */
                        .wine-header-row {
                            display: grid;
                            grid-template-columns: 2fr 1fr 0.5fr 0.8fr 0.5fr 0.8fr;
                            gap: 8px;
                            padding: 8px 0;
                            border-bottom: 2px solid black;
                            font-weight: bold;
                            font-size: 11px;
                            color: black;
                            background-color: #e0e0e0;
                        }
                        
                        .wine-header-row > div {
                            text-align: center;
                        }
                        
                        .wine-header-row > div:first-child {
                            text-align: left;
                        }
                        
                        .wine-header-row > div:last-child {
                            text-align: right;
                        }
                        
                        /* Footer compatto */
                        .wine-footer {
                            margin-top: 20px;
                            text-align: center;
                            font-size: 10px;
                            color: black;
                            border-top: 1px solid black;
                            padding-top: 10px;
                        }
                        
                        .wine-footer p {
                            margin: 2px 0;
                        }
                        
                        /* Page breaks */
                        .page-break {
                            page-break-before: always;
                        }
                        
                        /* Print styles ottimizzati */
                        @media print {
                            body {
                                margin: 0;
                                padding: 10px;
                                background: white;
                                color: black;
                            }
                            
                            .print-wine-list {
                                max-width: none;
                            }
                            
                            .wine-item {
                                page-break-inside: avoid;
                            }
                            
                            .wine-category {
                                page-break-inside: avoid;
                            }
                            
                            /* Assicura che tutto sia in bianco e nero */
                            * {
                                color: black !important;
                                background: white !important;
                                border-color: black !important;
                            }
                        }
                        
                                /* Responsive per schermi piccoli */
        @media (max-width: 600px) {
            .wine-item {
                grid-template-columns: 1fr;
                gap: 2px;
                padding: 4px 0;
            }
            
            .wine-header-row {
                display: none;
            }
        }
        
        /* Stili per lo slider delle tabelle */
        .table-slider-container {
            position: relative;
            margin: 20px 0;
        }
        
        .slider-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .slider-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .slider-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }
        
        .slider-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .slider-indicator {
            font-weight: bold;
            color: #333;
            min-width: 60px;
            text-align: center;
        }
        
        .table-wrapper {
            overflow-x: auto;
            overflow-y: hidden;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-width: 100%;
            position: relative;
            width: 100%;
        }
        
        /* Assicura che le tabelle mantengano la loro larghezza minima */
        .table-wrapper .data-table {
            margin-top: 0;
            border-radius: 0;
            min-width: 100%;
        }
        
        /* Stili per il nuovo contenitore delle tabelle */
        .table-container {
            margin: 20px 0;
            position: relative;
        }
        
        /* Sistema responsive completo */
        @media (max-width: 1200px) {
            .container {
                margin: 10px;
                padding: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .form-grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 15px;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                margin: 5px;
                border-radius: 10px;
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .header p {
                font-size: 1em;
            }
            
            .nav-tabs {
                flex-direction: row;
                overflow-x: auto;
                padding: 0 10px;
            }
            
            .nav-tab {
                flex: 0 0 auto;
                min-width: 100px;
                padding: 12px 15px;
                font-size: 14px;
            }
            
            .tab-content {
                padding: 15px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 10px 12px;
                font-size: 14px;
            }
            
            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }
            
            .table-container {
                margin: 10px 0;
            }
            
            .table-wrapper {
                border-radius: 4px;
                overflow-x: auto;
            }
            
            .data-table {
                font-size: 12px;
                min-width: 600px;
            }
            
            .data-table th,
            .data-table td {
                padding: 6px 4px;
                font-size: 11px;
            }
            
            .data-table td:last-child .btn {
                padding: 3px 5px;
                font-size: 10px;
                margin: 1px;
            }
            
            .actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .actions .btn {
                width: 100%;
                margin: 2px 0;
            }
            
            .export-section {
                padding: 15px;
            }
            
            .export-section h4 {
                font-size: 16px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .container {
                margin: 2px;
                border-radius: 8px;
            }
            
            .header {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .header p {
                font-size: 0.9em;
            }
            
            .nav-tabs {
                padding: 0 5px;
            }
            
            .nav-tab {
                min-width: 80px;
                padding: 10px 12px;
                font-size: 12px;
            }
            
            .tab-content {
                padding: 10px;
            }
            
            .form-grid {
                gap: 8px;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 8px 10px;
                font-size: 13px;
            }
            
            .btn {
                padding: 8px 16px;
                font-size: 13px;
            }
            
            .data-table {
                font-size: 11px;
                min-width: 500px;
            }
            
            .data-table th,
            .data-table td {
                padding: 4px 3px;
                font-size: 10px;
            }
            
            .data-table td:last-child .btn {
                padding: 2px 4px;
                font-size: 9px;
            }
            
            .actions {
                gap: 5px;
            }
            
            .actions .btn {
                padding: 6px 12px;
                font-size: 12px;
            }
        }
        
        /* Gestione per schermi molto piccoli */
        @media (max-width: 360px) {
            body {
                padding: 2px;
            }
            
            .container {
                margin: 1px;
                border-radius: 6px;
            }
            
            .header {
                padding: 8px;
            }
            
            .header h1 {
                font-size: 1.3em;
            }
            
            .header p {
                font-size: 0.8em;
            }
            
            .nav-tabs {
                padding: 0 2px;
            }
            
            .nav-tab {
                min-width: 70px;
                padding: 8px 10px;
                font-size: 11px;
            }
            
            .tab-content {
                padding: 8px;
            }
            
            .form-grid {
                gap: 6px;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 6px 8px;
                font-size: 12px;
            }
            
            .btn {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .data-table {
                font-size: 10px;
                min-width: 400px;
            }
            
            .data-table th,
            .data-table td {
                padding: 3px 2px;
                font-size: 9px;
            }
            
            .data-table td:last-child .btn {
                padding: 1px 3px;
                font-size: 8px;
            }
            
            .actions {
                gap: 3px;
            }
            
            .actions .btn {
                padding: 4px 8px;
                font-size: 11px;
            }
        }
        
        /* Indicatori di scroll per le tabelle */
        .table-wrapper.has-scroll::before,
        .table-wrapper.has-scroll::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 20px;
            pointer-events: none;
            z-index: 5;
            transition: opacity 0.3s ease;
        }
        
        /* Miglioramenti per dispositivi touch */
        @media (hover: none) and (pointer: coarse) {
            .table-wrapper {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }
            
            .data-table th,
            .data-table td {
                min-height: 44px; /* Altezza minima per touch */
                display: flex;
                align-items: center;
            }
            
            .btn {
                min-height: 44px;
                min-width: 44px;
            }
            
            .nav-tab {
                min-height: 44px;
            }
        }
        
        /* Gestione per schermi orizzontali */
        @media (orientation: landscape) and (max-height: 600px) {
            .header {
                padding: 10px 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
                margin-bottom: 5px;
            }
            
            .header p {
                font-size: 0.9em;
                margin: 0;
            }
            
            .tab-content {
                padding: 15px;
            }
            
            .form-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 10px;
            }
            
            .data-table {
                font-size: 11px;
            }
            
            .data-table th,
            .data-table td {
                padding: 6px 8px;
            }
        }
        
        /* Gestione per schermi molto grandi */
        @media (min-width: 1400px) {
            .container {
                max-width: 1400px;
            }
            
            .form-grid {
                grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
                gap: 25px;
            }
            
            .data-table {
                font-size: 16px;
            }
            
            .data-table th,
            .data-table td {
                padding: 15px 20px;
            }
            
            .btn {
                padding: 15px 30px;
                font-size: 18px;
            }
        }
        
        /* Gestione per schermi ultra-wide */
        @media (min-width: 1920px) {
            .container {
                max-width: 1800px;
            }
            
            .form-grid {
                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
                gap: 30px;
            }
            
            .data-table {
                font-size: 18px;
            }
            
            .data-table th,
            .data-table td {
                padding: 18px 25px;
            }
            
            .btn {
                padding: 18px 35px;
                font-size: 20px;
            }
        }
        
        .table-wrapper.has-scroll::before {
            left: 0;
            background: linear-gradient(to right, rgba(255,255,255,0.9), transparent);
            opacity: 0;
        }
        
        .table-wrapper.has-scroll::after {
            right: 0;
            background: linear-gradient(to left, rgba(255,255,255,0.9), transparent);
            opacity: 0;
        }
        
        .table-wrapper.scrolled-left::before {
            opacity: 1;
        }
        
        .table-wrapper.scrolled-right::after {
            opacity: 1;
        }
        
        .table-wrapper::-webkit-scrollbar {
            height: 8px;
        }
        
        .table-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .table-wrapper::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Responsive per lo slider */
        @media (max-width: 768px) {
            .slider-controls {
                margin-bottom: 10px;
            }
            
            .slider-btn {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
            
            .slider-indicator {
                font-size: 14px;
            }
        }
        
        /* Miglioramenti per nav-tabs su schermi molto piccoli */
        @media (max-width: 480px) {
            .nav-tabs {
                padding: 0 10px;
            }
            
            .nav-tab {
                min-width: 100px;
                padding: 12px 15px;
                font-size: 14px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .header p {
                font-size: 1em;
            }
        }
        
        /* Miglioramenti per schermi piccoli - mantieni scroll orizzontale */
        @media (max-width: 600px) {
            .table-slider-container {
                margin: 15px 0;
            }
            
            .slider-controls {
                margin-bottom: 10px;
                padding: 8px;
            }
            
            .slider-btn {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
            
            .slider-indicator {
                font-size: 12px;
                min-width: 50px;
            }
            
            .data-table {
                font-size: 11px;
            }
            
            .data-table th,
            .data-table td {
                padding: 6px 4px;
                white-space: nowrap;
            }
            
            .btn-sm {
                padding: 4px 6px;
                font-size: 11px;
            }
            
            /* Nascondi le card mobile */
            .mobile-cards {
                display: none;
            }
        }

        /* Ottimizzazioni CSS per performance */
        .data-table {
            contain: layout style paint;
        }
        
        .nav-tabs {
            contain: layout style;
        }
        
        .tab-content {
            contain: layout style paint;
        }

        /* Ottimizzazione: Riduzione reflow per animazioni */
        .btn {
            will-change: transform;
        }
        
        .nav-tab {
            will-change: background-color, color;
        }

        /* Ottimizzazione: Lazy loading per immagini future */
        .lazy-image {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .lazy-image.loaded {
            opacity: 1;
        }

        /* ===== SEZIONE BENVENUTO MODERNA ===== */
        .modern-welcome-section {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }

        /* Hero Section */
        .hero-section {
            position: relative;
            padding: 60px 20px;
            text-align: center;
            color: white;
            min-height: 60vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hero-background {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 1;
        }

        .gradient-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.8), rgba(118, 75, 162, 0.8));
            z-index: 2;
        }

        .floating-elements {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 3;
            overflow: hidden;
        }

        .floating-icon {
            position: absolute;
            font-size: 3rem;
            opacity: 0.1;
            animation: float 6s ease-in-out infinite;
        }

        .floating-icon:nth-child(1) { top: 10%; left: 10%; animation-delay: 0s; }
        .floating-icon:nth-child(2) { top: 20%; right: 15%; animation-delay: 2s; }
        .floating-icon:nth-child(3) { bottom: 30%; left: 20%; animation-delay: 4s; }
        .floating-icon:nth-child(4) { bottom: 20%; right: 10%; animation-delay: 1s; }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .hero-content {
            position: relative;
            z-index: 4;
            max-width: 800px;
            margin: 0 auto;
        }

        .welcome-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .badge-icon {
            font-size: 1.2rem;
        }

        .badge-text {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .hero-title {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 15px;
            line-height: 1.2;
        }

        .highlight {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero-subtitle {
            font-size: 1.3rem;
            margin-bottom: 40px;
            opacity: 0.9;
        }

        .hero-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 120px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }

        .stat-number {
            display: block;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Actions Section */
        .actions-section {
            padding: 60px 20px;
            background: white;
            position: relative;
        }

        .section-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .section-header h2 {
            font-size: 2.5rem;
            color: #333;
            margin-bottom: 10px;
        }

        .section-header p {
            font-size: 1.1rem;
            color: #666;
        }

        .action-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .action-card {
            position: relative;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .action-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .action-card.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .action-card.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .card-glow {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .action-card:hover .card-glow {
            transform: translateX(100%);
        }

        .card-content {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .card-icon {
            position: relative;
            flex-shrink: 0;
        }

        .icon-emoji {
            font-size: 3rem;
            position: relative;
            z-index: 2;
        }

        .icon-background {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            z-index: 1;
        }

        .card-info {
            flex: 1;
        }

        .card-info h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .card-info p {
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .card-stats {
            display: flex;
            gap: 20px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .card-action {
            flex-shrink: 0;
        }

        .modern-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .modern-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .arrow-icon {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
            transition: transform 0.3s ease;
        }

        .modern-btn:hover .arrow-icon {
            transform: translateX(3px);
        }

        /* Quick Actions Section */
        .quick-actions-section {
            padding: 60px 20px;
            background: #f8f9fa;
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .quick-action-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .quick-action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .action-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .action-content {
            flex: 1;
        }

        .action-content h4 {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 5px;
        }

        .action-content p {
            color: #666;
            font-size: 0.9rem;
            margin: 0;
        }

        .action-arrow {
            font-size: 1.2rem;
            color: #667eea;
            transition: transform 0.3s ease;
        }

        .quick-action-card:hover .action-arrow {
            transform: translateX(5px);
        }

        /* Info Section */
        .info-section {
            padding: 40px 20px;
            background: white;
        }

        .info-card {
            max-width: 800px;
            margin: 0 auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .info-icon {
            font-size: 2.5rem;
            flex-shrink: 0;
        }

        .info-content h4 {
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        .info-content p {
            opacity: 0.9;
            line-height: 1.6;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .hero-title {
                font-size: 2.5rem;
            }

            .hero-stats {
                flex-direction: column;
                align-items: center;
            }

            .action-cards {
                grid-template-columns: 1fr;
            }

            .card-content {
                flex-direction: column;
                text-align: center;
            }

            .quick-actions-grid {
                grid-template-columns: 1fr;
            }

            .info-card {
                flex-direction: column;
                text-align: center;
            }
        }

        /* Stili legacy per compatibilit√† */
        .welcome-section {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .guest-note p {
            margin: 0;
            color: #856404;
            font-size: 1.1em;
        }

        /* Dashboard Styles - Modern Redesign */
        .dashboard-container {
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 30px;
            background: linear-gradient(135deg, #1a5f3a 0%, #2d5a3d 50%, #1a5f3a 100%);
            color: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(26, 95, 58, 0.3);
            position: relative;
            overflow: hidden;
        }

        .dashboard-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            pointer-events: none;
        }

        .dashboard-header h2 {
            margin: 0 0 15px 0;
            font-size: 2.5em;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }

        .dashboard-header p {
            margin: 0;
            opacity: 0.95;
            font-size: 1.2em;
            font-weight: 300;
            position: relative;
            z-index: 1;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255,255,255,0.8);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #1a5f3a, #2d5a3d, #1a5f3a);
            background-size: 200% 100%;
            animation: shimmer 2s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }

        .stat-icon {
            font-size: 3em;
            margin-right: 25px;
            color: #1a5f3a;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        .stat-content h3 {
            margin: 0 0 8px 0;
            font-size: 2.2em;
            color: #2c3e50;
            font-weight: 700;
        }

        .stat-content p {
            margin: 0;
            color: #7f8c8d;
            font-weight: 600;
            font-size: 1.1em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 35px;
            margin-bottom: 40px;
        }

        .chart-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            border: 1px solid rgba(255,255,255,0.8);
            transition: transform 0.3s ease;
        }

        .chart-section:hover {
            transform: translateY(-3px);
        }

        .chart-section h3 {
            margin: 0 0 25px 0;
            color: #2c3e50;
            font-size: 1.4em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-section h3::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, #1a5f3a, #2d5a3d);
            border-radius: 2px;
        }

        .chart-wrapper {
            position: relative;
            height: 350px;
            border-radius: 15px;
            overflow: hidden;
        }

        .news-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            border: 1px solid rgba(255,255,255,0.8);
            margin-bottom: 30px;
        }

        .news-section h3 {
            margin: 0 0 25px 0;
            color: #2c3e50;
            font-size: 1.4em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .news-section h3::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, #1a5f3a, #2d5a3d);
            border-radius: 2px;
        }

        .news-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .news-source-indicator {
            background: linear-gradient(135deg, #1a5f3a, #2d5a3d);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            box-shadow: 0 3px 10px rgba(26, 95, 58, 0.3);
        }

        .news-container {
            max-height: 600px;
            overflow-y: auto;
            border-radius: 15px;
            background: rgba(255,255,255,0.5);
        }

        .news-item {
            border-bottom: 1px solid rgba(0,0,0,0.08);
            padding: 0;
            transition: all 0.3s ease;
            border-radius: 15px;
            margin: 15px 0;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .news-item:hover {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .news-item:last-child {
            border-bottom: none;
        }

        .news-content {
            display: flex;
            align-items: stretch;
            min-height: 120px;
        }

        .news-image {
            flex: 0 0 200px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .news-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .news-item:hover .news-image img {
            transform: scale(1.05);
        }

        .news-text {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .news-item:not(:has(.news-image)) .news-text {
            padding: 25px;
        }

        .news-title {
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 1.1em;
            line-height: 1.4;
        }

        .news-title a {
            color: #1a5f3a;
            text-decoration: none;
            transition: color 0.3s ease;
            display: block;
        }

        .news-title a:hover {
            color: #2d5a3d;
            text-decoration: underline;
        }

        .news-description {
            color: #5a6c7d;
            margin-bottom: 15px;
            line-height: 1.6;
            font-size: 0.95em;
            flex: 1;
        }

        .news-meta {
            font-size: 0.9em;
            color: #95a5a6;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .news-meta::before {
            content: 'üïí';
            font-size: 0.8em;
        }

        .loading-news {
            text-align: center;
            padding: 60px 40px;
            color: #7f8c8d;
            font-style: italic;
            font-size: 1.1em;
        }

        /* Filtri e Controlli Moderni */
        .filters-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            border: 1px solid rgba(255,255,255,0.8);
        }

        .filters-section h3 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 1.4em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filters-section h3::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, #1a5f3a, #2d5a3d);
            border-radius: 2px;
        }

        .filter-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #1a5f3a;
            color: #1a5f3a;
            border-radius: 25px;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-outline:hover {
            background: linear-gradient(135deg, #1a5f3a, #2d5a3d);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 95, 58, 0.3);
        }

        .btn-outline.active {
            background: linear-gradient(135deg, #1a5f3a, #2d5a3d);
            color: white;
            box-shadow: 0 5px 15px rgba(26, 95, 58, 0.3);
        }

        /* Animazioni Dashboard */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .news-date {
            color: #95a5a6;
            font-weight: 500;
        }

        .news-source {
            color: #1a5f3a;
            font-weight: 600;
            margin-left: 15px;
            padding: 2px 8px;
            background: rgba(26, 95, 58, 0.1);
            border-radius: 12px;
            font-size: 0.8em;
        }

        /* Responsive per le notizie */
        @media (max-width: 768px) {
            .news-content {
                flex-direction: column;
                min-height: auto;
            }

            .news-image {
                flex: 0 0 150px;
                width: 100%;
            }

            .news-text {
                padding: 15px;
            }

            .news-title {
                font-size: 1em;
            }

            .news-description {
                font-size: 0.9em;
            }

            .news-meta {
                flex-direction: column;
                gap: 5px;
                align-items: flex-start;
            }
        }

        /* Stili per gestione stati fatture */
        .stato-actions {
            display: flex;
            gap: 2px;
            flex-wrap: wrap;
        }

        .stato-actions .btn-xs {
            padding: 2px 6px;
            font-size: 0.7em;
            min-width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stato-actions .btn-xs:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-paid {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .status-pending {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: white;
        }

        .status-overdue {
            background: linear-gradient(135deg, #dc3545, #e83e8c);
            color: white;
        }

        /* Stili per sezione benvenuto ospiti */
        .guest-only {
            display: none;
        }

        .guest-only.active {
            display: block;
        }

        /* Nascondi tab benvenuto per admin */
        .nav-tab.guest-only {
            display: none !important;
        }

        /* Mostra tab benvenuto solo per ospiti */
        .nav-tab.guest-only.active {
            display: block !important;
        }

        /* Forza nascondere tab benvenuto per admin */
        body:not(.guest-mode) .nav-tab.guest-only {
            display: none !important;
        }

        /* Mostra tab benvenuto solo in modalit√† ospite */
        body.guest-mode .nav-tab.guest-only.active {
            display: block !important;
        }

        /* Nascondi tab admin-only per ospiti */
        body.guest-mode .nav-tab.admin-only {
            display: none !important;
        }

        /* Mostra tab admin-only solo per admin */
        body:not(.guest-mode) .nav-tab.admin-only {
            display: block !important;
        }

        /* Nascondi sezioni admin-only per ospiti */
        body.guest-mode .tab-content.admin-only {
            display: none !important;
        }

        /* Mostra sezioni admin-only solo per admin */
        body:not(.guest-mode) .tab-content.admin-only {
            display: block !important;
        }

        /* Forza visibilit√† tab admin-only per admin */
        body:not(.guest-mode) .nav-tab.admin-only {
            display: block !important;
        }

        /* Assicurati che le tab admin siano visibili per Tommaso */
        .nav-tab.admin-only[style*="display: none"] {
            display: block !important;
        }

        .welcome-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 30px;
            margin: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        }

        .welcome-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .welcome-header h2 {
            color: #1a5f3a;
            margin-bottom: 10px;
        }

        .welcome-subtitle {
            color: #6c757d;
            font-style: italic;
        }

        .welcome-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .welcome-info {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .guest-features ul {
            list-style: none;
            padding: 0;
        }

        .guest-features li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .guest-features li:last-child {
            border-bottom: none;
        }

        .welcome-menu {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .menu-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .menu-card {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: #1a5f3a;
        }

        .menu-card-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .menu-card h4 {
            color: #1a5f3a;
            margin-bottom: 10px;
        }

        .menu-card p {
            color: #6c757d;
            margin-bottom: 15px;
        }

        .menu-card-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-item strong {
            display: block;
            font-size: 1.5em;
            color: #1a5f3a;
        }

        .stat-item small {
            color: #6c757d;
            font-size: 0.8em;
        }

        .menu-card-btn {
            width: 100%;
            margin-top: 10px;
        }

        .welcome-footer {
            grid-column: 1 / -1;
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-top: 20px;
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .guest-note {
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            color: #856404;
        }

        /* Responsive per sezione benvenuto */
        @media (max-width: 768px) {
            .welcome-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .menu-cards {
                grid-template-columns: 1fr;
            }

            .welcome-section {
                margin: 10px;
                padding: 20px;
            }
        }

        /* Widget Grid Styles */
        .widgets-container {
            margin-bottom: 40px;
        }

        .widget-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            border: 1px solid rgba(255,255,255,0.8);
        }

        .widget-section h3 {
            margin: 0 0 25px 0;
            color: #2c3e50;
            font-size: 1.4em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .widget-section h3::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, #1a5f3a, #2d5a3d);
            border-radius: 2px;
        }

        .widget-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .widget-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .widget-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .widget-icon {
            font-size: 2em;
            color: #1a5f3a;
        }

        .widget-content h4 {
            margin: 0 0 5px 0;
            color: #2c3e50;
            font-weight: 600;
            font-size: 1em;
        }

        .widget-content p {
            margin: 0;
            color: #7f8c8d;
            font-weight: 500;
            font-size: 0.9em;
        }

        /* Widget Styles */
        .widgets-container {
            margin-bottom: 30px;
        }

        .widget-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .widget-section h3 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 1.3em;
        }

        .widget-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .widget-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            transition: transform 0.3s ease;
        }

        .widget-card:hover {
            transform: translateY(-2px);
        }

        .widget-icon {
            font-size: 1.5em;
            margin-right: 15px;
            color: #1a5f3a;
        }

        .widget-content h4 {
            margin: 0 0 5px 0;
            font-size: 1em;
            color: #333;
        }

        .widget-content p {
            margin: 0;
            font-size: 0.9em;
            color: #666;
        }

        /* News Controls */
        .news-controls {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .news-source-indicator {
            margin-left: auto;
            font-size: 0.85em;
            color: #666;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .news-source-indicator span {
            font-weight: 600;
            color: #1a5f3a;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .chart-wrapper {
                height: 250px;
            }
            
            .widget-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-controls {
                justify-content: center;
            }
        }

        /* Responsive per la scheda di benvenuto */
        @media (max-width: 768px) {
            .welcome-header h2 {
                font-size: 2em;
            }
            
            .menu-cards {
                grid-template-columns: 1fr;
            }
            
            .quick-actions-grid {
                grid-template-columns: 1fr;
            }
            
            .welcome-section {
                padding: 10px;
            }
        }

        /* Nascondi elementi admin per ospiti */
        .admin-only {
            display: none !important;
        }

        .guest-only {
            display: block !important;
        }
        
        .nav-tab.hidden-for-guest {
            display: none !important;
        }

        // Ottimizzazione: Gestione eventi con cleanup
        function addEventListeners() {
            // Event listeners per filtri vini
            const filterInputs = ['filterNome', 'filterProduttore', 'filterRegione', 'filterVitigno'];
            filterInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', debouncedApplyFilters);
                }
            });
            
            // Event listeners per select
            const filterSelects = ['filterTipologia', 'filterStock'];
            filterSelects.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', applyViniFilters);
                }
            });
            
            // Event listeners per filtri prodotti
            const filterInputsProdotti = ['filterNomeProdotti', 'filterMarca', 'filterFornitore'];
            filterInputsProdotti.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', debouncedApplyProdottiFilters);
                }
            });
            
            const filterSelectsProdotti = ['filterCategoriaPrincipale', 'filterStockProdotti', 'filterPrezzo'];
            filterSelectsProdotti.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', applyProdottiFilters);
                }
            });
        }

        // Ottimizzazione: Cleanup event listeners
        function removeEventListeners() {
            const filterInputs = ['filterNome', 'filterProduttore', 'filterRegione', 'filterVitigno'];
            filterInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.removeEventListener('input', debouncedApplyFilters);
                }
            });
            
            const filterSelects = ['filterTipologia', 'filterStock'];
            filterSelects.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.removeEventListener('change', applyViniFilters);
                }
            });
        }

        // Funzioni per il sistema di login
        function showLoginModal() {
            const overlay = document.getElementById('loginOverlay');
            const usernameInput = document.getElementById('loginUsername');
            overlay.style.display = 'flex';
            usernameInput.focus();
            usernameInput.value = '';
            document.getElementById('loginPassword').value = '';
        }

        function hideLoginModal() {
            const overlay = document.getElementById('loginOverlay');
            overlay.style.display = 'none';
        }

        function handleLoginPassword(event) {
            if (event.key === 'Enter') {
                validateLogin();
            }
        }

        function validateLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (username === 'Tommaso' && password === 'Tommy123') {
                currentUser = 'admin';
                isLoggedIn = true;
                hideLoginModal();
                showAdminInterface();
                showNotification('üîì Accesso amministratore effettuato!', 'success');
            } else {
                showNotification('‚ùå Credenziali errate!', 'error');
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginPassword').focus();
            }
        }

        function guestLogin() {
            currentUser = 'guest';
            isLoggedIn = true;
            hideLoginModal();
            showGuestInterface();
            showNotification('üë§ Accesso cliente effettuato!', 'success');
        }

        function showAdminInterface() {
            // Rimuovi classe guest-mode dal body
            document.body.classList.remove('guest-mode');
            
            // Forza la visibilit√† delle tab admin-only
            const adminTabs = document.querySelectorAll('.nav-tab.admin-only');
            adminTabs.forEach(tab => {
                tab.style.display = 'block';
                tab.classList.remove('hidden-for-guest');
                tab.classList.add('admin-only');
            });
            
            // Ripristina l'ordine originale delle schede per admin
            restoreOriginalTabOrder();
            
            // Nascondi IMMEDIATAMENTE la tab benvenuto per admin
            const benvenutoTabElement = document.querySelector('.nav-tab[onclick="showTab(\'benvenuto\')"]');
            if (benvenutoTabElement) {
                benvenutoTabElement.style.display = 'none';
                benvenutoTabElement.classList.remove('active');
                benvenutoTabElement.classList.add('guest-only');
            }
            
            // Mostra tutte le sezioni per l'admin (tranne benvenuto)
            document.querySelectorAll('.nav-tab').forEach(tab => {
                if (!tab.classList.contains('guest-only')) {
                    tab.style.display = 'block';
                    tab.classList.remove('hidden-for-guest');
                }
                // Mostra specificamente le tab admin-only
                if (tab.classList.contains('admin-only')) {
                    tab.style.display = 'block';
                    tab.classList.remove('hidden-for-guest');
                }
            });
            
            // Mostra la tab dashboard per Tommaso
            const dashboardTab = document.querySelector('.nav-tab[onclick="showTab(\'dashboard\')"]');
            if (dashboardTab) dashboardTab.style.display = 'block';
            
            // Nascondi specificamente la sezione benvenuto per admin
            const benvenutoSection = document.getElementById('benvenuto');
            if (benvenutoSection) {
                benvenutoSection.style.display = 'none';
                benvenutoSection.classList.remove('active');
                benvenutoSection.classList.remove('guest-only');
            }
            
            document.getElementById('securityToggle').style.display = 'block';
            
            // Mostra form di inserimento per admin
            const formSections = document.querySelectorAll('.form-section');
            formSections.forEach(section => {
                section.style.display = 'block';
            });
            
            // Mostra tutti i pulsanti per admin
            const actionButtons = document.querySelectorAll('.actions');
            actionButtons.forEach(actions => {
                const buttons = actions.querySelectorAll('.btn');
                buttons.forEach(button => {
                    button.style.display = 'inline-block';
                });
            });
            
            // Mostra intestazioni prezzi di acquisto per admin
            const prezzoAcquistoHeaders = document.querySelectorAll('#prezzoAcquistoHeaderProdotti, #prezzoAcquistoHeaderVini');
            prezzoAcquistoHeaders.forEach(header => {
                header.style.display = 'table-cell';
                header.classList.remove('hidden-for-guest');
            });
            
            // Mostra celle prezzi di acquisto nelle tabelle
            showPurchasePricesForAdmin();
            
            // Mostra info utente
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('currentUserDisplay').textContent = 'üë®‚Äçüíº Amministratore: Tommaso';
            
            // Mostra la dashboard di default per Tommaso
            showTab('dashboard');
            
            // Aggiorna l'interfaccia
            updateSecurityToggle();
            updateAllTables();
            
            // Carica la dashboard per Tommaso
            loadTommasoDashboard();
            
            // Inizializza l'aggiornamento automatico
            initializeDashboardAutoUpdate();
            
            // Inizializza la gestione stati fatture
            initializeStatoFatture();
            
            // Nascondi la tab benvenuto per admin
            hideBenvenutoTabForAdmin();
            
            // Avvia il monitoraggio della tab benvenuto per admin
            monitorBenvenutoTabForAdmin();
            
            // Mostra le tab admin-only per Tommaso
            showAdminTabsForTommaso();
            
            // Inizializza correttamente le schede
            initializeTabsCorrectly();
        }

        function showGuestInterface() {
            // Aggiungi classe guest-mode al body
            document.body.classList.add('guest-mode');
            
            // Nascondi completamente tab admin-only per ospiti
            const clientiTab = document.querySelector('.nav-tab[onclick="showTab(\'clienti\')"]');
            const fattureTab = document.querySelector('.nav-tab[onclick="showTab(\'fatture\')"]');
            const dashboardTab = document.querySelector('.nav-tab[onclick="showTab(\'dashboard\')"]');
            
            if (clientiTab) {
                clientiTab.style.display = 'none';
                clientiTab.classList.add('hidden-for-guest');
            }
            if (fattureTab) {
                fattureTab.style.display = 'none';
                fattureTab.classList.add('hidden-for-guest');
            }
            if (dashboardTab) {
                dashboardTab.style.display = 'none';
                dashboardTab.classList.add('hidden-for-guest');
            }
            
            // Mostra scheda di benvenuto per ospiti
            const benvenutoTab = document.querySelector('.nav-tab[onclick="showTab(\'benvenuto\')"]');
            if (benvenutoTab) {
                benvenutoTab.style.display = 'block';
                benvenutoTab.classList.add('guest-only');
                benvenutoTab.classList.add('active');
            }
            
                                        // Mostra la sezione benvenuto per ospiti
            const benvenutoSection = document.getElementById('benvenuto');
            if (benvenutoSection) {
                benvenutoSection.style.display = 'block';
                benvenutoSection.classList.add('guest-only');
                benvenutoSection.classList.add('active');
                // Aggiorna le statistiche della sezione benvenuto
                setTimeout(() => {
                    updateWelcomeStats();
                }, 100);
            }
            
            // Riorganizza l'ordine delle schede per ospiti: Benvenuto, Prodotti, Vini
            organizeTabsForGuest();
            
            // Nascondi pulsante sicurezza
            document.getElementById('securityToggle').style.display = 'none';
            
            // Nascondi form di inserimento per prodotti e vini
            const formSections = document.querySelectorAll('.form-section');
            formSections.forEach(section => {
                section.style.display = 'none';
            });
            
            // Nascondi pulsanti di aggiunta e import/export per clienti
            const actionButtons = document.querySelectorAll('.actions');
            actionButtons.forEach(actions => {
                const buttons = actions.querySelectorAll('.btn');
                buttons.forEach(button => {
                    if (button.textContent.includes('‚ûï') || 
                        button.textContent.includes('üì•') || 
                        button.textContent.includes('üìä')) {
                        button.style.display = 'none';
                    }
                });
            });
            
            // Nascondi completamente prezzi di acquisto per clienti
            hidePurchasePricesForGuests();
            
            // Mostra info utente
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('currentUserDisplay').textContent = 'üë§ Cliente';
            
            // Disattiva la censura per i clienti (mostra sempre i prezzi)
            isSecurityActive = false;
            isSecurityUnlocked = true;
            
            // Aggiorna le tabelle
            updateAllTables();
            
            // Attiva la modalit√† ospite
            setupGuestMode();
            
            // Verifica che tutto sia corretto
            setTimeout(() => {
                verifyGuestMode();
            }, 500);
        }

        function logout() {
            currentUser = null;
            isLoggedIn = false;
            
            // Ferma tutti i monitoraggi
            stopAllMonitoring();
            
            // Rimuovi classe guest-mode dal body
            document.body.classList.remove('guest-mode');
            
            // Nascondi info utente
            document.getElementById('userInfo').style.display = 'none';
            
            // Nascondi tutte le tab
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Nascondi dashboard per tutti
            const dashboardTab = document.querySelector('.nav-tab[onclick="showTab(\'dashboard\')"]');
            if (dashboardTab) dashboardTab.style.display = 'none';
            
            // Reset modalit√† ospite
            document.querySelectorAll('.guest-only').forEach(el => {
                el.style.display = 'none';
            });
            
            // Nascondi specificamente la sezione benvenuto
            const benvenutoSection = document.getElementById('benvenuto');
            if (benvenutoSection) {
                benvenutoSection.style.display = 'none';
                benvenutoSection.classList.remove('guest-only');
            }
            
            // Nascondi specificamente la tab benvenuto
            const benvenutoTab = document.querySelector('.nav-tab[onclick="showTab(\'benvenuto\')"]');
            if (benvenutoTab) {
                benvenutoTab.style.display = 'none';
                benvenutoTab.classList.remove('active');
                benvenutoTab.classList.add('guest-only');
            }
            
            // Rimuovi note per ospiti
            document.querySelectorAll('.guest-note').forEach(note => {
                note.remove();
            });
            
            // Ripristina l'ordine originale delle schede
            restoreOriginalTabOrder();
            
            showLoginModal();
            showNotification('üëã Logout effettuato!', 'info');
        }
        
        // Aggiorna indicatore sincronizzazione
        function updateSyncIndicator() {
            const indicator = document.getElementById('syncIndicator');
            if (isOnline) {
                indicator.textContent = 'üîÑ Sincronizzazione attiva';
                indicator.style.color = '#28a745';
            } else {
                indicator.textContent = 'üì° Modalit√† offline';
                indicator.style.color = '#ffc107';
            }
        }

        // Mostra statistiche sincronizzazione
        function showSyncStats() {
            const stats = {
                clienti: clienti.length,
                documenti: documenti.length,
                prodotti: prodotti.length,
                vini: vini.length,
                lastSync: localStorage.getItem('tommy_last_sync'),
                deviceId: deviceId,
                isOnline: isOnline,
                backupCount: Object.keys(localStorage).filter(key => key.startsWith('tommy_backup_')).length
            };
            
            console.log('üìä Statistiche sincronizzazione:', stats);
            
            const message = `
                üìä Statistiche Sincronizzazione:
                
                üìã Dati:
                ‚Ä¢ Clienti: ${stats.clienti}
                ‚Ä¢ Documenti: ${stats.documenti}
                ‚Ä¢ Prodotti: ${stats.prodotti}
                ‚Ä¢ Vini: ${stats.vini}
                
                üîÑ Sincronizzazione:
                ‚Ä¢ Stato: ${stats.isOnline ? 'üåê Online' : 'üì° Offline'}
                ‚Ä¢ Ultimo sync: ${stats.lastSync ? new Date(parseInt(stats.lastSync)).toLocaleString() : 'Mai'}
                ‚Ä¢ Device ID: ${stats.deviceId}
                ‚Ä¢ Backup disponibili: ${stats.backupCount}
            `;
            
            alert(message);
        }
        
        // Funzione per forzare la sincronizzazione
        async function forceSync() {
            try {
                showLoading(true);
                console.log('üîÑ Avvio sincronizzazione forzata...');
                
                // Verifica integrit√† dati prima del sync
                verifyDataIntegrity();
                
                // Controlla aggiornamenti dal cloud
                const hasUpdates = await forceSyncOnStartup();
                
                // Salva i dati locali
                saveDataToStorage();
                
                // Crea backup
                createBackup();
                
                if (hasUpdates) {
                    showNotification('üîÑ Sincronizzazione completata con aggiornamenti!', 'success');
                } else {
                    showNotification('üîÑ Sincronizzazione completata!', 'success');
                }
                
                // Mostra statistiche
                showSyncStats();
                
            } catch (error) {
                console.error('‚ùå Errore nella sincronizzazione forzata:', error);
                showNotification('‚ùå Errore nella sincronizzazione', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Funzioni per configurazione GitHub
        function showGitHubConfig() {
            const overlay = document.getElementById('githubConfigOverlay');
            const tokenInput = document.getElementById('githubToken');
            const gistInput = document.getElementById('gistId');
            const enabledCheckbox = document.getElementById('githubEnabled');
            
            overlay.style.display = 'flex';
            tokenInput.focus();
            
            // Precompila i campi con i valori salvati
            tokenInput.value = GITHUB_CONFIG.token;
            gistInput.value = GITHUB_CONFIG.gistId;
            enabledCheckbox.checked = GITHUB_CONFIG.enabled;
        }

        // Funzioni per configurazione GitHub obbligatoria all'avvio
        function showGitHubSetup() {
            const overlay = document.getElementById('githubSetupOverlay');
            const tokenInput = document.getElementById('githubTokenSetup');
            const gistInput = document.getElementById('gistIdSetup');
            
            overlay.style.display = 'flex';
            tokenInput.focus();
            
            // Precompila il Gist ID con quello pre-configurato
            gistInput.value = 'ed140f6366c097f54410d096017bb51b';
        }

        function hideGitHubSetup() {
            const overlay = document.getElementById('githubSetupOverlay');
            overlay.style.display = 'none';
        }

        function saveGitHubSetup() {
            const token = document.getElementById('githubTokenSetup').value.trim();
            const gistId = document.getElementById('gistIdSetup').value.trim();
            
            if (!token) {
                showNotification('‚ùå Inserisci il token GitHub', 'error');
                return;
            }
            
            // Salva la configurazione
            GITHUB_CONFIG.token = token;
            GITHUB_CONFIG.gistId = gistId;
            GITHUB_CONFIG.enabled = true;
            
            localStorage.setItem('tommy_github_token', token);
            localStorage.setItem('tommy_gist_id', gistId);
            localStorage.setItem('tommy_github_enabled', 'true');
            
            hideGitHubSetup();
            showNotification('‚úÖ GitHub configurato! Ora accedi al sistema', 'success');
            
            // Mostra il modal di login
            setTimeout(() => {
                showLoginModal();
            }, 1000);
        }

        function skipGitHubSetup() {
            hideGitHubSetup();
            showNotification('‚è≠Ô∏è Configurazione GitHub saltata. Puoi configurarla dopo tramite ‚öôÔ∏è GitHub', 'info');
            
            // Mostra il modal di login
            setTimeout(() => {
                showLoginModal();
            }, 1000);
        }
        
        function hideGitHubConfig() {
            const overlay = document.getElementById('githubConfigOverlay');
            overlay.style.display = 'none';
        }
        
        function saveGitHubConfig() {
            const token = document.getElementById('githubToken').value.trim();
            const gistId = document.getElementById('gistId').value.trim();
            const enabled = document.getElementById('githubEnabled').checked;
            
            if (enabled && (!token || !gistId)) {
                showNotification('‚ùå Inserisci token e Gist ID per abilitare GitHub', 'error');
                return;
            }
            
            // Salva la configurazione
            GITHUB_CONFIG.token = token;
            GITHUB_CONFIG.gistId = gistId;
            GITHUB_CONFIG.enabled = enabled;
            
            localStorage.setItem('tommy_github_token', token);
            localStorage.setItem('tommy_gist_id', gistId);
            localStorage.setItem('tommy_github_enabled', enabled.toString());
            
            hideGitHubConfig();
            showNotification('‚úÖ Configurazione GitHub salvata!', 'success');
            
            // Testa la connessione se abilitata
            if (enabled) {
                testGitHubConnection();
            }
        }
        
        async function testGitHubConnection() {
            try {
                showLoading(true);
                
                // Verifica configurazione
                if (!GITHUB_CONFIG.token || !GITHUB_CONFIG.gistId) {
                    showNotification('‚ùå Configurazione GitHub incompleta - imposta token e Gist ID', 'error');
                    return;
                }
                
                const success = await saveToGitHubGist({
                    clienti: [],
                    fatture: [],
                    prodotti: [],
                    vini: [],
                    lastModified: Date.now(),
                    deviceId: deviceId
                });
                
                if (success) {
                    showNotification('‚úÖ Connessione GitHub testata con successo!', 'success');
                } else {
                    showNotification('‚ùå Errore nella connessione GitHub - verifica token e permessi', 'error');
                }
            } catch (error) {
                console.error('Errore nel test GitHub:', error);
                showNotification('‚ùå Errore nel test della connessione', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Dashboard Functions for Tommaso
        let currentTimeFilter = 'all';
        let currentNewsSource = 'gnews';
        let dashboardCharts = {};

        function loadTommasoDashboard() {
            updateDashboardStats();
            updateSystemWidgets();
            createFattureChart();
            createTipoChart();
            createClientiChart();
            createStatoChart();
            loadWineNews();
            
            // Imposta il filtro temporale di default
            setTimeFilter('all');
        }

        function updateDashboardStats() {
            // Filtra i documenti in base al periodo selezionato
            const filteredDocs = filterDocumentsByTime(documenti, currentTimeFilter);
            
            // Aggiorna statistiche rapide
            document.getElementById('totalFatture').textContent = filteredDocs.length;
            
            const totalRevenue = filteredDocs.reduce((sum, doc) => sum + (doc.totale || 0), 0);
            document.getElementById('totalRevenue').textContent = `‚Ç¨${totalRevenue.toFixed(2)}`;
            
            document.getElementById('totalClienti').textContent = clienti.length;
            document.getElementById('totalVini').textContent = vini.length;
        }

        function updateSystemWidgets() {
            // Calcola storage utilizzato
            const storageUsed = calculateStorageUsage();
            document.getElementById('storageInfo').textContent = `${storageUsed.toFixed(2)} MB`;
            
            // Ultimo sync
            const lastSync = localStorage.getItem('tommy_last_sync');
            const lastSyncText = lastSync ? 
                new Date(parseInt(lastSync)).toLocaleString('it-IT') : 
                'Mai';
            document.getElementById('lastSyncInfo').textContent = lastSyncText;
            
            // Verifica integrit√† dati
            const integrityStatus = verifyDataIntegrity();
            document.getElementById('integrityInfo').textContent = integrityStatus ? '‚úÖ OK' : '‚ùå Errori';
            
            // Alert di sistema
            const alerts = checkSystemAlerts();
            document.getElementById('alertInfo').textContent = alerts.length > 0 ? 
                `${alerts.length} problema/i` : 'Nessun problema';
        }

        function filterDocumentsByTime(documents, filter) {
            const now = new Date();
            const startOfYear = new Date(now.getFullYear(), 0, 1);
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const startOfWeek = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            return documents.filter(doc => {
                const docDate = new Date(doc.data);
                switch(filter) {
                    case 'year':
                        return docDate >= startOfYear;
                    case 'month':
                        return docDate >= startOfMonth;
                    case 'week':
                        return docDate >= startOfWeek;
                    default:
                        return true;
                }
            });
        }

        function setTimeFilter(filter, event) {
            currentTimeFilter = filter;
            
            // Aggiorna stile dei pulsanti
            document.querySelectorAll('.filter-controls .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Ricrea i grafici con i nuovi dati filtrati
            updateDashboardStats();
            createFattureChart();
            createTipoChart();
            createClientiChart();
            createStatoChart();
        }

        function calculateStorageUsage() {
            let totalSize = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    totalSize += localStorage[key].length * 2; // 2 bytes per carattere
                }
            }
            return totalSize / (1024 * 1024); // Converti in MB
        }

        function checkSystemAlerts() {
            const alerts = [];
            
            // Controlla fatture scadute
            const scadute = documenti.filter(doc => {
                if (!doc.scadenza) return false;
                const scadenza = new Date(doc.scadenza);
                return scadenza < new Date() && doc.stato !== 'pagata';
            });
            
            if (scadute.length > 0) {
                alerts.push(`${scadute.length} fattura/e scaduta/e`);
            }
            
            // Controlla prodotti con stock basso
            const lowStock = prodotti.filter(prod => {
                return prod.quantita <= (prod.quantitaMinima || 5);
            });
            
            if (lowStock.length > 0) {
                alerts.push(`${lowStock.length} prodotto/i con stock basso`);
            }
            
            return alerts;
        }

        function createFattureChart() {
            const ctx = document.getElementById('fattureChart');
            if (!ctx) return;

            // Distruggi il grafico esistente se presente
            if (dashboardCharts.fattureChart) {
                dashboardCharts.fattureChart.destroy();
            }

            // Filtra i documenti in base al periodo selezionato
            const filteredDocs = filterDocumentsByTime(documenti, currentTimeFilter);
            
            // Raggruppa fatture per mese
            const monthlyData = {};
            const currentYear = new Date().getFullYear();
            
            filteredDocs.forEach(doc => {
                const date = new Date(doc.data);
                if (date.getFullYear() === currentYear) {
                    const month = date.getMonth();
                    const monthName = new Date(2024, month).toLocaleDateString('it-IT', { month: 'short' });
                    
                    if (!monthlyData[monthName]) {
                        monthlyData[monthName] = { count: 0, revenue: 0 };
                    }
                    monthlyData[monthName].count++;
                    monthlyData[monthName].revenue += doc.totale || 0;
                }
            });

            const months = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
            const labels = months.filter(month => monthlyData[month]);
            const data = labels.map(month => monthlyData[month].count);
            const revenueData = labels.map(month => monthlyData[month].revenue);

            dashboardCharts.fattureChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Numero Fatture',
                        data: data,
                        borderColor: '#1a5f3a',
                        backgroundColor: 'rgba(26, 95, 58, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'Fatturato (‚Ç¨)',
                        data: revenueData,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Numero Fatture'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Fatturato (‚Ç¨)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }

        function createTipoChart() {
            const ctx = document.getElementById('tipoChart');
            if (!ctx) return;

            // Distruggi il grafico esistente se presente
            if (dashboardCharts.tipoChart) {
                dashboardCharts.tipoChart.destroy();
            }

            // Filtra i documenti in base al periodo selezionato
            const filteredDocs = filterDocumentsByTime(documenti, currentTimeFilter);

            // Raggruppa documenti per tipo
            const tipoData = {};
            filteredDocs.forEach(doc => {
                const tipo = doc.tipo || 'altro';
                tipoData[tipo] = (tipoData[tipo] || 0) + 1;
            });

            const labels = Object.keys(tipoData);
            const data = Object.values(tipoData);
            const colors = ['#1a5f3a', '#28a745', '#ffc107', '#dc3545', '#6c757d'];

            dashboardCharts.tipoChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.map(tipo => tipo.charAt(0).toUpperCase() + tipo.slice(1)),
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        function createClientiChart() {
            const ctx = document.getElementById('clientiChart');
            if (!ctx) return;

            // Distruggi il grafico esistente se presente
            if (dashboardCharts.clientiChart) {
                dashboardCharts.clientiChart.destroy();
            }

            // Filtra i documenti in base al periodo selezionato
            const filteredDocs = filterDocumentsByTime(documenti, currentTimeFilter);

            // Raggruppa per cliente e calcola fatturato
            const clientiData = {};
            filteredDocs.forEach(doc => {
                const cliente = doc.cliente || 'Sconosciuto';
                clientiData[cliente] = (clientiData[cliente] || 0) + (doc.totale || 0);
            });

            // Prendi i top 5 clienti
            const sortedClienti = Object.entries(clientiData)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            const labels = sortedClienti.map(([cliente]) => cliente.length > 20 ? cliente.substring(0, 20) + '...' : cliente);
            const data = sortedClienti.map(([,fatturato]) => fatturato);

            dashboardCharts.clientiChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Fatturato (‚Ç¨)',
                        data: data,
                        backgroundColor: '#1a5f3a',
                        borderColor: '#2d5a3d',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Fatturato (‚Ç¨)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function createStatoChart() {
            const ctx = document.getElementById('statoChart');
            if (!ctx) return;

            // Distruggi il grafico esistente se presente
            if (dashboardCharts.statoChart) {
                dashboardCharts.statoChart.destroy();
            }

            // Filtra i documenti in base al periodo selezionato
            const filteredDocs = filterDocumentsByTime(documenti, currentTimeFilter);

            // Raggruppa per stato
            const statoData = {};
            filteredDocs.forEach(doc => {
                const stato = doc.stato || 'in_attesa';
                statoData[stato] = (statoData[stato] || 0) + 1;
            });

            const labels = Object.keys(statoData).map(stato => {
                switch(stato) {
                    case 'pagata': return 'Pagata';
                    case 'in_attesa': return 'In Attesa';
                    case 'scaduta': return 'Scaduta';
                    default: return stato.charAt(0).toUpperCase() + stato.slice(1);
                }
            });
            const data = Object.values(statoData);
            const colors = ['#28a745', '#ffc107', '#dc3545'];

            dashboardCharts.statoChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        async function loadWineNews() {
            const newsContainer = document.getElementById('newsContainer');
            if (!newsContainer) return;

            try {
                newsContainer.innerHTML = '<div class="loading-news">üîÑ Caricamento notizie dal mondo del vino...</div>';
                updateNewsSourceIndicator();
                
                let news = null;
                let apiError = false;
                
                if (currentNewsSource === 'gnews') {
                    try {
                        news = await fetchWineNewsFromAPI();
                        if (!news) {
                            apiError = true;
                            console.log('NewsAPI non disponibile - usando notizie simulate');
                        }
                    } catch (error) {
                        apiError = true;
                        console.log('Errore NewsAPI - usando notizie simulate');
                    }
                } else {
                    try {
                        news = await fetchWineNewsFromAlternative();
                        if (!news) {
                            apiError = true;
                            console.log('API alternativa non disponibile - usando notizie simulate');
                        }
                    } catch (error) {
                        apiError = true;
                        console.log('Errore API alternativa - usando notizie simulate');
                    }
                }
                
                // Se non ci sono notizie dall'API, usa quelle simulate
                if (!news || news.length === 0) {
                    news = getMockWineNews();
                    apiError = true;
                }
                
                // Renderizza le notizie con design moderno e immagini
                newsContainer.innerHTML = news.map((news, index) => `
                    <div class="news-item" style="animation: fadeInUp 0.5s ease ${index * 0.1}s both;">
                        <div class="news-content">
                            ${news.image ? `
                                <div class="news-image">
                                    <img src="${news.image}" alt="${news.title}" onerror="this.style.display='none'">
                                </div>
                            ` : ''}
                            <div class="news-text">
                                <div class="news-title">
                                    <a href="${news.url}" target="_blank" rel="noopener noreferrer">${news.title}</a>
                                </div>
                                <div class="news-description">${news.description}</div>
                                <div class="news-meta">
                                    <span class="news-date">${news.publishedAt}</span>
                                    <span class="news-source">${news.source || (apiError ? 'Notizie simulate' : 'GNews')}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // Mostra notifica se si usano notizie simulate
                if (apiError) {
                    setTimeout(() => {
                        showNotification('üì∞ Mostrando notizie simulate - API non disponibile', 'info');
                    }, 1000);
                }

            } catch (error) {
                console.error('Errore nel caricamento notizie:', error);
                // Fallback a notizie simulate in caso di errore
                newsContainer.innerHTML = getMockWineNews().map((news, index) => `
                    <div class="news-item" style="animation: fadeInUp 0.5s ease ${index * 0.1}s both;">
                        <div class="news-content">
                            <div class="news-text">
                                <div class="news-title">
                                    <a href="${news.url}" target="_blank">${news.title}</a>
                                </div>
                                <div class="news-description">${news.description}</div>
                                <div class="news-meta">
                                    <span class="news-date">${news.publishedAt}</span>
                                    <span class="news-source">Notizie simulate</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                setTimeout(() => {
                    showNotification('üì∞ Mostrando notizie simulate - Errore di caricamento', 'warning');
                }, 1000);
            }
        }

        async function fetchWineNewsFromAPI() {
            try {
                // Usa GNews API per ottenere notizie specifiche sui vini
                const apiKey = '03f58ed7bfc0ac51ff02e00ae8bfc2c4'; // Chiave GNews
                
                // Query specifiche per notizie sui vini in italiano
                const wineQueries = [
                    'vino italiano',
                    'cantina italiana',
                    'viticoltura',
                    'enologia',
                    'sommelier',
                    'DOC vino',
                    'Barolo Chianti Brunello',
                    'vino rosso bianco spumante',
                    'degustazione vini',
                    'industria del vino'
                ];
                
                // Seleziona una query casuale per variet√†
                const randomQuery = wineQueries[Math.floor(Math.random() * wineQueries.length)];
                const language = 'it';
                const country = 'it';
                const max = 10;
                
                const url = `https://gnews.io/api/v4/search?q=${encodeURIComponent(randomQuery)}&lang=${language}&country=${country}&max=${max}&apikey=${apiKey}`;
                
                console.log('üîç Ricerca notizie GNews:', randomQuery);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    // Gestisci errori specifici dell'API
                    if (response.status === 401) {
                        console.warn('GNews API key non valida - usando notizie simulate');
                        return null;
                    } else if (response.status === 429) {
                        console.warn('GNews rate limit raggiunto - usando notizie simulate');
                        return null;
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                }
                
                const data = await response.json();
                
                if (data.articles && data.articles.length > 0) {
                    // Filtra articoli pi√π rilevanti
                    const wineArticles = data.articles.filter(article => {
                        const title = article.title.toLowerCase();
                        const description = (article.description || '').toLowerCase();
                        const content = title + ' ' + description;
                        
                        // Parole chiave specifiche per il vino
                        const wineKeywords = [
                            'vino', 'wine', 'cantina', 'winery', 'viticoltura', 'viticulture',
                            'enologia', 'enology', 'sommelier', 'degustazione', 'tasting',
                            'barolo', 'chianti', 'brunello', 'amarone', 'doc', 'docg',
                            'rosso', 'bianco', 'spumante', 'red wine', 'white wine', 'sparkling',
                            'uva', 'grape', 'vendemmia', 'harvest', 'bottiglia', 'bottle',
                            'prosecco', 'champagne', 'franciacorta', 'valpolicella'
                        ];
                        
                        return wineKeywords.some(keyword => content.includes(keyword));
                    });
                    
                    console.log(`üç∑ Trovati ${wineArticles.length} articoli sui vini su ${data.articles.length} totali`);
                    
                    return wineArticles.slice(0, 6).map(article => ({
                        title: article.title,
                        description: article.description || 'Nessuna descrizione disponibile',
                        url: article.url,
                        publishedAt: formatDate(article.publishedAt),
                        source: article.source.name || 'GNews',
                        image: article.image || null
                    }));
                }
                
                console.log('üì∞ Nessun articolo trovato su GNews');
                return null;
                
            } catch (error) {
                console.error('Errore API GNews:', error);
                return null;
            }
        }

        async function fetchWineNewsFromAlternative() {
            try {
                // Prova prima con un'API di notizie specializzate
                const wineNewsSources = [
                    'https://www.decanter.com/wine-news/',
                    'https://www.winebusiness.com/news/',
                    'https://www.wine-searcher.com/news/',
                    'https://www.wineenthusiast.com/news/'
                ];
                
                // Seleziona una fonte casuale
                const randomSource = wineNewsSources[Math.floor(Math.random() * wineNewsSources.length)];
                
                // Usa un proxy CORS per ottenere notizie da fonti specializzate
                const response = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent(randomSource));
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Parsing semplificato del contenuto HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(data.contents, 'text/html');
                const articles = doc.querySelectorAll('article, .news-item, .post, .news, .story');
                
                const news = [];
                articles.forEach((article, index) => {
                    if (index < 8) { // Prendi pi√π articoli per il filtro
                        const title = article.querySelector('h1, h2, h3, .title, .headline')?.textContent?.trim();
                        const description = article.querySelector('p, .description, .excerpt, .summary')?.textContent?.trim();
                        const link = article.querySelector('a')?.href;
                        
                        if (title) {
                            news.push({
                                title: title,
                                description: description || 'Nessuna descrizione disponibile',
                                url: link || '#',
                                publishedAt: 'Oggi'
                            });
                        }
                    }
                });
                
                // Filtra articoli specifici sul vino
                const wineKeywords = [
                    'wine', 'vino', 'winery', 'cantina', 'viticulture', 'viticoltura',
                    'sommelier', 'tasting', 'degustazione', 'barolo', 'chianti', 'brunello',
                    'amarone', 'doc', 'docg', 'red', 'white', 'sparkling', 'rosso', 'bianco',
                    'spumante', 'grape', 'uva', 'harvest', 'vendemmia', 'bottle', 'bottiglia'
                ];
                
                const filteredNews = news.filter(article => {
                    const content = (article.title + ' ' + article.description).toLowerCase();
                    return wineKeywords.some(keyword => content.includes(keyword));
                });
                
                return filteredNews.slice(0, 5);
                
            } catch (error) {
                console.error('Errore API alternativa:', error);
                return null;
            }
        }

        function getMockWineNews() {
            const currentDate = new Date();
            const mockNews = [
                {
                    title: "üç∑ Barolo 2019: Un'annata eccezionale per il re dei vini",
                    description: "La vendemmia 2019 del Barolo si conferma come una delle migliori degli ultimi decenni. I produttori riportano vini di straordinaria complessit√† e longevit√†.",
                    url: "#",
                    publishedAt: "Oggi",
                    source: "WineNews"
                },
                {
                    title: "üèÜ Brunello di Montalcino conquista nuovi mercati asiatici",
                    description: "Il prestigioso vino toscano sta registrando un boom di vendite in Cina e Giappone, con un incremento del 45% rispetto all'anno scorso.",
                    url: "#",
                    publishedAt: "Ieri",
                    source: "VinoToday"
                },
                {
                    title: "üåø Viticoltura sostenibile: le nuove tendenze del 2024",
                    description: "I produttori italiani stanno adottando sempre pi√π pratiche sostenibili, dalla riduzione dei pesticidi all'uso di energie rinnovabili.",
                    url: "#",
                    publishedAt: "2 giorni fa",
                    source: "GreenWine"
                },
                {
                    title: "üçá Amarone della Valpolicella: qualit√† in crescita",
                    description: "La DOCG Amarone della Valpolicella registra un miglioramento costante della qualit√†, con vini sempre pi√π raffinati e complessi.",
                    url: "#",
                    publishedAt: "3 giorni fa",
                    source: "VenetoWine"
                },
                {
                    title: "üë®‚Äçüç≥ I sommelier italiani trionfano ai campionati mondiali",
                    description: "La delegazione italiana ha conquistato il primo posto ai campionati mondiali di sommelier, confermando la leadership nel settore.",
                    url: "#",
                    publishedAt: "1 settimana fa",
                    source: "SommelierNews"
                },
                {
                    title: "üçæ Prosecco supera Champagne nelle vendite globali",
                    description: "Il Prosecco DOC e DOCG ha superato lo Champagne nelle vendite globali, confermando il successo internazionale dei vini spumanti italiani.",
                    url: "#",
                    publishedAt: "4 giorni fa",
                    source: "SparklingNews"
                },
                {
                    title: "üå± Vini biologici: Italia leader europeo nella produzione",
                    description: "L'Italia conferma la sua posizione di leader europeo nella produzione di vini biologici, con oltre 100.000 ettari di vigneti certificati.",
                    url: "#",
                    publishedAt: "5 giorni fa",
                    source: "BioWine"
                },
                {
                    title: "üèÖ Chianti Classico: Nuove regole per la DOCG dal 2024",
                    description: "Il Consorzio del Chianti Classico introduce nuove norme per migliorare la qualit√† e la tipicit√† dei vini della zona storica.",
                    url: "#",
                    publishedAt: "1 settimana fa",
                    source: "TuscanyWine"
                }
            ];
            
            // Restituisce notizie casuali per variet√†
            return mockNews.sort(() => Math.random() - 0.5).slice(0, 5);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInHours = Math.floor((now - date) / (1000 * 60 * 60));
            
            if (diffInHours < 1) return 'Poco fa';
            if (diffInHours < 24) return `${diffInHours} ore fa`;
            if (diffInHours < 48) return 'Ieri';
            
            const diffInDays = Math.floor(diffInHours / 24);
            return `${diffInDays} giorni fa`;
        }

        function refreshNews() {
            loadWineNews();
            showNotification('üîÑ Notizie aggiornate!', 'success');
        }

        function toggleNewsSource() {
            currentNewsSource = currentNewsSource === 'gnews' ? 'alternative' : 'gnews';
            updateNewsSourceIndicator();
            loadWineNews();
            showNotification(`üì∞ Fonte notizie cambiata: ${currentNewsSource === 'gnews' ? 'GNews' : 'Alternativa'}`, 'info');
        }

        // Contatore errori API per auto-disabilitazione
        let newsApiErrorCount = 0;
        const MAX_NEWS_API_ERRORS = 3;
        
        // Flag per gestione stato fatture
        let enableStatoFatture = true; // Flag per abilitare/disabilitare modifica stato
        
        function updateNewsSourceIndicator() {
            const currentSourceElement = document.getElementById('currentSource');
            if (currentSourceElement) {
                currentSourceElement.textContent = currentNewsSource === 'gnews' ? 'GNews' : 'Alternativa';
            }
        }
        
        // Funzione per gestire errori API persistenti
        function handleNewsApiError() {
            newsApiErrorCount++;
            if (newsApiErrorCount >= MAX_NEWS_API_ERRORS) {
                // Disabilita automaticamente NewsAPI dopo troppi errori
                currentNewsSource = 'alternative';
                newsApiErrorCount = 0; // Reset counter
                updateNewsSourceIndicator();
                showNotification('üì∞ Cambiato automaticamente a fonte alternativa', 'info');
            }
        }

        // Funzione per verificare e aggiornare lo stato delle fatture
        function checkAndUpdateStatoFatture() {
            if (!enableStatoFatture) {
                console.log('üîí Modifica stato fatture disabilitata');
                return;
            }

            let updatedCount = 0;
            const currentDate = new Date();

            documenti.forEach((documento, index) => {
                // Verifica se il documento ha il campo stato
                if (!documento.hasOwnProperty('stato')) {
                    console.log(`üìã Documento ${documento.numero} non ha campo stato - aggiungendo...`);
                    documenti[index].stato = 'in_attesa';
                    updatedCount++;
                }

                // Controlla se la fattura √® scaduta
                if (documento.scadenza && documento.stato !== 'pagata') {
                    const scadenza = new Date(documento.scadenza);
                    if (scadenza < currentDate) {
                        console.log(`‚ö†Ô∏è Fattura ${documento.numero} scaduta - aggiornando stato...`);
                        documenti[index].stato = 'scaduta';
                        updatedCount++;
                    }
                }
            });

            if (updatedCount > 0) {
                updateFattureTable();
                saveDataToStorage();
                showNotification(`üîÑ Aggiornati ${updatedCount} stati fatture`, 'info');
                console.log(`‚úÖ Aggiornati ${updatedCount} stati fatture`);
            }

            return updatedCount;
        }

        // Funzione per cambiare lo stato di una fattura
        function changeStatoFattura(id, newStato) {
            if (!enableStatoFatture) {
                showNotification('üîí Modifica stato fatture disabilitata', 'warning');
                return;
            }

            const documentoIndex = documenti.findIndex(d => d.id === id);
            if (documentoIndex === -1) {
                showNotification('‚ùå Fattura non trovata', 'error');
                return;
            }

            const statiValidi = ['in_attesa', 'pagata', 'scaduta'];
            if (!statiValidi.includes(newStato)) {
                showNotification('‚ùå Stato non valido', 'error');
                return;
            }

            const oldStato = documenti[documentoIndex].stato;
            documenti[documentoIndex].stato = newStato;
            
            updateFattureTable();
            saveDataToStorage();
            
            showNotification(`‚úÖ Stato fattura ${documenti[documentoIndex].numero} cambiato da "${oldStato}" a "${newStato}"`, 'success');
            console.log(`üîÑ Stato fattura ${documenti[documentoIndex].numero}: ${oldStato} ‚Üí ${newStato}`);
        }

        // Funzione per abilitare/disabilitare la modifica dello stato
        function toggleStatoFatture() {
            enableStatoFatture = !enableStatoFatture;
            const status = enableStatoFatture ? 'abilitata' : 'disabilitata';
            updateToggleStatoButton();
            showNotification(`üîß Modifica stato fatture ${status}`, 'info');
            console.log(`üîß Modifica stato fatture: ${status}`);
        }

        // Funzione per aggiornare l'aspetto del pulsante toggle
        function updateToggleStatoButton() {
            const toggleBtn = document.getElementById('toggleStatoBtn');
            if (toggleBtn) {
                if (enableStatoFatture) {
                    toggleBtn.textContent = 'üîí Disabilita Stati';
                    toggleBtn.className = 'btn btn-outline btn-warning';
                    toggleBtn.title = 'Disabilita modifica stati fatture';
                } else {
                    toggleBtn.textContent = 'üîì Abilita Stati';
                    toggleBtn.className = 'btn btn-outline btn-success';
                    toggleBtn.title = 'Abilita modifica stati fatture';
                }
            }
        }

        // Aggiornamento automatico della dashboard
        function startDashboardAutoUpdate() {
            // Aggiorna la dashboard ogni 5 minuti
            setInterval(() => {
                if (currentUser === 'admin' && document.getElementById('dashboard').classList.contains('active')) {
                    updateDashboardStats();
                    updateSystemWidgets();
                    console.log('üîÑ Dashboard aggiornata automaticamente');
                }
            }, 5 * 60 * 1000); // 5 minuti
        }

        // Inizializza l'aggiornamento automatico quando Tommaso accede
        function initializeDashboardAutoUpdate() {
            startDashboardAutoUpdate();
        }

        // Inizializza la gestione stati fatture
        function initializeStatoFatture() {
            updateToggleStatoButton();
            // Verifica automatica degli stati all'avvio
            setTimeout(() => {
                checkAndUpdateStatoFatture();
            }, 1000);
        }

        // Funzione per nascondere la tab benvenuto per admin
        function hideBenvenutoTabForAdmin() {
            if (currentUser === 'admin') {
                const benvenutoTab = document.querySelector('.nav-tab[onclick="showTab(\'benvenuto\')"]');
                if (benvenutoTab) {
                    benvenutoTab.style.display = 'none';
                    benvenutoTab.classList.remove('active');
                    benvenutoTab.classList.add('guest-only');
                }
            }
        }

        // Variabile globale per il timer di monitoraggio benvenuto
        let benvenutoMonitorTimer = null;

        // Funzione per monitorare e nascondere la tab benvenuto per admin
        function monitorBenvenutoTabForAdmin() {
            // Ferma tutti i monitoraggi esistenti
            stopAllMonitoring();
            
            if (currentUser === 'admin') {
                let lastLogTime = 0;
                benvenutoMonitorTimer = setInterval(() => {
                    const currentTime = Date.now();
                    let hasChanges = false;
                    
                    const benvenutoTab = document.querySelector('.nav-tab[onclick="showTab(\'benvenuto\')"]');
                    if (benvenutoTab && benvenutoTab.style.display !== 'none') {
                        benvenutoTab.style.display = 'none';
                        benvenutoTab.classList.remove('active');
                        benvenutoTab.classList.add('guest-only');
                        hasChanges = true;
                    }
                    
                    // Log solo se ci sono stati cambiamenti e non pi√π di una volta ogni 5 secondi
                    if (hasChanges && (currentTime - lastLogTime) > 5000) {
                        console.log('üîí Tab benvenuto nascosta per admin');
                        lastLogTime = currentTime;
                    }
                }, 2000); // Controlla ogni 2 secondi invece di 1
            }
        }

        // Funzione per nascondere le tab admin-only per ospiti
        function hideAdminTabsForGuest() {
            if (currentUser === 'guest') {
                const adminTabs = document.querySelectorAll('.nav-tab.admin-only');
                adminTabs.forEach(tab => {
                    tab.style.display = 'none';
                    tab.classList.remove('active');
                    tab.classList.add('admin-only');
                });
            }
        }

        // Variabili globali per i timer di monitoraggio
        let guestMonitorTimer = null;
        let adminMonitorTimer = null;
        let monitoringActive = false;

        // Funzione per fermare tutti i monitoraggi
        function stopAllMonitoring() {
            if (guestMonitorTimer) {
                clearInterval(guestMonitorTimer);
                guestMonitorTimer = null;
            }
            if (adminMonitorTimer) {
                clearInterval(adminMonitorTimer);
                adminMonitorTimer = null;
            }
            if (benvenutoMonitorTimer) {
                clearInterval(benvenutoMonitorTimer);
                benvenutoMonitorTimer = null;
            }
            monitoringActive = false;
        }

        // Funzione per avviare il monitoraggio in modo sicuro
        function startSafeMonitoring() {
            if (monitoringActive) {
                stopAllMonitoring();
            }
            
            if (currentUser === 'guest') {
                monitorAdminTabsForGuest();
            } else if (currentUser === 'admin') {
                monitorAdminTabsForTommaso();
                monitorBenvenutoTabForAdmin();
            }
            
            monitoringActive = true;
        }

        // Funzione per monitorare e nascondere le tab admin-only per ospiti
        function monitorAdminTabsForGuest() {
            // Ferma tutti i monitoraggi esistenti
            stopAllMonitoring();
            
            if (currentUser === 'guest') {
                let lastLogTime = 0;
                guestMonitorTimer = setInterval(() => {
                    const currentTime = Date.now();
                    let hasChanges = false;
                    
                    const adminTabs = document.querySelectorAll('.nav-tab.admin-only');
                    adminTabs.forEach(tab => {
                        if (tab.style.display !== 'none') {
                            tab.style.display = 'none';
                            tab.classList.remove('active');
                            tab.classList.add('admin-only');
                            hasChanges = true;
                        }
                    });

                    // Nascondi anche le sezioni admin-only per ospiti
                    const adminSections = document.querySelectorAll('.tab-content.admin-only');
                    adminSections.forEach(section => {
                        if (section.style.display !== 'none' && !section.classList.contains('active')) {
                            section.style.display = 'none';
                            section.classList.remove('active');
                            section.classList.add('admin-only');
                            hasChanges = true;
                        }
                    });
                    
                    // Log solo se ci sono stati cambiamenti e non pi√π di una volta ogni 5 secondi
                    if (hasChanges && (currentTime - lastLogTime) > 5000) {
                        console.log('üîí Elementi admin nascosti per ospite');
                        lastLogTime = currentTime;
                    }
                }, 2000); // Controlla ogni 2 secondi invece di 1
            }
        }

        // Funzione per gestire l'accesso alle sezioni admin-only per ospiti
        function handleAdminSectionAccessForGuest(sectionName) {
            if (currentUser === 'guest') {
                const adminSections = ['dashboard', 'clienti', 'fatture'];
                if (adminSections.includes(sectionName)) {
                    showNotification('üîí Accesso negato: Sezione riservata agli amministratori', 'error');
                    return false;
                }
            }
            return true;
        }

        // Funzione per pulire e riorganizzare le classi CSS delle schede
        function cleanupTabClasses() {
            // Rimuovi classi duplicate e conflittuali
            document.querySelectorAll('.nav-tab').forEach(tab => {
                // Rimuovi classi duplicate
                const classes = tab.classList;
                if (classes.contains('admin-only') && classes.contains('guest-only')) {
                    if (currentUser === 'admin') {
                        tab.classList.remove('guest-only');
                    } else {
                        tab.classList.remove('admin-only');
                    }
                }
                
                // Assicurati che le tab abbiano le classi corrette
                if (currentUser === 'admin') {
                    if (tab.getAttribute('onclick') && tab.getAttribute('onclick').includes('dashboard') ||
                        tab.getAttribute('onclick') && tab.getAttribute('onclick').includes('clienti') ||
                        tab.getAttribute('onclick') && tab.getAttribute('onclick').includes('fatture')) {
                        tab.classList.add('admin-only');
                        tab.classList.remove('guest-only');
                    }
                } else {
                    if (tab.getAttribute('onclick') && tab.getAttribute('onclick').includes('benvenuto')) {
                        tab.classList.add('guest-only');
                        tab.classList.remove('admin-only');
                    }
                }
            });
            
            // Pulisci anche le sezioni
            document.querySelectorAll('.tab-content').forEach(section => {
                const sectionId = section.id;
                if (sectionId === 'dashboard' || sectionId === 'clienti' || sectionId === 'fatture') {
                    section.classList.add('admin-only');
                    section.classList.remove('guest-only');
                } else if (sectionId === 'benvenuto') {
                    section.classList.add('guest-only');
                    section.classList.remove('admin-only');
                }
            });
        }

        // Funzione per prevenire la duplicazione delle schede
        function preventTabDuplication() {
            // Controlla se ci sono tab duplicate
            const tabIds = ['dashboard', 'clienti', 'fatture', 'prodotti', 'vini', 'benvenuto'];
            tabIds.forEach(tabId => {
                const tabs = document.querySelectorAll(`.nav-tab[onclick*="showTab('${tabId}')"]`);
                if (tabs.length > 1) {
                    // Mantieni solo la prima tab e rimuovi le duplicate
                    for (let i = 1; i < tabs.length; i++) {
                        tabs[i].remove();
                    }
                }
            });
            
            // Controlla se ci sono sezioni duplicate
            tabIds.forEach(sectionId => {
                const sections = document.querySelectorAll(`#${sectionId}`);
                if (sections.length > 1) {
                    // Mantieni solo la prima sezione e rimuovi le duplicate
                    for (let i = 1; i < sections.length; i++) {
                        sections[i].remove();
                    }
                }
            });
        }

        // Funzione per mostrare le tab admin-only per Tommaso
        function showAdminTabsForTommaso() {
            if (currentUser === 'admin') {
                const adminTabs = document.querySelectorAll('.nav-tab.admin-only');
                adminTabs.forEach(tab => {
                    tab.style.display = 'block';
                    tab.classList.remove('hidden-for-guest');
                    tab.classList.add('admin-only');
                });
                
                // Mostra anche le sezioni admin-only
                const adminSections = document.querySelectorAll('.tab-content.admin-only');
                adminSections.forEach(section => {
                    section.style.display = 'block';
                    section.classList.remove('hidden-for-guest');
                    section.classList.add('admin-only');
                });
                
                console.log('üë®‚Äçüíº Tab admin mostrate per Tommaso');
            }
        }

        // Funzione per monitorare e mostrare le tab admin-only per Tommaso
        function monitorAdminTabsForTommaso() {
            // Ferma tutti i monitoraggi esistenti
            stopAllMonitoring();
            
            if (currentUser === 'admin') {
                let lastLogTime = 0;
                adminMonitorTimer = setInterval(() => {
                    const currentTime = Date.now();
                    let hasChanges = false;
                    
                    const adminTabs = document.querySelectorAll('.nav-tab.admin-only');
                    adminTabs.forEach(tab => {
                        if (tab.style.display === 'none') {
                            tab.style.display = 'block';
                            tab.classList.remove('hidden-for-guest');
                            tab.classList.add('admin-only');
                            hasChanges = true;
                        }
                    });

                    // Mostra anche le sezioni admin-only se nascoste
                    const adminSections = document.querySelectorAll('.tab-content.admin-only');
                    adminSections.forEach(section => {
                        if (section.style.display === 'none') {
                            section.style.display = 'block';
                            section.classList.remove('hidden-for-guest');
                            section.classList.add('admin-only');
                            hasChanges = true;
                        }
                    });
                    
                    // Log solo se ci sono stati cambiamenti e non pi√π di una volta ogni 5 secondi
                    if (hasChanges && (currentTime - lastLogTime) > 5000) {
                        console.log('üë®‚Äçüíº Elementi admin ripristinati per Tommaso');
                        lastLogTime = currentTime;
                    }
                }, 2000); // Controlla ogni 2 secondi invece di 1
            }
        }

        // Funzione per inizializzare correttamente le schede all'avvio
        function initializeTabsCorrectly() {
            // Ferma tutti i monitoraggi esistenti
            stopAllMonitoring();
            
            // Pulisci le classi CSS
            cleanupTabClasses();
            
            // Preveni la duplicazione delle schede
            preventTabDuplication();
            
            // Forza il nascondimento di tutte le sezioni all'avvio
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
                tab.style.display = 'none';
                tab.setAttribute('style', 'display: none !important');
            });
            
            // Imposta la visualizzazione corretta in base al tipo di utente
            if (currentUser === 'admin') {
                // Mostra tutte le tab admin per admin
                const adminTabIds = ['dashboard', 'clienti', 'fatture'];
                adminTabIds.forEach(tabId => {
                    const tab = document.querySelector(`.nav-tab[onclick*="showTab('${tabId}')"]`);
                    if (tab) {
                        tab.style.display = 'block';
                        tab.classList.add('admin-only');
                        tab.classList.remove('guest-only');
                        tab.classList.remove('hidden-for-guest');
                    }
                });
                
                // Nascondi la tab benvenuto per admin
                const benvenutoTab = document.querySelector('.nav-tab[onclick*="showTab(\'benvenuto\')"]');
                if (benvenutoTab) {
                    benvenutoTab.style.display = 'none';
                    benvenutoTab.classList.add('guest-only');
                    benvenutoTab.classList.remove('admin-only');
                }
                
                // Mostra le sezioni admin
                adminTabIds.forEach(sectionId => {
                    const section = document.getElementById(sectionId);
                    if (section) {
                        section.style.display = 'block';
                        section.classList.add('admin-only');
                        section.classList.remove('guest-only');
                        section.classList.remove('hidden-for-guest');
                    }
                });
                
                // Nascondi la sezione benvenuto per admin
                const benvenutoSection = document.getElementById('benvenuto');
                if (benvenutoSection) {
                    benvenutoSection.style.display = 'none';
                    benvenutoSection.classList.add('guest-only');
                    benvenutoSection.classList.remove('admin-only');
                }
                
            } else if (currentUser === 'guest') {
                // Nascondi tutte le tab admin per ospiti
                const adminTabIds = ['dashboard', 'clienti', 'fatture'];
                adminTabIds.forEach(tabId => {
                    const tab = document.querySelector(`.nav-tab[onclick*="showTab('${tabId}')"]`);
                    if (tab) {
                        tab.style.display = 'none';
                        tab.classList.add('admin-only');
                        tab.classList.add('hidden-for-guest');
                        tab.classList.remove('guest-only');
                    }
                });
                
                // Mostra la tab benvenuto per ospiti
                const benvenutoTab = document.querySelector('.nav-tab[onclick*="showTab(\'benvenuto\')"]');
                if (benvenutoTab) {
                    benvenutoTab.style.display = 'block';
                    benvenutoTab.classList.add('guest-only');
                    benvenutoTab.classList.remove('admin-only');
                    benvenutoTab.classList.remove('hidden-for-guest');
                }
                
                // Nascondi le sezioni admin per ospiti
                adminTabIds.forEach(sectionId => {
                    const section = document.getElementById(sectionId);
                    if (section) {
                        section.style.display = 'none';
                        section.classList.add('admin-only');
                        section.classList.add('hidden-for-guest');
                        section.classList.remove('guest-only');
                    }
                });
                
                // Mostra la sezione benvenuto per ospiti
                const benvenutoSection = document.getElementById('benvenuto');
                if (benvenutoSection) {
                    benvenutoSection.style.display = 'block';
                    benvenutoSection.classList.add('guest-only');
                    benvenutoSection.classList.remove('admin-only');
                }
            }
            
            // Forza il nascondimento di tutte le sezioni all'avvio
            forceHideAllSections();
            
            // Avvia il monitoraggio sicuro
            startSafeMonitoring();
        }
    </script>
</body>
</html> 