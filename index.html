<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Tommy - Privilege Caf√®&Wine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: white;
            color: #ff6b6b;
            border-bottom: 3px solid #ff6b6b;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h3 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ff6b6b;
            font-size: 1.5em;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: #ff6b6b;
            color: white;
        }

        .btn-primary:hover {
            background: #ee5a24;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-paid {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-overdue {
            background: #f8d7da;
            color: #721c24;
        }

        .stock-low {
            background: #f8d7da;
            color: #721c24;
        }

        .stock-ok {
            background: #d4edda;
            color: #155724;
        }

        .actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 30px;
        }

        .export-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .export-section h4 {
            margin-bottom: 15px;
            color: #333;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }

        /* Stili per la stampa del listino vini */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .print-wine-list, .print-wine-list * {
                visibility: visible;
            }
            
            .print-wine-list {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: white;
                padding: 20px;
                margin: 0;
            }
            
                                    .wine-header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 3px solid #228B22;
                            padding-bottom: 20px;
                            position: relative;
                        }
                        
                        .wine-header::before,
                        .wine-header::after {
                            content: 'üç∑';
                            font-size: 24px;
                            position: absolute;
                            top: 50%;
                            transform: translateY(-50%);
                        }
                        
                        .wine-header::before {
                            left: 20px;
                        }
                        
                        .wine-header::after {
                            right: 20px;
                        }
                        
                        .wine-title {
                            font-size: 36px;
                            font-weight: bold;
                            color: #228B22;
                            margin: 0;
                            font-family: 'Georgia', serif;
                        }
            
            .wine-subtitle {
                font-size: 18px;
                color: #666;
                margin: 10px 0 0 0;
                font-style: italic;
            }
            
            .wine-date {
                font-size: 14px;
                color: #888;
                margin: 5px 0 0 0;
            }
            
                                    .wine-category {
                            margin: 40px 0 20px 0;
                            font-size: 24px;
                            font-weight: bold;
                            color: #228B22;
                            border-bottom: 2px solid #228B22;
                            padding-bottom: 12px;
                            text-transform: uppercase;
                            letter-spacing: 1px;
                            position: relative;
                            text-align: center;
                        }
                        
                        .wine-category::before {
                            content: '';
                            position: absolute;
                            top: 50%;
                            left: 0;
                            right: 0;
                            height: 1px;
                            background: linear-gradient(to right, transparent, #228B22, transparent);
                        }
                        
                        .wine-category::after {
                            content: 'üçá';
                            position: absolute;
                            top: 50%;
                            right: 10px;
                            transform: translateY(-50%);
                            font-size: 18px;
                        }
            
            .wine-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px 0;
                border-bottom: 1px solid #f0f0f0;
                font-size: 16px;
            }
            
            .wine-item:last-child {
                border-bottom: 2px solid #ddd;
            }
            
            .wine-name {
                font-weight: 600;
                color: #333;
                flex: 1;
            }
            
            .wine-price {
                font-weight: bold;
                color: #8B0000;
                font-size: 18px;
                min-width: 80px;
                text-align: right;
            }
            
            .wine-tipologia {
                font-size: 14px;
                color: #666;
                font-style: italic;
                margin-left: 20px;
                flex: 0 0 120px;
            }
            
            .page-break {
                page-break-before: always;
            }
            
            .wine-footer {
                margin-top: 40px;
                text-align: center;
                font-size: 12px;
                color: #888;
                border-top: 1px solid #ddd;
                padding-top: 20px;
            }
        }

        /* Animazione per loading spinner */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Miglioramenti responsive per tabelle */
        @media (max-width: 768px) {
            .data-table {
                font-size: 12px;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px 4px;
            }
            
            .btn-sm {
                padding: 4px 8px;
                font-size: 12px;
            }
        }
        
        /* Stili per tabelle con scroll orizzontale */
        .table-scroll-container {
            overflow-x: auto;
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .table-scroll-container::-webkit-scrollbar {
            height: 8px;
        }
        
        .table-scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .table-scroll-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .table-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .scrollable-table {
            min-width: 1200px; /* Larghezza minima per contenere tutte le colonne */
            width: 100%;
        }
        
        .scrollable-table th,
        .scrollable-table td {
            white-space: nowrap;
            padding: 12px 8px;
        }
        
        /* Stili specifici per colonne importanti */
        .scrollable-table td:nth-child(1) { /* Nome */
            font-weight: 600;
            min-width: 150px;
        }
        
        .scrollable-table td:nth-child(8) { /* Prezzo Ingrosso */
            font-weight: 600;
            color: #28a745;
        }
        
        .scrollable-table td:nth-child(9) { /* Prezzo Dettaglio */
            font-weight: 600;
            color: #dc3545;
        }
        
        .scrollable-table td:nth-child(10) { /* Quantit√† */
            text-align: center;
            font-weight: 600;
        }
        
        .scrollable-table td:nth-child(14) { /* Azioni */
            white-space: nowrap;
            min-width: 120px;
        }

        /* Stili per la censura e il sistema di sicurezza */
        .censored {
            color: transparent;
            text-shadow: 0 0 8px #000;
            user-select: none;
            position: relative;
        }

        .censored::before {
            content: '***';
            color: #666;
            text-shadow: none;
            position: absolute;
            left: 0;
            top: 0;
        }

        .security-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .security-modal {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .security-modal h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .security-modal input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            text-align: center;
        }

        .security-modal input:focus {
            outline: none;
            border-color: #ff6b6b;
        }

        .security-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .security-toggle:hover {
            background: #ee5a24;
            transform: translateY(-2px);
        }

        .security-toggle.active {
            background: #28a745;
        }

        .security-toggle.active:hover {
            background: #218838;
        }

        .security-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
            text-align: center;
        }

        .security-warning strong {
            color: #d63031;
        }

        /* Animazione per il toggle di sicurezza */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .security-toggle.alert {
            animation: pulse 2s infinite;
            background: #dc3545;
        }

        /* Stili per i campi censurati nelle tabelle */
        .table-censored {
            position: relative;
        }

        .table-censored .censored {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 2px 6px;
        }

        /* Stili per i modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 90%;
            max-height: 90%;
            width: 1200px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.5em;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Stili per la sezione prodotti */
        .prodotti-section {
            margin: 30px 0;
        }

        .prodotti-controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        .prodotti-table-container {
            overflow-x: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }

        .prodotti-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        .prodotti-table th,
        .prodotti-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .prodotti-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .prodotti-table input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .prodotti-table input:focus {
            outline: none;
            border-color: #ff6b6b;
        }

        /* Stili per i totali */
        .totali-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .totali-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .totali-grid input {
            font-weight: bold;
            font-size: 16px;
            background: white;
        }

        /* Stili per il catalogo */
        .catalogo-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .catalogo-tab {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .catalogo-tab.active {
            color: #ff6b6b;
            border-bottom: 3px solid #ff6b6b;
        }

        .catalogo-tab:hover {
            background: #e9ecef;
        }

        .catalogo-tab-content {
            display: none;
        }

        .catalogo-tab-content.active {
            display: block;
        }

        .catalogo-table {
            width: 100%;
            border-collapse: collapse;
        }

        .catalogo-table th,
        .catalogo-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .catalogo-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .catalogo-table tr:hover {
            background: #f8f9fa;
        }

        /* Stili per la tabella di anteprima */
        .anteprima-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .anteprima-section h5 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
        }

        .anteprima-table-container {
            overflow-x: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: white;
        }

        .anteprima-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        .anteprima-table th,
        .anteprima-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
        }

        .anteprima-table th {
            background: #e9ecef;
            font-weight: 600;
            color: #495057;
        }

        .anteprima-table tr:hover {
            background: #f8f9fa;
        }

        .anteprima-table .sconto-cell {
            font-weight: 600;
            color: #dc3545;
        }

        .anteprima-table .subtotale-cell {
            font-weight: 600;
            color: #28a745;
        }

        /* Stili per i controlli nell'anteprima */
        .anteprima-table input[type="number"],
        .anteprima-table select {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .anteprima-table input[type="number"]:focus,
        .anteprima-table select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .anteprima-table .sconto-cell .flex-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Stili per il pulsante elimina nell'anteprima */
        .anteprima-table .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .anteprima-table .btn-danger:hover {
            background: #c82333;
        }

        /* Stili per i badge */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-primary {
            background: #007bff;
            color: white;
        }

        .badge-warning {
            background: #ffc107;
            color: #212529;
        }

        .badge-info {
            background: #17a2b8;
            color: white;
        }

        .badge-secondary {
            background: #6c757d;
            color: white;
        }

        /* Responsive per il sistema di sicurezza */
        @media (max-width: 768px) {
            .security-toggle {
                top: 10px;
                right: 10px;
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .security-modal {
                margin: 20px;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading Indicator -->
        <div id="loadingIndicator" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
                <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #ff6b6b; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
                <p>Caricamento...</p>
            </div>
        </div>

        <!-- Sistema di Login -->
        <div id="loginOverlay" class="security-overlay">
            <div class="security-modal">
                <h3>üç∑ Gestione Tommy - Accesso</h3>
                <div class="security-warning">
                    <strong>üîê LOGIN:</strong><br>
                    Inserisci le credenziali per accedere al sistema
                </div>
                <input type="text" id="loginUsername" placeholder="Username..." style="margin-bottom: 10px;">
                <input type="password" id="loginPassword" placeholder="Password..." onkeypress="handleLoginPassword(event)">
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-primary" onclick="validateLogin()">üîì Accedi</button>
                    <button class="btn btn-secondary" onclick="guestLogin()">üë§ Accesso Cliente</button>
                </div>
            </div>
        </div>

        <!-- Sistema di Sicurezza -->
        <button id="securityToggle" class="security-toggle" onclick="toggleSecurity()" title="üîí Attiva/Disattiva Sicurezza" style="display: none;">
            üîí Sicurezza
        </button>

        <!-- Modal per Password di Sicurezza -->
        <div id="securityOverlay" class="security-overlay">
            <div class="security-modal">
                <h3 id="securityModalTitle">üîê Accesso Sicurezza</h3>
                <div class="security-warning" id="securityWarning">
                    <strong>‚ö†Ô∏è ATTENZIONE:</strong><br>
                    Inserisci la password per visualizzare i prezzi di acquisto
                </div>
                <input type="password" id="securityPassword" placeholder="Inserisci password..." onkeypress="handleSecurityPassword(event)">
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-primary" id="securityActionBtn" onclick="validateSecurityPassword()">üîì Sblocca</button>
                    <button class="btn btn-secondary" onclick="cancelSecurity()">‚ùå Annulla</button>
                </div>
                <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-info" onclick="showChangePasswordModal()">üîë Cambia Password</button>
                </div>
                <p style="margin-top: 15px; font-size: 12px; color: #666;">
                    Password attuale: <strong id="currentPasswordDisplay">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</strong>
                </p>
            </div>
        </div>

        <!-- Modal per Cambio Password -->
        <div id="changePasswordOverlay" class="security-overlay">
            <div class="security-modal">
                <h3>üîë Cambio Password</h3>
                <div class="security-warning">
                    <strong>‚ö†Ô∏è ATTENZIONE:</strong><br>
                    Inserisci la password attuale e poi la nuova password
                </div>
                <input type="password" id="currentPassword" placeholder="Password attuale..." style="margin-bottom: 10px;">
                <input type="password" id="newPassword" placeholder="Nuova password..." style="margin-bottom: 10px;">
                <input type="password" id="confirmPassword" placeholder="Conferma nuova password..." style="margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-primary" onclick="changePassword()">üîë Cambia Password</button>
                    <button class="btn btn-secondary" onclick="cancelChangePassword()">‚ùå Annulla</button>
                </div>
            </div>
        </div>

        <!-- Modal per Configurazione GitHub -->
        <div id="githubConfigOverlay" class="security-overlay">
            <div class="security-modal">
                <h3>‚öôÔ∏è Configurazione GitHub</h3>
                <div class="security-warning">
                    <strong>üì° SINCRONIZZAZIONE:</strong><br>
                    Configura GitHub per sincronizzare i dati tra dispositivi
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">GitHub Token:</label>
                    <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <small style="color: #666; font-size: 12px;">Token personale con permessi gist</small>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Gist ID:</label>
                    <input type="text" id="gistId" placeholder="xxxxxxxxxxxxxxxxxxxx" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <small style="color: #666; font-size: 12px;">ID del Gist (crea un nuovo Gist e copia l'ID)</small>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="githubEnabled" style="margin: 0;">
                        <span>Abilita sincronizzazione GitHub</span>
                    </label>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-primary" onclick="saveGitHubConfig()">üíæ Salva Configurazione</button>
                    <button class="btn btn-secondary" onclick="hideGitHubConfig()">‚ùå Annulla</button>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px;">
                    <strong>üìã Istruzioni:</strong><br>
                    1. Crea un token GitHub su Settings > Developer settings > Personal access tokens<br>
                    2. Crea un nuovo Gist su gist.github.com<br>
                    3. Inserisci token e Gist ID qui sopra<br>
                    4. I dati verranno sincronizzati automaticamente
                </div>
            </div>
        </div>

        <!-- Modal per Configurazione GitHub Obbligatoria all'Avvio -->
        <div id="githubSetupOverlay" class="security-overlay">
            <div class="security-modal">
                <h3>üîß Configurazione Iniziale GitHub</h3>
                <div class="security-warning">
                    <strong>üì° SINCRONIZZAZIONE CLOUD:</strong><br>
                    Inserisci il tuo token GitHub per abilitare la sincronizzazione tra dispositivi
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">GitHub Token:</label>
                    <input type="password" id="githubTokenSetup" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <small style="color: #666; font-size: 12px;">Token personale con permessi gist</small>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Gist ID (opzionale):</label>
                    <input type="text" id="gistIdSetup" placeholder="ed140f6366c097f54410d096017bb51b" value="ed140f6366c097f54410d096017bb51b" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <small style="color: #666; font-size: 12px;">ID del Gist (pre-compilato con il tuo Gist)</small>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-primary" onclick="saveGitHubSetup()">‚úÖ Configura e Continua</button>
                    <button class="btn btn-secondary" onclick="skipGitHubSetup()">‚è≠Ô∏è Salta Configurazione</button>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px;">
                    <strong>üí° Suggerimento:</strong><br>
                    Se non hai ancora un token, puoi saltare questa configurazione e inserirla dopo tramite il pulsante ‚öôÔ∏è GitHub
                </div>
            </div>
        </div>
        
        <div class="header">
            <h1>üç∑ Gestione Tommy</h1>
            <p>Privilege Caf√®&Wine - Sistema di Gestione Dati</p>
            <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">
                üíæ Dati salvati automaticamente nel browser
                <div id="syncStatus" style="margin-top: 5px; font-size: 0.8em;">
                    <span id="syncIndicator">üîÑ Sincronizzazione attiva</span>
                    <span id="deviceInfo" style="margin-left: 10px;">üì± Dispositivo: <span id="deviceIdDisplay"></span></span>
                </div>
            </div>
                                <div id="userInfo" style="margin-top: 10px; display: none;">
                        <span id="currentUserDisplay"></span>
                        <button class="btn btn-sm btn-secondary" onclick="logout()" style="margin-left: 10px;">üö™ Logout</button>
                        <button class="btn btn-sm btn-info" onclick="forceSync()" style="margin-left: 10px;" title="üîÑ Forza sincronizzazione">üîÑ Sync</button>
                        <button class="btn btn-sm btn-warning" onclick="showGitHubConfig()" style="margin-left: 10px;" title="‚öôÔ∏è Configura GitHub">‚öôÔ∏è GitHub</button>
                    </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('clienti', event)">üë• Clienti</button>
            <button class="nav-tab" onclick="showTab('fatture', event)">üìÑ Fatture</button>
            <button class="nav-tab" onclick="showTab('prodotti', event)">üç∫ Prodotti</button>
            <button class="nav-tab" onclick="showTab('vini', event)">üç∑ Vini</button>
        </div>

        <!-- TAB CLIENTI -->
        <div id="clienti" class="tab-content active">
            <div class="form-section">
                <h3>üìù Inserimento Nuovo Cliente</h3>
                <form id="clienteForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nome Azienda</label>
                            <input type="text" name="nomeAzienda" placeholder="Nome dell'azienda (lasciare vuoto per privati)">
                        </div>
                        <div class="form-group">
                            <label>Tipologia *</label>
                            <select name="tipologia" required onchange="toggleNomeAzienda()">
                                <option value="">Seleziona tipologia...</option>
                                <option value="privato">Privato</option>
                                <option value="azienda">Azienda</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Nome Referente *</label>
                            <input type="text" name="nome" required>
                        </div>
                        <div class="form-group">
                            <label>Cognome Referente *</label>
                            <input type="text" name="cognome" required>
                        </div>
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" name="email" required>
                        </div>
                        <div class="form-group">
                            <label>Telefono *</label>
                            <input type="tel" name="telefono" required>
                        </div>
                        <div class="form-group">
                            <label>Indirizzo</label>
                            <input type="text" name="indirizzo">
                        </div>
                        <div class="form-group">
                            <label>Citt√†</label>
                            <input type="text" name="citta">
                        </div>
                        <div class="form-group">
                            <label>CAP</label>
                            <input type="text" name="cap">
                        </div>
                        <div class="form-group">
                            <label>Data Registrazione</label>
                            <input type="date" name="dataRegistrazione">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Note</label>
                        <textarea name="note" placeholder="Note aggiuntive sul cliente..."></textarea>
                    </div>
                    <div class="actions">
                        <button type="submit" class="btn btn-primary">‚ûï Aggiungi Cliente</button>
                        <button type="button" class="btn btn-success" onclick="exportToExcel('clienti')">üìä Esporta Excel</button>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('importClienti').click()">üì• Importa Excel</button>
                        <input type="file" id="importClienti" accept=".xlsx,.xls" style="display: none;" onchange="importFromExcel('clienti', this)">
                    </div>
                </form>
            </div>

            <div class="export-section">
                <h4>üìã Lista Clienti</h4>
                <table id="clientiTable" class="data-table">
                    <thead>
                        <tr>
                            <th>Nome Azienda</th>
                            <th>Tipologia</th>
                            <th>Nome Referente</th>
                            <th>Cognome Referente</th>
                            <th>Email</th>
                            <th>Telefono</th>
                            <th>Citt√†</th>
                            <th>Data Registrazione</th>
                            <th>Note</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="clientiTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- TAB FATTURE -->
        <div id="fatture" class="tab-content">
            <div class="form-section">
                <h3>üìÑ Gestione Documenti</h3>
                <div class="actions">
                    <button type="button" class="btn btn-primary" onclick="showFatturaModal()">üìÑ Nuova Fattura</button>
                    <button type="button" class="btn btn-warning" onclick="showProformaModal()">üìã Nuova Proforma</button>
                    <button type="button" class="btn btn-info" onclick="showDDTModal()">üöö Nuovo DDT</button>
                    <button type="button" class="btn btn-success" onclick="exportToExcel('fatture')">üìä Esporta Excel</button>
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('importFatture').click()">üì• Importa Excel</button>
                    <input type="file" id="importFatture" accept=".xlsx,.xls" style="display: none;" onchange="importFromExcel('fatture', this)">
                </div>
            </div>

            <div class="export-section">
                <h4>üìã Lista Documenti</h4>
                <table id="fattureTable" class="data-table">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Numero</th>
                            <th>Cliente</th>
                            <th>Data</th>
                            <th>Scadenza</th>
                            <th>Subtotale</th>
                            <th>Sconto Extra</th>
                            <th>Totale</th>
                            <th>Stato</th>
                            <th>Note</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="fattureTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- TAB PRODOTTI -->
        <div id="prodotti" class="tab-content">
            <div class="form-section">
                <h3>üç∫ Inserimento Nuovo Prodotto</h3>
                <form id="prodottoForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nome Prodotto *</label>
                            <input type="text" name="nome" required>
                        </div>
                        <div class="form-group">
                            <label>Categoria Principale *</label>
                            <select name="categoriaPrincipale" id="categoriaPrincipale" required onchange="updateSottocategorie()">
                                <option value="">Seleziona categoria...</option>
                                <option value="distillati">Distillati</option>
                                <option value="liquori">Liquori</option>
                                <option value="vini">Vini</option>
                                <option value="birre">Birre</option>
                                <option value="altro">Altro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Sottocategoria *</label>
                            <select name="sottocategoria" id="sottocategoria" required>
                                <option value="">Prima seleziona una categoria...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Marca</label>
                            <input type="text" name="marca">
                        </div>
                        <div class="form-group">
                            <label>Prezzo Acquisto (‚Ç¨) <span id="securityLabelProdotti" style="color: #dc3545; font-size: 12px;">üîí</span></label>
                            <input type="number" name="prezzoAcquisto" step="0.01" id="prezzoAcquistoProdottiInput">
                        </div>
                        <div class="form-group">
                            <label>Prezzo Vendita Ingrosso (‚Ç¨) *</label>
                            <input type="number" name="prezzoVenditaIngrosso" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Prezzo Vendita al Dettaglio (‚Ç¨) *</label>
                            <input type="number" name="prezzoVenditaDettaglio" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Quantit√† in Stock *</label>
                            <input type="number" name="quantita" required>
                        </div>
                        <div class="form-group">
                            <label>Quantit√† Minima</label>
                            <input type="number" name="quantitaMinima" value="5">
                        </div>
                        <div class="form-group">
                            <label>Fornitore</label>
                            <input type="text" name="fornitore">
                        </div>
                        <div class="form-group">
                            <label>Codice Prodotto</label>
                            <input type="text" name="codiceProdotto">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Note</label>
                        <textarea name="note" placeholder="Note sul prodotto..."></textarea>
                    </div>
                    <div class="actions">
                        <button type="submit" class="btn btn-primary">‚ûï Aggiungi Prodotto</button>
                        <button type="button" class="btn btn-success" onclick="exportToExcel('prodotti', 'dettaglio')">üìä Esporta Excel Dettaglio</button>
                        <button type="button" class="btn btn-warning" onclick="exportToExcel('prodotti', 'ingrosso')">üìä Esporta Excel Ingrosso</button>
                        <button type="button" class="btn btn-info" onclick="exportToExcel('prodotti', 'completo')">üìä Esporta Excel Completo</button>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('importProdotti').click()">üì• Importa Excel</button>
                        <input type="file" id="importProdotti" accept=".xlsx,.xls" style="display: none;" onchange="importFromExcel('prodotti', this)">
                    </div>
                </form>
            </div>

            <div class="export-section">
                <h4>üìã Lista Prodotti</h4>
                
                <!-- Sistema di Filtri -->
                <div class="filters-section" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h5 style="margin-bottom: 15px; color: #333;">üîç Filtri di Ricerca</h5>
                    <div class="filters-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Nome Prodotto</label>
                            <input type="text" id="filterNomeProdotti" placeholder="Cerca per nome..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Categoria Principale</label>
                            <select id="filterCategoriaPrincipale" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Tutte le categorie</option>
                                <option value="distillati">Distillati</option>
                                <option value="liquori">Liquori</option>
                                <option value="vini">Vini</option>
                                <option value="birre">Birre</option>
                                <option value="altro">Altro</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Marca</label>
                            <input type="text" id="filterMarca" placeholder="Cerca per marca..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Fornitore</label>
                            <input type="text" id="filterFornitore" placeholder="Cerca per fornitore..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Stato Stock</label>
                            <select id="filterStockProdotti" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Tutti</option>
                                <option value="ok">OK</option>
                                <option value="basso">Scorte Basse</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Prezzo</label>
                            <select id="filterPrezzo" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Tutti i prezzi</option>
                                <option value="basso">Prezzo basso (< ‚Ç¨10)</option>
                                <option value="medio">Prezzo medio (‚Ç¨10-‚Ç¨30)</option>
                                <option value="alto">Prezzo alto (> ‚Ç¨30)</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-actions" style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button type="button" class="btn btn-primary" onclick="applyProdottiFilters()">üîç Applica Filtri</button>
                        <button type="button" class="btn btn-secondary" onclick="clearProdottiFilters()">üóëÔ∏è Cancella Filtri</button>
                        <span id="filterResultsProdotti" style="margin-left: 10px; font-weight: 600; color: #666;"></span>
                    </div>
                </div>
                
                <table id="prodottiTable" class="data-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Categoria</th>
                            <th>Marca</th>
                            <th id="prezzoAcquistoHeaderProdotti" style="display: none;">Prezzo Acquisto</th>
                            <th>Prezzo Ingrosso</th>
                            <th>Prezzo Dettaglio</th>
                            <th>Quantit√†</th>
                            <th>Stato Stock</th>
                            <th>Fornitore</th>
                            <th>Note</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="prodottiTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- TAB VINI -->
        <div id="vini" class="tab-content">
            <div class="form-section">
                <h3>üç∑ Inserimento Nuovo Vino</h3>
                <form id="vinoForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nome Vino *</label>
                            <input type="text" name="nome" required>
                        </div>
                        <div class="form-group">
                            <label>Produttore *</label>
                            <input type="text" name="produttore" required>
                        </div>
                        <div class="form-group">
                            <label>Annata *</label>
                            <input type="number" name="annata" min="1900" max="2030" required>
                        </div>
                        <div class="form-group">
                            <label>Tipologia Vino *</label>
                            <select name="tipologia" required>
                                <option value="">Seleziona tipologia...</option>
                                <option value="rosso">Rosso</option>
                                <option value="bianco">Bianco</option>
                                <option value="rosato">Rosato</option>
                                <option value="spumante">Spumante</option>
                                <option value="frizzante">Vino Frizzante</option>
                                <option value="dolce">Vino Dolce</option>
                                <option value="franciacorta">Franciacorta</option>
                                <option value="metodo-classico">Metodo Classico</option>
                                <option value="prosecco">Prosecco</option>
                                <option value="champagne">Champagne</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Regione</label>
                            <input type="text" name="regione">
                        </div>
                        <div class="form-group">
                            <label>Vitigno</label>
                            <input type="text" name="vitigno" placeholder="es. Sangiovese, Nebbiolo, Chardonnay...">
                        </div>
                        <div class="form-group">
                            <label>Prezzo Acquisto (‚Ç¨) <span id="securityLabelVini" style="color: #dc3545; font-size: 12px;">üîí</span></label>
                            <input type="number" name="prezzoAcquisto" step="0.01" id="prezzoAcquistoViniInput">
                        </div>
                        <div class="form-group">
                            <label>Prezzo Vendita Ingrosso (‚Ç¨) *</label>
                            <input type="number" name="prezzoVenditaIngrosso" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Prezzo Vendita al Dettaglio (‚Ç¨) *</label>
                            <input type="number" name="prezzoVenditaDettaglio" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Quantit√† *</label>
                            <input type="number" name="quantita" required>
                        </div>
                        <div class="form-group">
                            <label>Unit√† di Misura</label>
                            <input type="text" name="unitaMisura" placeholder="es. bottiglie, cassette, litri...">
                        </div>
                        <div class="form-group">
                            <label>Fornitore</label>
                            <input type="text" name="fornitore">
                        </div>
                        <div class="form-group">
                            <label>Codice Prodotto</label>
                            <input type="text" name="codiceProdotto">
                        </div>

                    </div>
                    <div class="form-group">
                        <label>Descrizione</label>
                        <textarea name="descrizione" placeholder="Descrizione del vino..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Note</label>
                        <textarea name="note" placeholder="Note aggiuntive..."></textarea>
                    </div>
                    <div class="actions">
                        <button type="submit" class="btn btn-primary">‚ûï Aggiungi Vino</button>
                        <button type="button" class="btn btn-success" onclick="exportToExcel('vini', 'dettaglio')">üìä Esporta Excel Dettaglio</button>
                        <button type="button" class="btn btn-warning" onclick="exportToExcel('vini', 'ingrosso')">üìä Esporta Excel Ingrosso</button>
                        <button type="button" class="btn btn-info" onclick="exportToExcel('vini', 'completo')">üìä Esporta Excel Completo</button>
                        <button type="button" class="btn btn-primary" onclick="printWineList()">üñ®Ô∏è Stampa Listino</button>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('importVini').click()">üì• Importa Excel</button>
                        <input type="file" id="importVini" accept=".xlsx,.xls" style="display: none;" onchange="importFromExcel('vini', this)">
                    </div>
                </form>
            </div>

            <div class="export-section">
                <h4>üìã Lista Vini</h4>
                
                <!-- Sistema di Filtri -->
                <div class="filters-section" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h5 style="margin-bottom: 15px; color: #333;">üîç Filtri di Ricerca</h5>
                    <div class="filters-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Nome Vino</label>
                            <input type="text" id="filterNome" placeholder="Cerca per nome..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Produttore</label>
                            <input type="text" id="filterProduttore" placeholder="Cerca per produttore..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Tipologia</label>
                            <select id="filterTipologia" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Tutte le tipologie</option>
                                <option value="rosso">Rosso</option>
                                <option value="bianco">Bianco</option>
                                <option value="rosato">Rosato</option>
                                <option value="spumante">Spumante</option>
                                <option value="frizzante">Vino Frizzante</option>
                                <option value="dolce">Vino Dolce</option>
                                <option value="franciacorta">Franciacorta</option>
                                <option value="metodo-classico">Metodo Classico</option>
                                <option value="prosecco">Prosecco</option>
                                <option value="champagne">Champagne</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Regione</label>
                            <input type="text" id="filterRegione" placeholder="Cerca per regione..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Vitigno</label>
                            <input type="text" id="filterVitigno" placeholder="Cerca per vitigno..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Stato Stock</label>
                            <select id="filterStock" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Tutti</option>
                                <option value="ok">OK</option>
                                <option value="basso">Scorte Basse</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-actions" style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button type="button" class="btn btn-primary" onclick="applyViniFilters()">üîç Applica Filtri</button>
                        <button type="button" class="btn btn-secondary" onclick="clearViniFilters()">üóëÔ∏è Cancella Filtri</button>
                        <span id="filterResults" style="margin-left: 10px; font-weight: 600; color: #666;"></span>
                    </div>
                </div>
                
                <div class="table-scroll-container">
                    <table id="viniTable" class="data-table scrollable-table">
                        <thead>
                            <tr>
                                                            <th>Nome</th>
                            <th>Produttore</th>
                            <th>Annata</th>
                            <th>Tipologia</th>
                            <th>Regione</th>
                            <th>Vitigno</th>
                            <th id="prezzoAcquistoHeaderVini" style="display: none;">Prezzo Acquisto</th>
                            <th>Prezzo Ingrosso</th>
                            <th>Prezzo Dettaglio</th>
                            <th>Quantit√†</th>
                            <th>Unit√†</th>
                            <th>Stato Stock</th>
                            <th>Note</th>
                            <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="viniTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Fattura -->
    <div id="fatturaModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìÑ Nuova Fattura</h3>
                <button class="modal-close" onclick="hideFatturaModal()">&times;</button>
            </div>
            <form id="fatturaFormModal">
                <div class="modal-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Tipo Documento *</label>
                            <select name="tipoDocumento" required>
                                <option value="fattura">Fattura</option>
                                <option value="proforma">Proforma</option>
                                <option value="ddt">DDT</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Numero Documento *</label>
                            <input type="text" name="numero" required>
                        </div>
                        <div class="form-group">
                            <label>Cliente *</label>
                            <select name="cliente" required>
                                <option value="">Seleziona cliente...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Data Documento *</label>
                            <input type="date" name="data" required>
                        </div>
                        <div class="form-group">
                            <label>Data Scadenza</label>
                            <input type="date" name="scadenza">
                        </div>
                        <div class="form-group">
                            <label>Sconto Extra (‚Ç¨)</label>
                            <input type="number" name="scontoExtra" step="0.01" value="0" onchange="calcolaTotali()" placeholder="0.00">
                        </div>
                    </div>
                    
                    <div class="prodotti-section">
                        <h4>üõí Prodotti/Servizi (Prezzi IVA Inclusa)</h4>
                        <div class="prodotti-controls">
                            <button type="button" class="btn btn-sm btn-primary" onclick="aggiungiRigaProdotto()">‚ûï Aggiungi Prodotto</button>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="selezionaDaCatalogo()">üìã Seleziona da Catalogo</button>
                        </div>
                        
                        <!-- Tabella di inserimento prodotti -->
                        <div class="prodotti-table-container">
                            <table id="prodottiTable" class="prodotti-table">
                                <thead>
                                    <tr>
                                        <th>Prodotto/Servizio</th>
                                        <th>Quantit√†</th>
                                        <th>Prezzo Unitario (IVA Inclusa)</th>
                                        <th>Tipo Sconto</th>
                                        <th>Valore Sconto</th>
                                        <th>Subtotale Riga</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="prodottiTableBody"></tbody>
                            </table>
                        </div>
                        
                        <!-- Tabella di anteprima prodotti -->
                        <div class="anteprima-section">
                            <h5>üìã Anteprima Prodotti Aggiunti</h5>
                            <div class="anteprima-table-container">
                                <table id="anteprimaTable" class="anteprima-table">
                                    <thead>
                                        <tr>
                                            <th>Prodotto</th>
                                            <th>Q.t√†</th>
                                            <th>Prezzo Unit.</th>
                                            <th>Sconto</th>
                                            <th>Subtotale</th>
                                            <th>Azioni</th>
                                        </tr>
                                    </thead>
                                    <tbody id="anteprimaTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="totali-section">
                        <div class="totali-grid">
                            <div class="form-group">
                                <label>Subtotale</label>
                                <input type="number" name="subtotale" step="0.01" readonly>
                            </div>
                            <div class="form-group">
                                <label>Sconto Extra</label>
                                <input type="number" name="scontoExtraDisplay" step="0.01" readonly>
                            </div>
                            <div class="form-group">
                                <label>Totale</label>
                                <input type="number" name="totale" step="0.01" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Note</label>
                        <textarea name="note" placeholder="Note sul documento..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">üíæ Salva Documento</button>
                    <button type="button" class="btn btn-success" onclick="stampaDocumento()">üñ®Ô∏è Stampa</button>
                    <button type="button" class="btn btn-secondary" onclick="hideFatturaModal()">‚ùå Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Selezione Catalogo -->
    <div id="catalogoModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìã Selezione da Catalogo</h3>
                <button class="modal-close" onclick="hideCatalogoModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="catalogo-tabs">
                    <button class="catalogo-tab active" onclick="showCatalogoTab('prodotti')">üç∫ Prodotti</button>
                    <button class="catalogo-tab" onclick="showCatalogoTab('vini')">üç∑ Vini</button>
                </div>
                <div class="catalogo-content">
                    <div id="catalogoProdotti" class="catalogo-tab-content active">
                        <table class="catalogo-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Categoria</th>
                                    <th>Prezzo Ingrosso</th>
                                    <th>Prezzo Dettaglio</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="catalogoProdottiBody"></tbody>
                        </table>
                    </div>
                    <div id="catalogoVini" class="catalogo-tab-content">
                        <table class="catalogo-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Produttore</th>
                                    <th>Prezzo Ingrosso</th>
                                    <th>Prezzo Dettaglio</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="catalogoViniBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Dati in memoria
        let clienti = [];
        let documenti = [];
        let prodotti = [];
        let vini = [];
        
        // Stato dell'applicazione
        let isLoading = false;
        let currentFilters = {};
        
        // Sistema di sicurezza e accesso
        let isSecurityActive = true; // Di default attiva la censura
        let isSecurityUnlocked = false; // Se la password √® stata inserita correttamente
        let SECURITY_PASSWORD = 'Tommy123'; // Password predefinita
        let currentUser = null; // 'admin' o 'guest'
        let isLoggedIn = false; // Se l'utente √® loggato
        
        // Sistema di sincronizzazione
        let lastSyncTime = 0;
        let syncInterval = null;
        let deviceId = generateDeviceId();
        let isOnline = navigator.onLine;
        
        // Configurazione GitHub
        const GITHUB_CONFIG = {
            token: localStorage.getItem('tommy_github_token') || '',
            gistId: localStorage.getItem('tommy_gist_id') || 'ed140f6366c097f54410d096017bb51b',
            enabled: localStorage.getItem('tommy_github_enabled') === 'true'
        };
        
        // Genera ID univoco per il dispositivo
        function generateDeviceId() {
            let deviceId = localStorage.getItem('tommy_device_id');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('tommy_device_id', deviceId);
            }
            return deviceId;
        }

        // Utility functions
        function showLoading(show = true) {
            isLoading = show;
            const loadingEl = document.getElementById('loadingIndicator');
            if (loadingEl) {
                loadingEl.style.display = show ? 'block' : 'none';
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">√ó</button>
            `;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#ffc107'};
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                display: flex;
                align-items: center;
                gap: 10px;
                max-width: 300px;
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }

        // Debounce function per performance
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Carica dati dal localStorage all'avvio con sincronizzazione robusta
        async function loadDataFromStorage() {
            try {
                showLoading(true);
                console.log('üîÑ Avvio caricamento dati...');
                
                // Carica dati locali con validazione
                const savedClienti = localStorage.getItem('tommy_clienti');
                const savedDocumenti = localStorage.getItem('tommy_documenti');
                const savedProdotti = localStorage.getItem('tommy_prodotti');
                const savedVini = localStorage.getItem('tommy_vini');
                
                // Validazione e caricamento dati
                if (savedClienti) {
                    try {
                        clienti = JSON.parse(savedClienti);
                        console.log(`‚úÖ Clienti caricati: ${clienti.length} record`);
                    } catch (e) {
                        console.error('‚ùå Errore parsing clienti:', e);
                        clienti = [];
                    }
                }
                
                if (savedDocumenti) {
                    try {
                        documenti = JSON.parse(savedDocumenti);
                        console.log(`‚úÖ Documenti caricati: ${documenti.length} record`);
                    } catch (e) {
                        console.error('‚ùå Errore parsing documenti:', e);
                        documenti = [];
                    }
                }
                
                if (savedProdotti) {
                    try {
                        prodotti = JSON.parse(savedProdotti);
                        console.log(`‚úÖ Prodotti caricati: ${prodotti.length} record`);
                    } catch (e) {
                        console.error('‚ùå Errore parsing prodotti:', e);
                        prodotti = [];
                    }
                }
                
                if (savedVini) {
                    try {
                        vini = JSON.parse(savedVini);
                        console.log(`‚úÖ Vini caricati: ${vini.length} record`);
                    } catch (e) {
                        console.error('‚ùå Errore parsing vini:', e);
                        vini = [];
                    }
                }
                
                // Sync forzato all'avvio
                console.log('üîÑ Avvio sincronizzazione forzata...');
                await forceSyncOnStartup();
                
                // Aggiorna le tabelle
                updateAllTables();
                showNotification('‚úÖ Dati caricati e sincronizzati con successo!', 'success');
                
                // Avvia il sistema di sincronizzazione
                startSyncSystem();
                
                // Imposta il salvataggio automatico alla chiusura
                setupAutoSaveOnClose();
                
            } catch (error) {
                console.error('‚ùå Errore nel caricamento dati:', error);
                showNotification('‚ùå Errore nel caricamento dei dati salvati', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Sync forzato all'avvio con controllo completo
        async function forceSyncOnStartup() {
            try {
                console.log('üîÑ Controllo aggiornamenti cloud...');
                
                // Prima controlla GitHub Gist se configurato
                if (GITHUB_CONFIG.enabled && GITHUB_CONFIG.token && GITHUB_CONFIG.gistId) {
                    console.log('üì° Controllo GitHub Gist...');
                    const githubData = await loadFromGitHubGist();
                    if (githubData) {
                        const localTimestamp = localStorage.getItem('tommy_last_sync');
                        const githubTime = githubData.lastModified;
                        const localTime = parseInt(localTimestamp) || 0;
                        
                        console.log(`üìä Timestamp locale: ${localTime}, GitHub: ${githubTime}`);
                        
                        if (githubTime > localTime && githubData.deviceId !== deviceId) {
                            console.log('‚úÖ Aggiornamento dati da GitHub...');
                            
                            // Aggiorna i dati locali con quelli di GitHub
                            clienti = githubData.clienti || clienti;
                            documenti = githubData.documenti || documenti;
                            prodotti = githubData.prodotti || prodotti;
                            vini = githubData.vini || vini;
                            
                            // Salva i dati aggiornati localmente
                            saveAllDataToLocalStorage();
                            localStorage.setItem('tommy_last_sync', githubTime.toString());
                            
                            console.log('‚úÖ Sincronizzazione GitHub completata');
                            showNotification('üì° Dati sincronizzati da GitHub!', 'success');
                            return true;
                        } else {
                            console.log('‚ÑπÔ∏è Nessun aggiornamento necessario da GitHub');
                        }
                    }
                }
                
                // Fallback: controlla localStorage cloud
                console.log('üì° Controllo localStorage cloud...');
                const cloudData = localStorage.getItem('tommy_cloud_data');
                const cloudTimestamp = localStorage.getItem('tommy_cloud_timestamp');
                const localTimestamp = localStorage.getItem('tommy_last_sync');
                
                if (cloudData && cloudTimestamp && localTimestamp) {
                    const cloudTime = parseInt(cloudTimestamp);
                    const localTime = parseInt(localTimestamp);
                    
                    console.log(`üìä Timestamp locale: ${localTime}, Cloud: ${cloudTime}`);
                    
                    if (cloudTime > localTime) {
                        // Ci sono dati pi√π recenti nel cloud
                        const cloudDataObj = JSON.parse(cloudData);
                        
                        // Verifica che i dati non siano dello stesso dispositivo
                        if (cloudDataObj.deviceId !== deviceId) {
                            console.log('‚úÖ Aggiornamento dati dal cloud...');
                            
                            // Aggiorna i dati locali con quelli del cloud
                            clienti = cloudDataObj.clienti || clienti;
                            documenti = cloudDataObj.documenti || documenti;
                            prodotti = cloudDataObj.prodotti || prodotti;
                            vini = cloudDataObj.vini || vini;
                            
                            // Salva i dati aggiornati localmente
                            saveAllDataToLocalStorage();
                            localStorage.setItem('tommy_last_sync', cloudTimestamp);
                            
                            console.log('‚úÖ Sincronizzazione cloud completata');
                            showNotification('üì° Dati sincronizzati dal cloud!', 'success');
                            return true;
                        }
                    }
                }
                
                console.log('‚ÑπÔ∏è Nessun aggiornamento necessario');
                return false;
                
            } catch (error) {
                console.error('‚ùå Errore nel sync forzato:', error);
                showNotification('‚ö†Ô∏è Errore sincronizzazione - Dati locali mantenuti', 'warning');
                return false;
            }
        }

        // Salva tutti i dati nel localStorage con validazione
        function saveAllDataToLocalStorage() {
            try {
                const timestamp = Date.now();
                
                // Validazione dati prima del salvataggio
                const validatedClienti = Array.isArray(clienti) ? clienti : [];
                const validatedDocumenti = Array.isArray(documenti) ? documenti : [];
                const validatedProdotti = Array.isArray(prodotti) ? prodotti : [];
                const validatedVini = Array.isArray(vini) ? vini : [];
                
                // Salvataggio con validazione
                localStorage.setItem('tommy_clienti', JSON.stringify(validatedClienti));
                localStorage.setItem('tommy_documenti', JSON.stringify(validatedDocumenti));
                localStorage.setItem('tommy_prodotti', JSON.stringify(validatedProdotti));
                localStorage.setItem('tommy_vini', JSON.stringify(validatedVini));
                localStorage.setItem('tommy_last_sync', timestamp.toString());
                localStorage.setItem('tommy_device_id', deviceId);
                
                console.log(`üíæ Dati salvati: ${validatedClienti.length} clienti, ${validatedDocumenti.length} documenti, ${validatedProdotti.length} prodotti, ${validatedVini.length} vini`);
                
                return true;
            } catch (error) {
                console.error('‚ùå Errore salvataggio localStorage:', error);
                return false;
            }
        }

        // Imposta salvataggio automatico alla chiusura
        function setupAutoSaveOnClose() {
            // Salvataggio automatico alla chiusura della finestra
            window.addEventListener('beforeunload', function(e) {
                console.log('üîÑ Salvataggio automatico alla chiusura...');
                saveDataToStorage();
                createBackup(); // Crea backup prima della chiusura
                
                // Mostra messaggio di conferma
                e.preventDefault();
                e.returnValue = 'I dati non salvati andranno persi. Sei sicuro di voler chiudere?';
                return e.returnValue;
            });
            
            // Salvataggio automatico quando la pagina perde il focus
            window.addEventListener('blur', function() {
                console.log('üîÑ Salvataggio automatico (perdita focus)...');
                saveDataToStorage();
            });
            
            // Salvataggio automatico ogni 30 secondi
            setInterval(() => {
                console.log('üîÑ Salvataggio automatico periodico...');
                saveDataToStorage();
            }, 30000);
            
            // Backup automatico ogni 5 minuti
            setInterval(() => {
                console.log('üíæ Backup automatico...');
                createBackup();
            }, 300000); // 5 minuti
            
            console.log('‚úÖ Sistema di salvataggio automatico configurato');
        }

        // Controlla aggiornamenti dal cloud
        async function checkForCloudUpdates() {
            try {
                // Prima controlla GitHub Gist se configurato
                if (GITHUB_CONFIG.enabled) {
                    const githubData = await loadFromGitHubGist();
                    if (githubData) {
                        const localTimestamp = localStorage.getItem('tommy_last_sync');
                        const githubTime = githubData.lastModified;
                        const localTime = parseInt(localTimestamp) || 0;
                        
                        if (githubTime > localTime && githubData.deviceId !== deviceId) {
                            // Aggiorna i dati locali con quelli di GitHub
                            clienti = githubData.clienti || clienti;
                            documenti = githubData.documenti || documenti;
                            prodotti = githubData.prodotti || prodotti;
                            vini = githubData.vini || vini;
                            
                            // Salva i dati aggiornati localmente
                            localStorage.setItem('tommy_clienti', JSON.stringify(clienti));
                            localStorage.setItem('tommy_documenti', JSON.stringify(documenti));
                            localStorage.setItem('tommy_prodotti', JSON.stringify(prodotti));
                            localStorage.setItem('tommy_vini', JSON.stringify(vini));
                            localStorage.setItem('tommy_last_sync', githubTime.toString());
                            
                            showNotification('üì° Dati sincronizzati da GitHub!', 'success');
                            return;
                        }
                    }
                }
                
                // Fallback: controlla localStorage
                const cloudData = localStorage.getItem('tommy_cloud_data');
                const cloudTimestamp = localStorage.getItem('tommy_cloud_timestamp');
                const localTimestamp = localStorage.getItem('tommy_last_sync');
                
                if (cloudData && cloudTimestamp && localTimestamp) {
                    const cloudTime = parseInt(cloudTimestamp);
                    const localTime = parseInt(localTimestamp);
                    
                    if (cloudTime > localTime) {
                        // Ci sono dati pi√π recenti nel cloud
                        const cloudDataObj = JSON.parse(cloudData);
                        
                        // Verifica che i dati non siano dello stesso dispositivo
                        if (cloudDataObj.deviceId !== deviceId) {
                            // Aggiorna i dati locali con quelli del cloud
                            clienti = cloudDataObj.clienti || clienti;
                            documenti = cloudDataObj.documenti || documenti;
                            prodotti = cloudDataObj.prodotti || prodotti;
                            vini = cloudDataObj.vini || vini;
                            
                            // Salva i dati aggiornati localmente
                            localStorage.setItem('tommy_clienti', JSON.stringify(clienti));
                            localStorage.setItem('tommy_documenti', JSON.stringify(documenti));
                            localStorage.setItem('tommy_prodotti', JSON.stringify(prodotti));
                            localStorage.setItem('tommy_vini', JSON.stringify(vini));
                            localStorage.setItem('tommy_last_sync', cloudTimestamp);
                            
                            showNotification('üì° Dati sincronizzati dal cloud!', 'success');
                        }
                    }
                }
            } catch (error) {
                console.error('Errore nel controllo aggiornamenti cloud:', error);
            }
        }
        
        // Avvia il sistema di sincronizzazione robusto
        function startSyncSystem() {
            console.log('üîÑ Avvio sistema di sincronizzazione...');
            
            // Verifica integrit√† dati all'avvio
            verifyDataIntegrity();
            
            // Controlla aggiornamenti ogni 30 secondi
            syncInterval = setInterval(async () => {
                if (isOnline) {
                    console.log('üîÑ Controllo aggiornamenti periodico...');
                    await checkForCloudUpdates();
                }
            }, 30000);
            
            // Ascolta eventi di connessione
            window.addEventListener('online', () => {
                isOnline = true;
                console.log('üåê Connessione ripristinata');
                showNotification('üåê Connessione ripristinata - Sincronizzazione attiva', 'success');
                checkForCloudUpdates();
                updateSyncIndicator();
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                console.log('üì° Modalit√† offline');
                showNotification('üì° Modalit√† offline - Dati salvati localmente', 'warning');
                updateSyncIndicator();
            });
            
            // Ascolta modifiche ai dati da altri dispositivi
            window.addEventListener('tommyDataChanged', (event) => {
                const { data, deviceId: sourceDeviceId, timestamp } = event.detail;
                
                // Ignora le proprie modifiche
                if (sourceDeviceId === deviceId) return;
                
                console.log('üîÑ Dati ricevuti da altro dispositivo');
                
                // Aggiorna i dati se sono pi√π recenti
                if (timestamp > lastSyncTime) {
                    clienti = data.clienti || clienti;
                    documenti = data.documenti || documenti;
                    prodotti = data.prodotti || prodotti;
                    vini = data.vini || vini;
                    
                    // Salva localmente con validazione
                    saveAllDataToLocalStorage();
                    localStorage.setItem('tommy_last_sync', timestamp.toString());
                    
                    // Aggiorna le tabelle
                    updateAllTables();
                    
                    showNotification('üîÑ Dati aggiornati da altro dispositivo', 'info');
                }
            });
            
            console.log('‚úÖ Sistema di sincronizzazione avviato');
        }

        // Verifica integrit√† dei dati
        function verifyDataIntegrity() {
            console.log('üîç Verifica integrit√† dati...');
            
            let issues = [];
            
            // Verifica che tutti i dati siano array
            if (!Array.isArray(clienti)) {
                issues.push('Clienti non √® un array valido');
                clienti = [];
            }
            
            if (!Array.isArray(documenti)) {
                issues.push('Documenti non √® un array valido');
                documenti = [];
            }
            
            if (!Array.isArray(prodotti)) {
                issues.push('Prodotti non √® un array valido');
                prodotti = [];
            }
            
            if (!Array.isArray(vini)) {
                issues.push('Vini non √® un array valido');
                vini = [];
            }
            
            // Verifica ID univoci
            const clientiIds = clienti.map(c => c.id).filter((id, index, arr) => arr.indexOf(id) !== index);
            const documentiIds = documenti.map(d => d.id).filter((id, index, arr) => arr.indexOf(id) !== index);
            const prodottiIds = prodotti.map(p => p.id).filter((id, index, arr) => arr.indexOf(id) !== index);
            const viniIds = vini.map(v => v.id).filter((id, index, arr) => arr.indexOf(id) !== index);
            
            if (clientiIds.length > 0) issues.push(`ID duplicati nei clienti: ${clientiIds.join(', ')}`);
            if (documentiIds.length > 0) issues.push(`ID duplicati nei documenti: ${documentiIds.join(', ')}`);
            if (prodottiIds.length > 0) issues.push(`ID duplicati nei prodotti: ${prodottiIds.join(', ')}`);
            if (viniIds.length > 0) issues.push(`ID duplicati nei vini: ${viniIds.join(', ')}`);
            
            if (issues.length > 0) {
                console.warn('‚ö†Ô∏è Problemi di integrit√† trovati:', issues);
                showNotification(`‚ö†Ô∏è ${issues.length} problemi di integrit√† risolti`, 'warning');
                
                // Salva i dati corretti
                saveAllDataToLocalStorage();
            } else {
                console.log('‚úÖ Integrit√† dati verificata - Nessun problema trovato');
            }
        }

        // Backup automatico dei dati
        function createBackup() {
            try {
                const backupData = {
                    clienti: clienti,
                    documenti: documenti,
                    prodotti: prodotti,
                    vini: vini,
                    timestamp: Date.now(),
                    deviceId: deviceId,
                    version: '1.0'
                };
                
                const backupKey = `tommy_backup_${Date.now()}`;
                localStorage.setItem(backupKey, JSON.stringify(backupData));
                
                // Mantieni solo gli ultimi 5 backup
                const backupKeys = Object.keys(localStorage).filter(key => key.startsWith('tommy_backup_'));
                if (backupKeys.length > 5) {
                    backupKeys.sort().slice(0, -5).forEach(key => localStorage.removeItem(key));
                }
                
                console.log('üíæ Backup creato:', backupKey);
                return true;
            } catch (error) {
                console.error('‚ùå Errore creazione backup:', error);
                return false;
            }
        }

        // Ripristina da backup
        function restoreFromBackup(backupKey) {
            try {
                const backupData = localStorage.getItem(backupKey);
                if (!backupData) {
                    throw new Error('Backup non trovato');
                }
                
                const backup = JSON.parse(backupData);
                
                // Verifica integrit√† backup
                if (!backup.clienti || !backup.documenti || !backup.prodotti || !backup.vini) {
                    throw new Error('Backup corrotto');
                }
                
                // Ripristina i dati
                clienti = backup.clienti;
                documenti = backup.documenti;
                prodotti = backup.prodotti;
                vini = backup.vini;
                
                // Salva i dati ripristinati
                saveAllDataToLocalStorage();
                updateAllTables();
                
                console.log('‚úÖ Ripristino da backup completato:', backupKey);
                showNotification('‚úÖ Dati ripristinati da backup', 'success');
                return true;
            } catch (error) {
                console.error('‚ùå Errore ripristino backup:', error);
                showNotification('‚ùå Errore nel ripristino da backup', 'error');
                return false;
            }
        }

        // Funzione per aggiungere i dati dell'azienda di Tommaso
        function addTommasoCompanyData() {
            // Controlla se l'azienda di Tommaso esiste gi√†
            const existingCompany = clienti.find(cliente => 
                                        cliente.nomeAzienda === 'Privilege Caf√®&Wine' || 
                cliente.nomeAzienda === 'Privilege Caf√®&Wine' ||
                (cliente.nome === 'Tommaso' && cliente.tipologia === 'azienda')
            );
            
            if (existingCompany) {
                // Aggiorna i dati esistenti
                existingCompany.indirizzo = 'C.so Vittorio Emanuele II, 48 Bitonto (Ba) 70032';
                existingCompany.telefono = '0803740786';
                existingCompany.email = 'tommyprivilege@gmail.com';
                existingCompany.nomeAzienda = 'Privilege Caf√®&Wine';
                existingCompany.citta = 'Bitonto';
                existingCompany.cap = '70032';
                existingCompany.provincia = 'BA';
                showNotification('‚úÖ Dati azienda Tommaso aggiornati!', 'success');
            } else {
                // Aggiungi nuovo cliente azienda
                const newCompany = {
                    id: Date.now().toString(),
                    nome: 'Tommaso',
                    cognome: '',
                    email: 'tommyprivilege@gmail.com',
                    telefono: '0803740786',
                    indirizzo: 'C.so Vittorio Emanuele II, 48 Bitonto (Ba) 70032',
                    citta: 'Bitonto',
                    cap: '70032',
                    provincia: 'BA',
                    tipologia: 'azienda',
                    nomeAzienda: 'Privilege Caf√®&Wine',
                    note: 'Azienda principale - Dati per intestazione fatture',
                    dataRegistrazione: new Date().toISOString().split('T')[0]
                };
                
                clienti.push(newCompany);
                showNotification('‚úÖ Azienda Tommaso aggiunta con successo!', 'success');
            }
            
            // Salva i dati
            saveDataToStorage();
            updateAllTables();
        }

                // Salva dati nel localStorage con gestione errori e sincronizzazione robusta
        function saveDataToStorage() {
            try {
                console.log('üíæ Avvio salvataggio dati...');
                const timestamp = Date.now();
                
                // Salvataggio validato nel localStorage
                const saveSuccess = saveAllDataToLocalStorage();
                if (!saveSuccess) {
                    throw new Error('Errore nel salvataggio localStorage');
                }
                
                // Prepara dati per il cloud
                const dataToSave = {
                    clienti: clienti,
                    documenti: documenti,
                    prodotti: prodotti,
                    vini: vini,
                    lastModified: timestamp,
                    deviceId: deviceId
                };
                
                // Salva anche nel cloud storage se disponibile
                saveToCloudStorage(dataToSave);
                
                // Aggiorna il timestamp dell'ultima modifica
                lastSyncTime = timestamp;
                
                console.log('‚úÖ Salvataggio completato con successo');
                
            } catch (error) {
                console.error('‚ùå Errore nel salvataggio:', error);
                showNotification('‚ùå Errore nel salvataggio dei dati', 'error');
            }
        }
        
        // Salva dati nel cloud storage (GitHub Gist + localStorage fallback)
        async function saveToCloudStorage(data) {
            try {
                // Salva sempre in localStorage come backup
                localStorage.setItem('tommy_cloud_data', JSON.stringify(data));
                localStorage.setItem('tommy_cloud_timestamp', Date.now().toString());
                
                // Se GitHub √® configurato, salva anche l√¨
                if (GITHUB_CONFIG.enabled && GITHUB_CONFIG.token && GITHUB_CONFIG.gistId) {
                    const success = await saveToGitHubGist(data);
                    if (success) {
                        showNotification('üì° Dati sincronizzati su GitHub!', 'success');
                    } else {
                        showNotification('‚ö†Ô∏è Errore sincronizzazione GitHub - Dati salvati localmente', 'warning');
                    }
                }
                
                // Simula sincronizzazione con altri dispositivi
                broadcastDataChange(data);
                
            } catch (error) {
                console.error('Errore nel salvataggio cloud:', error);
            }
        }
        
        // Salva dati su GitHub Gist
        async function saveToGitHubGist(data) {
            try {
                const response = await fetch(`https://api.github.com/gists/${GITHUB_CONFIG.gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        description: `Gestione Tommy - Dati aggiornati il ${new Date().toLocaleString('it-IT')}`,
                        files: {
                            'tommy_data.json': {
                                content: JSON.stringify({
                                    clienti: data.clienti,
                                    documenti: data.documenti,
                                    prodotti: data.prodotti,
                                    vini: data.vini,
                                    lastModified: data.lastModified,
                                    deviceId: data.deviceId
                                }, null, 2)
                            }
                        }
                    })
                });
                
                return response.ok;
            } catch (error) {
                console.error('Errore nel salvataggio su GitHub Gist:', error);
                return false;
            }
        }
        
        // Carica dati da GitHub Gist
        async function loadFromGitHubGist() {
            try {
                if (!GITHUB_CONFIG.enabled || !GITHUB_CONFIG.token || !GITHUB_CONFIG.gistId) {
                    return null;
                }
                
                const response = await fetch(`https://api.github.com/gists/${GITHUB_CONFIG.gistId}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const gist = await response.json();
                    const file = gist.files['tommy_data.json'];
                    if (file && file.content) {
                        return JSON.parse(file.content);
                    }
                }
                
                return null;
            } catch (error) {
                console.error('Errore nel caricamento da GitHub Gist:', error);
                return null;
            }
        }
        
        // Broadcast delle modifiche ai dati
        function broadcastDataChange(data) {
            // Simula la sincronizzazione con altri dispositivi
            // In un'implementazione reale, questo sarebbe un WebSocket o Server-Sent Events
            const event = new CustomEvent('tommyDataChanged', {
                detail: {
                    data: data,
                    deviceId: deviceId,
                    timestamp: Date.now()
                }
            });
            window.dispatchEvent(event);
        }

        // Funzione per mostrare le tab
        function showTab(tabName, event = null) {
            // Nascondi tutte le tab
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostra la tab selezionata
            document.getElementById(tabName).classList.add('active');
            
            // Se l'evento √® disponibile, attiva il pulsante cliccato
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Altrimenti trova e attiva il pulsante della tab corrispondente
                const tabButtons = document.querySelectorAll('.nav-tab');
                tabButtons.forEach(button => {
                    if (button.getAttribute('onclick') && button.getAttribute('onclick').includes(tabName)) {
                        button.classList.add('active');
                    }
                });
            }
            
            // Aggiorna il select clienti se si √® nella tab fatture
            if (tabName === 'fatture') {
                updateClientiSelect();
            }
        }

        // Gestione form clienti migliorata
        function updateClientiTable() {
            try {
                const tbody = document.getElementById('clientiTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                clienti.forEach(cliente => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${cliente.nome || ''}</td>
                        <td>${cliente.cognome || ''}</td>
                        <td>${cliente.email || ''}</td>
                        <td>${cliente.telefono || ''}</td>
                        <td>${cliente.citta || ''}</td>
                        <td>${cliente.dataRegistrazione || ''}</td>
                        <td>${cliente.note || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editCliente(${cliente.id})">‚úèÔ∏è Modifica</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCliente(${cliente.id})">üóëÔ∏è Elimina</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Errore nell\'aggiornamento tabella clienti:', error);
                showNotification('Errore nell\'aggiornamento della tabella clienti', 'error');
            }
        }

        function editCliente(id) {
            const cliente = clienti.find(c => c.id === id);
            if (!cliente) return;
            const form = document.getElementById('clienteForm');
            form.nomeAzienda.value = cliente.nomeAzienda || '';
            form.tipologia.value = cliente.tipologia || 'privato';
            form.nome.value = cliente.nome;
            form.cognome.value = cliente.cognome;
            form.email.value = cliente.email;
            form.telefono.value = cliente.telefono;
            form.indirizzo.value = cliente.indirizzo;
            form.citta.value = cliente.citta;
            form.cap.value = cliente.cap;
            form.dataRegistrazione.value = cliente.dataRegistrazione;
            form.note.value = cliente.note;
            
            // Aggiorna la visibilit√† del campo Nome Azienda
            toggleNomeAzienda();
            
            if (!form.querySelector('[name="editId"]')) {
                const hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = 'editId';
                form.appendChild(hidden);
            }
            form.editId.value = cliente.id;
            form.scrollIntoView({ behavior: 'smooth' });
        }

        function deleteCliente(id) {
            if (confirm('Sei sicuro di voler eliminare questo cliente?')) {
                const idx = clienti.findIndex(c => c.id === id);
                if (idx !== -1) {
                    clienti.splice(idx, 1);
                    updateClientiTable();
                    saveDataToStorage();
                    alert('Cliente eliminato con successo!');
                }
            }
        }

        document.getElementById('clienteForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            // Validazione per le aziende
            const tipologia = formData.get('tipologia');
            const nomeAzienda = formData.get('nomeAzienda');
            
            if (tipologia === 'azienda' && !nomeAzienda.trim()) {
                alert('Per le aziende √® obbligatorio inserire il nome dell\'azienda!');
                return;
            }
            
            const editId = formData.get('editId');
            if (editId) {
                const idx = clienti.findIndex(c => c.id == editId);
                if (idx !== -1) {
                    clienti[idx] = {
                        ...clienti[idx],
                        nomeAzienda: formData.get('nomeAzienda'),
                        tipologia: formData.get('tipologia'),
                        nome: formData.get('nome'),
                        cognome: formData.get('cognome'),
                        email: formData.get('email'),
                        telefono: formData.get('telefono'),
                        indirizzo: formData.get('indirizzo'),
                        citta: formData.get('citta'),
                        cap: formData.get('cap'),
                        dataRegistrazione: formData.get('dataRegistrazione'),
                        note: formData.get('note')
                    };
                    updateClientiTable();
                    saveDataToStorage();
                    alert('Cliente modificato con successo!');
                }
                this.removeChild(this.querySelector('[name="editId"]'));
                this.reset();
                return;
            }
            // Inserimento nuovo cliente (comportamento originale)
            const cliente = {
                id: Date.now(),
                nomeAzienda: formData.get('nomeAzienda'),
                tipologia: formData.get('tipologia'),
                nome: formData.get('nome'),
                cognome: formData.get('cognome'),
                email: formData.get('email'),
                telefono: formData.get('telefono'),
                indirizzo: formData.get('indirizzo'),
                citta: formData.get('citta'),
                cap: formData.get('cap'),
                dataRegistrazione: formData.get('dataRegistrazione'),
                note: formData.get('note')
            };
            clienti.push(cliente);
            updateClientiTable();
            saveDataToStorage();
            this.reset();
            alert('Cliente aggiunto con successo!');
        });

        // Gestione form fatture
        function updateFattureTable() {
            const tbody = document.getElementById('fattureTableBody');
            tbody.innerHTML = '';
            
                            documenti.forEach(documento => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><span class="badge badge-${getTipoBadge(documento.tipo)}">${documento.tipo.toUpperCase()}</span></td>
                        <td>${documento.numero}</td>
                        <td>${documento.cliente}</td>
                        <td>${documento.data}</td>
                        <td>${documento.scadenza || '-'}</td>
                        <td>‚Ç¨${documento.subtotale.toFixed(2)}</td>
                        <td>‚Ç¨${documento.scontoExtra.toFixed(2)}</td>
                        <td>‚Ç¨${documento.totale.toFixed(2)}</td>
                        <td>${getStatoBadge(documento.stato)}</td>
                        <td>${documento.note || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editDocumento(${documento.id})">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-success" onclick="stampaDocumentoSalvato(${documento.id})">üñ®Ô∏è</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteDocumento(${documento.id})">üóëÔ∏è</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
        }

        function getTipoBadge(tipo) {
            switch(tipo) {
                case 'fattura': return 'primary';
                case 'proforma': return 'warning';
                case 'ddt': return 'info';
                default: return 'secondary';
            }
        }

        function getStatoBadge(stato) {
            if (!stato) return '<span class="status-badge status-pending">In Attesa</span>';
            
            switch(stato) {
                case 'pagata': 
                    return '<span class="status-badge status-paid">Pagata</span>';
                case 'in_attesa': 
                    return '<span class="status-badge status-pending">In Attesa</span>';
                case 'scaduta': 
                    return '<span class="status-badge status-overdue">Scaduta</span>';
                default: 
                    return '<span class="status-badge status-pending">In Attesa</span>';
            }
        }

        function editDocumento(id) {
            const documento = documenti.find(d => d.id === id);
            if (!documento) return;
            
            // Popola il modal con i dati del documento
            const modal = document.getElementById('fatturaModal');
            modal.style.display = 'flex';
            
            document.querySelector('#fatturaModal h3').textContent = `‚úèÔ∏è Modifica ${documento.tipo.toUpperCase()}`;
            document.querySelector('#fatturaModal select[name="tipoDocumento"]').value = documento.tipo;
            document.querySelector('#fatturaModal input[name="numero"]').value = documento.numero;
            document.querySelector('#fatturaModal select[name="cliente"]').value = documento.cliente;
            document.querySelector('#fatturaModal input[name="data"]').value = documento.data;
            document.querySelector('#fatturaModal input[name="scadenza"]').value = documento.scadenza || '';
            document.querySelector('#fatturaModal input[name="scontoExtra"]').value = documento.scontoExtra || 0;
            document.querySelector('#fatturaModal textarea[name="note"]').value = documento.note || '';
            
            // Popola le righe prodotto
            righeProdotto = [...documento.prodotti];
            updateProdottiTable();
            calcolaTotali();
            
            // Modifica il comportamento del form per l'aggiornamento
            const form = document.getElementById('fatturaFormModal');
            form.onsubmit = function(e) {
                e.preventDefault();
                updateDocumento(id);
            };
        }

        function updateDocumento(id) {
            const formData = new FormData(document.getElementById('fatturaFormModal'));
            
            if (righeProdotto.length === 0) {
                alert('Aggiungi almeno un prodotto/servizio!');
                return;
            }
            
            const documentoIndex = documenti.findIndex(d => d.id === id);
            if (documentoIndex === -1) return;
            
            documenti[documentoIndex] = {
                ...documenti[documentoIndex],
                tipo: formData.get('tipoDocumento'),
                numero: formData.get('numero'),
                cliente: formData.get('cliente'),
                data: formData.get('data'),
                scadenza: formData.get('scadenza'),
                subtotale: parseFloat(formData.get('subtotale')),
                scontoExtra: parseFloat(formData.get('scontoExtra')),
                totale: parseFloat(formData.get('totale')),
                prodotti: [...righeProdotto],
                note: formData.get('note')
            };
            
            updateFattureTable();
            saveDataToStorage();
            
            alert('Documento aggiornato con successo!');
            hideFatturaModal();
            
            // Ripristina il comportamento normale del form
            const form = document.getElementById('fatturaFormModal');
            form.onsubmit = null;
        }

        function deleteDocumento(id) {
            if (confirm('Sei sicuro di voler eliminare questo documento?')) {
                documenti = documenti.filter(d => d.id !== id);
                updateFattureTable();
                saveDataToStorage();
            }
        }

        function stampaDocumentoSalvato(id) {
            const documento = documenti.find(d => d.id === id);
            if (!documento) return;
            
            // Crea il contenuto per la stampa
            let printContent = `
                <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px;">
                    <div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px;">
                        <h1 style="margin: 0; color: #333;">Privilege Caf√®&Wine</h1>
                        <p style="margin: 5px 0; color: #666;">C.so Vittorio Emanuele II, 48 Bitonto (Ba) 70032 - Tel: 0803740786</p>
                        <h2 style="margin: 20px 0; color: #ff6b6b;">${documento.tipo.toUpperCase()} N. ${documento.numero}</h2>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                            <div>
                                <strong>Cliente:</strong> ${documento.cliente}<br>
                                <strong>Data:</strong> ${documento.data}
                            </div>
                            <div style="text-align: right;">
                                <strong>Numero:</strong> ${documento.numero}<br>
                                <strong>Tipo:</strong> ${documento.tipo.toUpperCase()}
                            </div>
                        </div>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Prodotto/Servizio</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Q.t√†</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Prezzo Unit.</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Sconto</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Imponibile</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            documento.prodotti.forEach(riga => {
                const tipoSconto = riga.tipoSconto || 'percentuale';
                const valoreSconto = riga.valoreSconto || 0;
                const simboloSconto = tipoSconto === 'percentuale' ? '%' : '‚Ç¨';
                
                // Calcolo dinamico dell'imponibile
                const quantita = parseFloat(riga.quantita) || 0;
                const prezzoUnitario = parseFloat(riga.prezzoUnitario) || 0;
                const subtotaleBase = quantita * prezzoUnitario;
                
                let imponibile = subtotaleBase;
                
                // Applica sconto se presente
                if (valoreSconto > 0) {
                    if (tipoSconto === 'percentuale') {
                        // Sconto percentuale
                        const scontoAmount = subtotaleBase * (valoreSconto / 100);
                        imponibile = subtotaleBase - scontoAmount;
                    } else {
                        // Sconto fisso in euro
                        imponibile = subtotaleBase - valoreSconto;
                    }
                }
                
                // Assicurati che l'imponibile non sia negativo
                imponibile = Math.max(0, imponibile);
                
                printContent += `
                    <tr>
                        <td style="padding: 12px; border: 1px solid #ddd;">${riga.prodotto}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${riga.quantita}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">‚Ç¨${riga.prezzoUnitario.toFixed(2)}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${valoreSconto}${simboloSconto}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">‚Ç¨${imponibile.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            // Calcolo dinamico del subtotale e totale
            let subtotaleCalcolato = 0;
            let scontoExtraCalcolato = parseFloat(documento.scontoExtra) || 0;
            
            // Ricalcola il subtotale basandosi sui nuovi imponibili
            documento.prodotti.forEach(riga => {
                const quantita = parseFloat(riga.quantita) || 0;
                const prezzoUnitario = parseFloat(riga.prezzoUnitario) || 0;
                const subtotaleBase = quantita * prezzoUnitario;
                
                let imponibile = subtotaleBase;
                const valoreSconto = parseFloat(riga.valoreSconto) || 0;
                const tipoSconto = riga.tipoSconto || 'percentuale';
                
                if (valoreSconto > 0) {
                    if (tipoSconto === 'percentuale') {
                        const scontoAmount = subtotaleBase * (valoreSconto / 100);
                        imponibile = subtotaleBase - scontoAmount;
                    } else {
                        imponibile = subtotaleBase - valoreSconto;
                    }
                }
                
                imponibile = Math.max(0, imponibile);
                subtotaleCalcolato += imponibile;
            });
            
            // Calcola il totale finale
            const totaleCalcolato = subtotaleCalcolato - scontoExtraCalcolato;
            
            printContent += `
                        </tbody>
                    </table>
                    
                    <div style="text-align: right; margin-top: 30px;">
                        <div style="margin-bottom: 10px;">
                            <strong>Subtotale:</strong> ‚Ç¨${subtotaleCalcolato.toFixed(2)}
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Sconto Extra:</strong> ‚Ç¨${scontoExtraCalcolato.toFixed(2)}
                        </div>
                        <div style="font-size: 18px; font-weight: bold; border-top: 2px solid #333; padding-top: 10px;">
                            <strong>TOTALE:</strong> ‚Ç¨${totaleCalcolato.toFixed(2)}
                        </div>
                    </div>
                </div>
            `;
            
            // Crea una nuova finestra per la stampa
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${documento.tipo.toUpperCase()} ${documento.numero}</title>
                    <style>
                        body { margin: 0; padding: 20px; }
                        @media print {
                            body { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    ${printContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            
            // Stampa automatica
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }



        // Gestione form prodotti
        document.getElementById('prodottoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const editId = formData.get('editId');
            if (editId) {
                // Modifica prodotto esistente
                const idx = prodotti.findIndex(p => p.id == editId);
                if (idx !== -1) {
                    prodotti[idx] = {
                        ...prodotti[idx],
                        nome: formData.get('nome'),
                        categoriaPrincipale: formData.get('categoriaPrincipale'),
                        sottocategoria: formData.get('sottocategoria'),
                        marca: formData.get('marca'),
                        prezzoAcquisto: parseFloat(formData.get('prezzoAcquisto')) || 0,
                        prezzoVenditaIngrosso: parseFloat(formData.get('prezzoVenditaIngrosso')),
                        prezzoVenditaDettaglio: parseFloat(formData.get('prezzoVenditaDettaglio')),
                        quantita: parseInt(formData.get('quantita')),
                        quantitaMinima: parseInt(formData.get('quantitaMinima')),
                        fornitore: formData.get('fornitore'),
                        codiceProdotto: formData.get('codiceProdotto'),
                        note: formData.get('note')
                    };
                    updateProdottiTable();
                    saveDataToStorage();
                    alert('Prodotto modificato con successo!');
                }
                // Rimuovi campo nascosto e resetta il form
                this.removeChild(this.querySelector('[name="editId"]'));
                this.reset();
                return;
            }
            // Inserimento nuovo prodotto (comportamento originale)
            const prodotto = {
                id: Date.now(),
                nome: formData.get('nome'),
                categoriaPrincipale: formData.get('categoriaPrincipale'),
                sottocategoria: formData.get('sottocategoria'),
                marca: formData.get('marca'),
                prezzoAcquisto: parseFloat(formData.get('prezzoAcquisto')) || 0,
                prezzoVenditaIngrosso: parseFloat(formData.get('prezzoVenditaIngrosso')),
                prezzoVenditaDettaglio: parseFloat(formData.get('prezzoVenditaDettaglio')),
                quantita: parseInt(formData.get('quantita')),
                quantitaMinima: parseInt(formData.get('quantitaMinima')),
                fornitore: formData.get('fornitore'),
                codiceProdotto: formData.get('codiceProdotto'),
                note: formData.get('note')
            };
            prodotti.push(prodotto);
            updateProdottiTable();
            saveDataToStorage();
            this.reset();
            alert('Prodotto aggiunto con successo!');
        });

        // Gestione form vini
        function updateViniTable() {
            const tbody = document.getElementById('viniTableBody');
            tbody.innerHTML = '';
            
            vini.forEach(vino => {
                const stockClass = vino.quantita <= 3 ? 'stock-low' : 'stock-ok';
                const stockText = vino.quantita <= 3 ? 'Scorte Basse' : 'OK';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${vino.nome}</td>
                    <td>${vino.produttore}</td>
                    <td>${vino.annata}</td>
                    <td>${vino.tipologia}</td>
                    <td>${vino.regione}</td>
                    <td>${vino.vitigno || '-'}</td>
                    <td>‚Ç¨${vino.prezzoAcquisto.toFixed(2)}</td>
                    <td>‚Ç¨${vino.prezzoVenditaIngrosso.toFixed(2)}</td>
                    <td>‚Ç¨${vino.prezzoVenditaDettaglio.toFixed(2)}</td>
                    <td>${vino.quantita}</td>
                    <td>${vino.unitaMisura || 'bottiglie'}</td>
                    <td><span class="status-badge ${stockClass}">${stockText}</span></td>
                    <td>${vino.note}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editVino(${vino.id})">‚úèÔ∏è Modifica</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteVino(${vino.id})">ÔøΩÔøΩÔ∏è Elimina</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function editVino(id) {
            const vino = vini.find(v => v.id === id);
            if (!vino) return;
            const form = document.getElementById('vinoForm');
            form.nome.value = vino.nome;
            form.produttore.value = vino.produttore;
            form.annata.value = vino.annata;
            form.tipologia.value = vino.tipologia;
            form.regione.value = vino.regione;
            form.vitigno.value = vino.vitigno;
            form.prezzoAcquisto.value = vino.prezzoAcquisto;
            form.prezzoVenditaIngrosso.value = vino.prezzoVenditaIngrosso;
            form.prezzoVenditaDettaglio.value = vino.prezzoVenditaDettaglio;
            form.quantita.value = vino.quantita;
            form.unitaMisura.value = vino.unitaMisura || 'bottiglie';
            form.fornitore.value = vino.fornitore;
            form.codiceProdotto.value = vino.codiceProdotto;
            form.descrizione.value = vino.descrizione;
            form.note.value = vino.note;
            if (!form.querySelector('[name="editId"]')) {
                const hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = 'editId';
                form.appendChild(hidden);
            }
            form.editId.value = vino.id;
            form.scrollIntoView({ behavior: 'smooth' });
        }

        function deleteVino(id) {
            if (confirm('Sei sicuro di voler eliminare questo vino?')) {
                const idx = vini.findIndex(v => v.id === id);
                if (idx !== -1) {
                    vini.splice(idx, 1);
                    updateViniTable();
                    saveDataToStorage();
                    alert('Vino eliminato con successo!');
                }
            }
        }

        document.getElementById('vinoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const editId = formData.get('editId');
            if (editId) {
                const idx = vini.findIndex(v => v.id == editId);
                if (idx !== -1) {
                    vini[idx] = {
                        ...vini[idx],
                        nome: formData.get('nome'),
                        produttore: formData.get('produttore'),
                        annata: parseInt(formData.get('annata')),
                        tipologia: formData.get('tipologia'),
                        regione: formData.get('regione'),
                        vitigno: formData.get('vitigno'),
                        prezzoAcquisto: parseFloat(formData.get('prezzoAcquisto')) || 0,
                        prezzoVenditaIngrosso: parseFloat(formData.get('prezzoVenditaIngrosso')),
                        prezzoVenditaDettaglio: parseFloat(formData.get('prezzoVenditaDettaglio')),
                        quantita: parseInt(formData.get('quantita')),
                        unitaMisura: formData.get('unitaMisura') || 'bottiglie',
                        fornitore: formData.get('fornitore'),
                        codiceProdotto: formData.get('codiceProdotto'),
                        descrizione: formData.get('descrizione'),
                        note: formData.get('note')
                    };
                    updateViniTable();
                    saveDataToStorage();
                    alert('Vino modificato con successo!');
                }
                this.removeChild(this.querySelector('[name="editId"]'));
                this.reset();
                return;
            }
            // Inserimento nuovo vino (comportamento originale)
            const vino = {
                id: Date.now(),
                nome: formData.get('nome'),
                produttore: formData.get('produttore'),
                annata: parseInt(formData.get('annata')),
                tipologia: formData.get('tipologia'),
                regione: formData.get('regione'),
                vitigno: formData.get('vitigno'),
                prezzoAcquisto: parseFloat(formData.get('prezzoAcquisto')) || 0,
                prezzoVenditaIngrosso: parseFloat(formData.get('prezzoVenditaIngrosso')),
                prezzoVenditaDettaglio: parseFloat(formData.get('prezzoVenditaDettaglio')),
                quantita: parseInt(formData.get('quantita')),
                unitaMisura: formData.get('unitaMisura') || 'bottiglie',
                fornitore: formData.get('fornitore'),
                codiceProdotto: formData.get('codiceProdotto'),
                descrizione: formData.get('descrizione'),
                note: formData.get('note')
            };
            vini.push(vino);
            updateViniTable();
            saveDataToStorage();
            this.reset();
            alert('Vino aggiunto con successo!');
        });


        
        // Funzione per gestire la visibilit√† del campo Nome Azienda
        function toggleNomeAzienda() {
            const tipologiaSelect = document.querySelector('select[name="tipologia"]');
            const nomeAziendaInput = document.querySelector('input[name="nomeAzienda"]');
            
            if (tipologiaSelect.value === 'azienda') {
                nomeAziendaInput.required = true;
                nomeAziendaInput.placeholder = 'Nome dell\'azienda (obbligatorio)';
            } else {
                nomeAziendaInput.required = false;
                nomeAziendaInput.placeholder = 'Nome dell\'azienda (lasciare vuoto per privati)';
            }
        }
        
        // Funzione per aggiornare il select clienti nelle fatture (evita duplicati)
        function updateClientiSelect() {
            const clienteSelect = document.querySelector('select[name="cliente"]');
            if (!clienteSelect) return;
            
            // Salva il valore selezionato
            const selectedValue = clienteSelect.value;
            
            // Pulisci le opzioni esistenti
            clienteSelect.innerHTML = '<option value="">Seleziona cliente...</option>';
            
            // Crea un Set per evitare duplicati
            const clientiUnici = new Set();
            
            // Aggiungi i clienti unici
            clienti.forEach(cliente => {
                let displayValue, optionValue;
                
                if (cliente.tipologia === 'azienda' && cliente.nomeAzienda) {
                    // Per le aziende, usa il nome azienda
                    displayValue = cliente.nomeAzienda;
                    optionValue = cliente.nomeAzienda;
                } else {
                    // Per i privati o aziende senza nome, usa nome e cognome
                    displayValue = `${cliente.nome} ${cliente.cognome}`;
                    optionValue = `${cliente.nome} ${cliente.cognome}`;
                }
                
                // Aggiungi solo se non √® gi√† presente
                if (!clientiUnici.has(optionValue)) {
                    clientiUnici.add(optionValue);
                    
                    const option = document.createElement('option');
                    option.value = optionValue;
                    option.textContent = displayValue + (cliente.tipologia === 'azienda' ? ' (Azienda)' : ' (Privato)');
                    clienteSelect.appendChild(option);
                }
            });
            
            // Ripristina il valore selezionato se era presente
            if (selectedValue) {
                clienteSelect.value = selectedValue;
            }
        }

        // Variabili globali per i documenti
        let righeProdotto = [];

        // Funzioni per i modal
        function showFatturaModal() {
            const modal = document.getElementById('fatturaModal');
            modal.style.display = 'flex';
            
            // Imposta la data di oggi
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('#fatturaModal input[name="data"]').value = today;
            
            // Aggiorna il select clienti
            updateClientiSelect();
            
            // Pulisci le righe prodotto
            righeProdotto = [];
            updateProdottiTable();
            
            // Pulisci i totali
            calcolaTotali();
        }

        function hideFatturaModal() {
            const modal = document.getElementById('fatturaModal');
            modal.style.display = 'none';
        }

        function showProformaModal() {
            const modal = document.getElementById('fatturaModal');
            modal.style.display = 'flex';
            document.querySelector('#fatturaModal h3').textContent = 'üìã Nuova Proforma';
            document.querySelector('#fatturaModal select[name="tipoDocumento"]').value = 'proforma';
            
            // Imposta la data di oggi
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('#fatturaModal input[name="data"]').value = today;
            
            // Aggiorna il select clienti
            updateClientiSelect();
            
            // Pulisci le righe prodotto
            righeProdotto = [];
            updateProdottiTable();
            
            // Pulisci i totali
            calcolaTotali();
        }

        function showDDTModal() {
            const modal = document.getElementById('fatturaModal');
            modal.style.display = 'flex';
            document.querySelector('#fatturaModal h3').textContent = 'üöö Nuovo DDT';
            document.querySelector('#fatturaModal select[name="tipoDocumento"]').value = 'ddt';
            
            // Imposta la data di oggi
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('#fatturaModal input[name="data"]').value = today;
            
            // Aggiorna il select clienti
            updateClientiSelect();
            
            // Pulisci le righe prodotto
            righeProdotto = [];
            updateProdottiTable();
            
            // Pulisci i totali
            calcolaTotali();
        }

        // Funzioni per gestire le righe prodotto
        function aggiungiRigaProdotto() {
            const riga = {
                id: Date.now() + Math.random(),
                prodotto: '',
                quantita: 1,
                prezzoUnitario: 0,
                tipoSconto: 'percentuale', // 'percentuale' o 'arbitrario'
                valoreSconto: 0,
                subtotaleRiga: 0
            };
            
            righeProdotto.push(riga);
            updateProdottiTable();
            updateAnteprimaTable();
            calcolaTotali();
        }

        function rimuoviRigaProdotto(id) {
            righeProdotto = righeProdotto.filter(r => r.id !== id);
            updateProdottiTable();
            updateAnteprimaTable();
            calcolaTotali();
        }

        function updateProdottiTable() {
            const tbody = document.getElementById('prodottiTableBody');
            tbody.innerHTML = '';
            
            righeProdotto.forEach(riga => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" value="${riga.prodotto}" onchange="aggiornaRiga(${riga.id}, 'prodotto', this.value)" placeholder="Nome prodotto/servizio"></td>
                    <td><input type="number" value="${riga.quantita}" onchange="aggiornaRiga(${riga.id}, 'quantita', this.value)" min="1" step="1"></td>
                    <td><input type="number" value="${riga.prezzoUnitario}" onchange="aggiornaRiga(${riga.id}, 'prezzoUnitario', this.value)" step="0.01"></td>
                    <td>
                        <select onchange="aggiornaRiga(${riga.id}, 'tipoSconto', this.value)">
                            <option value="percentuale" ${riga.tipoSconto === 'percentuale' ? 'selected' : ''}>%</option>
                            <option value="arbitrario" ${riga.tipoSconto === 'arbitrario' ? 'selected' : ''}>‚Ç¨</option>
                        </select>
                    </td>
                    <td><input type="number" value="${riga.valoreSconto}" onchange="aggiornaRiga(${riga.id}, 'valoreSconto', this.value)" step="0.01" min="0"></td>
                    <td><input type="number" value="${riga.subtotaleRiga}" readonly></td>
                    <td><button type="button" class="btn btn-sm btn-danger" onclick="rimuoviRigaProdotto(${riga.id})">üóëÔ∏è</button></td>
                `;
                tbody.appendChild(row);
            });
            
            // Aggiorna anche la tabella di anteprima
            updateAnteprimaTable();
        }

        function aggiornaRiga(id, campo, valore) {
            const riga = righeProdotto.find(r => r.id === id);
            if (riga) {
                if (campo === 'tipoSconto' || campo === 'prodotto') {
                    riga[campo] = valore;
                } else {
                    riga[campo] = parseFloat(valore) || 0;
                }
                calcolaSubtotaleRiga(riga);
                updateProdottiTable();
                updateAnteprimaTable();
                calcolaTotali();
            }
        }

        function calcolaSubtotaleRiga(riga) {
            const quantita = parseFloat(riga.quantita) || 0;
            const prezzoUnitario = parseFloat(riga.prezzoUnitario) || 0;
            const tipoSconto = riga.tipoSconto || 'percentuale';
            const valoreSconto = parseFloat(riga.valoreSconto) || 0;
            
            const subtotale = quantita * prezzoUnitario;
            let scontoImporto = 0;
            
            if (tipoSconto === 'percentuale') {
                // Sconto percentuale sul totale della riga
                scontoImporto = subtotale * (valoreSconto / 100);
            } else {
                // Sconto fisso in euro
                scontoImporto = valoreSconto;
            }
            
            riga.subtotaleRiga = Math.max(0, subtotale - scontoImporto);
        }

        function updateAnteprimaTable() {
            const tbody = document.getElementById('anteprimaTableBody');
            tbody.innerHTML = '';
            
            righeProdotto.forEach(riga => {
                const tipoSconto = riga.tipoSconto || 'percentuale';
                const valoreSconto = riga.valoreSconto || 0;
                const simboloSconto = tipoSconto === 'percentuale' ? '%' : '‚Ç¨';
                const scontoDisplay = valoreSconto > 0 ? `${valoreSconto}${simboloSconto}` : '-';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${riga.prodotto}</td>
                    <td>
                        <input type="number" value="${riga.quantita}" min="1" step="1" 
                               style="width: 60px; text-align: center;"
                               onchange="modificaQuantitaAnteprima(${riga.id}, this.value)">
                    </td>
                    <td>‚Ç¨${riga.prezzoUnitario.toFixed(2)}</td>
                    <td class="sconto-cell">
                        <div class="flex-container">
                            <select onchange="modificaTipoScontoAnteprima(${riga.id}, this.value)" 
                                    style="width: 50px;">
                                <option value="percentuale" ${tipoSconto === 'percentuale' ? 'selected' : ''}>%</option>
                                <option value="arbitrario" ${tipoSconto === 'arbitrario' ? 'selected' : ''}>‚Ç¨</option>
                            </select>
                            <input type="number" value="${valoreSconto}" min="0" step="0.01" 
                                   style="width: 60px; text-align: center;"
                                   onchange="modificaValoreScontoAnteprima(${riga.id}, this.value)">
                        </div>
                    </td>
                    <td class="subtotale-cell">‚Ç¨${riga.subtotaleRiga.toFixed(2)}</td>
                    <td style="text-align: center;">
                        <button type="button" class="btn btn-sm btn-danger" 
                                onclick="eliminaRigaAnteprima(${riga.id})" 
                                style="padding: 2px 6px; font-size: 12px;" 
                                title="Elimina prodotto">
                            üóëÔ∏è
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function calcolaTotali() {
            const scontoExtra = parseFloat(document.querySelector('#fatturaModal input[name="scontoExtra"]').value) || 0;
            
            let subtotale = 0;
            righeProdotto.forEach(riga => {
                subtotale += parseFloat(riga.subtotaleRiga) || 0;
            });
            
            const totale = subtotale - scontoExtra;
            
            document.querySelector('#fatturaModal input[name="subtotale"]').value = subtotale.toFixed(2);
            document.querySelector('#fatturaModal input[name="scontoExtraDisplay"]').value = scontoExtra.toFixed(2);
            document.querySelector('#fatturaModal input[name="totale"]').value = totale.toFixed(2);
        }

        // Funzioni per modificare dall'anteprima
        function modificaQuantitaAnteprima(id, nuovaQuantita) {
            const riga = righeProdotto.find(r => r.id === id);
            if (riga) {
                riga.quantita = parseInt(nuovaQuantita) || 1;
                calcolaSubtotaleRiga(riga);
                updateAnteprimaTable();
                calcolaTotali();
            }
        }

        function modificaTipoScontoAnteprima(id, nuovoTipo) {
            const riga = righeProdotto.find(r => r.id === id);
            if (riga) {
                riga.tipoSconto = nuovoTipo;
                calcolaSubtotaleRiga(riga);
                updateAnteprimaTable();
                calcolaTotali();
            }
        }

        function modificaValoreScontoAnteprima(id, nuovoValore) {
            const riga = righeProdotto.find(r => r.id === id);
            if (riga) {
                riga.valoreSconto = parseFloat(nuovoValore) || 0;
                calcolaSubtotaleRiga(riga);
                updateAnteprimaTable();
                calcolaTotali();
            }
        }

        function eliminaRigaAnteprima(id) {
            const riga = righeProdotto.find(r => r.id === id);
            if (riga && confirm(`Sei sicuro di voler eliminare "${riga.prodotto}" dalla fattura?`)) {
                righeProdotto = righeProdotto.filter(r => r.id !== id);
                updateProdottiTable();
                updateAnteprimaTable();
                calcolaTotali();
                showNotification('Prodotto eliminato dalla fattura', 'success');
            }
        }

        // Funzioni per il catalogo
        function selezionaDaCatalogo() {
            const modal = document.getElementById('catalogoModal');
            modal.style.display = 'flex';
            
            // Popola le tabelle del catalogo
            popolaCatalogoProdotti();
            popolaCatalogoVini();
        }

        function hideCatalogoModal() {
            const modal = document.getElementById('catalogoModal');
            modal.style.display = 'none';
        }

        function showCatalogoTab(tab) {
            // Nascondi tutte le tab
            document.querySelectorAll('.catalogo-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.catalogo-tab').forEach(tabBtn => {
                tabBtn.classList.remove('active');
            });
            
            // Mostra la tab selezionata
            document.getElementById(`catalogo${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');
            event.target.classList.add('active');
        }

        function popolaCatalogoProdotti() {
            const tbody = document.getElementById('catalogoProdottiBody');
            tbody.innerHTML = '';
            
            prodotti.forEach(prodotto => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${prodotto.nome}</td>
                    <td>${prodotto.categoriaPrincipale} - ${prodotto.sottocategoria}</td>
                    <td>‚Ç¨${prodotto.prezzoVenditaIngrosso.toFixed(2)}</td>
                    <td>‚Ç¨${prodotto.prezzoVenditaDettaglio.toFixed(2)}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-primary" onclick="selezionaProdotto('${prodotto.nome}', ${prodotto.prezzoVenditaDettaglio})">Seleziona</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function popolaCatalogoVini() {
            const tbody = document.getElementById('catalogoViniBody');
            tbody.innerHTML = '';
            
            vini.forEach(vino => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${vino.nome}</td>
                    <td>${vino.produttore}</td>
                    <td>‚Ç¨${vino.prezzoVenditaIngrosso.toFixed(2)}</td>
                    <td>‚Ç¨${vino.prezzoVenditaDettaglio.toFixed(2)}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-primary" onclick="selezionaProdotto('${vino.nome}', ${vino.prezzoVenditaDettaglio})">Seleziona</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function selezionaProdotto(nome, prezzo) {
            const riga = {
                id: Date.now() + Math.random(),
                prodotto: nome,
                quantita: 1,
                prezzoUnitario: prezzo,
                tipoSconto: 'percentuale',
                valoreSconto: 0,
                subtotaleRiga: 0
            };
            
            // Calcola il subtotale iniziale
            calcolaSubtotaleRiga(riga);
            
            righeProdotto.push(riga);
            updateProdottiTable();
            updateAnteprimaTable();
            calcolaTotali();
            hideCatalogoModal();
        }

        // Gestione del form fattura
        document.getElementById('fatturaFormModal').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            if (righeProdotto.length === 0) {
                alert('Aggiungi almeno un prodotto/servizio!');
                return;
            }
            
            const documento = {
                id: Date.now(),
                tipo: formData.get('tipoDocumento'),
                numero: formData.get('numero'),
                cliente: formData.get('cliente'),
                data: formData.get('data'),
                scadenza: formData.get('scadenza'),
                subtotale: parseFloat(formData.get('subtotale')),
                scontoExtra: parseFloat(formData.get('scontoExtra')),
                totale: parseFloat(formData.get('totale')),
                prodotti: [...righeProdotto],
                note: formData.get('note'),
                stato: 'in_attesa'
            };
            
            documenti.push(documento);
            updateFattureTable();
            saveDataToStorage();
            
            alert('Documento salvato con successo!');
            hideFatturaModal();
            this.reset();
        });

        // Funzione per stampare il documento
        function stampaDocumento() {
            const formData = new FormData(document.getElementById('fatturaFormModal'));
            
            if (righeProdotto.length === 0) {
                alert('Aggiungi almeno un prodotto/servizio!');
                return;
            }
            
            const tipo = formData.get('tipoDocumento');
            const numero = formData.get('numero');
            const cliente = formData.get('cliente');
            const data = formData.get('data');
            const subtotale = parseFloat(formData.get('subtotale'));
            const scontoExtra = parseFloat(formData.get('scontoExtra'));
            const totale = parseFloat(formData.get('totale'));
            
            // Crea il contenuto per la stampa
            let printContent = `
                <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px;">
                    <div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px;">
                        <h1 style="margin: 0; color: #333;">Privilege Caf√®&Wine</h1>
                        <p style="margin: 5px 0; color: #666;">C.so Vittorio Emanuele II, 48 Bitonto (Ba) 70032 - Tel: 0803740786</p>
                        <h2 style="margin: 20px 0; color: #ff6b6b;">${tipo.toUpperCase()} N. ${numero}</h2>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                            <div>
                                <strong>Cliente:</strong> ${cliente}<br>
                                <strong>Data:</strong> ${data}
                            </div>
                            <div style="text-align: right;">
                                <strong>Numero:</strong> ${numero}<br>
                                <strong>Tipo:</strong> ${tipo.toUpperCase()}
                            </div>
                        </div>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Prodotto/Servizio</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Q.t√†</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Prezzo Unit.</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Sconto</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Imponibile</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Calcolo dinamico del subtotale e totale
            let subtotaleCalcolato = 0;
            let scontoExtraCalcolato = parseFloat(scontoExtra) || 0;
            
            righeProdotto.forEach(riga => {
                const tipoSconto = riga.tipoSconto || 'percentuale';
                const valoreSconto = riga.valoreSconto || 0;
                const simboloSconto = tipoSconto === 'percentuale' ? '%' : '‚Ç¨';
                
                // Calcolo dinamico dell'imponibile
                const quantita = parseFloat(riga.quantita) || 0;
                const prezzoUnitario = parseFloat(riga.prezzoUnitario) || 0;
                const subtotaleBase = quantita * prezzoUnitario;
                
                let imponibile = subtotaleBase;
                
                // Applica sconto se presente
                if (valoreSconto > 0) {
                    if (tipoSconto === 'percentuale') {
                        // Sconto percentuale
                        const scontoAmount = subtotaleBase * (valoreSconto / 100);
                        imponibile = subtotaleBase - scontoAmount;
                    } else {
                        // Sconto fisso in euro
                        imponibile = subtotaleBase - valoreSconto;
                    }
                }
                
                // Assicurati che l'imponibile non sia negativo
                imponibile = Math.max(0, imponibile);
                subtotaleCalcolato += imponibile;
                
                printContent += `
                    <tr>
                        <td style="padding: 12px; border: 1px solid #ddd;">${riga.prodotto}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${riga.quantita}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">‚Ç¨${riga.prezzoUnitario.toFixed(2)}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${valoreSconto}${simboloSconto}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">‚Ç¨${imponibile.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            // Calcola il totale finale
            const totaleCalcolato = subtotaleCalcolato - scontoExtraCalcolato;
            
            printContent += `
                        </tbody>
                    </table>
                    
                    <div style="text-align: right; margin-top: 30px;">
                        <div style="margin-bottom: 10px;">
                            <strong>Subtotale:</strong> ‚Ç¨${subtotaleCalcolato.toFixed(2)}
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Sconto Extra:</strong> ‚Ç¨${scontoExtraCalcolato.toFixed(2)}
                        </div>
                        <div style="font-size: 18px; font-weight: bold; border-top: 2px solid #333; padding-top: 10px;">
                            <strong>TOTALE:</strong> ‚Ç¨${totaleCalcolato.toFixed(2)}
                        </div>
                    </div>
                </div>
            `;
            
            // Crea una nuova finestra per la stampa
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${tipo.toUpperCase()} ${numero}</title>
                    <style>
                        body { margin: 0; padding: 20px; }
                        @media print {
                            body { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    ${printContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            
            // Stampa automatica
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }





        function deleteProdotto(id) {
            if (confirm('Sei sicuro di voler eliminare questo prodotto?')) {
                const idx = prodotti.findIndex(p => p.id === id);
                if (idx !== -1) {
                    prodotti.splice(idx, 1);
                    updateProdottiTable();
                    saveDataToStorage();
                    alert('Prodotto eliminato con successo!');
                }
            }
        }



        // Funzione per modificare un prodotto
        function editProdotto(id) {
            const prodotto = prodotti.find(p => p.id === id);
            if (!prodotto) return;
            // Precompila il form con i dati del prodotto
            const form = document.getElementById('prodottoForm');
            form.nome.value = prodotto.nome;
            form.categoriaPrincipale.value = prodotto.categoriaPrincipale;
            updateSottocategorie();
            form.sottocategoria.value = prodotto.sottocategoria;
            form.marca.value = prodotto.marca;
            form.prezzoAcquisto.value = prodotto.prezzoAcquisto;
            form.prezzoVenditaIngrosso.value = prodotto.prezzoVenditaIngrosso;
            form.prezzoVenditaDettaglio.value = prodotto.prezzoVenditaDettaglio;
            form.quantita.value = prodotto.quantita;
            form.quantitaMinima.value = prodotto.quantitaMinima;
            form.fornitore.value = prodotto.fornitore;
            form.codiceProdotto.value = prodotto.codiceProdotto;
            form.note.value = prodotto.note;
            // Salva l'id in un campo nascosto
            if (!form.querySelector('[name="editId"]')) {
                const hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = 'editId';
                form.appendChild(hidden);
            }
            form.editId.value = prodotto.id;
            // Scorri in alto al form
            form.scrollIntoView({ behavior: 'smooth' });
        }

        // Categorie e sottocategorie semplificate e ottimizzate
        const categorie = {
            distillati: {
                rum: 'Rum',
                gin: 'Gin',
                vodka: 'Vodka',
                whisky: 'Whisky',
                tequila: 'Tequila',
                cognac: 'Cognac',
                brandy: 'Brandy',
                bourbon: 'Bourbon',
                scotch: 'Scotch',
                irish: 'Irish Whiskey',
                grappa: 'Grappa',
                altro: 'Altri Distillati'
            },
            liquori: {
                amari: 'Amari',
                digestivi: 'Digestivi',
                creme: 'Creme Liquori',
                premium: 'Premium',
                flavored: 'Aromatizzati',
                limoncello: 'Limoncello',
                sambuca: 'Sambuca',
                altro: 'Altri Liquori'
            },
            vini: {
                rossi: 'Vini Rossi',
                bianchi: 'Vini Bianchi',
                spumanti: 'Spumanti',
                dessert: 'Vini da Dessert',
                fortificati: 'Vini Fortificati',
                altro: 'Altri Vini'
            },
            birre: {
                lager: 'Lager',
                ale: 'Ale',
                speciali: 'Birre Speciali',
                italiane: 'Birre Italiane',
                altro: 'Altre Birre'
            },
            altro: {
                generico: 'Generico',
                altro: 'Altro'
            }
        };

        // Funzione per ottenere il nome di visualizzazione delle sottocategorie
        function getSottocategoriaDisplayName(categoriaPrincipale, sottocategoria) {
            if (categorie[categoriaPrincipale] && categorie[categoriaPrincipale][sottocategoria]) {
                return categorie[categoriaPrincipale][sottocategoria];
            }
            return sottocategoria.charAt(0).toUpperCase() + sottocategoria.slice(1);
        }

        // Funzione per aggiornare le sottocategorie
        function updateSottocategorie() {
            const categoriaPrincipale = document.getElementById('categoriaPrincipale').value;
            const sottocategoriaSelect = document.getElementById('sottocategoria');
            
            sottocategoriaSelect.innerHTML = '<option value="">Seleziona sottocategoria...</option>';
            
            if (categoriaPrincipale && categorie[categoriaPrincipale]) {
                Object.keys(categorie[categoriaPrincipale]).forEach(sottocat => {
                    const option = document.createElement('option');
                    option.value = sottocat;
                    option.textContent = categorie[categoriaPrincipale][sottocat];
                    sottocategoriaSelect.appendChild(option);
                });
            }
        }

        // Funzione per importare da Excel
        function importFromExcel(type, input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    if (jsonData.length === 0) {
                        alert('Il file Excel √® vuoto!');
                        return;
                    }

                    let importedCount = 0;
                    let existingCount = 0;

                    jsonData.forEach(row => {
                        const item = convertExcelRowToItem(type, row);
                        if (item) {
                            // Controlla se l'elemento esiste gi√†
                            const exists = checkIfExists(type, item);
                            if (!exists) {
                                addItemToArray(type, item);
                                importedCount++;
                            } else {
                                existingCount++;
                            }
                        }
                    });

                    // Aggiorna le tabelle e salva
                    updateAllTables();
                    saveDataToStorage();

                    alert(`Importazione completata!\nNuovi elementi: ${importedCount}\nElementi esistenti saltati: ${existingCount}`);
                    input.value = ''; // Reset input
                } catch (error) {
                    alert('Errore durante l\'importazione del file Excel: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Funzione per convertire riga Excel in oggetto
        function convertExcelRowToItem(type, row) {
            switch(type) {
                case 'clienti':
                    return {
                        id: Date.now() + Math.random(),
                        nomeAzienda: row['Nome Azienda'] || '',
                        tipologia: row['Tipologia'] || 'privato',
                        nome: row['Nome Referente'] || row['Nome'] || '',
                        cognome: row['Cognome Referente'] || row['Cognome'] || '',
                        email: row['Email'] || '',
                        telefono: row['Telefono'] || '',
                        indirizzo: row['Indirizzo'] || '',
                        citta: row['Citt√†'] || '',
                        cap: row['CAP'] || '',
                        dataRegistrazione: row['Data Registrazione'] || new Date().toISOString().split('T')[0],
                        note: row['Note'] || ''
                    };
                case 'fatture':
                    return {
                        id: Date.now() + Math.random(),
                        tipo: row['Tipo'] ? row['Tipo'].toLowerCase() : 'fattura',
                        numero: row['Numero'] || '',
                        cliente: row['Cliente'] || '',
                        data: row['Data'] || new Date().toISOString().split('T')[0],
                        scadenza: row['Scadenza'] || '',
                        subtotale: parseFloat(row['Subtotale']) || 0,
                        scontoExtra: parseFloat(row['Sconto Extra']) || 0,
                        totale: parseFloat(row['Totale']) || 0,
                        prodotti: [],
                        stato: row['Stato'] || 'in_attesa',
                        note: row['Note'] || ''
                    };
                case 'prodotti':
                    return {
                        id: Date.now() + Math.random(),
                        nome: row['Nome'] || '',
                        categoriaPrincipale: row['Categoria Principale'] || 'altro',
                        sottocategoria: row['Sottocategoria'] || 'altro',
                        marca: row['Marca'] || '',
                        prezzoAcquisto: parseFloat(row['Prezzo Acquisto']) || 0,
                        prezzoVenditaIngrosso: parseFloat(row['Prezzo Vendita Ingrosso']) || 0,
                        prezzoVenditaDettaglio: parseFloat(row['Prezzo Vendita al Dettaglio']) || 0,
                        quantita: parseInt(row['Quantit√†']) || 0,
                        quantitaMinima: parseInt(row['Quantit√† Minima']) || 5,
                        fornitore: row['Fornitore'] || '',
                        codiceProdotto: row['Codice Prodotto'] || '',
                        note: row['Note'] || ''
                    };
                case 'vini':
                    return {
                        id: Date.now() + Math.random(),
                        nome: row['Nome'] || '',
                        produttore: row['Produttore'] || '',
                        annata: parseInt(row['Annata']) || new Date().getFullYear(),
                        tipologia: row['Tipologia'] || 'rosso',
                        regione: row['Regione'] || '',
                        vitigno: row['Vitigno'] || '',
                        prezzoAcquisto: parseFloat(row['Prezzo Acquisto']) || 0,
                        prezzoVenditaIngrosso: parseFloat(row['Prezzo Vendita Ingrosso']) || 0,
                        prezzoVenditaDettaglio: parseFloat(row['Prezzo Vendita al Dettaglio']) || 0,
                        quantita: parseInt(row['Quantit√†']) || 0,
                        unitaMisura: row['Unit√† di Misura'] || 'bottiglie',
                        fornitore: row['Fornitore'] || '',
                        codiceProdotto: row['Codice Prodotto'] || '',
                        descrizione: row['Descrizione'] || '',
                        note: row['Note'] || ''
                    };
                default:
                    return null;
            }
        }

        // Funzione per controllare se un elemento esiste gi√†
        function checkIfExists(type, item) {
            switch(type) {
                case 'clienti':
                    return clienti.some(c => c.email === item.email && c.nome === item.nome);
                case 'fatture':
                    return documenti.some(d => d.numero === item.numero);
                case 'prodotti':
                    return prodotti.some(p => p.nome === item.nome && p.marca === item.marca);
                case 'vini':
                    return vini.some(v => v.nome === item.nome && v.produttore === item.produttore && v.annata === item.annata);
                default:
                    return false;
            }
        }

        // Funzione per aggiungere elemento all'array
        function addItemToArray(type, item) {
            switch(type) {
                case 'clienti':
                    clienti.push(item);
                    break;
                case 'fatture':
                    documenti.push(item);
                    break;
                case 'prodotti':
                    prodotti.push(item);
                    break;
                case 'vini':
                    vini.push(item);
                    break;
            }
        }

        // Funzione per aggiornare tutte le tabelle
        function updateAllTables() {
            updateClientiTable();
            updateFattureTable();
            updateProdottiTable();
            updateViniTable();
        }

        // Funzione per esportare in Excel con formattazione avanzata
        function exportToExcel(type, prezzoType = null) {
            let data = [];
            let filename = '';
            let columnWidths = [];
            
            switch(type) {
                case 'clienti':
                    data = clienti.map(c => ({
                        'Nome Azienda': c.nomeAzienda || '',
                        'Tipologia': c.tipologia || 'privato',
                        'Nome Referente': c.nome,
                        'Cognome Referente': c.cognome,
                        'Email': c.email,
                        'Telefono': c.telefono,
                        'Indirizzo': c.indirizzo,
                        'Citt√†': c.citta,
                        'CAP': c.cap,
                        'Data Registrazione': c.dataRegistrazione,
                        'Note': c.note
                    }));
                    filename = 'Clienti_Tommy.xlsx';
                    columnWidths = [25, 15, 20, 20, 30, 15, 25, 15, 10, 15, 40];
                    break;
                    
                case 'fatture':
                    data = documenti.map(d => ({
                        'Tipo': d.tipo.toUpperCase(),
                        'Numero': d.numero,
                        'Cliente': d.cliente,
                        'Data': d.data,
                        'Scadenza': d.scadenza || '',
                        'Subtotale': d.subtotale,
                        'Sconto Extra': d.scontoExtra,
                        'Totale': d.totale,
                        'Stato': d.stato,
                        'Note': d.note || ''
                    }));
                    filename = 'Documenti_Tommy.xlsx';
                    columnWidths = [15, 15, 25, 12, 12, 12, 12, 12, 15, 40];
                    break;
                    
                case 'prodotti':
                    if (prezzoType === 'ingrosso') {
                        data = prodotti.map(p => ({
                            'Nome': p.nome,
                            'Categoria Principale': p.categoriaPrincipale,
                            'Sottocategoria': p.sottocategoria,
                            'Marca': p.marca,
                            'Prezzo Acquisto': p.prezzoAcquisto,
                            'Prezzo Vendita Ingrosso': p.prezzoVenditaIngrosso,
                            'Quantit√†': p.quantita,
                            'Quantit√† Minima': p.quantitaMinima,
                            'Fornitore': p.fornitore,
                            'Codice Prodotto': p.codiceProdotto,
                            'Note': p.note
                        }));
                        filename = 'Prodotti_Ingrosso_Tommy.xlsx';
                        columnWidths = [25, 20, 20, 15, 15, 18, 10, 12, 20, 15, 30];
                    } else if (prezzoType === 'dettaglio') {
                        data = prodotti.map(p => ({
                            'Nome': p.nome,
                            'Categoria Principale': p.categoriaPrincipale,
                            'Sottocategoria': p.sottocategoria,
                            'Marca': p.marca,
                            'Prezzo Acquisto': p.prezzoAcquisto,
                            'Prezzo Vendita al Dettaglio': p.prezzoVenditaDettaglio,
                            'Quantit√†': p.quantita,
                            'Quantit√† Minima': p.quantitaMinima,
                            'Fornitore': p.fornitore,
                            'Codice Prodotto': p.codiceProdotto,
                            'Note': p.note
                        }));
                        filename = 'Prodotti_Dettaglio_Tommy.xlsx';
                        columnWidths = [25, 20, 20, 15, 15, 20, 10, 12, 20, 15, 30];
                    } else {
                        // Export completo con entrambi i prezzi
                        data = prodotti.map(p => ({
                            'Nome': p.nome,
                            'Categoria Principale': p.categoriaPrincipale,
                            'Sottocategoria': p.sottocategoria,
                            'Marca': p.marca,
                            'Prezzo Acquisto': p.prezzoAcquisto,
                            'Prezzo Vendita Ingrosso': p.prezzoVenditaIngrosso,
                            'Prezzo Vendita al Dettaglio': p.prezzoVenditaDettaglio,
                            'Quantit√†': p.quantita,
                            'Quantit√† Minima': p.quantitaMinima,
                            'Fornitore': p.fornitore,
                            'Codice Prodotto': p.codiceProdotto,
                            'Note': p.note
                        }));
                        filename = 'Prodotti_Completo_Tommy.xlsx';
                        columnWidths = [25, 20, 20, 15, 15, 18, 20, 10, 12, 20, 15, 30];
                    }
                    break;
                    
                case 'vini':
                    if (prezzoType === 'ingrosso') {
                        data = vini.map(v => ({
                            'Nome': v.nome,
                            'Produttore': v.produttore,
                            'Annata': v.annata,
                            'Tipologia': v.tipologia,
                            'Regione': v.regione,
                            'Vitigno': v.vitigno,
                            'Prezzo Acquisto': v.prezzoAcquisto,
                            'Prezzo Vendita Ingrosso': v.prezzoVenditaIngrosso,
                            'Quantit√†': v.quantita,
                            'Unit√† di Misura': v.unitaMisura || 'bottiglie',
                            'Fornitore': v.fornitore,
                            'Codice Prodotto': v.codiceProdotto,
                            'Descrizione': v.descrizione,
                            'Note': v.note
                        }));
                        filename = 'Vini_Ingrosso_Tommy.xlsx';
                        columnWidths = [25, 20, 10, 15, 15, 15, 15, 18, 10, 15, 20, 15, 30, 30];
                    } else if (prezzoType === 'dettaglio') {
                        data = vini.map(v => ({
                            'Nome': v.nome,
                            'Produttore': v.produttore,
                            'Annata': v.annata,
                            'Tipologia': v.tipologia,
                            'Regione': v.regione,
                            'Vitigno': v.vitigno,
                            'Prezzo Acquisto': v.prezzoAcquisto,
                            'Prezzo Vendita al Dettaglio': v.prezzoVenditaDettaglio,
                            'Quantit√†': v.quantita,
                            'Unit√† di Misura': v.unitaMisura || 'bottiglie',
                            'Fornitore': v.fornitore,
                            'Codice Prodotto': v.codiceProdotto,
                            'Descrizione': v.descrizione,
                            'Note': v.note
                        }));
                        filename = 'Vini_Dettaglio_Tommy.xlsx';
                        columnWidths = [25, 20, 10, 15, 15, 15, 15, 20, 10, 15, 20, 15, 30, 30];
                    } else {
                        // Export completo con entrambi i prezzi
                        data = vini.map(v => ({
                            'Nome': v.nome,
                            'Produttore': v.produttore,
                            'Annata': v.annata,
                            'Tipologia': v.tipologia,
                            'Regione': v.regione,
                            'Vitigno': v.vitigno,
                            'Prezzo Acquisto': v.prezzoAcquisto,
                            'Prezzo Vendita Ingrosso': v.prezzoVenditaIngrosso,
                            'Prezzo Vendita al Dettaglio': v.prezzoVenditaDettaglio,
                            'Quantit√†': v.quantita,
                            'Unit√† di Misura': v.unitaMisura || 'bottiglie',
                            'Fornitore': v.fornitore,
                            'Codice Prodotto': v.codiceProdotto,
                            'Descrizione': v.descrizione,
                            'Note': v.note
                        }));
                        filename = 'Vini_Completo_Tommy.xlsx';
                        columnWidths = [25, 20, 10, 15, 15, 15, 15, 18, 20, 10, 15, 20, 15, 30, 30];
                    }
                    break;
            }
            
            if (data.length === 0) {
                alert('Nessun dato da esportare!');
                return;
            }
            
            // Crea il foglio di lavoro
            const ws = XLSX.utils.json_to_sheet(data);
            
            // Imposta le larghezze delle colonne
            ws['!cols'] = columnWidths.map(width => ({ width }));
            
            // Imposta la riga di intestazione come fissa
            ws['!freeze'] = { r: 1, c: 0 };
            
            // Aggiungi stili per l'intestazione
            const headerRange = XLSX.utils.decode_range(ws['!ref']);
            for (let C = headerRange.s.c; C <= headerRange.e.c; ++C) {
                const cellAddress = XLSX.utils.encode_cell({ r: 0, c: C });
                if (!ws[cellAddress]) continue;
                
                // Stile per intestazioni
                ws[cellAddress].s = {
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "4472C4" } },
                    alignment: { horizontal: "center", vertical: "center" },
                    border: {
                        top: { style: "thin" },
                        bottom: { style: "thin" },
                        left: { style: "thin" },
                        right: { style: "thin" }
                    }
                };
            }
            
            // Stili per le righe dati
            for (let R = 1; R <= headerRange.e.r; ++R) {
                for (let C = headerRange.s.c; C <= headerRange.e.c; ++C) {
                    const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                    if (!ws[cellAddress]) continue;
                    
                    // Stile per dati
                    ws[cellAddress].s = {
                        border: {
                            top: { style: "thin" },
                            bottom: { style: "thin" },
                            left: { style: "thin" },
                            right: { style: "thin" }
                        },
                        alignment: { vertical: "center" }
                    };
                    
                    // Stile speciale per colonne numeriche (prezzi, quantit√†)
                    const columnName = Object.keys(data[0])[C];
                    if (columnName && (columnName.includes('Prezzo') || columnName.includes('Quantit√†') || columnName.includes('Importo'))) {
                        ws[cellAddress].s.numFmt = '‚Ç¨#,##0.00';
                    }
                }
            }
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Dati");
            XLSX.writeFile(wb, filename);
        }

        // Funzione per stampare il listino vini
        function printWineList() {
            if (vini.length === 0) {
                alert('Nessun vino disponibile per la stampa!');
                return;
            }

            // Chiedi all'utente quale tipo di listino stampare
            const tipoListino = confirm('Vuoi stampare il listino al DETTAGLIO?\n\nClicca OK per DETTAGLIO\nClicca Annulla per INGROSSO');
            const isDettaglio = tipoListino;
            const prezzoType = isDettaglio ? 'dettaglio' : 'ingrosso';
            const prezzoField = isDettaglio ? 'prezzoVenditaDettaglio' : 'prezzoVenditaIngrosso';
            const tipoText = isDettaglio ? 'DETTAGLIO' : 'INGROSSO';

            // Raggruppa i vini per tipologia
            const viniPerTipologia = {};
            vini.forEach(vino => {
                if (!viniPerTipologia[vino.tipologia]) {
                    viniPerTipologia[vino.tipologia] = [];
                }
                viniPerTipologia[vino.tipologia].push(vino);
            });

            // Crea il contenuto HTML per la stampa
            let printContent = `
                <div class="print-wine-list">
                    <div class="wine-header">
                        <h1 class="wine-title">Privilege Caf√®&Wine</h1>
                        <p class="wine-subtitle">Listino Vini - ${tipoText}</p>
                        <p class="wine-date">Aggiornato al ${new Date().toLocaleDateString('it-IT')}</p>
                    </div>
            `;

            // Aggiungi i vini raggruppati per tipologia
            Object.keys(viniPerTipologia).forEach((tipologia, index) => {
                if (index > 0 && index % 8 === 0) {
                    printContent += '<div class="page-break"></div>';
                }
                
                printContent += `<div class="wine-category">${tipologia.charAt(0).toUpperCase() + tipologia.slice(1)}</div>`;
                
                viniPerTipologia[tipologia].forEach(vino => {
                    printContent += `
                        <div class="wine-item">
                            <div class="wine-name">${vino.nome}</div>
                            <div class="wine-producer">${vino.produttore}</div>
                            <div class="wine-year">${vino.annata}</div>
                            <div class="wine-unit">${vino.unitaMisura || 'bottiglie'}</div>
                            <div class="wine-vitigno">${vino.vitigno || '-'}</div>
                            <div class="wine-price">‚Ç¨${vino[prezzoField].toFixed(2)}</div>
                        </div>
                    `;
                });
            });

            printContent += `
                    <div class="wine-footer">
                        <p>Privilege Caf√®&Wine - Listino prezzi al ${tipoText.toLowerCase()}</p>
                        <p>I prezzi sono espressi in Euro e includono IVA</p>
                    </div>
                </div>
            `;

            // Crea una nuova finestra per la stampa
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Listino Vini ${tipoText} - Privilege Caf√®&Wine</title>
                    <style>
                        body {
                            font-family: 'Arial', sans-serif;
                            margin: 0;
                            padding: 20px;
                            background: white;
                        }
                        
                        .print-wine-list {
                            max-width: 800px;
                            margin: 0 auto;
                        }
                        
                        .wine-header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 3px solid #228B22;
                            padding-bottom: 20px;
                            position: relative;
                        }
                        
                        .wine-header::before,
                        .wine-header::after {
                            content: 'üç∑';
                            font-size: 24px;
                            position: absolute;
                            top: 50%;
                            transform: translateY(-50%);
                        }
                        
                        .wine-header::before {
                            left: 20px;
                        }
                        
                        .wine-header::after {
                            right: 20px;
                        }
                        
                        .wine-title {
                            font-size: 36px;
                            font-weight: bold;
                            color: #228B22;
                            margin: 0;
                            font-family: 'Georgia', serif;
                        }
                        
                        .wine-subtitle {
                            font-size: 18px;
                            color: #666;
                            margin: 10px 0 0 0;
                            font-style: italic;
                        }
                        
                        .wine-date {
                            font-size: 14px;
                            color: #888;
                            margin: 5px 0 0 0;
                        }
                        
                        .wine-category {
                            margin: 40px 0 20px 0;
                            font-size: 24px;
                            font-weight: bold;
                            color: #228B22;
                            border-bottom: 2px solid #228B22;
                            padding-bottom: 12px;
                            text-transform: uppercase;
                            letter-spacing: 1px;
                            position: relative;
                            text-align: center;
                        }
                        
                        .wine-category::before {
                            content: '';
                            position: absolute;
                            top: 50%;
                            left: 0;
                            right: 0;
                            height: 1px;
                            background: linear-gradient(to right, transparent, #228B22, transparent);
                        }
                        
                        .wine-category::after {
                            content: 'üçá';
                            position: absolute;
                            top: 50%;
                            right: 10px;
                            transform: translateY(-50%);
                            font-size: 18px;
                        }
                        
                        .wine-item {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 12px 0;
                            border-bottom: 1px solid #f0f0f0;
                            font-size: 16px;
                        }
                        
                        .wine-item:last-child {
                            border-bottom: 2px solid #ddd;
                        }
                        
                        .wine-name {
                            font-weight: 600;
                            color: #333;
                            flex: 2;
                            min-width: 200px;
                        }
                        
                        .wine-producer {
                            font-weight: 500;
                            color: #555;
                            flex: 1;
                            min-width: 120px;
                            text-align: center;
                        }
                        
                        .wine-year {
                            font-weight: 500;
                            color: #666;
                            flex: 0 0 60px;
                            text-align: center;
                        }
                        
                        .wine-unit {
                            font-size: 12px;
                            color: #888;
                            flex: 0 0 80px;
                            text-align: center;
                        }
                        
                        .wine-vitigno {
                            font-size: 14px;
                            color: #666;
                            font-style: italic;
                            flex: 0 0 100px;
                            text-align: center;
                        }
                        
                        .wine-price {
                            font-weight: bold;
                            color: #228B22;
                            font-size: 18px;
                            min-width: 80px;
                            text-align: right;
                        }
                        
                        .page-break {
                            page-break-before: always;
                        }
                        
                        .wine-footer {
                            margin-top: 40px;
                            text-align: center;
                            font-size: 12px;
                            color: #888;
                            border-top: 1px solid #ddd;
                            padding-top: 20px;
                        }
                        
                        @media print {
                            body {
                                margin: 0;
                                padding: 0;
                            }
                            
                            .wine-item {
                                page-break-inside: avoid;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${printContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            
            // Stampa automatica dopo un breve delay
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        // Funzione per i colori delle categorie
        function getCategoriaColor(categoria) {
            const colors = {
                distillati: 'bg-amber-100 text-amber-800',
                liquori: 'bg-blue-100 text-blue-800',
                vini: 'bg-wine-100 text-wine-800',
                birre: 'bg-orange-100 text-orange-800',
                rum: 'bg-amber-100 text-amber-800',
                gin: 'bg-blue-100 text-blue-800',
                vodka: 'bg-gray-100 text-gray-800',
                whisky: 'bg-orange-100 text-orange-800',
                tequila: 'bg-green-100 text-green-800',
                cognac: 'bg-purple-100 text-purple-800',
                brandy: 'bg-red-100 text-red-800',
                amari: 'bg-red-100 text-red-800',
                digestivi: 'bg-green-100 text-green-800',
                creme: 'bg-pink-100 text-pink-800',
                premium: 'bg-purple-100 text-purple-800',
                flavored: 'bg-blue-100 text-blue-800',
                rossi: 'bg-red-100 text-red-800',
                bianchi: 'bg-yellow-100 text-yellow-800',
                spumanti: 'bg-pink-100 text-pink-800',
                dessert: 'bg-purple-100 text-purple-800',
                fortificati: 'bg-orange-100 text-orange-800',
                lager: 'bg-yellow-100 text-yellow-800',
                ale: 'bg-amber-100 text-amber-800',
                speciali: 'bg-purple-100 text-purple-800',
                italiane: 'bg-green-100 text-green-800',
                liquore: 'bg-pink-100 text-pink-800',
                altro: 'bg-gray-100 text-gray-800',
            };
            return colors[categoria] || colors.altro;
        }

        // Inizializzazione migliorata
        document.addEventListener('DOMContentLoaded', async function() {
            // Event listener per il campo tipologia
            const tipologiaSelect = document.querySelector('select[name="tipologia"]');
            if (tipologiaSelect) {
                tipologiaSelect.addEventListener('change', toggleNomeAzienda);
            }
            try {
                // Pre-configurazione GitHub all'avvio
                localStorage.setItem('tommy_gist_id', 'ed140f6366c097f54410d096017bb51b');
                localStorage.setItem('tommy_github_enabled', 'true');
                
                // Carica la password di sicurezza
                loadSecurityPassword();
                
                // Carica i dati salvati
                await loadDataFromStorage();
                
                // Aggiungi i dati dell'azienda di Tommaso
                addTommasoCompanyData();
                
                // Controlla se GitHub √® gi√† configurato
                const hasGitHubToken = localStorage.getItem('tommy_github_token');
                
                if (!hasGitHubToken) {
                    // Se non c'√® il token, mostra la configurazione GitHub prima del login
                    showGitHubSetup();
                } else {
                    // Se c'√® gi√† il token, mostra direttamente il login
                    showLoginModal();
                }
                
                // Imposta la data di oggi come default
                const today = new Date().toISOString().split('T')[0];
                const dataInputs = document.querySelectorAll('input[type="date"]');
                dataInputs.forEach(input => {
                    if (!input.value) {
                        input.value = today;
                    }
                });
                
                // Mostra info dispositivo
                document.getElementById('deviceIdDisplay').textContent = deviceId.substring(0, 8) + '...';
                
                // Aggiorna indicatore sincronizzazione
                updateSyncIndicator();
                
                // Test automatico connessione GitHub
                setTimeout(async () => {
                    if (GITHUB_CONFIG.enabled && GITHUB_CONFIG.token && GITHUB_CONFIG.gistId) {
                        const success = await testGitHubConnection();
                        if (success) {
                            showNotification('‚úÖ GitHub configurato e connesso!', 'success');
                        }
                    }
                }, 2000);

                // Event listeners per la modale di setup GitHub
                const githubTokenSetup = document.getElementById('githubTokenSetup');
                const gistIdSetup = document.getElementById('gistIdSetup');
                
                if (githubTokenSetup) {
                    githubTokenSetup.addEventListener('keypress', function(event) {
                        if (event.key === 'Enter') {
                            saveGitHubSetup();
                        } else if (event.key === 'Escape') {
                            skipGitHubSetup();
                        }
                    });
                }
                
                if (gistIdSetup) {
                    gistIdSetup.addEventListener('keypress', function(event) {
                        if (event.key === 'Enter') {
                            saveGitHubSetup();
                        } else if (event.key === 'Escape') {
                            skipGitHubSetup();
                        }
                    });
                }
                
                // Event listeners per filtri vini con debounce
                const filterInputs = ['filterNome', 'filterProduttore', 'filterRegione', 'filterVitigno'];
                filterInputs.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('input', debouncedApplyFilters);
                    }
                });
                
                // Event listeners per select vini
                const filterSelects = ['filterTipologia', 'filterStock'];
                filterSelects.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('change', applyViniFilters);
                    }
                });
                
                // Event listeners per filtri prodotti con debounce
                const filterInputsProdotti = ['filterNomeProdotti', 'filterMarca', 'filterFornitore'];
                filterInputsProdotti.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('input', debouncedApplyProdottiFilters);
                    }
                });
                
                // Event listeners per select prodotti
                const filterSelectsProdotti = ['filterCategoriaPrincipale', 'filterStockProdotti', 'filterPrezzo'];
                filterSelectsProdotti.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('change', applyProdottiFilters);
                    }
                });

                // Validazione form migliorata
                const forms = document.querySelectorAll('form');
                forms.forEach(form => {
                    form.addEventListener('submit', function(e) {
                        const requiredFields = form.querySelectorAll('[required]');
                        let isValid = true;
                        
                        requiredFields.forEach(field => {
                            if (!field.value.trim()) {
                                field.style.borderColor = '#dc3545';
                                isValid = false;
                            } else {
                                field.style.borderColor = '#e9ecef';
                            }
                        });
                        
                        if (!isValid) {
                            e.preventDefault();
                            showNotification('Compila tutti i campi obbligatori', 'error');
                        }
                    });
                });

                showNotification('Sistema caricato con successo!', 'success');
            } catch (error) {
                console.error('Errore nell\'inizializzazione:', error);
                showNotification('Errore nell\'inizializzazione del sistema', 'error');
            }
        });

        // Funzioni per i filtri vini con debounce
        const debouncedApplyFilters = debounce(applyViniFilters, 300);

        // Funzioni per i filtri prodotti con debounce
        const debouncedApplyProdottiFilters = debounce(applyProdottiFilters, 300);

        function applyViniFilters() {
            try {
                const filterNome = document.getElementById('filterNome').value.toLowerCase();
                const filterProduttore = document.getElementById('filterProduttore').value.toLowerCase();
                const filterTipologia = document.getElementById('filterTipologia').value;
                const filterRegione = document.getElementById('filterRegione').value.toLowerCase();
                const filterVitigno = document.getElementById('filterVitigno').value.toLowerCase();
                const filterStock = document.getElementById('filterStock').value;

                const tbody = document.getElementById('viniTableBody');
                tbody.innerHTML = '';
                
                let filteredCount = 0;
                
                vini.forEach(vino => {
                    // Applica filtri
                    const matchesNome = !filterNome || vino.nome.toLowerCase().includes(filterNome);
                    const matchesProduttore = !filterProduttore || vino.produttore.toLowerCase().includes(filterProduttore);
                    const matchesTipologia = !filterTipologia || vino.tipologia === filterTipologia;
                    const matchesRegione = !filterRegione || (vino.regione && vino.regione.toLowerCase().includes(filterRegione));
                    const matchesVitigno = !filterVitigno || (vino.vitigno && vino.vitigno.toLowerCase().includes(filterVitigno));
                    
                    // Filtro stock
                    const stockClass = vino.quantita <= 3 ? 'stock-low' : 'stock-ok';
                    const stockText = vino.quantita <= 3 ? 'Scorte Basse' : 'OK';
                    const matchesStock = !filterStock || 
                        (filterStock === 'ok' && vino.quantita > 3) ||
                        (filterStock === 'basso' && vino.quantita <= 3);

                    if (matchesNome && matchesProduttore && matchesTipologia && matchesRegione && matchesVitigno && matchesStock) {
                        // Gestione censura prezzi di acquisto nei filtri - solo per admin
                        let prezzoAcquistoCell = '';
                        if (currentUser === 'admin') {
                            const prezzoAcquistoDisplay = isSecurityActive && !isSecurityUnlocked ? 
                                `<span class="censored">‚Ç¨${vino.prezzoAcquisto.toFixed(2)}</span>` : 
                                `‚Ç¨${vino.prezzoAcquisto.toFixed(2)}`;
                            prezzoAcquistoCell = `<td class="table-censored">${prezzoAcquistoDisplay}</td>`;
                        }
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${vino.nome}</td>
                            <td>${vino.produttore}</td>
                            <td>${vino.annata}</td>
                            <td>${vino.tipologia}</td>
                            <td>${vino.regione}</td>
                            <td>${vino.vitigno || '-'}</td>
                            ${prezzoAcquistoCell}
                            <td>‚Ç¨${vino.prezzoVenditaIngrosso.toFixed(2)}</td>
                            <td>‚Ç¨${vino.prezzoVenditaDettaglio.toFixed(2)}</td>
                            <td>${vino.quantita}</td>
                            <td>${vino.unitaMisura || 'bottiglie'}</td>
                            <td><span class="status-badge ${stockClass}">${stockText}</span></td>
                            <td>${vino.note}</td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="editVino(${vino.id})">‚úèÔ∏è Modifica</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteVino(${vino.id})">üóëÔ∏è Elimina</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                        filteredCount++;
                    }
                });
                
                // Mostra risultati
                const totalCount = vini.length;
                document.getElementById('filterResults').textContent = 
                    `Risultati: ${filteredCount} di ${totalCount} vini`;
            } catch (error) {
                console.error('Errore nell\'applicazione filtri:', error);
                showNotification('Errore nell\'applicazione dei filtri', 'error');
            }
        }

        function clearViniFilters() {
            try {
                document.getElementById('filterNome').value = '';
                document.getElementById('filterProduttore').value = '';
                document.getElementById('filterTipologia').value = '';
                document.getElementById('filterRegione').value = '';
                document.getElementById('filterVitigno').value = '';
                document.getElementById('filterStock').value = '';
                document.getElementById('filterResults').textContent = '';
                updateViniTable();
                showNotification('Filtri cancellati', 'success');
            } catch (error) {
                console.error('Errore nella cancellazione filtri:', error);
                showNotification('Errore nella cancellazione dei filtri', 'error');
            }
        }

        function applyProdottiFilters() {
            try {
                const filterNome = document.getElementById('filterNomeProdotti').value.toLowerCase();
                const filterCategoria = document.getElementById('filterCategoriaPrincipale').value;
                const filterMarca = document.getElementById('filterMarca').value.toLowerCase();
                const filterFornitore = document.getElementById('filterFornitore').value.toLowerCase();
                const filterStock = document.getElementById('filterStockProdotti').value;
                const filterPrezzo = document.getElementById('filterPrezzo').value;

                const tbody = document.getElementById('prodottiTableBody');
                tbody.innerHTML = '';
                
                let filteredCount = 0;
                
                prodotti.forEach(prodotto => {
                    // Applica filtri
                    const matchesNome = !filterNome || prodotto.nome.toLowerCase().includes(filterNome);
                    const matchesCategoria = !filterCategoria || prodotto.categoriaPrincipale === filterCategoria;
                    const matchesMarca = !filterMarca || (prodotto.marca && prodotto.marca.toLowerCase().includes(filterMarca));
                    const matchesFornitore = !filterFornitore || (prodotto.fornitore && prodotto.fornitore.toLowerCase().includes(filterFornitore));
                    
                    // Filtro stock
                    const stockClass = prodotto.quantita <= prodotto.quantitaMinima ? 'stock-low' : 'stock-ok';
                    const stockText = prodotto.quantita <= prodotto.quantitaMinima ? 'Scorte Basse' : 'OK';
                    const matchesStock = !filterStock || 
                        (filterStock === 'ok' && prodotto.quantita > prodotto.quantitaMinima) ||
                        (filterStock === 'basso' && prodotto.quantita <= prodotto.quantitaMinima);
                    
                    // Filtro prezzo (usa prezzo dettaglio come riferimento)
                    let matchesPrezzo = true;
                    if (filterPrezzo) {
                        const prezzo = prodotto.prezzoVenditaDettaglio;
                        if (filterPrezzo === 'basso' && prezzo >= 10) matchesPrezzo = false;
                        else if (filterPrezzo === 'medio' && (prezzo < 10 || prezzo > 30)) matchesPrezzo = false;
                        else if (filterPrezzo === 'alto' && prezzo <= 30) matchesPrezzo = false;
                    }

                    if (matchesNome && matchesCategoria && matchesMarca && matchesFornitore && matchesStock && matchesPrezzo) {
                        // Gestione censura prezzi di acquisto - solo per admin
                        let prezzoAcquistoCell = '';
                        if (currentUser === 'admin') {
                            const prezzoAcquistoDisplay = isSecurityActive && !isSecurityUnlocked ? 
                                `<span class="censored">‚Ç¨${prodotto.prezzoAcquisto.toFixed(2)}</span>` : 
                                `‚Ç¨${prodotto.prezzoAcquisto.toFixed(2)}`;
                            prezzoAcquistoCell = `<td class="table-censored">${prezzoAcquistoDisplay}</td>`;
                        }
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${prodotto.nome}</td>
                            <td>
                                <div>
                                    <span class="status-badge ${getCategoriaColor(prodotto.categoriaPrincipale)}">${prodotto.categoriaPrincipale.toUpperCase()}</span>
                                    <br>
                                    <span class="status-badge ${getCategoriaColor(prodotto.sottocategoria)}">${getSottocategoriaDisplayName(prodotto.categoriaPrincipale, prodotto.sottocategoria)}</span>
                                </div>
                            </td>
                            <td>${prodotto.marca}</td>
                            ${prezzoAcquistoCell}
                            <td>‚Ç¨${prodotto.prezzoVenditaIngrosso.toFixed(2)}</td>
                            <td>‚Ç¨${prodotto.prezzoVenditaDettaglio.toFixed(2)}</td>
                            <td>${prodotto.quantita}</td>
                            <td>${prodotto.unitaMisura || 'bottiglie'}</td>
                            <td><span class="status-badge ${stockClass}">${stockText}</span></td>
                            <td>${prodotto.fornitore}</td>
                            <td>${prodotto.note}</td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="editProdotto(${prodotto.id})">‚úèÔ∏è Modifica</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteProdotto(${prodotto.id})">üóëÔ∏è Elimina</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                        filteredCount++;
                    }
                });
                
                // Mostra risultati
                const totalCount = prodotti.length;
                document.getElementById('filterResultsProdotti').textContent = 
                    `Risultati: ${filteredCount} di ${totalCount} prodotti`;
            } catch (error) {
                console.error('Errore nell\'applicazione filtri prodotti:', error);
                showNotification('Errore nell\'applicazione dei filtri prodotti', 'error');
            }
        }

        function clearProdottiFilters() {
            try {
                document.getElementById('filterNomeProdotti').value = '';
                document.getElementById('filterCategoriaPrincipale').value = '';
                document.getElementById('filterMarca').value = '';
                document.getElementById('filterFornitore').value = '';
                document.getElementById('filterStockProdotti').value = '';
                document.getElementById('filterPrezzo').value = '';
                document.getElementById('filterResultsProdotti').textContent = '';
                updateProdottiTable();
                showNotification('Filtri prodotti cancellati', 'success');
            } catch (error) {
                console.error('Errore nella cancellazione filtri prodotti:', error);
                showNotification('Errore nella cancellazione dei filtri prodotti', 'error');
            }
        }

        // Funzioni per il sistema di sicurezza
        function toggleSecurity() {
            if (isSecurityActive && !isSecurityUnlocked) {
                // Se la sicurezza √® attiva ma bloccata, mostra il modal per sbloccare
                showSecurityModal('unlock');
            } else if (isSecurityActive && isSecurityUnlocked) {
                // Se la sicurezza √® attiva e sbloccata, riattiva la censura
                activateSecurity();
            } else {
                // Se la sicurezza √® disattivata, riattivala
                activateSecurity();
            }
        }

        function showSecurityModal(mode = 'unlock') {
            const overlay = document.getElementById('securityOverlay');
            const passwordInput = document.getElementById('securityPassword');
            const modalTitle = document.getElementById('securityModalTitle');
            const warning = document.getElementById('securityWarning');
            const actionBtn = document.getElementById('securityActionBtn');
            const currentPasswordDisplay = document.getElementById('currentPasswordDisplay');
            
            overlay.style.display = 'flex';
            passwordInput.focus();
            passwordInput.value = '';
            
            // Aggiorna il display della password attuale (nascosta)
            currentPasswordDisplay.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            
            if (mode === 'unlock') {
                modalTitle.textContent = 'üîê Accesso Sicurezza';
                warning.innerHTML = '<strong>‚ö†Ô∏è ATTENZIONE:</strong><br>Inserisci la password per visualizzare i prezzi di acquisto';
                actionBtn.textContent = 'üîì Sblocca';
                actionBtn.onclick = validateSecurityPassword;
            }
        }

        function hideSecurityModal() {
            const overlay = document.getElementById('securityOverlay');
            overlay.style.display = 'none';
        }

        function handleSecurityPassword(event) {
            if (event.key === 'Enter') {
                validateSecurityPassword();
            } else if (event.key === 'Escape') {
                cancelSecurity();
            }
        }

        function validateSecurityPassword() {
            const password = document.getElementById('securityPassword').value;
            
            if (password === SECURITY_PASSWORD) {
                isSecurityUnlocked = true;
                hideSecurityModal();
                updateSecurityToggle();
                updateAllTables();
                showNotification('üîì Sicurezza disattivata - Prezzi di acquisto visibili', 'success');
                
                // Auto-riattiva la sicurezza dopo 5 minuti
                setTimeout(() => {
                    if (isSecurityUnlocked) {
                        activateSecurity();
                        showNotification('üîí Sicurezza riattivata automaticamente', 'warning');
                    }
                }, 300000); // 5 minuti
            } else {
                showNotification('‚ùå Password errata!', 'error');
                document.getElementById('securityPassword').value = '';
                document.getElementById('securityPassword').focus();
            }
        }

        function cancelSecurity() {
            hideSecurityModal();
            document.getElementById('securityPassword').value = '';
        }

        function activateSecurity() {
            isSecurityActive = true;
            isSecurityUnlocked = false;
            updateSecurityToggle();
            updateAllTables();
            showNotification('üîí Sicurezza attivata - Prezzi di acquisto censurati', 'success');
        }

        function updateSecurityToggle() {
            const toggle = document.getElementById('securityToggle');
            if (isSecurityActive && !isSecurityUnlocked) {
                toggle.textContent = 'üîí Sicurezza';
                toggle.className = 'security-toggle';
                toggle.title = 'üîí Sicurezza attiva - Clicca per sbloccare';
            } else if (isSecurityActive && isSecurityUnlocked) {
                toggle.textContent = 'üîì Sbloccato';
                toggle.className = 'security-toggle active';
                toggle.title = 'üîì Sicurezza sbloccata - Clicca per riattivare';
            } else {
                toggle.textContent = '‚ö†Ô∏è Disattivata';
                toggle.className = 'security-toggle alert';
                toggle.title = '‚ö†Ô∏è Sicurezza disattivata - Clicca per riattivare';
            }
            updateFormSecurity();
        }

        // Censura dinamica dei campi input nei form
        function updateFormSecurity() {
            // Prodotti
            const inputProdotti = document.getElementById('prezzoAcquistoProdottiInput');
            const labelProdotti = document.getElementById('securityLabelProdotti');
            if (inputProdotti && labelProdotti) {
                if (isSecurityActive && !isSecurityUnlocked) {
                    inputProdotti.type = 'password';
                    inputProdotti.placeholder = '***';
                    inputProdotti.style.letterSpacing = '2px';
                    labelProdotti.textContent = 'üîí';
                } else {
                    inputProdotti.type = 'number';
                    inputProdotti.placeholder = '';
                    inputProdotti.style.letterSpacing = 'normal';
                    labelProdotti.textContent = 'üîì';
                }
            }
            // Vini
            const inputVini = document.getElementById('prezzoAcquistoViniInput');
            const labelVini = document.getElementById('securityLabelVini');
            if (inputVini && labelVini) {
                if (isSecurityActive && !isSecurityUnlocked) {
                    inputVini.type = 'password';
                    inputVini.placeholder = '***';
                    inputVini.style.letterSpacing = '2px';
                    labelVini.textContent = 'üîí';
                } else {
                    inputVini.type = 'number';
                    inputVini.placeholder = '';
                    inputVini.style.letterSpacing = 'normal';
                    labelVini.textContent = 'üîì';
                }
            }
        }

        // Aggiungi event listeners per ricerca in tempo reale
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing code ...
            
            // Event listeners per filtri vini
            const filterInputs = ['filterNome', 'filterProduttore', 'filterRegione', 'filterVitigno'];
            filterInputs.forEach(id => {
                document.getElementById(id).addEventListener('input', function() {
                    if (this.value.length >= 2 || this.value.length === 0) {
                        applyViniFilters();
                    }
                });
            });
            
            // Event listeners per select
            document.getElementById('filterTipologia').addEventListener('change', applyViniFilters);
            document.getElementById('filterStock').addEventListener('change', applyViniFilters);
            
            // Inizializza il toggle di sicurezza
            updateSecurityToggle();
        });

        // Funzioni per il cambio password
        function showChangePasswordModal() {
            hideSecurityModal();
            const overlay = document.getElementById('changePasswordOverlay');
            const currentPasswordInput = document.getElementById('currentPassword');
            overlay.style.display = 'flex';
            currentPasswordInput.focus();
            currentPasswordInput.value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        function hideChangePasswordModal() {
            const overlay = document.getElementById('changePasswordOverlay');
            overlay.style.display = 'none';
        }

        function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (currentPassword !== SECURITY_PASSWORD) {
                showNotification('‚ùå Password attuale errata!', 'error');
                return;
            }
            
            if (newPassword.length < 4) {
                showNotification('‚ùå La nuova password deve essere di almeno 4 caratteri!', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showNotification('‚ùå Le password non coincidono!', 'error');
                return;
            }
            
            SECURITY_PASSWORD = newPassword;
            hideChangePasswordModal();
            showNotification('‚úÖ Password cambiata con successo!', 'success');
            
            // Salva la nuova password nel localStorage
            try {
                localStorage.setItem('tommy_security_password', SECURITY_PASSWORD);
            } catch (error) {
                console.error('Errore nel salvataggio password:', error);
            }
        }

        function cancelChangePassword() {
            hideChangePasswordModal();
        }

        // Carica la password salvata all'avvio
        function loadSecurityPassword() {
            try {
                const savedPassword = localStorage.getItem('tommy_security_password');
                if (savedPassword) {
                    SECURITY_PASSWORD = savedPassword;
                }
            } catch (error) {
                console.error('Errore nel caricamento password:', error);
            }
        }

        // Funzioni per il sistema di login
        function showLoginModal() {
            const overlay = document.getElementById('loginOverlay');
            const usernameInput = document.getElementById('loginUsername');
            overlay.style.display = 'flex';
            usernameInput.focus();
            usernameInput.value = '';
            document.getElementById('loginPassword').value = '';
        }

        function hideLoginModal() {
            const overlay = document.getElementById('loginOverlay');
            overlay.style.display = 'none';
        }

        function handleLoginPassword(event) {
            if (event.key === 'Enter') {
                validateLogin();
            }
        }

        function validateLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (username === 'Tommaso' && password === 'Tommy123') {
                currentUser = 'admin';
                isLoggedIn = true;
                hideLoginModal();
                showAdminInterface();
                showNotification('üîì Accesso amministratore effettuato!', 'success');
            } else {
                showNotification('‚ùå Credenziali errate!', 'error');
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginPassword').focus();
            }
        }

        function guestLogin() {
            currentUser = 'guest';
            isLoggedIn = true;
            hideLoginModal();
            showGuestInterface();
            showNotification('üë§ Accesso cliente effettuato!', 'success');
        }

        function showAdminInterface() {
            // Mostra tutte le sezioni per l'admin
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.style.display = 'block';
            });
            document.getElementById('securityToggle').style.display = 'block';
            
            // Mostra form di inserimento per admin
            const formSections = document.querySelectorAll('.form-section');
            formSections.forEach(section => {
                section.style.display = 'block';
            });
            
            // Mostra tutti i pulsanti per admin
            const actionButtons = document.querySelectorAll('.actions');
            actionButtons.forEach(actions => {
                const buttons = actions.querySelectorAll('.btn');
                buttons.forEach(button => {
                    button.style.display = 'inline-block';
                });
            });
            
            // Mostra intestazioni prezzi di acquisto per admin
            const prezzoAcquistoHeaders = document.querySelectorAll('#prezzoAcquistoHeaderProdotti, #prezzoAcquistoHeaderVini');
            prezzoAcquistoHeaders.forEach(header => {
                header.style.display = 'table-cell';
            });
            
            // Mostra info utente
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('currentUserDisplay').textContent = 'üë®‚Äçüíº Amministratore: Tommaso';
            
            // Mostra la tab clienti di default per admin
            showTab('clienti');
            
            // Aggiorna l'interfaccia
            updateSecurityToggle();
            updateAllTables();
        }

        function showGuestInterface() {
            // Nascondi sezioni non accessibili ai clienti
            const clientiTab = document.querySelector('.nav-tab[onclick="showTab(\'clienti\')"]');
            const fattureTab = document.querySelector('.nav-tab[onclick="showTab(\'fatture\')"]');
            
            if (clientiTab) clientiTab.style.display = 'none';
            if (fattureTab) fattureTab.style.display = 'none';
            
            // Nascondi pulsante sicurezza
            document.getElementById('securityToggle').style.display = 'none';
            
            // Nascondi form di inserimento per prodotti e vini
            const formSections = document.querySelectorAll('.form-section');
            formSections.forEach(section => {
                section.style.display = 'none';
            });
            
            // Nascondi pulsanti di aggiunta e import/export per clienti
            const actionButtons = document.querySelectorAll('.actions');
            actionButtons.forEach(actions => {
                const buttons = actions.querySelectorAll('.btn');
                buttons.forEach(button => {
                    if (button.textContent.includes('‚ûï') || 
                        button.textContent.includes('üì•') || 
                        button.textContent.includes('üìä')) {
                        button.style.display = 'none';
                    }
                });
            });
            
            // Nascondi intestazioni prezzi di acquisto per clienti
            const prezzoAcquistoHeaders = document.querySelectorAll('#prezzoAcquistoHeaderProdotti, #prezzoAcquistoHeaderVini');
            prezzoAcquistoHeaders.forEach(header => {
                header.style.display = 'none';
            });
            
            // Mostra info utente
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('currentUserDisplay').textContent = 'üë§ Cliente';
            
            // Mostra solo prodotti e vini
            showTab('prodotti');
            
            // Disattiva la censura per i clienti (mostra sempre i prezzi)
            isSecurityActive = false;
            isSecurityUnlocked = true;
            
            // Aggiorna le tabelle
            updateAllTables();
        }

        function logout() {
            currentUser = null;
            isLoggedIn = false;
            
            // Nascondi info utente
            document.getElementById('userInfo').style.display = 'none';
            
            // Nascondi tutte le tab
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            showLoginModal();
            showNotification('üëã Logout effettuato!', 'info');
        }
        
        // Aggiorna indicatore sincronizzazione
        function updateSyncIndicator() {
            const indicator = document.getElementById('syncIndicator');
            if (isOnline) {
                indicator.textContent = 'üîÑ Sincronizzazione attiva';
                indicator.style.color = '#28a745';
            } else {
                indicator.textContent = 'üì° Modalit√† offline';
                indicator.style.color = '#ffc107';
            }
        }

        // Mostra statistiche sincronizzazione
        function showSyncStats() {
            const stats = {
                clienti: clienti.length,
                documenti: documenti.length,
                prodotti: prodotti.length,
                vini: vini.length,
                lastSync: localStorage.getItem('tommy_last_sync'),
                deviceId: deviceId,
                isOnline: isOnline,
                backupCount: Object.keys(localStorage).filter(key => key.startsWith('tommy_backup_')).length
            };
            
            console.log('üìä Statistiche sincronizzazione:', stats);
            
            const message = `
                üìä Statistiche Sincronizzazione:
                
                üìã Dati:
                ‚Ä¢ Clienti: ${stats.clienti}
                ‚Ä¢ Documenti: ${stats.documenti}
                ‚Ä¢ Prodotti: ${stats.prodotti}
                ‚Ä¢ Vini: ${stats.vini}
                
                üîÑ Sincronizzazione:
                ‚Ä¢ Stato: ${stats.isOnline ? 'üåê Online' : 'üì° Offline'}
                ‚Ä¢ Ultimo sync: ${stats.lastSync ? new Date(parseInt(stats.lastSync)).toLocaleString() : 'Mai'}
                ‚Ä¢ Device ID: ${stats.deviceId}
                ‚Ä¢ Backup disponibili: ${stats.backupCount}
            `;
            
            alert(message);
        }
        
        // Funzione per forzare la sincronizzazione
        async function forceSync() {
            try {
                showLoading(true);
                console.log('üîÑ Avvio sincronizzazione forzata...');
                
                // Verifica integrit√† dati prima del sync
                verifyDataIntegrity();
                
                // Controlla aggiornamenti dal cloud
                const hasUpdates = await forceSyncOnStartup();
                
                // Salva i dati locali
                saveDataToStorage();
                
                // Crea backup
                createBackup();
                
                if (hasUpdates) {
                    showNotification('üîÑ Sincronizzazione completata con aggiornamenti!', 'success');
                } else {
                    showNotification('üîÑ Sincronizzazione completata!', 'success');
                }
                
                // Mostra statistiche
                showSyncStats();
                
            } catch (error) {
                console.error('‚ùå Errore nella sincronizzazione forzata:', error);
                showNotification('‚ùå Errore nella sincronizzazione', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Funzioni per configurazione GitHub
        function showGitHubConfig() {
            const overlay = document.getElementById('githubConfigOverlay');
            const tokenInput = document.getElementById('githubToken');
            const gistInput = document.getElementById('gistId');
            const enabledCheckbox = document.getElementById('githubEnabled');
            
            overlay.style.display = 'flex';
            tokenInput.focus();
            
            // Precompila i campi con i valori salvati
            tokenInput.value = GITHUB_CONFIG.token;
            gistInput.value = GITHUB_CONFIG.gistId;
            enabledCheckbox.checked = GITHUB_CONFIG.enabled;
        }

        // Funzioni per configurazione GitHub obbligatoria all'avvio
        function showGitHubSetup() {
            const overlay = document.getElementById('githubSetupOverlay');
            const tokenInput = document.getElementById('githubTokenSetup');
            const gistInput = document.getElementById('gistIdSetup');
            
            overlay.style.display = 'flex';
            tokenInput.focus();
            
            // Precompila il Gist ID con quello pre-configurato
            gistInput.value = 'ed140f6366c097f54410d096017bb51b';
        }

        function hideGitHubSetup() {
            const overlay = document.getElementById('githubSetupOverlay');
            overlay.style.display = 'none';
        }

        function saveGitHubSetup() {
            const token = document.getElementById('githubTokenSetup').value.trim();
            const gistId = document.getElementById('gistIdSetup').value.trim();
            
            if (!token) {
                showNotification('‚ùå Inserisci il token GitHub', 'error');
                return;
            }
            
            // Salva la configurazione
            GITHUB_CONFIG.token = token;
            GITHUB_CONFIG.gistId = gistId;
            GITHUB_CONFIG.enabled = true;
            
            localStorage.setItem('tommy_github_token', token);
            localStorage.setItem('tommy_gist_id', gistId);
            localStorage.setItem('tommy_github_enabled', 'true');
            
            hideGitHubSetup();
            showNotification('‚úÖ GitHub configurato! Ora accedi al sistema', 'success');
            
            // Mostra il modal di login
            setTimeout(() => {
                showLoginModal();
            }, 1000);
        }

        function skipGitHubSetup() {
            hideGitHubSetup();
            showNotification('‚è≠Ô∏è Configurazione GitHub saltata. Puoi configurarla dopo tramite ‚öôÔ∏è GitHub', 'info');
            
            // Mostra il modal di login
            setTimeout(() => {
                showLoginModal();
            }, 1000);
        }
        
        function hideGitHubConfig() {
            const overlay = document.getElementById('githubConfigOverlay');
            overlay.style.display = 'none';
        }
        
        function saveGitHubConfig() {
            const token = document.getElementById('githubToken').value.trim();
            const gistId = document.getElementById('gistId').value.trim();
            const enabled = document.getElementById('githubEnabled').checked;
            
            if (enabled && (!token || !gistId)) {
                showNotification('‚ùå Inserisci token e Gist ID per abilitare GitHub', 'error');
                return;
            }
            
            // Salva la configurazione
            GITHUB_CONFIG.token = token;
            GITHUB_CONFIG.gistId = gistId;
            GITHUB_CONFIG.enabled = enabled;
            
            localStorage.setItem('tommy_github_token', token);
            localStorage.setItem('tommy_gist_id', gistId);
            localStorage.setItem('tommy_github_enabled', enabled.toString());
            
            hideGitHubConfig();
            showNotification('‚úÖ Configurazione GitHub salvata!', 'success');
            
            // Testa la connessione se abilitata
            if (enabled) {
                testGitHubConnection();
            }
        }
        
        async function testGitHubConnection() {
            try {
                showLoading(true);
                const success = await saveToGitHubGist({
                    clienti: [],
                    fatture: [],
                    prodotti: [],
                    vini: [],
                    lastModified: Date.now(),
                    deviceId: deviceId
                });
                
                if (success) {
                    showNotification('‚úÖ Connessione GitHub testata con successo!', 'success');
                } else {
                    showNotification('‚ùå Errore nella connessione GitHub', 'error');
                }
            } catch (error) {
                console.error('Errore nel test GitHub:', error);
                showNotification('‚ùå Errore nel test della connessione', 'error');
            } finally {
                showLoading(false);
            }
        }
    </script>
</body>
</html> 